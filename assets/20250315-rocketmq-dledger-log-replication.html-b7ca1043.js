import{_ as c}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o as l,c as u,a as n,b as s,d as a,e}from"./app-2e704839.js";const i={},k={href:"http://hscarb.github.io/rocketmq/20250315-rocketmq-dledger-log-replication.html",target:"_blank",rel:"noopener noreferrer"},r=e(`<h1 id="rocketmq-dledger-日志复制-流程详解-源码解析" tabindex="-1"><a class="header-anchor" href="#rocketmq-dledger-日志复制-流程详解-源码解析" aria-hidden="true">#</a> RocketMQ DLedger 日志复制 流程详解 &amp; 源码解析</h1><h2 id="_1-背景" tabindex="-1"><a class="header-anchor" href="#_1-背景" aria-hidden="true">#</a> 1. 背景</h2><p>在 RocketMQ 4.5.0 版本以前，只提供了主从同步功能，但是主节点宕机之后从节点只能读不能写，没有主从切换能力。RocketMQ 4.5.0 引入了 DLedger 来实现主从切换。</p><p>DLedger 是基于 Raft 算法的 WAL 实现，它是为消息场景量身定制的，提供了日志写入和读取的接口，且对顺序读出和随机读出做了优化，充分适应消息系统消峰填谷的需求。</p><p>在 RocketMQ 4.8.0 版本以前，DLedger 模式的性能比主备模式差 1 个数量级<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup>，所以建议用尽可能新的版本部署。</p><p>DLedger 的实现大体可以分为两个部分，Leader 选举和日志复制。Leader 选举负责集群中选出一个主节点，而日志复制则确保各节点之间的数据一致性。本文基于 DLedger 0.2.7 版本源码详解日志复制的设计和流程。</p><h2 id="_2-概要设计" tabindex="-1"><a class="header-anchor" href="#_2-概要设计" aria-hidden="true">#</a> 2. 概要设计</h2><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/03/1742145285964.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>整个日志复制流程如上图所示：</p><ol><li>客户端向 Broker 发送消息，Leader Broker 中的消息处理器处理该生产请求。</li><li>在 DLedger 模式开启的情况下，消息处理器将生产请求交给 DLedger 服务进行消息存储。</li><li>DLedger 服务先将消息保存到本地存储。</li><li>构造客户端响应的 Future，放到一个 Map 中，等待日志转发线程将日志转发到 Follower 之后回填这个 Future 的结果后返回给客户端。</li><li>日志转发线程从上次转发的位置开始扫描。</li><li>日志转发线程将消息转发到 Follower 节点，该过程也是异步的，转发后会将等待转发完成的日志序号存在一个 pendingMap 中。</li><li>Follower Broker 中 DLedger 请求处理器收到 Leader 的日志转发请求，将该请求放入待处理队列。</li><li>Follower 的日志条目接收器扫描待处理队列中的请求。</li><li>将扫描到的请求对应的消息写入 Follower 本地存储，回填等待转发完成的 Future 结果。</li><li>Leader 的日志转发线程感知到日志转发请求完成后，移除 pendingMap 中的日志序号，更新节点水位表，这个表中存储着集群中所有节点的日志转发最新水位，用于判断日志是否被大多数节点写入。</li><li>日志转发线程同时唤醒结果仲裁线程。</li><li>结果仲裁线程根据节点水位表，得到当前集群中的大多数节点已经写入的日志序号。</li><li>大多数节点已经写入的日志序号和它之前的日志序号都认为已经写入完成，回填之前日志追加请求的 Future 结果。</li><li>返回结果给客户端。</li></ol><hr><p>我们可以把日志复制的流程分为 4 个部分：</p><ol><li>Leader 接收日志请求并存储，包含上面的 2~4 步。</li><li>Leader 的日志转发线程将日志转发到 Follower，包含上面的 5~6 步。</li><li>Follower 的请求处理线程接收和保存 Leader 的推送的日志，包含上面的 7~9 步。</li><li>Leader 的结果仲裁线程仲裁日志在所有节点保存的状态，更新日志水位，包含上面的 10~13 步。</li></ol><p>在下面的详细设计中，会按照这 4 个步骤来进行分析。</p><h2 id="_3-详细设计" tabindex="-1"><a class="header-anchor" href="#_3-详细设计" aria-hidden="true">#</a> 3. 详细设计</h2><p>在概要设计中，我们把 DLedger 日志复制分成 4 个主要步骤，在 DLedger 中，这 4 个步骤都主要在类 <code>DLedgerEntryPusher</code> 中实现，其中后面 3 个步骤有专门的线程进行处理，这些线程都作为 <code>DLedgerEntryPusher</code> 的内部类存在，这样就可以访问 <code>DLedgerEntryPusher</code> 的私有字段。</p><ul><li>Leader 接收日志请求并存储：由 <code>DLedgerMmapFileStore</code> 保存日志，然后由 <code>DLedgerEntryPusher</code> 等待日志转发完成。</li><li>Leader 转发日志到 Follower：由 <code>EntryDispatcher</code> 处理。</li><li>Follower 接收和保存 Leader 推送的日志：由 <code>EntryHandler</code> 处理。</li><li>Leader 仲裁复制结果：由 <code>QuorumAckChecker</code> 处理。</li></ul><hr><p>在具体讲解每个步骤之前，我们先来看一下 DLedger 日志复制中用到的容易混淆的几个 index 的含义。只有 <code>DLedgerMmapFileStore</code> 的两个字段是定时持久化的，其他的几个 index 字段都是对应的处理类在处理业务逻辑时需要临时用到的。</p><table><thead><tr><th>字段名</th><th>所属类</th><th>持久化</th><th>含义</th></tr></thead><tbody><tr><td>writeIndex</td><td>EntryDispatcher</td><td>×</td><td>Leader 向某一 Follower 节点推送的下一 index</td></tr><tr><td>ledgerEndIndex</td><td>DLedgerMmapFileStore</td><td>√</td><td>本地已写入存储的最大 index</td></tr><tr><td>committedIndex</td><td>DLedgerMmapFileStore</td><td>√</td><td>已被集群中超过半数节点确认的 index，表示已提交（可应用到状态机）的最大index</td></tr><tr><td>lastQuorumIndex</td><td>QuorumAckChecker</td><td>×</td><td>仲裁成功的最大 index，表示已达到多数节点复制确认的最大 index</td></tr><tr><td>peerWaterMarksByTerm</td><td>DLedgerEntryPusher</td><td>×</td><td>每个 term，集群内各个节点已经确认存储的最大 index（水位线）</td></tr></tbody></table><p>他们的大小关系通常是：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>lastQuorumIndex ≤ committedIndex ≤ ledgerEndIndex
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_3-1-leader-日志存储" tabindex="-1"><a class="header-anchor" href="#_3-1-leader-日志存储" aria-hidden="true">#</a> 3.1 Leader 日志存储</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/03/1742145286269.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li>对于启动 DLedger 模式的 RocketMQ Broker，其 CommitLog 会被初始化为 <code>DLedgerCommitLog</code>，它的 <code>handleAppend</code> 方法会作为 <code>DLedgerServer</code> 的入口，调用 DLedger 的日志追加逻辑。</li><li>先校验日志追加请求的合法性，然后调用 <code>appendAsLeader</code> 将日志追加到 Leader 本地存储。 <ol><li>追加前会先根据追加请求计算出 log 需要放入的偏移量。</li><li>将 log 写入底层文件。</li><li>将构造 log 索引，写入索引文件。</li><li>更新 <code>ledgerEndIndex</code> 和 <code>ledgerEndTerm</code>，表示 Ledger 本地存储的最大 index 和 term。这两个元数据会定期持久化到磁盘，以便故障恢复时使用。</li><li>返回追加结果。</li></ol></li><li>调用 <code>DLedgerEntryPusher</code> 的 <code>waitAck</code> 方法，将日志推送到 Follower 节点。 <ol><li>更新集群水位表中 Leader 的最大日志序号，因为在 Leader 上写入的日志已经被确认。</li><li>新建一个日志追加的 Future，放入等待响应的日志追加 Future 中，等日志转发线程回填该 Future 的结果后就将结果返回给上层客户端。</li></ol></li></ol><h3 id="_3-2-leader-转发日志到-follower" tabindex="-1"><a class="header-anchor" href="#_3-2-leader-转发日志到-follower" aria-hidden="true">#</a> 3.2 Leader 转发日志到 Follower</h3><p>Leader 日志转发的流程由 <code>EntryDispatcher</code> 类处理，它的主要逻辑在 <code>doWork</code> 方法中，无限循环调用。</p><p><code>EntryDispatcher</code> 类有 4 个状态，每个状态会向 Follower 发送不同类型的请求。<br> 下面是 <code>EntryDispatcher</code> 类状态流转图：</p>`,28),d=e(`<ul><li><code>COMPARE</code>：日志对比，当发生 Leader 切换时，新 Leader 需要与 Follower 进行日志对比，截断 Follower 多余的日志。</li><li><code>TRUNCATE</code>：日志截断，新 Leader 发现 Follower 存在多余的数据（未提交的），发送 <code>TRUNCATE</code> 请求，要求 Follower 删除多余的数据，保证数据一致性。</li><li><code>APPEND</code>：日志追加，Leader 向 Follower 发送日志追加请求，Leader 将日志复制追加到 Follower。</li><li><code>COMMIT</code>：日志提交，Leader 向 Follower 同步当前节点的已提交日志序号。其实在 <code>APPEND</code> 时也会向 Follower 同步当前节点的已提交日志序号，但是有时 <code>APPEND</code> 请求不那么频繁，可能存在老的日志在多数节点复制完之后更新 <code>committedIndex</code>，但是无法及时用 <code>APPEND</code> 请求去更新到 Follower，所以此时需要 <code>COMMIT</code> 请求来同步。每秒会向 Follower <code>COMMIT</code> 一次。</li></ul><hr><p><code>EntryDispatcher</code> 的执行逻辑如下：</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/03/1742145286313.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li>检查和刷新节点状态，如果不是 Leader 则返回，如果是，则继续判断 <code>EntryDispatcher</code> 的状态。</li><li>如果是新 Leader，初始状态是 <code>COMPARE</code>，进入 <code>doCompare</code> 方法。 <ol><li>如果是新集群，没有数据，无需比较。</li><li>把 Leader 当前的日志末尾 index 作为需要比较的 index，从存储中获取末尾的日志。</li><li>向 Follower 发送 <code>COMPARE</code> 请求，等待 Follower 的响应。</li><li>根据比较的结果，决定 Follower 是否要截断，以及从哪里开始截断。具体逻辑查看下面的源码解析部分。</li><li>切换 <code>EntryDispatcher</code> 状态为 <code>TRUNCATE</code></li><li>执行 <code>doTruncate</code> 方法。</li><li>根据需要截断的 index，从存储中获取对应的日志。</li><li>向 Follower 发送 <code>TRUNCATE</code> 请求，等待 Follower 的响应。</li><li>切换 <code>EntryDispatcher</code> 状态为 <code>APPEND</code>。</li></ol></li><li>完成 <code>COMPARE</code> 和 <code>TRUNCATE</code> 后，<code>EntryDispatcher</code> 的状态会被切换为 <code>APPEND</code>，进入 <code>doAppend</code> 方法。 <ol><li>如果 Leader 当前向 Follower 推送的日志 index 大于 Leader 本地存储的日志 index，此时一般是已经推送完了全部的日志（但还不一定全部成功响应），还没有新日志要推送。这种情况下可能之前推送的日志条目被 Follower 响应，这样日志在多数节点复制完成后会推进 committedIndex，需要定时向 Follower 发送 <code>COMMIT</code> 请求来更新集群的 <code>committedIndex</code>。所以这里直接调用 <code>doCommit</code> 之后返回。</li><li>挂起的推送请求数量如果超过 1000，则不推送新的日志到 Follower，而是检查挂起的请求中超时的推送请求进行重推。</li><li>执行 <code>doAppendInner</code> 方法进行日志推送 <ul><li>从存储获取要推送的日志数据</li><li>检查是否需要流控，用 <code>sleep</code> 进行流控</li><li>向 Follower 发送 <code>APPEND</code> 请求</li><li>将推送的 <code>index</code> 加入推送等待表</li><li>设置推送成功的回调</li><li>如果 Follower 返回成功，则从等待表中删除 <code>index</code>，更新集群水位表，启动 <code>QuorumAckChecker</code> 进行结果检查。</li><li>如果 Follower 返回 <code>INCONSISTENT_STATE</code>，表示主从日志不一致，需要进行 <code>COMPARE</code> 和 <code>TRUNCATE</code>，切换状态到 <code>COMPARE</code>。</li></ul></li></ol></li><li>当前 index 推送完成，将 <code>writeIndex</code> 加一，准备推送下一条日志。</li></ol><h3 id="_3-3-follower-存储日志" tabindex="-1"><a class="header-anchor" href="#_3-3-follower-存储日志" aria-hidden="true">#</a> 3.3 Follower 存储日志</h3><p>Follower 收到 Leader 发来的推送请求会进行处理，根据请求类型不同，进行不同的逻辑。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/03/1742145286354.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><code>EntryHandler</code> 的 <code>handlePush</code> 方法接收 Leader 的推送请求，把请求放入对应的等待表中，唤醒 <code>EntryHandler</code> 线程后续从等待表中提取和处理。</li><li>主要有两个请求等待表 <ul><li>红色的 <code>compareOrTruncateRequests</code> 表示 <code>COMPARE</code>、<code>TRUNCATE</code>、<code>COMMIT</code> 请求的等待表，<code>EntryHandler</code> 线程会优先处理这个表中的请求，进行日志比对和截断操作。</li><li>绿色的 <code>writeRequestMap</code> 表示 <code>APPEND</code> 请求的等待表。</li></ul></li><li><code>EntryHandler</code> 线程的 <code>doWork</code> 方法主逻辑从两个请求等待表中获取等待的请求进行处理，，如果为空，则从 <code>writeRequestMap</code> 中获取请求。 <ul><li>优先从 <code>compareOrTruncateRequests</code> 中获取请求 <ul><li><code>COMPARE</code>：根据请求中需要比对的 index，从本地获取日志数据，判断是否存在（请求数据和本地数据是否相等）。存在则返回 <code>SUCCESS</code>，不存在返回 <code>INCONSISTENT_STATE</code>。</li><li><code>TRUNCATE</code>：调用 <code>DLedgerMmapFileStore</code> 的 <code>truncate</code> 方法，进行截断。该方法会把需要截断 index 之后的文件删除，index 所在的文件则重置文件末尾位置。</li><li><code>COMMIT</code>：将请求中的 <code>committedIndex</code> 更新到本地，表示整个集群已经确认的 index 序号。</li></ul></li><li>如果 <code>compareOrTruncateRequests</code> 为空，从 <code>writeRequestMap</code> 中获取请求 <ul><li>如果没有找到下一个 index 的 <code>APPEND</code> 请求，且等待表不为空，说明可能存在 <code>APPEND</code> 异常：调用 <code>checkAbnormalFuture</code> 检查请求是否丢失，会遍历所有挂起的 <code>APPEND</code> 请求进行检查。 <ol><li>待 APPEND 的 index 小于 Follower 存储的最大日志序号，这种情况在 Leader 重复推送时会出现，Follower 存储的内容与请求的一致返回 <code>SUCCESS</code>，内容不一致返回 <code>INCONSISTENT_STATE</code></li><li>待 APPEND 的 index 等于 Follower 存储的最大日志序号：正常，直接返回</li><li>待 APPEND 的 index 大于 Follower 存储的最大日志序号，这种情况在 Follower 宕机重启后，其最大 index 可能比宕机之前小，这样 Leader 推送的条目就超前于当前 Follower 保存的最大日志 index。请求已超时则返回 <code>INCONSISTENT_STATE</code>，触发 Leader 发送 <code>COMPARE</code>。</li></ol></li><li>如果成功找到下一个 index 的 <code>APPEND</code> 请求，则将请求中的日志数据写入 Follower 本地存储。然后用请求中的 <code>committedIndex</code> 更新到本地。</li></ul></li></ul></li></ul><h3 id="_3-4-leader-仲裁日志复制结果" tabindex="-1"><a class="header-anchor" href="#_3-4-leader-仲裁日志复制结果" aria-hidden="true">#</a> 3.4 Leader 仲裁日志复制结果</h3><p>Leader 在收到 Follower <code>APPEND</code> 成功的响应后会唤醒 <code>QuorumAckChecker</code> 线程，进行结果检查。<code>QuorumAckChecker</code> 的 <code>doWork</code> 方法是其主逻辑循环，逻辑如下：</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/03/1742145286395.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li>清除过期的（term 与当前不同）被挂起的 APPEND 请求</li><li>获取当前 term 的水位表，水位表中包含了集群中所有节点的当前日志复制水位。</li><li>将所有节点的水位倒序排序，中间的值就是大多数节点已经确认的 index。</li><li>更新 <code>DLedgerStore</code> 的已确认 index</li><li>对于已确认 index 之前的日志附加请求 Future，遍历它们，回填成功结果，此时客户端的请求会被响应。</li><li>更新 <code>lastQuorumIndex</code>，用于下次检查后的遍历</li></ol><h2 id="_4-源码解析" tabindex="-1"><a class="header-anchor" href="#_4-源码解析" aria-hidden="true">#</a> 4. 源码解析</h2><h3 id="_4-1-dledgerentrypusher-类字段设计" tabindex="-1"><a class="header-anchor" href="#_4-1-dledgerentrypusher-类字段设计" aria-hidden="true">#</a> 4.1 DLedgerEntryPusher 类字段设计</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * DLedger 条目推送器，负责在 Leader 节点上将条目推送给 Follower
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DLedgerEntryPusher</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DLedgerEntryPusher</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">DLedgerConfig</span> dLedgerConfig<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * DLedger 存储
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">DLedgerStore</span> dLedgerStore<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Raft 节点状态机，保存当前节点角色、id、term、对端节点等信息
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MemberState</span> memberState<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * RPC 实现类，用于集群内网络通信
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">DLedgerRpcService</span> dLedgerRpcService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 每个投票轮次中，复制组中每个节点当前已存储的最大日志序号（水位）
     * 用于判断已提交条目序号，仲裁一个条目是否已被超过半数节点存储
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">Long</span> <span class="token comment">/* 投票轮次 */</span><span class="token punctuation">,</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span> <span class="token comment">/* 节点编号 */</span><span class="token punctuation">,</span> <span class="token class-name">Long</span> <span class="token comment">/* 日志序号 */</span><span class="token operator">&gt;&gt;</span> peerWaterMarksByTerm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 每一个投票轮次中，发给 Follower，等待响应挂起的 Append 请求
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">Long</span> <span class="token comment">/* 投票轮次 */</span><span class="token punctuation">,</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">Long</span> <span class="token comment">/* 日志序号 */</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppendEntryResponse</span><span class="token punctuation">&gt;</span></span><span class="token operator">&gt;&gt;</span> pendingAppendResponsesByTerm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 条目接收处理线程，仅在 Follower 激活
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">EntryHandler</span> entryHandler<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 追加条目 ACK 仲裁线程，仅在 Leader 激活
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">QuorumAckChecker</span> quorumAckChecker<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 数据复制线程，在 Leader 节点会为每一个 Follower 节点创建一个 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">EntryDispatcher</span></span><span class="token punctuation">}</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">EntryDispatcher</span><span class="token punctuation">&gt;</span></span> dispatcherMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-leader-日志存储" tabindex="-1"><a class="header-anchor" href="#_4-2-leader-日志存储" aria-hidden="true">#</a> 4.2 Leader 日志存储</h3><h4 id="_4-2-1-dledgerserver-处理客户端-append-请求" tabindex="-1"><a class="header-anchor" href="#_4-2-1-dledgerserver-处理客户端-append-请求" aria-hidden="true">#</a> 4.2.1 DLedgerServer 处理客户端 Append 请求</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token doc-comment comment">/**
  * Leader 处理追加条目请求入口
  *
  * 1. 将条目追加到本地存储
  * 2. 将 Future 提交给 EntryPusher 并等待超过半数节点 ACK
  * 3. 如果待处理请求已满，则立即拒绝
  *
  * Handle the append requests:
  * 1.append the entry to local store
  * 2.submit the future to entry pusher and wait the quorum ack
  * 3.if the pending requests are full, then reject it immediately
  *
  * <span class="token keyword">@param</span> <span class="token parameter">request</span>
  * <span class="token keyword">@return</span>
  * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
  */</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppendEntryResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleAppend</span><span class="token punctuation">(</span><span class="token class-name">AppendEntryRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
     <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// 验证请求合理性</span>
         <span class="token comment">// 1. 验证请求目的节点是否为当前节点</span>
         <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRemoteId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN_MEMBER</span><span class="token punctuation">,</span> <span class="token string">&quot;%s != %s&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRemoteId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 2. 验证请求集群是否为当前集群</span>
         <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN_GROUP</span><span class="token punctuation">,</span> <span class="token string">&quot;%s != %s&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 3. 验证当前节点是否为 Leader</span>
         <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">NOT_LEADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 4. 验证当前节点状态是否为转移中</span>
         <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getTransferee</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">LEADER_TRANSFERRING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">long</span> currTerm <span class="token operator">=</span> memberState<span class="token punctuation">.</span><span class="token function">currTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 追加条目是异步过程，会将内容暂存到内存队列中。首先检查内存队列是否已满</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>dLedgerEntryPusher<span class="token punctuation">.</span><span class="token function">isPendingFull</span><span class="token punctuation">(</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">// 已满，向客户端返回错误码 LEADER_PENDING_FULL，表示本次追加请求失败</span>
             <span class="token class-name">AppendEntryResponse</span> appendEntryResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppendEntryResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             appendEntryResponse<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             appendEntryResponse<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">LEADER_PENDING_FULL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             appendEntryResponse<span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
             appendEntryResponse<span class="token punctuation">.</span><span class="token function">setLeaderId</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span> <span class="token class-name">AppendFuture</span><span class="token punctuation">.</span><span class="token function">newCompletedFuture</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> appendEntryResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
             <span class="token comment">// Push 队列未满</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token keyword">instanceof</span> <span class="token class-name">BatchAppendEntryRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token comment">// 批量 Append 请求</span>
                 <span class="token class-name">BatchAppendEntryRequest</span> batchRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BatchAppendEntryRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>batchRequest<span class="token punctuation">.</span><span class="token function">getBatchMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> batchRequest<span class="token punctuation">.</span><span class="token function">getBatchMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token comment">// record positions to return;</span>
                     <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> positions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span>batchRequest<span class="token punctuation">.</span><span class="token function">getBatchMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                     <span class="token class-name">DLedgerEntry</span> resEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                     <span class="token comment">// split bodys to append</span>
                     <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                     <span class="token class-name">Iterator</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> iterator <span class="token operator">=</span> batchRequest<span class="token punctuation">.</span><span class="token function">getBatchMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                         <span class="token class-name">DLedgerEntry</span> dLedgerEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLedgerEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                         dLedgerEntry<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                         resEntry <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">appendAsLeader</span><span class="token punctuation">(</span>dLedgerEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                         positions<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> resEntry<span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>
                     <span class="token comment">// only wait last entry ack is ok</span>
                     <span class="token class-name">BatchAppendFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppendEntryResponse</span><span class="token punctuation">&gt;</span></span> batchAppendFuture <span class="token operator">=</span>
                         <span class="token punctuation">(</span><span class="token class-name">BatchAppendFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppendEntryResponse</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> dLedgerEntryPusher<span class="token punctuation">.</span><span class="token function">waitAck</span><span class="token punctuation">(</span>resEntry<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     batchAppendFuture<span class="token punctuation">.</span><span class="token function">setPositions</span><span class="token punctuation">(</span>positions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">return</span> batchAppendFuture<span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
                 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DLedgerException</span><span class="token punctuation">(</span><span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">REQUEST_WITH_EMPTY_BODYS</span><span class="token punctuation">,</span> <span class="token string">&quot;BatchAppendEntryRequest&quot;</span> <span class="token operator">+</span>
                     <span class="token string">&quot; with empty bodys&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                 <span class="token comment">// 单个 Append 请求</span>
                 <span class="token class-name">DLedgerEntry</span> dLedgerEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLedgerEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 dLedgerEntry<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token comment">// Leader 节点日志存储</span>
                 <span class="token class-name">DLedgerEntry</span> resEntry <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">appendAsLeader</span><span class="token punctuation">(</span>dLedgerEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token comment">// 把写入的条目 Push 到所有 Follower，Leader 等待 Follower 节点 ACK</span>
                 <span class="token keyword">return</span> dLedgerEntryPusher<span class="token punctuation">.</span><span class="token function">waitAck</span><span class="token punctuation">(</span>resEntry<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[{}][HandleAppend] failed&quot;</span><span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">AppendEntryResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppendEntryResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         response<span class="token punctuation">.</span><span class="token function">copyBaseInfo</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
         response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         response<span class="token punctuation">.</span><span class="token function">setLeaderId</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getLeaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token class-name">AppendFuture</span><span class="token punctuation">.</span><span class="token function">newCompletedFuture</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-2-dledgerstore-保存日志到本地存储" tabindex="-1"><a class="header-anchor" href="#_4-2-2-dledgerstore-保存日志到本地存储" aria-hidden="true">#</a> 4.2.2 <code>DLedgerStore</code> 保存日志到本地存储</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Leader 节点追加日志条目
 *
 * <span class="token keyword">@param</span> <span class="token parameter">entry</span> 日志条目
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">DLedgerEntry</span> <span class="token function">appendAsLeader</span><span class="token punctuation">(</span><span class="token class-name">DLedgerEntry</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 校验</span>
    <span class="token comment">// 1. 当前节点是否为 Leader</span>
    <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">NOT_LEADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 当前节点磁盘是否已满，超过 90% 则磁盘满</span>
    <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token operator">!</span>isDiskFull<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">DISK_FULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 取 ThreadLocal 缓存的 条目和索引 Buffer</span>
    <span class="token class-name">ByteBuffer</span> dataBuffer <span class="token operator">=</span> localEntryBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> indexBuffer <span class="token operator">=</span> localIndexBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对客户端发送的数据进行编码，按照 DLedger 存储协议进行封装</span>
    <span class="token class-name">DLedgerEntryCoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> dataBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 数据缓冲区大小</span>
    <span class="token keyword">int</span> entrySize <span class="token operator">=</span> dataBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 锁定状态机</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>memberState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 再次校验节点状态是否为 Leader</span>
        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">NOT_LEADER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getTransferee</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">LEADER_TRANSFERRING</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置当前日志条目序号和投票轮次，DLedger 会为 Leader 节点收到的每一条数据在服务端维护一个递增的日志序号，作为唯一标识</span>
        <span class="token keyword">long</span> nextIndex <span class="token operator">=</span> ledgerEndIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span>nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">currTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span><span class="token function">setMagic</span><span class="token punctuation">(</span><span class="token constant">CURRENT_MAGIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将当前节点的投票轮次和日志序号强制覆盖写入到数据缓冲区中</span>
        <span class="token class-name">DLedgerEntryCoder</span><span class="token punctuation">.</span><span class="token function">setIndexTerm</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">currTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">CURRENT_MAGIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算消息写入的起始物理偏移量，并设置</span>
        <span class="token keyword">long</span> prePos <span class="token operator">=</span> dataFileList<span class="token punctuation">.</span><span class="token function">preAppend</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span><span class="token function">setPos</span><span class="token punctuation">(</span>prePos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>prePos <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">DISK_ERROR</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将写入位置覆盖写入到数据缓冲区</span>
        <span class="token class-name">DLedgerEntryCoder</span><span class="token punctuation">.</span><span class="token function">setPos</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">,</span> prePos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行追加条目钩子函数，在 RocketMQ 中，这里会重新计算消息数据的偏移量并覆盖写入 buffer</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AppendHook</span> writeHook <span class="token operator">:</span> appendHooks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            writeHook<span class="token punctuation">.</span><span class="token function">doHook</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> dataBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerEntry</span><span class="token punctuation">.</span><span class="token constant">BODY_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将数据条目追加到 PageCache 中</span>
        <span class="token keyword">long</span> dataPos <span class="token operator">=</span> dataFileList<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> dataBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>dataPos <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">DISK_ERROR</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>dataPos <span class="token operator">==</span> prePos<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">DISK_ERROR</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构建索引，写入 indexBuffer，并将索引追加到 PageCache 中</span>
        <span class="token class-name">DLedgerEntryCoder</span><span class="token punctuation">.</span><span class="token function">encodeIndex</span><span class="token punctuation">(</span>dataPos<span class="token punctuation">,</span> entrySize<span class="token punctuation">,</span> <span class="token constant">CURRENT_MAGIC</span><span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">currTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indexBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> indexPos <span class="token operator">=</span> indexFileList<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>indexBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> indexBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>indexPos <span class="token operator">==</span> entry<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">INDEX_UNIT_SIZE</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">DISK_ERROR</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[{}] Append as Leader {} {}&quot;</span><span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 日志末尾序号 + 1</span>
        ledgerEndIndex<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置日志末尾 term</span>
        ledgerEndTerm <span class="token operator">=</span> memberState<span class="token punctuation">.</span><span class="token function">currTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果日志开始序号没有初始化，则初始化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ledgerBeginIndex <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ledgerBeginIndex <span class="token operator">=</span> ledgerEndIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 更新当前节点 MemberState 的 ledgerEndIndex 与 ledgerEndTerm</span>
        <span class="token function">updateLedgerEndIndexAndTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-3-dledgerentrypusher-推送写入的日志到-follower-等待-follower-节点-ack" tabindex="-1"><a class="header-anchor" href="#_4-2-3-dledgerentrypusher-推送写入的日志到-follower-等待-follower-节点-ack" aria-hidden="true">#</a> 4.2.3 <code>DLedgerEntryPusher</code> 推送写入的日志到 Follower，等待 Follower 节点 ACK</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 把写入的条目 Push 到所有 Follower，Leader 等待 Follower 节点 ACK
 *
 * <span class="token keyword">@param</span> <span class="token parameter">entry</span> 追加的条目
 * <span class="token keyword">@param</span> <span class="token parameter">isBatchWait</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppendEntryResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">waitAck</span><span class="token punctuation">(</span><span class="token class-name">DLedgerEntry</span> entry<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isBatchWait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Leader 节点更新自身水位线</span>
    <span class="token function">updatePeerWaterMark</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getPeerMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果复制组内只有一个节点，直接返回成功</span>
        <span class="token class-name">AppendEntryResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppendEntryResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setLeaderId</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setPos</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isBatchWait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">BatchAppendFuture</span><span class="token punctuation">.</span><span class="token function">newCompletedFuture</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">AppendFuture</span><span class="token punctuation">.</span><span class="token function">newCompletedFuture</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Leader 等待 Follower 复制完数据，返回给客户端一个 Future</span>
        <span class="token function">checkTermForPendingMap</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;waitAck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AppendFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppendEntryResponse</span><span class="token punctuation">&gt;</span></span> future<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isBatchWait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BatchAppendFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>dLedgerConfig<span class="token punctuation">.</span><span class="token function">getMaxWaitAckTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppendFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>dLedgerConfig<span class="token punctuation">.</span><span class="token function">getMaxWaitAckTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        future<span class="token punctuation">.</span><span class="token function">setPos</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将 Future 放入 pendingAppendResponsesByTerm 中，等待 Follower 复制完数据后，填充结果</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppendEntryResponse</span><span class="token punctuation">&gt;</span></span> old <span class="token operator">=</span> pendingAppendResponsesByTerm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[MONITOR] get old wait at index={}&quot;</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-entrydispatcher-将日志从-leader-转发到-follower" tabindex="-1"><a class="header-anchor" href="#_4-3-entrydispatcher-将日志从-leader-转发到-follower" aria-hidden="true">#</a> 4.3 <code>EntryDispatcher</code> 将日志从 Leader 转发到 Follower</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 数据转发线程，负责将 Leader 节点的条目推送给 Follower 节点
 */</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">EntryDispatcher</span> <span class="token keyword">extends</span> <span class="token class-name">ShutdownAbleThread</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 向 Follower 发送命令的类型
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMPARE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 上一次发送 commit 请求的时间戳
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastPushCommitTimeMs <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 目标节点 ID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> peerId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * Leader 已完成 COMPARE 的日志序号
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> compareIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 已向 Follower 发送 APPEND 请求的日志序号（异步操作，不保证 Follower 响应）
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> writeIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 允许的最大挂起条目数量
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxPendingSize <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * Leader 节点当前投票轮次
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> term <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * Leader 节点 ID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> leaderId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 上次检测泄露的时间，即挂起的日志数量超过 maxPendingSize 的时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastCheckLeakTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 挂起的 APPEND 请求列表（Leader 将日志转发到 Follower 的请求）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">Long</span> <span class="token comment">/* 日志序号 */</span><span class="token punctuation">,</span> <span class="token class-name">Long</span> <span class="token comment">/* 挂起的时间戳 */</span><span class="token operator">&gt;</span> pendingMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> batchPendingMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">PushEntryRequest</span> batchAppendEntryRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PushEntryRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 每秒转发到 Follower 的日志带宽配额，默认 20M
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Quota</span> quota <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quota</span><span class="token punctuation">(</span>dLedgerConfig<span class="token punctuation">.</span><span class="token function">getPeerPushQuota</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">EntryDispatcher</span><span class="token punctuation">(</span><span class="token class-name">String</span> peerId<span class="token punctuation">,</span> <span class="token class-name">Logger</span> logger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">&quot;EntryDispatcher-&quot;</span> <span class="token operator">+</span> memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> peerId<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>peerId <span class="token operator">=</span> peerId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 检查节点是否为 Leader，并更新日志转发器的状态
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkAndFreshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当前节点不是 Leader，直接返回 false，暂停 EntryDispatcher 的复制执行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memberState<span class="token punctuation">.</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果集群触发了重新选举，当前节点刚被选举成 Leader，</span>
        <span class="token comment">// 日志转发器投票轮次与状态机投票轮次不相等，或 LeaderId 为空，或 LeaderId 与状态机 LeaderId 不相等</span>
        <span class="token comment">// 将 EntryDispatcher 的 term、leaderId 与 MemberState 同步，然后发送 COMPARE 请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>term <span class="token operator">!=</span> memberState<span class="token punctuation">.</span><span class="token function">currTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> leaderId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>leaderId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getLeaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>memberState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memberState<span class="token punctuation">.</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getLeaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 更新投票轮次和 LeaderId 为状态机的</span>
                term <span class="token operator">=</span> memberState<span class="token punctuation">.</span><span class="token function">currTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                leaderId <span class="token operator">=</span> memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 改变日志转发器的状态为 COMPARE</span>
                <span class="token function">changeState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMPARE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">PushEntryRequest</span> <span class="token function">buildPushRequest</span><span class="token punctuation">(</span><span class="token class-name">DLedgerEntry</span> entry<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PushEntryRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PushEntryRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setRemoteId</span><span class="token punctuation">(</span>peerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setLeaderId</span><span class="token punctuation">(</span>leaderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setCommitIndex</span><span class="token punctuation">(</span>dLedgerStore<span class="token punctuation">.</span><span class="token function">getCommittedIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> request<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resetBatchAppendEntryRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        batchAppendEntryRequest<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        batchAppendEntryRequest<span class="token punctuation">.</span><span class="token function">setRemoteId</span><span class="token punctuation">(</span>peerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        batchAppendEntryRequest<span class="token punctuation">.</span><span class="token function">setLeaderId</span><span class="token punctuation">(</span>leaderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        batchAppendEntryRequest<span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
        batchAppendEntryRequest<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">APPEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        batchAppendEntryRequest<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 检查是否超出配额，超出会触发流控
     * 1. 挂起的 APPEND 请求数，阈值为 1000
     * 2. 主从同步差异，阈值为 300 MB
     * 3. 每秒追加日志速率，阈值为 20 MB
     *
     * <span class="token keyword">@param</span> <span class="token parameter">entry</span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkQuotaAndWait</span><span class="token punctuation">(</span><span class="token class-name">DLedgerEntry</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 检查挂起的 APPEND 请求数是否超过阈值，未超过则返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> entry<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> maxPendingSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 内存存储，直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dLedgerStore <span class="token keyword">instanceof</span> <span class="token class-name">DLedgerMemoryStore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// MMAP 存储，检查主从同步差异，未超过则返回</span>
        <span class="token class-name">DLedgerMmapFileStore</span> mmapFileStore <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerMmapFileStore</span><span class="token punctuation">)</span> dLedgerStore<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mmapFileStore<span class="token punctuation">.</span><span class="token function">getDataFileList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxWrotePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> entry<span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> dLedgerConfig<span class="token punctuation">.</span><span class="token function">getPeerPushThrottlePoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 统计当前秒的速率，累加</span>
        quota<span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果触发流控，等待，直到当前这一秒结束</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>quota<span class="token punctuation">.</span><span class="token function">validateNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> leftNow <span class="token operator">=</span> quota<span class="token punctuation">.</span><span class="token function">leftNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[Push-{}]Quota exhaust, will sleep {}ms&quot;</span><span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> leftNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DLedgerUtils</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>leftNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * APPEND 日志实现，Leader 将日志转发到 Follower
     * <span class="token keyword">@param</span> <span class="token parameter">index</span> 日志序号
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAppendInner</span><span class="token punctuation">(</span><span class="token keyword">long</span> index<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据日志序号查询日志内容</span>
        <span class="token class-name">DLedgerEntry</span> entry <span class="token operator">=</span> <span class="token function">getDLedgerEntryForAppend</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 检查是否超出配额，如果超出则流控，sleep 一段时间</span>
        <span class="token function">checkQuotaAndWait</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构造 APPEND 请求</span>
        <span class="token class-name">PushEntryRequest</span> request <span class="token operator">=</span> <span class="token function">buildPushRequest</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">APPEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 异步发送 APPEND 请求</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> responseFuture <span class="token operator">=</span> dLedgerRpcService<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 保存发送 APPEND 请求，Key：APPEND 的日志序号，Value：APPEND 的时间戳</span>
        pendingMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// APPEND 成功回调</span>
        responseFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> ex<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>ex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">DLedgerResponseCode</span> responseCode <span class="token operator">=</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>responseCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token constant">SUCCESS</span><span class="token operator">:</span>
                        <span class="token comment">// 移除 APPEND 请求等待列表中的日志条目</span>
                        pendingMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// APPEND 成功后更新 Peer（对端节点）水位线（追加成功的日志序号）</span>
                        <span class="token function">updatePeerWaterMark</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 唤醒 ACK 仲裁线程，用于仲裁 APPEND 结果</span>
                        quorumAckChecker<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token constant">INCONSISTENT_STATE</span><span class="token operator">:</span>
                        <span class="token comment">// APPEND 请求状态不一致，Leader 将发送 COMPARE 请求，对比数据是否一致</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[Push-{}]Get INCONSISTENT_STATE when push index={} term={}&quot;</span><span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">changeState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMPARE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[Push-{}]Get error response code {} {}&quot;</span><span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> responseCode<span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token function">baseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lastPushCommitTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 根据日志序号查询内容
     *
     * <span class="token keyword">@param</span> <span class="token parameter">index</span> 日志序号
     * <span class="token keyword">@return</span> 日志条目
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">DLedgerEntry</span> <span class="token function">getDLedgerEntryForAppend</span><span class="token punctuation">(</span><span class="token keyword">long</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DLedgerEntry</span> entry<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            entry <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//  Do compare, in case the ledgerBeginIndex get refreshed.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INDEX_LESS_THAN_LOCAL_BEGIN</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[Push-{}]Get INDEX_LESS_THAN_LOCAL_BEGIN when requested index is {}, try to compare&quot;</span><span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">changeState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMPARE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">,</span> <span class="token string">&quot;writeIndex=%d&quot;</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 仅在距离上次发送至少过了1秒后才发送COMMIT请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerUtils</span><span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span>lastPushCommitTimeMs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">PushEntryRequest</span> request <span class="token operator">=</span> <span class="token function">buildPushRequest</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMMIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//Ignore the results</span>
            dLedgerRpcService<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lastPushCommitTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * APPEND 请求重推
     * 判断最新一个 APPEND 请求是否已经超时，如果超时则重新发送请求
     *
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doCheckAppendResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取 Follower 节点水位（已复制日志序号）</span>
        <span class="token keyword">long</span> peerWaterMark <span class="token operator">=</span> <span class="token function">getPeerWaterMark</span><span class="token punctuation">(</span>term<span class="token punctuation">,</span> peerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 尝试查找最老的（已复制序号 + 1）等待的 APPEND 请求</span>
        <span class="token class-name">Long</span> sendTimeMs <span class="token operator">=</span> pendingMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>peerWaterMark <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果下一个等待的 APPEND 请求已超时（1s），重试推送</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sendTimeMs <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sendTimeMs <span class="token operator">&gt;</span> dLedgerConfig<span class="token punctuation">.</span><span class="token function">getMaxPushTimeOutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[Push-{}]Retry to push entry at {}&quot;</span><span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> peerWaterMark <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doAppendInner</span><span class="token punctuation">(</span>peerWaterMark <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 追加日志条目到 Follower
     *
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAppend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 无限循环</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 检查节点状态，确保是 Leader，否则直接跳出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkAndFreshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 检查日志转发器内部状态，确保为 APPEND，否则直接跳出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">APPEND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果准备 APPEND 的日志超过了当前 Leader 的最大日志序号，一般是已经 push 完最后一条消息，还没有新消息需要同步的场景</span>
            <span class="token comment">// 此时每秒都向 follower 同步一次 commitIndex，因为 commitIndex 可能会随着某些条目在多数节点复制完成后推进</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>writeIndex <span class="token operator">&gt;</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 单独发送 COMMIT 请求</span>
                <span class="token function">doCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 检查最老的日志 APPEND 的请求是否超时，如果超时，重新发送 APPEND 请求</span>
                <span class="token function">doCheckAppendResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 没有新的日志条目需要推送，跳出</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 检查挂起的 APPEND 请求数量是否超过阈值（1000）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> maxPendingSize <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerUtils</span><span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span>lastCheckLeakTimeMs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 获取 Follower 节点的水位线（成功 APPEND 的日志序号）</span>
                <span class="token keyword">long</span> peerWaterMark <span class="token operator">=</span> <span class="token function">getPeerWaterMark</span><span class="token punctuation">(</span>term<span class="token punctuation">,</span> peerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果挂起请求日志序号小于水位线，说明已经 APPEND 成功，丢弃该请求</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> index <span class="token operator">:</span> pendingMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> peerWaterMark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pendingMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 记录最新一次检查的时间戳</span>
                lastCheckLeakTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果挂起的 APPEND 请求数量大于阈值</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> maxPendingSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 检查最老的日志 APPEND 的请求是否超时，如果超时，重新发送 APPEND 请求，跳出</span>
                <span class="token function">doCheckAppendResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 将日志转发到 Follower，异步操作，不等待 Follower 响应</span>
            <span class="token function">doAppendInner</span><span class="token punctuation">(</span>writeIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 准备 APPEND 下一条日志</span>
            writeIndex<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 在发送 COMPARE 请求后，发现 Follower 数据存在差异
     * Leader 向 Follower 发送 TRUNCATE 请求，截断 Follower 的数据
     *
     * <span class="token keyword">@param</span> <span class="token parameter">truncateIndex</span> Follower 需要开始截断的日志序号
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doTruncate</span><span class="token punctuation">(</span><span class="token keyword">long</span> truncateIndex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">TRUNCATE</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DLedgerEntry</span> truncateEntry <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>truncateIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>truncateEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[Push-{}]Will push data to truncate truncateIndex={} pos={}&quot;</span><span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> truncateIndex<span class="token punctuation">,</span> truncateEntry<span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构造 TRUNCATE 请求，发送到 Follower，等待 Follower 响应</span>
        <span class="token class-name">PushEntryRequest</span> truncateRequest <span class="token operator">=</span> <span class="token function">buildPushRequest</span><span class="token punctuation">(</span>truncateEntry<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">TRUNCATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PushEntryResponse</span> truncateResponse <span class="token operator">=</span> dLedgerRpcService<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>truncateRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>truncateResponse <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">,</span> <span class="token string">&quot;truncateIndex=%d&quot;</span><span class="token punctuation">,</span> truncateIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>truncateResponse<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>truncateResponse<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;truncateIndex=%d&quot;</span><span class="token punctuation">,</span> truncateIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lastPushCommitTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Follower 清理完多余的数据，Leader 将状态变为 APPEND</span>
        <span class="token function">changeState</span><span class="token punctuation">(</span>truncateIndex<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">APPEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 改变日志转发器的状态
     *
     * <span class="token keyword">@param</span> <span class="token parameter">index</span> 已写入日志序号
     * <span class="token keyword">@param</span> <span class="token parameter">target</span> 要修改的目标状态
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">changeState</span><span class="token punctuation">(</span><span class="token keyword">long</span> index<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[Push-{}]Change state from {} to {} at {}&quot;</span><span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> type<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">APPEND</span><span class="token operator">:</span>
                <span class="token comment">// 重置 compareIndex 指针</span>
                compareIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment">// 更新当前节点已追加日志序号为 index</span>
                <span class="token function">updatePeerWaterMark</span><span class="token punctuation">(</span>term<span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 唤醒 ACK 仲裁线程，对 APPEND 结果进行仲裁</span>
                quorumAckChecker<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 更新待追加日志序号</span>
                writeIndex <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dLedgerConfig<span class="token punctuation">.</span><span class="token function">isEnableBatchPush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">resetBatchAppendEntryRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">COMPARE</span><span class="token operator">:</span>
                <span class="token comment">// 从 APPEND 切换到 COMPARE</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">APPEND</span><span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMPARE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 重置 compareIndex 指针为 -1</span>
                    compareIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token comment">// 清空挂起的日志转发请求</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dLedgerConfig<span class="token punctuation">.</span><span class="token function">isEnableBatchPush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        batchPendingMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        pendingMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">TRUNCATE</span><span class="token operator">:</span>
                <span class="token comment">// 重置 compareIndex 为 -1</span>
                compareIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 更新日志转发器状态</span>
        type<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 向 Follower 发送 COMPARE 请求
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doCompare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 无限循环</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 验证当前状态下是否可以发送 COMPARE 请求，不是 Leader 则跳出循环</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkAndFreshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 请求类型不是 COMPARE 或 TRUNCATE，跳出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMPARE</span>
                <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">TRUNCATE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// compareIndex 和 ledgerEndIndex 都为 -1，表示时新的集群，没有存储任何数据，无需比较主从数据是否一致，跳出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>compareIndex <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 重置 compareIndex，如果为 -1 或不在有效范围内，重置 compareIndex 为 Leader 当前存储的最大日志序号</span>
            <span class="token comment">//revise the compareIndex</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>compareIndex <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                compareIndex <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[Push-{}][DoCompare] compareIndex=-1 means start to compare&quot;</span><span class="token punctuation">,</span> peerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>compareIndex <span class="token operator">&gt;</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> compareIndex <span class="token operator">&lt;</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[Push-{}][DoCompare] compareIndex={} out of range {}-{}&quot;</span><span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> compareIndex<span class="token punctuation">,</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                compareIndex <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 根据待比较日志序号查询 Leader 日志</span>
            <span class="token class-name">DLedgerEntry</span> entry <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>compareIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;compareIndex=%d&quot;</span><span class="token punctuation">,</span> compareIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 构造 COMPARE 请求</span>
            <span class="token class-name">PushEntryRequest</span> request <span class="token operator">=</span> <span class="token function">buildPushRequest</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMPARE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 向 Follower 发起 COMPARE 请求</span>
            <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> responseFuture <span class="token operator">=</span> dLedgerRpcService<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 等待获取请求结果，默认超时时间为 3s</span>
            <span class="token class-name">PushEntryResponse</span> response <span class="token operator">=</span> responseFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;compareIndex=%d&quot;</span><span class="token punctuation">,</span> compareIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> response<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;compareIndex=%d&quot;</span><span class="token punctuation">,</span> compareIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Follower 需要开始截断的日志序号</span>
            <span class="token keyword">long</span> truncateIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token comment">// 根据 Follower 响应计算 truncateIndex（Follower 需要截断的日志序号，即多余的数据）</span>
            <span class="token comment">// 如果响应码为 SUCCESS，表示 compareIndex 对应的日志条目在 Follower 上存在</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                 * The comparison is successful:
                 * 1.Just change to append state, if the follower&#39;s end index is equal the compared index.
                 * 2.Truncate the follower, if the follower has some dirty entries.
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>compareIndex <span class="token operator">==</span> response<span class="token punctuation">.</span><span class="token function">getEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 如果 Leader 已经完成比较的日志序号与 Follower 存储的最大日志序号相同，无需截断，切换日志转发器状态为 APPEND</span>
                    <span class="token function">changeState</span><span class="token punctuation">(</span>compareIndex<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">APPEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 设置 truncateIndex 为 compareIndex，将向从节点发送 TRUNCATE</span>
                    truncateIndex <span class="token operator">=</span> compareIndex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> response<span class="token punctuation">.</span><span class="token function">getBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                 * Leader 和 Follower 日志不相交
                 * 设置 truncateIndex 为 Leader 目前最小的偏移量。
                 * 这就意味着会删除 Follower 的所有数据，然后从 truncateIndex 开始向从节点重新转发日志
                 * 这种情况通常发生在 Follower 崩溃很长一段时间，而 Leader 删除过期的日志时
                 */</span>
                <span class="token comment">/*
                 The follower&#39;s entries does not intersect with the leader.
                 This usually happened when the follower has crashed for a long time while the leader has deleted the expired entries.
                 Just truncate the follower.
                 */</span>
                truncateIndex <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>compareIndex <span class="token operator">&lt;</span> response<span class="token punctuation">.</span><span class="token function">getBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                 * Leader 的 compareIndex 小于 Follower 节点的起始日志序号，从 Leader 最小日志序号开始同步
                 */</span>
                <span class="token comment">/*
                 The compared index is smaller than the follower&#39;s begin index.
                 This happened rarely, usually means some disk damage.
                 Just truncate the follower.
                 */</span>
                truncateIndex <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>compareIndex <span class="token operator">&gt;</span> response<span class="token punctuation">.</span><span class="token function">getEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                 * Leader 的 compareIndex 大于 Follower 节点的最大日志序号
                 * 将 compareIndex 设置为 Follower 最大日志序号，继续发起 COMPARE 请求
                 */</span>
                <span class="token comment">/*
                 The compared index is bigger than the follower&#39;s end index.
                 This happened frequently. For the compared index is usually starting from the end index of the leader.
                 */</span>
                compareIndex <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">/*
                 * compareIndex 大于 Follower 节点的开始日志序号，但小于 最大日志序号
                 * 表示有相交，将 compareIndex 减 1，继续比较，直到找到需要截断的日志序号
                 */</span>
                <span class="token comment">/*
                  Compare failed and the compared index is in the range of follower&#39;s entries.
                 */</span>
                compareIndex<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// compareIndex 小于 Leader 的最小日志序号，将 truncateIndex 设置为 Leader 的最小日志序号</span>
            <span class="token comment">/*
             The compared index is smaller than the leader&#39;s begin index, truncate the follower.
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>compareIndex <span class="token operator">&lt;</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                truncateIndex <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/*
             * 如果 truncateIndex 不等于 -1，则日志转发器状态为 TRUNCATE，然后立即向 Follower 发送 TRUNCATE 请求
             */</span>
            <span class="token comment">/*
             If get value for truncateIndex, do it right now.
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>truncateIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">changeState</span><span class="token punctuation">(</span>truncateIndex<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">TRUNCATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">doTruncate</span><span class="token punctuation">(</span>truncateIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 线程主循环，不断循环执行该方法
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 检查节点状态，并更新日志转发器状态</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkAndFreshState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 根据日志转发器状态向 Follower 发送 APPEND 或 COMPARE 请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">APPEND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dLedgerConfig<span class="token punctuation">.</span><span class="token function">isEnableBatchPush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">doBatchAppend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">doAppend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">doCompare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DLedgerEntryPusher</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[Push-{}]Error in {} writeIndex={} compareIndex={}&quot;</span><span class="token punctuation">,</span> peerId<span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> writeIndex<span class="token punctuation">,</span> compareIndex<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">changeState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMPARE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DLedgerUtils</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-entryhandler-在-follower-接收-leader-推送的请求-存储日志" tabindex="-1"><a class="header-anchor" href="#_4-4-entryhandler-在-follower-接收-leader-推送的请求-存储日志" aria-hidden="true">#</a> 4.4 <code>EntryHandler</code> 在 Follower 接收 Leader 推送的请求，存储日志</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 数据接收处理线程，节点为 Follower 时激活
 */</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">EntryHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ShutdownAbleThread</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 上次检查 Leader 是否有推送消息的时间戳
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastCheckFastForwardTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * APPEND 请求处理队列
     */</span>
    <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryRequest</span><span class="token punctuation">,</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> writeRequestMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * COMMIT、COMPARE、TRUNCATE 请求处理队列
     */</span>
    <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryRequest</span><span class="token punctuation">,</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> compareOrTruncateRequests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryRequest</span><span class="token punctuation">,</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">EntryHandler</span><span class="token punctuation">(</span><span class="token class-name">Logger</span> logger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">&quot;EntryHandler-&quot;</span> <span class="token operator">+</span> memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Follower 收到 Leader 请求处理入口，将请求放入待处理队列
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">writeRequestMap</span></span><span class="token punctuation">}</span> 和 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">compareOrTruncateRequests</span></span><span class="token punctuation">}</span>，由 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> 方法从队列拉取任务进行处理
     *
     * <span class="token keyword">@param</span> <span class="token parameter">request</span> Leader 请求
     * <span class="token keyword">@return</span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">handlePush</span><span class="token punctuation">(</span><span class="token class-name">PushEntryRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//The timeout should smaller than the remoting layer&#39;s request timeout</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">APPEND</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">isBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getBatchEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNEXPECTED_ARGUMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNEXPECTED_ARGUMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">long</span> index <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getFirstEntryIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 放入 APPEND 请求处理队列</span>
                <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryRequest</span><span class="token punctuation">,</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> old <span class="token operator">=</span> writeRequestMap<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果该序号的日志条目已存在，返回 REPEATED_PUSH</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[MONITOR]The index {} has already existed with {} and curr is {}&quot;</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> old<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">baseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">baseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">REPEATED_PUSH</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">COMMIT</span><span class="token operator">:</span>
                <span class="token comment">// 放入处理队列</span>
                compareOrTruncateRequests<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">COMPARE</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">TRUNCATE</span><span class="token operator">:</span>
                <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNEXPECTED_ARGUMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将 APPEND 等待队列清空</span>
                writeRequestMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 放入处理队列</span>
                compareOrTruncateRequests<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[BUG]Unknown type {} from {}&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">baseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNEXPECTED_ARGUMENT</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">PushEntryResponse</span> <span class="token function">buildResponse</span><span class="token punctuation">(</span><span class="token class-name">PushEntryRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">int</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PushEntryResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PushEntryResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMMIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getFirstEntryIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        response<span class="token punctuation">.</span><span class="token function">setBeginIndex</span><span class="token punctuation">(</span>dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setEndIndex</span><span class="token punctuation">(</span>dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 处理 Leader 发来的 APPEND 请求
     *
     * <span class="token keyword">@param</span> <span class="token parameter">writeIndex</span>
     * <span class="token keyword">@param</span> <span class="token parameter">request</span>
     * <span class="token keyword">@param</span> <span class="token parameter">future</span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleDoAppend</span><span class="token punctuation">(</span><span class="token keyword">long</span> writeIndex<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest</span> request<span class="token punctuation">,</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>writeIndex <span class="token operator">==</span> request<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Follower 日志追加</span>
            <span class="token class-name">DLedgerEntry</span> entry <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">appendAsFollower</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getLeaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> writeIndex<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 使用 Leader 节点的已提交指针更新 Follower 节点的已提交指针</span>
            <span class="token function">updateCommittedIndex</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getCommitIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[HandleDoWrite] writeIndex={}&quot;</span><span class="token punctuation">,</span> writeIndex<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Follower 处理 Leader 发来的 COMPARE 请求
     * 判断 Leader 传来的日志序号在 Follower 是否存在
     *
     * <span class="token keyword">@param</span> <span class="token parameter">compareIndex</span> Leader 已经完成比较的日志序号
     * <span class="token keyword">@param</span> <span class="token parameter">request</span> LEADER 发来的 COMPARE 请求
     * <span class="token keyword">@param</span> <span class="token parameter">future</span>
     * <span class="token keyword">@return</span> 日志序号存在：SUCCESS，不存在：INCONSISTENT_STATE
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleDoCompare</span><span class="token punctuation">(</span><span class="token keyword">long</span> compareIndex<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest</span> request<span class="token punctuation">,</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>compareIndex <span class="token operator">==</span> request<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMPARE</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 从 Follower 中获取日志序号为 compareIndex 的日志条目</span>
            <span class="token class-name">DLedgerEntry</span> local <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>compareIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 检查日志条目是否存在</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 存在，构造返回体返回</span>
            future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 日志条目在 Follower 不存在</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[HandleDoCompare] compareIndex={}&quot;</span><span class="token punctuation">,</span> compareIndex<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Follower 处理 Leader 发来的 COMMIT 请求
     * <span class="token keyword">@param</span> <span class="token parameter">committedIndex</span> Leader 中已提交的日志序号
     * <span class="token keyword">@param</span> <span class="token parameter">request</span> COMMIT 请求
     * <span class="token keyword">@param</span> <span class="token parameter">future</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleDoCommit</span><span class="token punctuation">(</span><span class="token keyword">long</span> committedIndex<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest</span> request<span class="token punctuation">,</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>committedIndex <span class="token operator">==</span> request<span class="token punctuation">.</span><span class="token function">getCommitIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">COMMIT</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将 Leader 节点的轮次和已提交指针，更新到 Follower 节点</span>
            <span class="token function">updateCommittedIndex</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> committedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[HandleDoCommit] committedIndex={}&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getCommitIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 处理 Leader 发来的 TRUNCATE 请求
     * 删除节点上 truncateIndex 之后的所有日志
     *
     * <span class="token keyword">@param</span> <span class="token parameter">truncateIndex</span>
     * <span class="token keyword">@param</span> <span class="token parameter">request</span>
     * <span class="token keyword">@param</span> <span class="token parameter">future</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleDoTruncate</span><span class="token punctuation">(</span><span class="token keyword">long</span> truncateIndex<span class="token punctuation">,</span> <span class="token class-name">PushEntryRequest</span> request<span class="token punctuation">,</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[HandleDoTruncate] truncateIndex={} pos={}&quot;</span><span class="token punctuation">,</span> truncateIndex<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>truncateIndex <span class="token operator">==</span> request<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PushEntryRequest<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">TRUNCATE</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 删除节点上 truncateIndex 之后的所有日志文件，包含 truncateIndex 的文件会修改读写指针</span>
            <span class="token keyword">long</span> index <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">truncate</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getLeaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>index <span class="token operator">==</span> truncateIndex<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 使用 Leader 节点的已提交指针更新 Follower 节点的已提交指针</span>
            <span class="token function">updateCommittedIndex</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getCommitIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[HandleDoTruncate] truncateIndex={}&quot;</span><span class="token punctuation">,</span> truncateIndex<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 遍历所有挂起的 APPEND 请求进行检查
     * 1. 待 APPEND 的 index 小于 Follower 存储的最大日志序号：
     *   * 内容一致返回 SUCCESS，不一致 INCONSISTENT_STATE
     *   * 这种情况在 Leader 重复推送消息时出现
     * 2. 待 APPEND 的 index 等于 Follower 存储的最大日志序号：正常，直接返回
     * 3. 待 APPEND 的 index 大于 Follower 存储的最大日志序号：
     *   * 请求已超时则返回 INCONSISTENT_STATE，触发 Leader 发送 COMPARE 请求
     *   * 这种情况在 Follower 宕机重启后，其 ledgerEndIndex 可能比之前小。Leader 推送条目的序号可能超前于当前 Follower 的最大日志序号
     * <span class="token keyword">@param</span> <span class="token parameter">endIndex</span> Follower 存储的最大日志序号
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkAppendFuture</span><span class="token punctuation">(</span><span class="token keyword">long</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> minFastForwardIndex <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历所有挂起的 APPEND 请求</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryRequest</span><span class="token punctuation">,</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pair <span class="token operator">:</span> writeRequestMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Batch append 的头尾 index</span>
            <span class="token keyword">long</span> firstEntryIndex <span class="token operator">=</span> pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirstEntryIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> lastEntryIndex <span class="token operator">=</span> pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastEntryIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 待追加日志序号小于等于 Follower 存储的最大日志序号</span>
            <span class="token comment">//Fall behind</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastEntryIndex <span class="token operator">&lt;=</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 如果 Follower 存储的该条日志与 Leader 推送请求中的不一样，返回 INCONSISTENT_STATE</span>
                    <span class="token comment">// 表示从该日志序号开始，Leader 与 Follower 数据不一致，需要发送 COMPARE 和 TRUNCATE 请求修正数据</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerEntry</span> dLedgerEntry <span class="token operator">:</span> pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBatchEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>dLedgerEntry<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dLedgerStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dLedgerEntry<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token class-name">DLedgerEntry</span> dLedgerEntry <span class="token operator">=</span> pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>dLedgerEntry<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dLedgerStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dLedgerEntry<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// Follower 存储的该条日志内容与 Leader 推送的日志内容相同，说明从节点已经存储该条日志，返回 SUCCESS</span>
                    pair<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PushFallBehind]The leader pushed an batch append entry last index={} smaller than current ledgerEndIndex={}, maybe the last ack is missed&quot;</span><span class="token punctuation">,</span> lastEntryIndex<span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[PushFallBehind]The leader pushed an batch append entry last index={} smaller than current ledgerEndIndex={}, maybe the last ack is missed&quot;</span><span class="token punctuation">,</span> lastEntryIndex<span class="token punctuation">,</span> endIndex<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pair<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                writeRequestMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirstEntryIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 待追加日志序号等于 endIndex + 1，表示 Follower 下一条期望追加的日志已经被 Leader 推送过来，是正常情况，直接返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstEntryIndex <span class="token operator">==</span> endIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 处理待追加日志序号大于 endIndex + 1 的情况</span>
            <span class="token comment">// 挂起时间未超时，继续检查下一条待追加日志</span>
            <span class="token class-name">TimeoutFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> pair<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 快速失败机制</span>
            <span class="token comment">// 挂起时间超时，说明该日志没有正常写入 Follower。记录其日志序号，最终向主节点反馈最小的超时日志序号。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstEntryIndex <span class="token operator">&lt;</span> minFastForwardIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                minFastForwardIndex <span class="token operator">=</span> firstEntryIndex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>minFastForwardIndex <span class="token operator">==</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryRequest</span><span class="token punctuation">,</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pair <span class="token operator">=</span> writeRequestMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>minFastForwardIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pair <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果有记录超时的待追加日志序号，向 Leader 返回 INCONSISTENT_STATE，让主节点发送 COMPARE 进行数据比对，保证主从一致性</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PushFastForward] ledgerEndIndex={} entryIndex={}&quot;</span><span class="token punctuation">,</span> endIndex<span class="token punctuation">,</span> minFastForwardIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pair<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">buildResponse</span><span class="token punctuation">(</span>pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">INCONSISTENT_STATE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * Leader 确实会向 Follower 推送条目并记录已推送的索引。但在以下情况下，推送过程可能会停止：
     *   * 如果 Follower 异常关闭，它的 ledgerEndIndex 可能会比之前更小（丢失提交的日志）。此时，Leader 可能会推送 index 超前的条目，并不断重试。
     *   * 如果 Follower 最后的（ack）丢失，且没有新消息写入，Leader 可能会重试推送最后一条消息，但 Follower 会忽略它。
     * <span class="token keyword">@param</span> <span class="token parameter">endIndex</span> Follower 存储的最大日志序号
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkAbnormalFuture</span><span class="token punctuation">(</span><span class="token keyword">long</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 距离上一次异常检查不到 1s，直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerUtils</span><span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span>lastCheckFastForwardTimeMs<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        lastCheckFastForwardTimeMs  <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 没有积压的 APPEND 请求，Leader 没有推送新日志，直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>writeRequestMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">checkAppendFuture</span><span class="token punctuation">(</span>endIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 不是从节点，跳出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memberState<span class="token punctuation">.</span><span class="token function">isFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>compareOrTruncateRequests<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果 COMMIT、COMPARE、TRUNCATE 请求队列不为空，优先处理</span>
                <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryRequest</span><span class="token punctuation">,</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pair <span class="token operator">=</span> compareOrTruncateRequests<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">PreConditions</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>pair <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token constant">TRUNCATE</span><span class="token operator">:</span>
                        <span class="token function">handleDoTruncate</span><span class="token punctuation">(</span>pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pair<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token constant">COMPARE</span><span class="token operator">:</span>
                        <span class="token function">handleDoCompare</span><span class="token punctuation">(</span>pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pair<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token constant">COMMIT</span><span class="token operator">:</span>
                        <span class="token function">handleDoCommit</span><span class="token punctuation">(</span>pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pair<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 处理 APPEND 请求</span>
                <span class="token comment">// 下一条待写日志序号 = 已存储的最大日志序号 + 1</span>
                <span class="token keyword">long</span> nextIndex <span class="token operator">=</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment">// 根据序号获取 APPEND 请求</span>
                <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryRequest</span><span class="token punctuation">,</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">PushEntryResponse</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pair <span class="token operator">=</span> writeRequestMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pair <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 在待写队列中没有找到对应的 APPEND 请求，调用 checkAbnormalFuture 检查请求是否丢失</span>
                    <span class="token function">checkAbnormalFuture</span><span class="token punctuation">(</span>dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 能找到 APPEND 请求，处理请求</span>
                <span class="token class-name">PushEntryRequest</span> request <span class="token operator">=</span> pair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">isBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">handleDoBatchAppend</span><span class="token punctuation">(</span>nextIndex<span class="token punctuation">,</span> request<span class="token punctuation">,</span> pair<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">handleDoAppend</span><span class="token punctuation">(</span>nextIndex<span class="token punctuation">,</span> request<span class="token punctuation">,</span> pair<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DLedgerEntryPusher</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error in {}&quot;</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DLedgerUtils</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-leader-的-quorumackchecker-检查日志推送到-follower-的结果" tabindex="-1"><a class="header-anchor" href="#_4-5-leader-的-quorumackchecker-检查日志推送到-follower-的结果" aria-hidden="true">#</a> 4.5 Leader 的 <code>QuorumAckChecker</code> 检查日志推送到 Follower 的结果</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 日志追加 ACK 投票仲裁线程，Leader 节点激活
 * This thread will check the quorum index and complete the pending requests.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">QuorumAckChecker</span> <span class="token keyword">extends</span> <span class="token class-name">ShutdownAbleThread</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 上次打印水位线日志的时间戳，用于日志打印
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastPrintWatermarkTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 上次检测泄漏的时间戳
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastCheckLeakTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 已投票仲裁的日志序号
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastQuorumIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">QuorumAckChecker</span><span class="token punctuation">(</span><span class="token class-name">Logger</span> logger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">&quot;QuorumAckChecker-&quot;</span> <span class="token operator">+</span> memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 追加日志仲裁主逻辑循环
     * 不断根据当前 term 复制组中所有节点已保存的日志水位 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">peerWaterMarksByTerm</span></span><span class="token punctuation">}</span> 来进行仲裁，
     * 根据仲裁成功的日志 index，把对应的 APPEND 请求返回客户端
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 打印日志，如果距上次打印时间超过 3s，则输出当前状态日志</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerUtils</span><span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span>lastPrintWatermarkTimeMs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerEntryPusher</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>fsmCaller<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> lastAppliedIndex <span class="token operator">=</span> <span class="token class-name">DLedgerEntryPusher</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>fsmCaller<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastAppliedIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[{}][{}] term={} ledgerBegin={} ledgerEnd={} committed={} watermarks={} appliedIndex={}&quot;</span><span class="token punctuation">,</span>
                        memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">currTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getCommittedIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>peerWaterMarksByTerm<span class="token punctuation">)</span><span class="token punctuation">,</span> lastAppliedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[{}][{}] term={} ledgerBegin={} ledgerEnd={} committed={} watermarks={}&quot;</span><span class="token punctuation">,</span>
                        memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">currTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerBeginIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getCommittedIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>peerWaterMarksByTerm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                lastPrintWatermarkTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 不是 Leader，等 1ms（防止 CPU 空转），返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memberState<span class="token punctuation">.</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">long</span> currTerm <span class="token operator">=</span> memberState<span class="token punctuation">.</span><span class="token function">currTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkTermForPendingMap</span><span class="token punctuation">(</span>currTerm<span class="token punctuation">,</span> <span class="token string">&quot;QuorumAckChecker&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkTermForWaterMark</span><span class="token punctuation">(</span>currTerm<span class="token punctuation">,</span> <span class="token string">&quot;QuorumAckChecker&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 清除过期的（term 与当前不同）被挂起的 APPEND 请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingAppendResponsesByTerm<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> term <span class="token operator">:</span> pendingAppendResponsesByTerm<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>term <span class="token operator">==</span> currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 清除 term 与当前不同的挂起请求，向客户端返回错误码 TERM_CHANGED</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">AppendEntryResponse</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> futureEntry <span class="token operator">:</span> pendingAppendResponsesByTerm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">AppendEntryResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppendEntryResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        response<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        response<span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span>futureEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">DLedgerResponseCode</span><span class="token punctuation">.</span><span class="token constant">TERM_CHANGED</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        response<span class="token punctuation">.</span><span class="token function">setLeaderId</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getLeaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[TermChange] Will clear the pending response index={} for term changed from {} to {}&quot;</span><span class="token punctuation">,</span> futureEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> term<span class="token punctuation">,</span> currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        futureEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    pendingAppendResponsesByTerm<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 清除已过期的节点日志保存水位线，即投票 term 与当前 term 不同的水位线</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>peerWaterMarksByTerm<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> term <span class="token operator">:</span> peerWaterMarksByTerm<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>term <span class="token operator">==</span> currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 清除投票轮次与当前轮次不同的水位线（复制组中每个节点当前存储的最大日志序列号），避免内存泄漏</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[TermChange] Will clear the watermarks for term changed from {} to {}&quot;</span><span class="token punctuation">,</span> term<span class="token punctuation">,</span> currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    peerWaterMarksByTerm<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 追加日志仲裁</span>
            <span class="token comment">// 获取当前 term 节点已经保存的日志表</span>
            <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span> <span class="token comment">/* 节点编号 */</span><span class="token punctuation">,</span> <span class="token class-name">Long</span> <span class="token comment">/*日志序号*/</span><span class="token operator">&gt;</span> peerWaterMarks <span class="token operator">=</span> peerWaterMarksByTerm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 按已经保存的日志序号大小降序排序</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> sortedWaterMarks <span class="token operator">=</span> peerWaterMarks<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">reverseOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取日志表中间的日志序号，即为完成仲裁的日志序号（超过半数大于它）</span>
            <span class="token keyword">long</span> quorumIndex <span class="token operator">=</span> sortedWaterMarks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sortedWaterMarks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StateMachineCaller</span><span class="token punctuation">&gt;</span></span> fsmCaller <span class="token operator">=</span> <span class="token class-name">DLedgerEntryPusher</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>fsmCaller<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fsmCaller<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// If there exist statemachine</span>
                <span class="token class-name">DLedgerEntryPusher</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>dLedgerStore<span class="token punctuation">.</span><span class="token function">updateCommittedIndex</span><span class="token punctuation">(</span>currTerm<span class="token punctuation">,</span> quorumIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">StateMachineCaller</span> caller <span class="token operator">=</span> fsmCaller<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                caller<span class="token punctuation">.</span><span class="token function">onCommitted</span><span class="token punctuation">(</span>quorumIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Check elapsed</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerUtils</span><span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span>lastCheckLeakTimeMs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">updatePeerWaterMark</span><span class="token punctuation">(</span>currTerm<span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">checkResponseFuturesElapsed</span><span class="token punctuation">(</span>caller<span class="token punctuation">.</span><span class="token function">getLastAppliedIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    lastCheckLeakTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>quorumIndex <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastQuorumIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 更新 committedIndex 索引（已提交的日志序号），方便 DLedgerStore 定时将 committedIndex 写入 checkPoint</span>
                dLedgerStore<span class="token punctuation">.</span><span class="token function">updateCommittedIndex</span><span class="token punctuation">(</span>currTerm<span class="token punctuation">,</span> quorumIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 处理 quorumIndex（已提交指针）之前的挂起等待 handleAppend 的 future 完成的 Dledger 客户端追加日志请求，返回成功</span>
                <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">AppendEntryResponse</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> responses <span class="token operator">=</span> pendingAppendResponsesByTerm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> needCheck <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> ackNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment">// 从 quorumIndex （已提交指针）开始倒序遍历</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> i <span class="token operator">=</span> quorumIndex<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> lastQuorumIndex<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 移除对应的挂起请求</span>
                        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AppendEntryResponse</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> responses<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>future <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// 如果未找到对应挂起的请求，说明前面挂起的请求已经全部处理完毕，结束遍历。</span>
                            <span class="token comment">// 标记需要进行泄漏检测</span>
                            needCheck <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// 找到对应的挂起请求，向客户端返回写入成功</span>
                            <span class="token class-name">AppendEntryResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppendEntryResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            response<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            response<span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            response<span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            response<span class="token punctuation">.</span><span class="token function">setLeaderId</span><span class="token punctuation">(</span>memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            response<span class="token punctuation">.</span><span class="token function">setPos</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AppendFuture</span><span class="token punctuation">)</span> future<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// 向客户端返回响应结果</span>
                            future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// ackNum + 1，表示本次仲裁向客户端返回响应结果的数量</span>
                        ackNum<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error in ack to index={} term={}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> currTerm<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 如果本次仲裁没有日志被成功追加，检查被挂起的追加请求</span>
                <span class="token comment">// 判断其大于 quorumIndex 日志序号的 APPEND 请求是否超时，如果超时，向客户端返回 WAIT_QUORUM_ACK_TIMEOUT</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ackNum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">checkResponseFuturesTimeout</span><span class="token punctuation">(</span>quorumIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DLedgerUtils</span><span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span>lastCheckLeakTimeMs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1000</span> <span class="token operator">||</span> needCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 检查挂起的日志追加请求是否泄漏</span>
                    <span class="token function">updatePeerWaterMark</span><span class="token punctuation">(</span>currTerm<span class="token punctuation">,</span> memberState<span class="token punctuation">.</span><span class="token function">getSelfId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dLedgerStore<span class="token punctuation">.</span><span class="token function">getLedgerEndIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 遍历已挂起的请求，如果日志序号已经仲裁成功，则向客户端返回成功</span>
                    <span class="token function">checkResponseFuturesElapsed</span><span class="token punctuation">(</span>quorumIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    lastCheckLeakTimeMs <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 更新上次仲裁成功的日志序号</span>
            lastQuorumIndex <span class="token operator">=</span> quorumIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DLedgerEntryPusher</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error in {}&quot;</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DLedgerUtils</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2>`,30),m=n("li",null,"RocketMQ 技术内幕 第2版",-1),v={href:"http://thesecretlivesofdata.com/raft/",target:"_blank",rel:"noopener noreferrer"},b=n("hr",null,null,-1),g=n("p",null,"欢迎关注公众号【消息中间件】（middleware-mq），更新消息中间件的源码解析和最新动态！",-1),f=n("figure",null,[n("img",{src:"https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202205170102971.jpg",alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),y=n("hr",{class:"footnotes-sep"},null,-1),w={class:"footnotes"},h={class:"footnotes-list"},E={id:"footnote1",class:"footnote-item"},L={href:"https://github.com/apache/rocketmq/issues/2278",target:"_blank",rel:"noopener noreferrer"},x=n("a",{href:"#footnote-ref1",class:"footnote-backref"},"↩︎",-1);function I(P,C){const t=p("ExternalLinkIcon"),o=p("Mermaid");return l(),u("div",null,[n("p",null,[s("原文地址："),n("a",k,[s("http://hscarb.github.io/rocketmq/20250315-rocketmq-dledger-log-replication.html"),a(t)])]),r,a(o,{id:"mermaid-328",code:"eJwrLkksSXXJTEwvSszVLTPiUgACZ3/fAMcgVwVdXTuFkKBQP2fHEFewBIwDlnEMCHD1cwGLQ5hgUaBeX88QmDFAJn61IHu4AMrIH+w="}),d,n("ul",null,[m,n("li",null,[n("a",v,[s("The Secret Lives of Data - Raft"),a(t)])])]),b,g,f,y,n("section",w,[n("ol",h,[n("li",E,[n("p",null,[n("a",L,[s("https://github.com/apache/rocketmq/issues/2278"),a(t)]),s(),x])])])])])}const A=c(i,[["render",I],["__file","20250315-rocketmq-dledger-log-replication.html.vue"]]);export{A as default};
