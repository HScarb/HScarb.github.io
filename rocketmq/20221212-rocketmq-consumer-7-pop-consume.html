<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.66" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html"><meta property="og:site_name" content="é‡‘ç”²è™«çš„åšå®¢"><meta property="og:title" content="RocketMQ 5.0ï¼šPOP æ¶ˆè´¹æ¨¡å¼ åŸç†è¯¦è§£ & æºç è§£æ"><meta property="og:description" content="åŸæ–‡åœ°å€ï¼šhttp://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html (http://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html) 1. èƒŒæ™¯ 1.1 ä»€ä¹ˆ..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-07-17T16:05:07.000Z"><meta property="article:author" content="Scarb"><meta property="article:published_time" content="2022-12-12T00:00:00.000Z"><meta property="article:modified_time" content="2023-07-17T16:05:07.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"RocketMQ 5.0ï¼šPOP æ¶ˆè´¹æ¨¡å¼ åŸç†è¯¦è§£ & æºç è§£æ","image":[""],"datePublished":"2022-12-12T00:00:00.000Z","dateModified":"2023-07-17T16:05:07.000Z","author":[{"@type":"Person","name":"Scarb"}]}</script><title>RocketMQ 5.0ï¼šPOP æ¶ˆè´¹æ¨¡å¼ åŸç†è¯¦è§£ & æºç è§£æ | é‡‘ç”²è™«çš„åšå®¢</title><meta name="description" content="åŸæ–‡åœ°å€ï¼šhttp://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html (http://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html) 1. èƒŒæ™¯ 1.1 ä»€ä¹ˆ...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-e6f2d601.css" as="style"><link rel="stylesheet" href="/assets/style-e6f2d601.css">
    <link rel="modulepreload" href="/assets/app-630f6f47.js"><link rel="modulepreload" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-650cf515.js"><link rel="modulepreload" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-b82b2c0c.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/index.html-102bf403.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-6f333d07.js" as="script"><link rel="prefetch" href="/assets/20230530-lxf-java-note.html-9300be95.js" as="script"><link rel="prefetch" href="/assets/20230815-mockito-note.html-c2258399.js" as="script"><link rel="prefetch" href="/assets/20240827-reactor-java.html-fe9c28ac.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-cac7204c.js" as="script"><link rel="prefetch" href="/assets/index.html-f508c123.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-d3e5eb48.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-7a801a5e.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-51122c83.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-0922cff0.js" as="script"><link rel="prefetch" href="/assets/20230813-lxf-js-note.html-82465167.js" as="script"><link rel="prefetch" href="/assets/20230820-powerjob.html-b9352ef3.js" as="script"><link rel="prefetch" href="/assets/20231015-consistent-hash.html-07b06be4.js" as="script"><link rel="prefetch" href="/assets/20241216-wow-restoration-druid-mythic-guide.html-d5f7518b.js" as="script"><link rel="prefetch" href="/assets/99991231-ryf-ts-note.html-730cf657.js" as="script"><link rel="prefetch" href="/assets/index.html-d5fdda96.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-5756ebfa.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-59cfb351.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-7fe5f428.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-9de184dd.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-bb235715.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-e29ec945.js" as="script"><link rel="prefetch" href="/assets/20231016-rabbitmq-consistent-hash-exchange.html-6e2e8f6d.js" as="script"><link rel="prefetch" href="/assets/index.html-8e2b67a8.js" as="script"><link rel="prefetch" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-90c27f1b.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-2023d209.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-5de0a873.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-ae13da53.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-1ec85a19.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-e7fef9e4.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-b65d2e82.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-591b00dc.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-00247a89.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-7e15b5f8.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-b701d200.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-f9dc2d19.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-873655ea.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-7b285f6b.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-5f11b114.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-da9eb2ad.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-63ba6675.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-f3b1dd76.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-33d17a44.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-4da4a69a.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-7510810a.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-071340e5.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-f07feea0.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-ff9830f7.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-26409d59.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-53d9ae69.js" as="script"><link rel="prefetch" href="/assets/20230808-rocketmq-timer.html-ee37a256.js" as="script"><link rel="prefetch" href="/assets/20240429-rocketmq-tieredstore.html-7d2652e2.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-ddc41950.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-f220a3ec.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-79144a64.js" as="script"><link rel="prefetch" href="/assets/index.html-2ed02595.js" as="script"><link rel="prefetch" href="/assets/404.html-8b9ee051.js" as="script"><link rel="prefetch" href="/assets/index.html-e1c6ee3c.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-19248d22.js" as="script"><link rel="prefetch" href="/assets/20230530-lxf-java-note.html-2b75b0ee.js" as="script"><link rel="prefetch" href="/assets/20230815-mockito-note.html-e7de5174.js" as="script"><link rel="prefetch" href="/assets/20240827-reactor-java.html-1eedd69c.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-e7d8f4cc.js" as="script"><link rel="prefetch" href="/assets/index.html-cda136f9.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-8f9500df.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-1cfa6f68.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-2a219dba.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-055f0154.js" as="script"><link rel="prefetch" href="/assets/20230813-lxf-js-note.html-aae86cce.js" as="script"><link rel="prefetch" href="/assets/20230820-powerjob.html-6a9387b8.js" as="script"><link rel="prefetch" href="/assets/20231015-consistent-hash.html-8e24142a.js" as="script"><link rel="prefetch" href="/assets/20241216-wow-restoration-druid-mythic-guide.html-0a50ff27.js" as="script"><link rel="prefetch" href="/assets/99991231-ryf-ts-note.html-490f4aa7.js" as="script"><link rel="prefetch" href="/assets/index.html-78277e91.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-0cb34f24.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-22a7e3ce.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-20d6e6c3.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-7ca1e5ba.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-e10cb022.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-fdb19c41.js" as="script"><link rel="prefetch" href="/assets/20231016-rabbitmq-consistent-hash-exchange.html-e923fe95.js" as="script"><link rel="prefetch" href="/assets/index.html-c28b463d.js" as="script"><link rel="prefetch" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-c8b621af.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-4f0ec78b.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-c3709dd5.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-2157e721.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-adb95d3c.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-5cc9d6f9.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-eee528a3.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-9896732e.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-71285138.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-35c76e81.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-e2f9f9e8.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-ed3d30e2.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-cf91eb00.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-d7d8a13a.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-5c973817.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-7b26c2ff.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-333f2451.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-3394727d.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-9d150260.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-9f68e8ba.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-52b334de.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-a5651372.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-36fb4fd1.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-723d56a5.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-1f39991a.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-2499a5bf.js" as="script"><link rel="prefetch" href="/assets/20230808-rocketmq-timer.html-a9dac3ff.js" as="script"><link rel="prefetch" href="/assets/20240429-rocketmq-tieredstore.html-5df2cd33.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-a5fbf8ce.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-3e140626.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-e3d6cd22.js" as="script"><link rel="prefetch" href="/assets/index.html-ac0eb2e9.js" as="script"><link rel="prefetch" href="/assets/404.html-20feaed4.js" as="script"><link rel="prefetch" href="/assets/giscus-0b7adcf8.js" as="script"><link rel="prefetch" href="/assets/auto-712ff3ee.js" as="script"><link rel="prefetch" href="/assets/index-2bf332f6.js" as="script"><link rel="prefetch" href="/assets/flowchart-c441f34d.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-aed0bc3b.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-abe06b83.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-ae79352e.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-5794cde2.js" as="script"><link rel="prefetch" href="/assets/SearchResult-a878c08d.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><img class="vp-nav-logo" src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/scarb/scarb.jpg" alt="é‡‘ç”²è™«çš„åšå®¢"><!----><span class="vp-site-name hide-in-pad">é‡‘ç”²è™«çš„åšå®¢</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/"><!---->Home<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link active" href="/rocketmq/"><!---->RocketMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/rabbitmq/"><!---->RabbitMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/java/"><!---->Java<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/other/"><!---->Other<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Follow Me"><span class="title"><!---->Follow Me</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="https://github.com/HScarb" rel="noopener noreferrer" target="_blank" aria-label="Github" class="nav-link"><!---->Github<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://juejin.cn/user/219558057345111/posts" rel="noopener noreferrer" target="_blank" aria-label="æ˜é‡‘" class="nav-link"><!---->æ˜é‡‘<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/HScarb/knowledge" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->RocketMQ 5.0ï¼šPOP æ¶ˆè´¹æ¨¡å¼ åŸç†è¯¦è§£ &amp; æºç è§£æ</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Scarb</span></span><span property="author" content="Scarb"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-12-12T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 28 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT28M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_1-èƒŒæ™¯">1. èƒŒæ™¯</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_1-1-ä»€ä¹ˆæ˜¯-pop-æ¶ˆè´¹">1.1 ä»€ä¹ˆæ˜¯ Pop æ¶ˆè´¹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_1-2-å¦‚ä½•ä½¿ç”¨-pop-æ¶ˆè´¹">1.2 å¦‚ä½•ä½¿ç”¨ Pop æ¶ˆè´¹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_1-3-å¼•å…¥-pop-æ¶ˆè´¹æ¨¡å¼çš„åŸå› ">1.3 å¼•å…¥ Pop æ¶ˆè´¹æ¨¡å¼çš„åŸå› </a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_2-æ¦‚è¦è®¾è®¡">2. æ¦‚è¦è®¾è®¡</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-1-pop-æ¶ˆè´¹æµç¨‹">2.1 Pop æ¶ˆè´¹æµç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-2-å®¢æˆ·ç«¯-æœåŠ¡ç«¯äº¤äº’">2.2 å®¢æˆ·ç«¯-æœåŠ¡ç«¯äº¤äº’</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-3-æœåŠ¡ç«¯å®ç°">2.3 æœåŠ¡ç«¯å®ç°</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_3-è¯¦ç»†è®¾è®¡">3. è¯¦ç»†è®¾è®¡</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-1-broker-ç«¯é‡å¹³è¡¡">3.1 Broker ç«¯é‡å¹³è¡¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-2-broker-ç«¯-pop-æ¶ˆæ¯">3.2 Broker ç«¯ Pop æ¶ˆæ¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-3-broker-ç«¯-ack-æ¶ˆæ¯">3.3 Broker ç«¯ ACK æ¶ˆæ¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-4-broker-ç«¯-checkpoint-ä¸-ackmsg-åŒ¹é…">3.4 Broker ç«¯ CheckPoint ä¸ AckMsg åŒ¹é…</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_4-æºç è§£æ">4. æºç è§£æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-1-broker-ç«¯é‡å¹³è¡¡">4.1 Broker ç«¯é‡å¹³è¡¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-2-broker-ç«¯-pop-æ¶ˆæ¯">4.2 Broker ç«¯ Pop æ¶ˆæ¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-3-broker-ç«¯-ack-æ¶ˆæ¯">4.3 Broker ç«¯ Ack æ¶ˆæ¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-4-broker-ç«¯-checkpoint-ä¸-ackmsg-åŒ¹é…">4.4 Broker ç«¯ CheckPoint ä¸ AckMsg åŒ¹é…</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>åŸæ–‡åœ°å€ï¼š<a href="http://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html" target="_blank" rel="noopener noreferrer">http://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h1 id="rocketmq-5-0-pop-æ¶ˆè´¹æ¨¡å¼-åŸç†è¯¦è§£-æºç è§£æ" tabindex="-1"><a class="header-anchor" href="#rocketmq-5-0-pop-æ¶ˆè´¹æ¨¡å¼-åŸç†è¯¦è§£-æºç è§£æ" aria-hidden="true">#</a> RocketMQ 5.0ï¼šPOP æ¶ˆè´¹æ¨¡å¼ åŸç†è¯¦è§£ &amp; æºç è§£æ</h1><h2 id="_1-èƒŒæ™¯" tabindex="-1"><a class="header-anchor" href="#_1-èƒŒæ™¯" aria-hidden="true">#</a> 1. èƒŒæ™¯</h2><h3 id="_1-1-ä»€ä¹ˆæ˜¯-pop-æ¶ˆè´¹" tabindex="-1"><a class="header-anchor" href="#_1-1-ä»€ä¹ˆæ˜¯-pop-æ¶ˆè´¹" aria-hidden="true">#</a> 1.1 ä»€ä¹ˆæ˜¯ Pop æ¶ˆè´¹</h3><p>RocketMQ 5.0 ä¸­å¼•å…¥äº†ä¸€ç§æ–°çš„æ¶ˆè´¹æ¨¡å¼ï¼šPop æ¶ˆè´¹æ¨¡å¼ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ RocketMQ åŸæ¥æœ‰ä¸¤ç§æ¶ˆè´¹æ¨¡å¼ï¼šPull æ¨¡å¼æ¶ˆè´¹å’Œ Push æ¨¡å¼æ¶ˆè´¹ï¼Œå…¶ä¸­ Push æ¨¡å¼æŒ‡çš„æ˜¯ Broker å°†æ¶ˆæ¯ä¸»åŠ¨â€œæ¨é€â€ç»™æ¶ˆè´¹è€…ï¼Œå®ƒçš„èƒŒåå…¶å®æ˜¯æ¶ˆè´¹è€…åœ¨ä¸æ–­åœ° Pull æ¶ˆæ¯æ¥å®ç°ç±»ä¼¼äº Broker â€œæ¨â€æ¶ˆæ¯ç»™æ¶ˆè´¹è€…çš„æ•ˆæœã€‚</p><p>æ–°å¼•å…¥çš„ Pop æ¶ˆè´¹æ¨¡å¼ä¸»è¦æ˜¯ç”¨äº Push æ¶ˆè´¹æ—¶å°†æ‹‰æ¶ˆæ¯çš„åŠ¨ä½œæ›¿æ¢æˆ Pop ã€‚Pop æ¶ˆè´¹çš„è¡Œä¸ºå’Œ Pull æ¶ˆè´¹å¾ˆåƒï¼ŒåŒºåˆ«åœ¨äº Pop æ¶ˆè´¹çš„é‡å¹³è¡¡æ˜¯åœ¨ Broker ç«¯åšçš„ï¼Œè€Œä¹‹å‰çš„ Pull å’Œ Push æ¶ˆè´¹éƒ½æ˜¯ç”±å®¢æˆ·ç«¯å®Œæˆé‡å¹³è¡¡ã€‚</p><h3 id="_1-2-å¦‚ä½•ä½¿ç”¨-pop-æ¶ˆè´¹" tabindex="-1"><a class="header-anchor" href="#_1-2-å¦‚ä½•ä½¿ç”¨-pop-æ¶ˆè´¹" aria-hidden="true">#</a> 1.2 å¦‚ä½•ä½¿ç”¨ Pop æ¶ˆè´¹</h3><p>RocketMQ æä¾›äº† 2 ç§æ–¹å¼ï¼Œèƒ½å¤Ÿè®© Push æ¶ˆè´¹åˆ‡æ¢ä¸ºä½¿ç”¨ Pop æ¨¡å¼æ‹‰å–æ¶ˆæ¯ï¼ˆPull æ¶ˆè´¹æš‚ä¸æ”¯æŒåˆ‡æ¢ Pop æ¨¡å¼ï¼‰ï¼Œåˆ†åˆ«ä¸ºå‘½ä»¤è¡Œæ–¹å¼åˆ‡æ¢å’Œå®¢æˆ·ç«¯ä»£ç æ–¹å¼åˆ‡æ¢ã€‚</p><h4 id="_1-2-1-ä½¿ç”¨å‘½ä»¤è¡Œæ–¹å¼åˆ‡æ¢" tabindex="-1"><a class="header-anchor" href="#_1-2-1-ä½¿ç”¨å‘½ä»¤è¡Œæ–¹å¼åˆ‡æ¢" aria-hidden="true">#</a> 1.2.1 ä½¿ç”¨å‘½ä»¤è¡Œæ–¹å¼åˆ‡æ¢</h4><p>åˆ©ç”¨å‘½ä»¤è¡Œï¼Œç”¨å¦‚ä¸‹å‘½ä»¤ï¼ŒæŒ‡å®šé›†ç¾¤å’Œéœ€è¦åˆ‡æ¢çš„æ¶ˆè´¹ç»„ï¼Œå¯ä»¥å°†ä¸€ä¸ªæ¶ˆè´¹ç»„åˆ‡æ¢æˆ Pop æ¶ˆè´¹æ¨¡å¼æ¶ˆè´¹æŸä¸ª Topic</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mqadmin setConsumeMode <span class="token parameter variable">-c</span> cluster <span class="token parameter variable">-t</span> topic <span class="token parameter variable">-g</span> group <span class="token parameter variable">-m</span> POP <span class="token parameter variable">-q</span> <span class="token number">8</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä»¥ä¸‹ä¸ºå‚æ•°å«ä¹‰ï¼Œå…¶ä¸­ <code>popShareQueueNum</code> è¡¨ç¤º 1 ä¸ªé˜Ÿåˆ—æœ€å¤šå¯ä»¥è¢« N ä¸ªæ¶ˆè´¹è€…åŒæ—¶æ¶ˆè´¹ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>opt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;clusterName&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;create subscription group to which cluster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
opt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token string">&quot;t&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;topicName&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;topic name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
opt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token string">&quot;g&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;groupName&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;consumer group name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
opt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token string">&quot;m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mode&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;consume mode. PULL/POP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
opt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token string">&quot;q&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;popShareQueueNum&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;num of queue which share in pop mode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-2-ä»£ç åˆ‡æ¢" tabindex="-1"><a class="header-anchor" href="#_1-2-2-ä»£ç åˆ‡æ¢" aria-hidden="true">#</a> 1.2.2 ä»£ç åˆ‡æ¢</h4><p>åœ¨åˆ›å»º Consumer ä¹‹å‰ï¼Œå…ˆè¿è¡Œ <code>switchPop()</code> æ–¹æ³•ï¼Œå®ƒå…¶å®ä¸ä¸Šé¢å‘½ä»¤è¡Œçš„é€»è¾‘ä¸€æ ·ï¼Œä¹Ÿæ˜¯å‘é€è¯·æ±‚ç»™é›†ç¾¤ä¸­çš„æ‰€æœ‰ Broker èŠ‚ç‚¹ï¼Œè®©å®ƒä»¬åˆ‡æ¢å¯¹åº”æ¶ˆè´¹è€…ç»„å’Œ Topic çš„æ¶ˆè´¹è€…çš„æ¶ˆè´¹æ¨¡å¼ä¸º Pop æ¨¡å¼ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// PopPushConsumer.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PopPushConsumer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONSUMER_GROUP</span> <span class="token operator">=</span> <span class="token string">&quot;CID_JODIE_1&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC</span> <span class="token operator">=</span> <span class="token string">&quot;TopicTest&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// Or use AdminTools directly: mqadmin setConsumeMode -c cluster -t topic -g group -m POP -n 8</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">switchPop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">DefaultMQAdminExt</span> mqAdminExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQAdminExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mqAdminExt<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ClusterInfo</span> clusterInfo <span class="token operator">=</span> mqAdminExt<span class="token punctuation">.</span><span class="token function">examineBrokerClusterInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> brokerAddrs <span class="token operator">=</span> clusterInfo<span class="token punctuation">.</span><span class="token function">getBrokerAddrTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">BrokerData</span><span class="token operator">::</span><span class="token function">selectBrokerAddr</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> brokerAddr <span class="token operator">:</span> brokerAddrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mqAdminExt<span class="token punctuation">.</span><span class="token function">setMessageRequestMode</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> <span class="token constant">TOPIC</span><span class="token punctuation">,</span> <span class="token constant">CONSUMER_GROUP</span><span class="token punctuation">,</span> <span class="token class-name">MessageRequestMode</span><span class="token punctuation">.</span><span class="token constant">POP</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token function">switchPop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token constant">CONSUMER_GROUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span><span class="token constant">CONSUME_FROM_LAST_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s Receive New Messages: %s %n&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setClientRebalance</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer Started.%n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3-å¼•å…¥-pop-æ¶ˆè´¹æ¨¡å¼çš„åŸå› " tabindex="-1"><a class="header-anchor" href="#_1-3-å¼•å…¥-pop-æ¶ˆè´¹æ¨¡å¼çš„åŸå› " aria-hidden="true">#</a> 1.3 å¼•å…¥ Pop æ¶ˆè´¹æ¨¡å¼çš„åŸå› </h3><p>å¼•å…¥ Pop æ¶ˆè´¹ä¸»è¦çš„åŸå› æ˜¯ç”±äº Push æ¶ˆè´¹çš„æœºåˆ¶å¯¼è‡´å®ƒå­˜åœ¨ä¸€äº›ç—›ç‚¹ã€‚RocketMQ 5.0 äº‘åŸç”ŸåŒ–çš„è¦æ±‚å‚¬ç”Ÿç€ä¸€ç§èƒ½å¤Ÿè§£å†³è¿™äº›ç—›ç‚¹çš„æ–°æ¶ˆè´¹æ¨¡å¼è¯ç”Ÿã€‚</p><p>Push æ¶ˆè´¹æ¨¡å¼çš„é‡å¹³è¡¡é€»è¾‘æ˜¯åœ¨å®¢æˆ·ç«¯å®Œæˆçš„ï¼Œè¿™å°±å¯¼è‡´äº†å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>å®¢æˆ·ç«¯ä»£ç é€»è¾‘è¾ƒé‡ï¼Œè¦æ”¯æŒä¸€ç§æ–°è¯­è¨€çš„å®¢æˆ·ç«¯å°±å¿…é¡»å®ç°å®Œæ•´çš„é‡å¹³è¡¡é€»è¾‘ï¼Œæ­¤å¤–è¿˜éœ€è¦å®ç°æ‹‰æ¶ˆæ¯ã€ä½ç‚¹ç®¡ç†ã€æ¶ˆè´¹å¤±è´¥åå°†æ¶ˆæ¯å‘å› Broker é‡è¯•ç­‰é€»è¾‘ã€‚è¿™ç»™å¤šè¯­è¨€å®¢æˆ·ç«¯çš„æ”¯æŒé€ æˆå¾ˆå¤§çš„é˜»ç¢ã€‚</li><li>å½“å®¢æˆ·ç«¯å‡çº§æˆ–è€…ä¸‹çº¿æ—¶ï¼Œéƒ½è¦è¿›è¡Œé‡å¹³è¡¡æ“ä½œï¼Œå¯èƒ½é€ æˆæ¶ˆæ¯å †ç§¯ã€‚</li></ol><p>æ­¤å¤–ï¼ŒPush æ¶ˆè´¹çš„ç‰¹æ€§æ˜¯é‡å¹³è¡¡åæ¯ä¸ªæ¶ˆè´¹è€…éƒ½åˆ†é…åˆ°æ¶ˆè´¹ä¸€å®šæ•°é‡çš„é˜Ÿåˆ—ï¼Œè€Œæ¯ä¸ªé˜Ÿåˆ—æœ€å¤šåªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚è¿™å°±å†³å®šäº†æ¶ˆè´¹è€…çš„æ¨ªå‘æ‰©å±•èƒ½åŠ›å—åˆ° Topic ä¸­é˜Ÿåˆ—æ•°é‡çš„é™åˆ¶ã€‚è¿™é‡Œæœ‰å¼•å…¥äº†å¦‚ä¸‹ç—›ç‚¹</p><ol><li>æ¶ˆè´¹è€…æ— æ³•æ— é™æ‰©å±•ï¼Œå½“æ¶ˆè´¹è€…æ•°é‡æ‰©å¤§åˆ°å¤§äºé˜Ÿåˆ—æ•°é‡æ—¶ï¼Œæœ‰çš„æ¶ˆè´¹è€…å°†æ— æ³•åˆ†é…åˆ°é˜Ÿåˆ—ã€‚</li><li>å½“æŸäº›æ¶ˆè´¹è€…åƒµæ­»ï¼ˆhang ä½ï¼‰æ—¶ï¼ˆä¸ Broker çš„å¿ƒè·³æœªæ–­ï¼Œä½†æ˜¯æ— æ³•æ¶ˆè´¹æ¶ˆæ¯ï¼‰ï¼Œä¼šé€ æˆå…¶æ¶ˆè´¹çš„é˜Ÿåˆ—çš„æ¶ˆæ¯å †ç§¯ï¼Œè¿Ÿè¿Ÿæ— æ³•è¢«æ¶ˆè´¹ï¼Œä¹Ÿä¸ä¼šä¸»åŠ¨é‡å¹³è¡¡æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</li></ol><hr><p>å¼•å…¥ Pop æ¶ˆè´¹æ¨¡å¼ä¹‹åï¼Œå¯ä»¥è§£å†³ Push æ¶ˆè´¹å¯¼è‡´çš„å¯èƒ½çš„æ¶ˆæ¯å †ç§¯é—®é¢˜å’Œæ¨ªå‘æ‰©å±•èƒ½åŠ›é—®é¢˜ã€‚æ­¤å¤–ï¼ŒRocketMQ 5.0 ä¸­å¼•å…¥äº†çš„è½»é‡åŒ–å®¢æˆ·ç«¯å°±ç”¨åˆ°äº† Pop æ¶ˆè´¹èƒ½åŠ›ï¼Œå°† Pop æ¶ˆè´¹æ¥å£ç”¨ gRPC å°è£…ï¼Œå®ç°äº†å¤šè¯­è¨€è½»é‡åŒ–å®¢æˆ·ç«¯ï¼Œè€Œä¸å¿…åœ¨å®¢æˆ·ç«¯å®ç°é‡å¹³è¡¡é€»è¾‘ã€‚è¯¦è§è¯¥é¡¹ç›® <a href="https://github.com/apache/rocketmq-clients" target="_blank" rel="noopener noreferrer">rocketmq-clients<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</p><h2 id="_2-æ¦‚è¦è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#_2-æ¦‚è¦è®¾è®¡" aria-hidden="true">#</a> 2. æ¦‚è¦è®¾è®¡</h2><p>Pop æ¶ˆè´¹ä¸»è¦çš„è®¾è®¡æ€æƒ³æ˜¯å°†ç¹é‡çš„å®¢æˆ·ç«¯é€»è¾‘å¦‚é‡å¹³è¡¡ã€æ¶ˆè´¹è¿›åº¦æäº¤ã€æ¶ˆè´¹å¤±è´¥åå‘åˆ° Broker é‡è¯•ç­‰é€»è¾‘æ”¾åˆ° Broker ç«¯ã€‚</p><p>å®¢æˆ·ç«¯åªéœ€è¦ä¸æ–­å‘é€ Pop è¯·æ±‚ï¼Œç”± Broker ç«¯æ¥åˆ†é…æ¯æ¬¡æ‹‰å–è¯·æ±‚è¦æ‹‰å–çš„é˜Ÿåˆ—å¹¶è¿”å›æ¶ˆæ¯ã€‚è¿™æ ·å°±å¯ä»¥å®ç°å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶æ‹‰å–ä¸€ä¸ªé˜Ÿåˆ—çš„æ•ˆæœï¼Œä¸ä¼šå­˜åœ¨ä¸€ä¸ªå®¢æˆ·ç«¯ hang ä½å¯¼è‡´é˜Ÿåˆ—æ¶ˆæ¯å †ç§¯ï¼Œä¹Ÿä¸ä¼šå­˜åœ¨é¢‘ç¹çš„é‡å¹³è¡¡å¯¼è‡´æ¶ˆæ¯ç§¯å‹ã€‚</p><h3 id="_2-1-pop-æ¶ˆè´¹æµç¨‹" tabindex="-1"><a class="header-anchor" href="#_2-1-pop-æ¶ˆè´¹æµç¨‹" aria-hidden="true">#</a> 2.1 Pop æ¶ˆè´¹æµç¨‹</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130012457.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä¸ºäº†ä¿è¯æ¶ˆè´¹é€Ÿåº¦ï¼ŒPop æ¶ˆè´¹ä¸€æ¬¡è¯·æ±‚å¯ä»¥æ‹‰å–ä¸€æ‰¹æ¶ˆæ¯ï¼Œæ‹‰å–åˆ°çš„æ¶ˆæ¯ç³»ç»Ÿå±æ€§ä¸­æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å±æ€§å«åš <code>POP_CK</code>ï¼Œå®ƒæ˜¯è¯¥æ¶ˆæ¯çš„å¥æŸ„ï¼ŒACK æ—¶è¦é€šè¿‡å¥æŸ„æ¥å®šä½åˆ°å®ƒã€‚åœ¨ Broker ç«¯ä¼šä¸ºè¿™æ‰¹æ¶ˆæ¯ä¿å­˜ä¸€ä¸ª <code>CheckPoint</code>ï¼Œå®ƒé‡Œé¢åŒ…å«ä¸€æ‰¹æ¶ˆæ¯çš„å¥æŸ„ä¿¡æ¯ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130025660.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¯¹äºé•¿æ—¶é—´æ²¡æœ‰ ACK çš„æ¶ˆæ¯ï¼ŒBroker ç«¯å¹¶éæ¯«æ— åŠæ³•ã€‚Pop æ¶ˆè´¹å¼•å…¥äº†æ¶ˆæ¯ä¸å¯è§æ—¶é—´ï¼ˆinvisibleTimeï¼‰çš„æœºåˆ¶ã€‚å½“ Pop å‡ºä¸€æ¡æ¶ˆæ¯åï¼Œè¿™æ¡æ¶ˆæ¯å¯¹æ‰€æœ‰æ¶ˆè´¹è€…ä¸å¯è§ï¼Œå³è¿›å…¥ä¸å¯è§æ—¶é—´ï¼Œå½“å®ƒè¶…è¿‡è¯¥æ—¶åˆ»è¿˜æ²¡æœ‰è¢« ACKï¼ŒBroker å°†ä¼šæŠŠå®ƒæ”¾å…¥ Pop ä¸“é—¨çš„é‡è¯• Topicï¼ˆè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º Reviveï¼‰ï¼Œè¿™æ¡æ¶ˆæ¯é‡æ–°å¯ä»¥è¢«æ¶ˆè´¹ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130013463.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Push æ¶ˆè´¹çš„é‡è¯•é—´éš”æ—¶é—´ä¼šéšç€é‡è¯•æ¬¡æ•°è€Œå¢åŠ ï¼ŒPop æ¶ˆè´¹ä¹Ÿæ²¿ç”¨äº†è¿™ä¸ªè®¾è®¡ã€‚æ­¤å¤–ï¼ŒPop æ¶ˆè´¹æä¾›äº†ä¸€ä¸ªæ¥å£ <code>changeInvisibleTime()</code> æ¥ä¿®æ”¹å•æ¡æ¶ˆæ¯çš„ä¸å¯è§æ—¶é—´ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130025555.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä»å›¾ä¸Šå¯ä»¥çœ‹è§ï¼Œæœ¬æ¥æ¶ˆæ¯ä¼šåœ¨ä¸­é—´è¿™ä¸ªæ—¶é—´ç‚¹å†ä¸€æ¬¡çš„å¯è§çš„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å¯è§ä¹‹å‰æå‰ä½¿ç”¨ <code>changeInvisibleTime</code> å»¶é•¿äº†ä¸å¯è§æ—¶é—´ï¼Œè®©è¿™æ¡æ¶ˆæ¯çš„å¯è§æ—¶é—´æ¨è¿Ÿäº†ã€‚</p><p>å½“æ¶ˆè´¹å¤±è´¥ï¼ˆç”¨æˆ·ä¸šåŠ¡ä»£ç è¿”å› reconsumeLater æˆ–è€…æŠ›å¼‚å¸¸ï¼‰çš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…å°±é€šè¿‡ <code>changeInvisibleTime</code> æŒ‰ç…§é‡è¯•æ¬¡æ•°æ¥ä¿®æ”¹ä¸‹ä¸€æ¬¡çš„å¯è§æ—¶é—´ã€‚å¦å¤–å¦‚æœæ¶ˆè´¹æ¶ˆæ¯ç”¨æ—¶è¶…è¿‡äº† 30 ç§’ï¼ˆé»˜è®¤å€¼ï¼Œå¯ä»¥ä¿®æ”¹ï¼‰ï¼Œåˆ™ Broker ä¹Ÿä¼šæŠŠæ¶ˆæ¯æ”¾åˆ°é‡è¯•é˜Ÿåˆ—ã€‚</p><h3 id="_2-2-å®¢æˆ·ç«¯-æœåŠ¡ç«¯äº¤äº’" tabindex="-1"><a class="header-anchor" href="#_2-2-å®¢æˆ·ç«¯-æœåŠ¡ç«¯äº¤äº’" aria-hidden="true">#</a> 2.2 å®¢æˆ·ç«¯-æœåŠ¡ç«¯äº¤äº’</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2022/12/1671126626388.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Pop æ¶ˆè´¹çš„æµç¨‹ä¸ Push æ¶ˆè´¹è¾ƒä¸ºç›¸ä¼¼ï¼Œè¿™é‡Œæˆ‘åˆ†ä¸º 5 ä¸ªæ­¥éª¤ã€‚</p><ol><li>å‘ Broker ç«¯å‘é€è¯·æ±‚ï¼Œåˆ‡æ¢æ¶ˆæ¯æ‹‰å–æ¨¡å¼ä¸º Pop æ¨¡å¼</li><li>é‡å¹³è¡¡æœåŠ¡æ‰§è¡Œé‡å¹³è¡¡ï¼Œæ­¤æ—¶å·²ç»åˆ‡æ¢ä¸º Pop æ¨¡å¼ï¼Œæ‰€ä»¥æ˜¯å‘ Broker ç«¯å‘èµ·è¯·æ±‚ï¼Œè¯·æ±‚ä¸­å¸¦æœ‰é‡å¹³è¡¡ç­–ç•¥ï¼ŒBroker ä¼šè¿”å›é‡å¹³è¡¡çš„ç»“æœã€‚</li><li>é‡å¹³è¡¡å®Œæ¯•ä¹‹åå¼€å§‹æ‹‰å–æ¶ˆæ¯ï¼Œæ‹‰å–æ¶ˆæ¯æœåŠ¡å‘é€ <code>POP_MESSAGE</code> è¯·æ±‚ç»™ Brokerï¼Œè·å–ä¸€æ‰¹æ¶ˆæ¯</li><li>æ¶ˆè´¹è¿™æ‰¹æ¶ˆæ¯</li><li>å¯¹æˆåŠŸæ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œå‘é€ ACK è¯·æ±‚ç»™ Broker</li></ol><h3 id="_2-3-æœåŠ¡ç«¯å®ç°" tabindex="-1"><a class="header-anchor" href="#_2-3-æœåŠ¡ç«¯å®ç°" aria-hidden="true">#</a> 2.3 æœåŠ¡ç«¯å®ç°</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130042984.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æœåŠ¡ç«¯æ”¶åˆ° Pop è¯·æ±‚åï¼Œä¼šå…ˆåœ¨ Queue ç»´åº¦ä¸ŠåŠ é”ï¼Œä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ‹‰å–è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯ã€‚</p><p>éšåæœåŠ¡ç«¯ä¼šåœ¨å­˜å‚¨ä¸­æŸ¥è¯¢ä¸€æ‰¹æ¶ˆæ¯ï¼Œå°†è¿™æ‰¹æ¶ˆæ¯çš„æ„å»ºçš„ <code>CheckPoint</code> ä¿å­˜åœ¨ Broker ä¸­ï¼Œä»¥ä¾¿ä¸ ACK çš„æ¶ˆæ¯åŒ¹é…ã€‚</p><p><code>CheckPoint</code> çš„å­˜åœ¨ç›®çš„æ˜¯ä¸ ACK çš„æ¶ˆæ¯åŒ¹é…ï¼Œå¹¶å°†æ²¡æœ‰åŒ¹é…çš„æ¶ˆæ¯é‡è¯•ã€‚<code>CheckPoint</code> çš„ <code>ReviveTime</code> å°±æ˜¯å®ƒè¿™æ‰¹æ¶ˆæ¯éœ€è¦è¢«å°è¯•é‡è¯•ï¼ˆå”¤é†’ï¼‰çš„æ—¶é—´ã€‚</p><p><code>CheckPoint</code>ä¼šå…ˆè¢«ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸€èˆ¬æ¥è¯´æ¶ˆæ¯æ¶ˆè´¹å¾ˆå¿«ï¼Œæ‰€ä»¥åœ¨å†…å­˜ä¸­å°±èƒ½å¤Ÿä¸ ACK æ¶ˆæ¯åŒ¹é…æˆåŠŸååˆ é™¤ã€‚å¦‚æœåœ¨ä¸€æ®µæ—¶é—´ï¼ˆé»˜è®¤ 3sï¼‰å†…æ²¡æœ‰åŒ¹é…æˆåŠŸï¼Œå®ƒå°†ä¼šä»å†…å­˜ä¸­è¢«åˆ é™¤ï¼Œè½¬å…¥ç£ç›˜ç­‰å¾…åŒ¹é…ã€‚</p><p>å¯¹äº ACK æ¶ˆæ¯ä¹Ÿä¸€æ ·ï¼Œå®ƒå…ˆè¢«æ”¾å…¥å†…å­˜ä¸­åŒ¹é…ï¼Œå¦‚æœåœ¨å†…å­˜ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„ <code>CheckPoint</code>ï¼Œä¹Ÿä¼šæ”¾å…¥ç£ç›˜ã€‚</p><hr><p>RocketMQ çš„ç£ç›˜å­˜å‚¨å®é™…ä¸Šå°±æ˜¯ Topic å’Œé˜Ÿåˆ—ã€‚ä¸ºäº†é¿å…é¢‘ç¹æ£€æŸ¥åŒ¹é…çŠ¶æ€ï¼Œæˆ‘ä»¬åªåœ¨ <code>CheckPoint</code> éœ€è¦è¢«å”¤é†’æ—¶åšæ£€æŸ¥ï¼Œè¿™é‡Œå°±å¯ä»¥ç”¨åˆ°å®šæ—¶æ¶ˆæ¯ï¼Œå°† <code>CheckPoint</code> å’Œ ACK æ¶ˆæ¯å®šæ—¶åˆ° <code>ReviveTime</code> æŠ•é€’ã€‚è¿™é‡Œ RocketMQ å°† <code>CheckPoint</code> çš„æŠ•é€’æ—¶é—´æå‰ 1sï¼Œä»¥ä¾¿èƒ½å…ˆæ¶ˆè´¹åˆ°ï¼Œä¸ ACK æ¶ˆæ¯åŒ¹é…ã€‚</p><p>å½“å®šæ—¶åˆ°æœŸï¼Œå®ƒä»¬ä¼šè¢«æŠ•é€’åˆ° <code>REVIVE_TOPIC</code>ã€‚æœ‰ä¸ªåå°çº¿ç¨‹æ¶ˆè´¹è¿™ä¸ª Topicï¼ŒæŠŠ <code>CheckPoint</code> æ”¾åˆ°ä¸€ä¸ª map ä¸­ï¼Œå¯¹äº ACK æ¶ˆæ¯åˆ™ä» map ä¸­æŸ¥æ‰¾ <code>CheckPoint</code> æ¥å°è¯•åŒ¹é…ï¼Œå¦‚æœåŒ¹é…æˆåŠŸåˆ™æ›´æ–° <code>REVIVE_TOPIC</code> çš„æ¶ˆè´¹ä½ç‚¹ã€‚å¯¹äºè¶…è¿‡ <code>ReviveTime</code> è¿˜æ²¡æœ‰è¢«åŒ¹é…çš„ <code>CheckPoint</code>ï¼ŒæŸ¥å‡ºè¿™æ‰¹æ¶ˆæ¯ä¸­è¦é‡è¯•æ¶ˆæ¯å¯¹åº”çš„çœŸå®æ¶ˆæ¯ï¼Œå¹¶æ”¾åˆ° Pop æ¶ˆè´¹é‡è¯• Topic ä¸­ã€‚</p><p>Broker ç«¯çš„ Pop æ¶ˆè´¹é€»è¾‘ä¼šæ¦‚ç‡æ€§æ¶ˆè´¹åˆ°é‡è¯• Topic ä¸­çš„æ¶ˆæ¯ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202212130045464.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_3-è¯¦ç»†è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#_3-è¯¦ç»†è®¾è®¡" aria-hidden="true">#</a> 3. è¯¦ç»†è®¾è®¡</h2><h3 id="_3-1-broker-ç«¯é‡å¹³è¡¡" tabindex="-1"><a class="header-anchor" href="#_3-1-broker-ç«¯é‡å¹³è¡¡" aria-hidden="true">#</a> 3.1 Broker ç«¯é‡å¹³è¡¡</h3><p>Pop æ¶ˆè´¹çš„é‡å¹³è¡¡åœ¨ Broker ç«¯å®Œæˆï¼Œå®¢æˆ·ç«¯çš„é‡å¹³è¡¡æœåŠ¡é‡å¹³è¡¡æ—¶ä¼šå‘ Broker ç«¯å‘é€æŸ¥è¯¢è¯·æ±‚ï¼ŒæŸ¥è¯¢è‡ªå·±çš„åˆ†é…ç»“æœã€‚</p><p>é‡å¹³è¡¡çš„ä¸»è¦é€»è¾‘å…¶å®ä¸åœ¨å®¢æˆ·ç«¯é‡å¹³è¡¡ç±»ä¼¼ï¼Œåªä¸è¿‡å˜æˆäº† Broker æ¥æ”¶å®¢æˆ·ç«¯çš„å‚æ•°ä¹‹åæ ¹æ®è¿™äº›å‚æ•°è¿›è¡Œé‡å¹³è¡¡ï¼Œç„¶åæŠŠé‡å¹³è¡¡ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>Broker ç«¯é‡å¹³è¡¡å…¥å£ä¸º <code>QueryAssignmentProcessor#doLoadBalance()</code>ã€‚</p><p>å¯¹äºå¹¿æ’­æ¨¡å¼ï¼Œç›´æ¥è¿”å› Topic ä¸‹æ‰€æœ‰çš„é˜Ÿåˆ—ã€‚</p><p>å¯¹äºé›†ç¾¤æ¨¡å¼ï¼ŒPop æ¨¡å¼çš„é‡å¹³è¡¡ä¸ Push æ¨¡å¼ä¸åŒï¼Œå®ƒå…è®¸ä¸€ä¸ªé˜Ÿåˆ—è¢«å¤šä¸ªæ¶ˆè´¹è€… Pop æ¶ˆè´¹ã€‚åœ¨åˆ‡æ¢ Pop æ¨¡å¼æ—¶å¼•å…¥äº† <code>popShareQueueNum</code> å‚æ•°ï¼Œè¡¨ç¤ºå…è®¸æ¶ˆè´¹è€…è¿›è¡Œé¢å¤–çš„è´Ÿè½½è·å–é˜Ÿåˆ—çš„æ¬¡æ•°ï¼ˆå¯ä»¥è¢«å…±äº«çš„é˜Ÿåˆ—æ•°ï¼‰ï¼Œ0 è¡¨ç¤ºå¯ä»¥æ¶ˆè´¹æ‰€æœ‰é˜Ÿåˆ—ã€‚</p><p>æ‰€ä»¥é‡å¹³è¡¡æ—¶å¯¹æ¯ä¸ªæ¶ˆè´¹è€…æ‰§è¡Œ <code>popShareQueueNum</code> æ¬¡é‡å¹³è¡¡ç­–ç•¥ï¼Œå°†å¤šæ¬¡é‡å¹³è¡¡åˆ†é…åˆ°çš„é˜Ÿåˆ—éƒ½åˆ†ç»™è¿™ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚è¿™æ ·ï¼Œæ¯ä¸ªé˜Ÿåˆ—å°±ä¼šè¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚</p><p>ä¸‹å›¾ä¸º <code>popShareQueueNum = 1</code> æ—¶çš„é‡å¹³è¡¡æƒ…å†µï¼Œæ¯ä¸ªæ¶ˆè´¹è€…è¢«è´Ÿè½½äº† 2 æ¬¡ï¼Œæ¯ä¸ªé˜Ÿåˆ—è¢« 2 ä¸ªæ¶ˆè´¹è€…å…±äº«ï¼ˆ1 + <code>popShareQueueNum</code>ï¼‰ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2022/12/1671126626711.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_3-2-broker-ç«¯-pop-æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_3-2-broker-ç«¯-pop-æ¶ˆæ¯" aria-hidden="true">#</a> 3.2 Broker ç«¯ Pop æ¶ˆæ¯</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2022/12/1671126626730.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_3-2-1-è¯·æ±‚å¤„ç†å…¥å£" tabindex="-1"><a class="header-anchor" href="#_3-2-1-è¯·æ±‚å¤„ç†å…¥å£" aria-hidden="true">#</a> 3.2.1 è¯·æ±‚å¤„ç†å…¥å£</h4><p>Pop æ¶ˆæ¯çš„ Broker ç«¯å¤„ç†æ˜¯ç”± <code>PopMessageProcessor#processRequest()</code> å®Œæˆã€‚</p><p>è¯¥æ–¹æ³•é€»è¾‘ä¸º</p><ol><li>å®Œæˆè¯·æ±‚ä½“è§£æå’Œä¸€äº›å‚æ•°å’Œæƒé™çš„æ ¡éªŒ</li><li>ç”Ÿæˆä¸€ä¸ª 0 åˆ° 99 çš„éšæœºæ•´æ•°ï¼Œå¦‚æœèƒ½è¢« 5 æ•´é™¤ï¼Œåˆ™å…ˆæ‹‰å–é‡è¯• Topicã€‚</li><li>ä»é‡è¯• Topic çš„æ¯ä¸ª Queue ä¸­ Pop æ¶ˆæ¯</li><li>æ ¹æ®è¯·æ±‚çš„é˜Ÿåˆ— Pop å¯¹åº”çš„é˜Ÿåˆ—çš„æ¶ˆæ¯ã€‚å¦‚æœ Pop è¯·æ±‚æŒ‡å®šäº†é˜Ÿåˆ—ï¼Œåªä¼šæ¶ˆè´¹ä¸€ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯ï¼›å¦‚æœæ²¡æœ‰æŒ‡å®šé˜Ÿåˆ—ï¼Œåˆ™ Pop æ‰€æœ‰é˜Ÿåˆ—çš„æ¶ˆæ¯</li><li>å¦‚æœ Pop çš„æ¶ˆæ¯æ²¡æœ‰æ»¡ï¼ˆè¾¾åˆ°è¯·æ±‚çš„æœ€å¤§æ¶ˆæ¯æ•°é‡ï¼‰ï¼Œä¸”ä¹‹å‰æ²¡æœ‰æ‹‰å–è¿‡é‡è¯•æ¶ˆæ¯ï¼Œåˆ™ Pop é‡è¯• Topic æ‰€æœ‰é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼ˆæœŸæœ›å¡«å……æ»¡ Pop è¯·æ±‚è¦æ±‚çš„æ•°é‡ï¼‰</li><li>åˆ¤æ–­æ˜¯å¦ Pop åˆ°æ¶ˆæ¯ï¼Œå¦‚æœæœ‰åˆ™ä¼ è¾“å›å®¢æˆ·ç«¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŒ‚èµ·è½®è¯¢ï¼Œç›´åˆ°è¶…è¿‡è¯·æ±‚çš„ timeout å‚æ•°æŒ‡å®šçš„æ—¶é—´</li></ol><h4 id="_3-2-2-pop-æ¶ˆæ¯æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_3-2-2-pop-æ¶ˆæ¯æ–¹æ³•" aria-hidden="true">#</a> 3.2.2 Pop æ¶ˆæ¯æ–¹æ³•</h4><p>ä¸Šé¢çš„ 3ã€4ã€5 éƒ½æ¶‰åŠåˆ°ä»å­˜å‚¨ä¸­ Pop æ¶ˆæ¯ï¼Œå®ƒä»¬éƒ½è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•ï¼š<code>popMsgFromQueue</code>ï¼Œå®ƒæ˜¯çœŸæ­£æŸ¥è¯¢æ¶ˆæ¯çš„æ–¹æ³•ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å®ƒçš„é€»è¾‘</p><ol><li>å°†éœ€è¦ Pop çš„é˜Ÿåˆ—ä¸Šé”ï¼ˆç”¨ <code>AtomicBoolean</code> å®ç°ï¼‰</li><li>è®¡ç®— Pop æ¶ˆæ¯çš„èµ·å§‹åç§»é‡ï¼Œä¼šè¿”å›å†…å­˜ä¸­ CheckPoint ä¸ ACK æ¶ˆæ¯åŒ¹é…åçš„æœ€æ–°ä½ç‚¹</li><li>ä»ç£ç›˜ä¸­æ ¹æ®èµ·å§‹åç§»é‡æŸ¥è¯¢ä¸€æ‰¹æ¶ˆæ¯</li><li>è®¡ç®—é˜Ÿåˆ—å‰©ä½™çš„æ¶ˆæ¯æ•°é‡ï¼ˆç”¨ä½œè¿”å›å€¼ï¼‰</li><li>æ‹‰å–çš„è¿™æ‰¹æ¶ˆæ¯å°†ç”Ÿæˆä¸€ä¸ª <code>CheckPoint</code>ï¼Œå­˜å…¥å†…å­˜å’Œç£ç›˜</li><li>è§£é”é˜Ÿåˆ—</li><li>è¿”å› Pop åˆ°çš„æ¶ˆæ¯</li></ol><p>ä¸Šé¢æ–¹æ³•ç¬¬ 5 æ­¥ä¼šå°†ç”Ÿæˆçš„ <code>CheckPoint</code> æ”¾å…¥å†…å­˜å’Œç£ç›˜ï¼Œæ³¨æ„è¿™ä¸ª <code>CheckPoint</code> ä¼šä¿å­˜ä¸€æ‰¹è·å–åˆ°çš„æ¶ˆæ¯çš„èµ·å§‹åç§»é‡å’Œç›¸å¯¹åç§»é‡ï¼ˆç›¸å¯¹äºèµ·å§‹åç§»é‡ï¼‰ï¼Œæ‰€ä»¥ä¸€ä¸ª <code>CheckPoint</code> åœ¨ä¿å­˜å’ŒåŒ¹é…æ—¶éƒ½å¯¹åº”ä¸€æ‰¹æ¶ˆæ¯ã€‚</p><h4 id="_3-2-3-ä¿å­˜-checkpoint-ç”¨äºåŒ¹é…" tabindex="-1"><a class="header-anchor" href="#_3-2-3-ä¿å­˜-checkpoint-ç”¨äºåŒ¹é…" aria-hidden="true">#</a> 3.2.3 ä¿å­˜ <code>CheckPoint</code> ç”¨äºåŒ¹é…</h4><ol><li>æ„é€  <code>CheckPoint</code>ï¼Œæ·»åŠ èµ·å§‹åç§»é‡å’Œæ‰€æœ‰ Pop å‡ºçš„æ¶ˆæ¯çš„ç›¸å¯¹åç§»é‡</li><li>å°è¯•å°† <code>CheckPoint</code> æ·»åŠ åˆ°å†…å­˜ Bufferï¼Œå¦‚æœæˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚ä½†æ˜¯åœ¨å†…å­˜ä¸­åŒ¹é… <code>CheckPoint</code> å’Œ <code>AckMsg</code> çš„å¼€å…³é»˜è®¤æ˜¯å…³é—­çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šåŠ å…¥åˆ°å†…å­˜ï¼Œä¼šç»§ç»­åé¢çš„é€»è¾‘æ”¾å…¥ç£ç›˜</li><li>å°† <code>CheckPoint</code> æ„é€ æˆä¸€ä¸ªæ¶ˆæ¯ï¼Œæ•°æ®éƒ½æ”¾åˆ°æ¶ˆæ¯ä½“ä¸­ï¼Œç„¶åè¿™ä¸ªæ¶ˆæ¯å®šæ—¶åˆ° <code>ReviveTime</code>ï¼ˆå”¤é†’é‡è¯•çš„æ—¶é—´ï¼‰- 1sï¼ˆä¸ºäº†ç•™æ—¶é—´ä¸ <code>AckMsg</code> åŒ¹é…ï¼‰å‘é€ã€‚ä¼šå‘é€åˆ° ReviveTopic çš„ä¸€ä¸ªé˜Ÿåˆ—ã€‚</li></ol><h3 id="_3-3-broker-ç«¯-ack-æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_3-3-broker-ç«¯-ack-æ¶ˆæ¯" aria-hidden="true">#</a> 3.3 Broker ç«¯ ACK æ¶ˆæ¯</h3><p>Ack æ¶ˆæ¯æ¥å£æ¯æ¬¡åªå…è®¸ Ack ä¸€æ¡æ¶ˆæ¯ï¼Œå…¥å£æ˜¯ <code>AckMessageProcessor#processRequest()</code></p><ol><li>ä»è¯·æ±‚å¤´è§£æå’Œæ„é€  Ack æ¶ˆæ¯ï¼Œå¹¶ä½œä¸€äº›æ ¡éªŒ</li><li>é¡ºåºæ¶ˆæ¯ Ack å’Œæ™®é€šæ¶ˆæ¯ Ack åˆ†åˆ«å¤„ç†ï¼Œè¿™é‡Œé’ˆå¯¹æ™®é€šæ¶ˆæ¯</li><li>å…ˆå°è¯•å°† Ack æ¶ˆæ¯æ”¾å…¥å†…å­˜ Bufferï¼Œå¦‚æœæˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚å¤±è´¥åˆ™æœ‰å¯èƒ½æ˜¯å†…å­˜åŒ¹é…æœªå¼€å¯ã€‚</li><li>å¦‚æœæ”¾å…¥å†…å­˜å¤±è´¥ï¼Œæ„é€ ä¸€ä¸ªç”¨äºå­˜åˆ°ç£ç›˜çš„æ¶ˆæ¯ï¼Œå®šæ—¶åˆ°å”¤é†’é‡è¯•æ—¶é—´æŠ•é€’ï¼ˆåˆ° ReviveTopicï¼‰ã€‚</li></ol><h3 id="_3-4-broker-ç«¯-checkpoint-ä¸-ackmsg-åŒ¹é…" tabindex="-1"><a class="header-anchor" href="#_3-4-broker-ç«¯-checkpoint-ä¸-ackmsg-åŒ¹é…" aria-hidden="true">#</a> 3.4 Broker ç«¯ <code>CheckPoint</code> ä¸ <code>AckMsg</code> åŒ¹é…</h3><p><code>CheckPoint</code> å’Œ <code>AckMsg</code> éƒ½è¢«è®¾è®¡æˆå…ˆå°è¯•æ”¾å…¥å†…å­˜ä¸­åŒ¹é…ï¼Œç„¶åå†ç£ç›˜ä¸­åŒ¹é…ï¼Œå› ä¸ºé€šå¸¸æƒ…å†µä¸‹æ¶ˆæ¯æ¶ˆè´¹ä¹‹åéƒ½èƒ½å¾ˆå¿« ACKï¼Œå†…å­˜åŒ¹é…æ€§èƒ½è¾ƒé«˜ã€‚å¦‚æœ <code>CheckPoint</code> åœ¨å†…å­˜ä¸­åœç•™å¤ªä¹…æ²¡æœ‰è¢«åŒ¹é…ï¼Œåˆ™ä¼šè½¬ç§»åˆ°ç£ç›˜ä¸­ï¼ˆReviveTopicï¼‰ï¼Œæœ‰ä¸ªçº¿ç¨‹æ¶ˆè´¹è¿™ä¸ª ReviveTopic æ¥åŒ¹é…ã€‚åˆ°è¾¾å”¤é†’é‡è¯•æ—¶é—´ï¼ˆReviveTimeï¼‰è¿˜æ²¡æœ‰è¢«åŒ¹é…çš„ <code>CheckPoint</code> é‡Œé¢çš„æ¶ˆæ¯å°†ä¼šé‡è¯•ï¼ˆå‘é€åˆ° Pop æ¶ˆæ¯é‡è¯• Topicï¼Œåé¢çš„ Pop æœ‰æ¦‚ç‡æ¶ˆè´¹åˆ°ï¼‰ã€‚</p><h4 id="_3-4-1-å†…å­˜åŒ¹é…" tabindex="-1"><a class="header-anchor" href="#_3-4-1-å†…å­˜åŒ¹é…" aria-hidden="true">#</a> 3.4.1 å†…å­˜åŒ¹é…</h4><p>å†…å­˜åŒ¹é…é€»è¾‘ç”±ä¸€ä¸ªçº¿ç¨‹ <code>PopBufferMergeService</code> å®Œæˆï¼Œåªæœ‰ä¸»èŠ‚ç‚¹è¿è¡Œè¯¥åŒ¹é…çº¿ç¨‹ã€‚</p><p>Pop æ¶ˆæ¯æ—¶ä¼šå…ˆæ·»åŠ  <code>CheckPoint</code> åˆ° bufferï¼ŒAck æ¶ˆæ¯æ—¶å°è¯•ä»å†…å­˜ buffer ä¸­çš„ <code>CheckPoint</code> åŒ¹é…ã€‚åŒæ—¶ï¼Œå®ƒæ¯ 5ms æ‰§è¡Œä¸€æ¬¡æ‰«æï¼Œå°†ä¸ç¬¦åˆå†…å­˜ä¸­å­˜æ´»æ¡ä»¶çš„ <code>CheckPoint</code> ç§»é™¤ï¼Œæ”¾å…¥ç£ç›˜å­˜å‚¨ã€‚</p><p><code>addCk</code> æ–¹æ³•å°† <code>CheckPoint</code> æ”¾å…¥å†…å­˜ Bufferã€‚<code>CheckPoint</code> ä¸­æœ‰ä¸€ä¸ªç è¡¨ <code>BitMap</code>ï¼Œç”¨æ¥è¡¨ç¤ºå®ƒé‡Œé¢çš„æ¯ä¸ªæ¡æ¶ˆæ¯æ˜¯å¦è¢« Ack å’Œè¢«å­˜åˆ°ç£ç›˜ã€‚ç”¨ <code>BitMap</code> å¯ä»¥åŠ é€ŸåŒ¹é…ã€‚</p><p><code>addAk</code> æ–¹æ³•ä¼šå°è¯•ä» buffer ä¸­æ‰¾ <code>CheckPoint</code> æ¥åŒ¹é…ã€‚å¦‚æœæ‰¾åˆ°å¯¹åº”çš„ <code>CheckPoint</code>ï¼Œåˆ™ä¿®æ”¹å®ƒç è¡¨çš„å¯¹åº”ä½ï¼Œè¡¨ç¤ºè¿™æ¡æ¶ˆæ¯è¢« ACKã€‚</p><p><code>scan</code> æ–¹æ³•æ¯ 5ms æ‰§è¡Œä¸€æ¬¡</p><ol><li>å°†å·²ç»åŒ¹é…æˆ–å­˜ç›˜çš„ <code>CheckPoint</code> ç§»å‡º buffer</li><li>æŠŠè¶…æ—¶çš„ <code>CheckPoint</code> å­˜å…¥ç£ç›˜</li><li>å¯¹äºåŒ¹é…å®Œæˆæˆ–è€…å­˜ç›˜çš„ <code>CheckPoint</code>ï¼Œä¸ºä»–ä»¬æäº¤æ¶ˆæ¯åç§»é‡</li></ol><h4 id="_3-4-2-store-åŒ¹é…å’Œæ¶ˆæ¯é‡è¯•" tabindex="-1"><a class="header-anchor" href="#_3-4-2-store-åŒ¹é…å’Œæ¶ˆæ¯é‡è¯•" aria-hidden="true">#</a> 3.4.2 Store åŒ¹é…å’Œæ¶ˆæ¯é‡è¯•</h4><p>ä»å†…å­˜ä¸­ç§»é™¤ä¿å­˜åˆ°ç£ç›˜çš„ <code>CheckPoint</code> å’Œ <code>AckMsg</code> éƒ½ä¼šå°è£…æˆæ¶ˆæ¯è¿›è¡Œå®šæ—¶æŠ•é€’ï¼ˆå®šæ—¶åˆ°é‡è¯•æ—¶é—´ï¼‰ï¼Œæœ€ç»ˆæŠ•é€’åˆ° <code>ReviveTopic</code>ã€‚å­˜å‚¨ä¸­åŒ¹é…ä¹Ÿç”±ä¸€ä¸ªçº¿ç¨‹ <code>PopReviveService</code> å®Œæˆï¼Œå®ƒæ¶ˆè´¹ <code>ReviveTopic</code> çš„æ¶ˆæ¯è¿›è¡ŒåŒ¹é…å’Œé‡è¯•ã€‚</p><p>Pop æ¶ˆè´¹ç”±äºè¦æ ¹æ® Topic æ¥ Pop æ¶ˆæ¯ï¼Œé‡è¯• Topic éœ€è¦é’ˆå¯¹æ¯ä¸ª [æ¶ˆè´¹ç»„-Topic] éš”ç¦»ï¼Œæ‰€ä»¥å®ƒä¸èƒ½ç”¨æ™®é€šæ¶ˆæ¯çš„æ¶ˆè´¹ç»„ç»´åº¦çš„é‡è¯• Topicï¼Œè€Œæ˜¯ç”¨ä¸“é—¨çš„ Pop é‡è¯• Topic <code>%RETRY%{æ¶ˆè´¹ç»„}_{TOPIC}</code>ã€‚</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2022/12/1671126626776.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>PopReviveService#run</code> æ–¹æ³•æ˜¯è¯¥å¤„ç†çº¿ç¨‹çš„å…¥å£ï¼Œå®ƒæ¯ç§’éƒ½ä¼šè°ƒç”¨ <code>consumeReviveMessage</code> æ¶ˆè´¹å’ŒåŒ¹é… ReviveTopic æ¶ˆæ¯ï¼Œç„¶åè°ƒç”¨ <code>mergeAndRevive</code> æ–¹æ³•æ£€æŸ¥åŒ¹é…çš„æƒ…å†µå¹¶å¯¹è¾¾åˆ°å”¤é†’æ—¶é—´è¿˜æ²¡æœ‰æˆåŠŸåŒ¹é…çš„æ¶ˆæ¯é‡è¯•ã€‚</p><p>è¿™ä¸¤ä¸ªæ–¹æ³•ä¼šå…ˆåˆå§‹åŒ–ä¸€ä¸ª mapï¼Œç”¨äºå­˜æ”¾ <code>CheckPoint</code>ï¼Œä¾› <code>AckMsg</code> æ ¹æ® map key æŸ¥æ‰¾ <code>CheckPoint</code>ã€‚</p><hr><p><code>consumeReviveMessage</code> ä¼šæ¶ˆè´¹ 2s å†…çš„ä¸€æ‰¹ ReviveTopic æ¶ˆæ¯ï¼ŒCK æ¶ˆæ¯æ”¾å…¥ mapï¼ŒAck æ¶ˆæ¯åˆ™ä» map ä¸­æŸ¥æ‰¾ CKï¼Œåœ¨ç è¡¨ä¸Šæ ‡è®°å¯¹åº”çš„æ¶ˆæ¯ä¸º Ackedã€‚</p><p><code>mergeAndRevive</code> æ–¹æ³•å¦‚å…¶åï¼Œéå†æ¶ˆè´¹åˆ°çš„ CK æ¶ˆæ¯ï¼Œå¯¹äºå·²ç»åˆ°é‡è¯•æ—¶é—´çš„ï¼Œå¯¹æ²¡æœ‰ Ack çš„æ¶ˆæ¯è¿›è¡Œé‡è¯•ã€‚</p><p>é‡è¯•é€»è¾‘ä¸ºå…ˆä» MessageStore æŸ¥è¯¢å¯¹åº”çš„çœŸæ­£æ¶ˆæ¯ï¼Œç„¶åå°†è¯¥æ¶ˆæ¯å‘é€åˆ° Pop é‡è¯•é˜Ÿåˆ—ã€‚</p><h2 id="_4-æºç è§£æ" tabindex="-1"><a class="header-anchor" href="#_4-æºç è§£æ" aria-hidden="true">#</a> 4. æºç è§£æ</h2><h3 id="_4-1-broker-ç«¯é‡å¹³è¡¡" tabindex="-1"><a class="header-anchor" href="#_4-1-broker-ç«¯é‡å¹³è¡¡" aria-hidden="true">#</a> 4.1 Broker ç«¯é‡å¹³è¡¡</h3><h4 id="_4-1-1-queryassignmentprocessor-doloadbalance" tabindex="-1"><a class="header-anchor" href="#_4-1-1-queryassignmentprocessor-doloadbalance" aria-hidden="true">#</a> 4.1.1 <code>QueryAssignmentProcessor#doLoadBalance</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Broker ç«¯é‡å¹³è¡¡
 * Returns empty set means the client should clear all load assigned to it before, null means invalid result and the
 * client should skip the update logic
 *
 * <span class="token keyword">@param</span> <span class="token parameter">topic</span>
 * <span class="token keyword">@param</span> <span class="token parameter">consumerGroup</span>
 * <span class="token keyword">@param</span> <span class="token parameter">clientId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">messageModel</span> æ¶ˆè´¹æ¨¡å‹ï¼ˆå¹¿æ’­/é›†ç¾¤ï¼‰
 * <span class="token keyword">@param</span> <span class="token parameter">strategyName</span> é‡å¹³è¡¡ç­–ç•¥å
 * <span class="token keyword">@return</span> the MessageQueues assigned to this client
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> <span class="token function">doLoadBalance</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> consumerGroup<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> clientId<span class="token punctuation">,</span>
                                        <span class="token keyword">final</span> <span class="token class-name">MessageModel</span> messageModel<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> strategyName<span class="token punctuation">,</span>
                                        <span class="token class-name">SetMessageRequestModeRequestBody</span> setMessageRequestModeRequestBody<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> assignedQueueSet <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">TopicRouteInfoManager</span> topicRouteInfoManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTopicRouteInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>messageModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">BROADCASTING</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¹¿æ’­æ¨¡å¼ï¼Œè¿”å›è¯¥ Topic ä¸‹æ‰€æœ‰é˜Ÿåˆ—</span>
            assignedQueueSet <span class="token operator">=</span> topicRouteInfoManager<span class="token punctuation">.</span><span class="token function">getTopicSubscribeInfo</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>assignedQueueSet <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;QueryLoad: no assignment for group[{}], the topic[{}] does not exist.&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> <span class="token constant">CLUSTERING</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// é›†ç¾¤æ¨¡å¼</span>
            <span class="token comment">// è·å– Topic ä¸‹æ‰€æœ‰é˜Ÿåˆ—</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqSet <span class="token operator">=</span> topicRouteInfoManager<span class="token punctuation">.</span><span class="token function">getTopicSubscribeInfo</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> mqSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>topic<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;QueryLoad: no assignment for group[{}], the topic[{}] does not exist.&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isServerLoadBalancerEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mqSet<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cidAll <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// è·å–å‘èµ·è¯·æ±‚çš„æ¶ˆè´¹ç»„ä¿¡æ¯</span>
            <span class="token class-name">ConsumerGroupInfo</span> consumerGroupInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConsumerGroupInfo</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>consumerGroupInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cidAll <span class="token operator">=</span> consumerGroupInfo<span class="token punctuation">.</span><span class="token function">getAllClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> cidAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;QueryLoad: no assignment for group[{}] topic[{}], get consumer id list failed&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqAll <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mqAll<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>mqSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å°†é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…å®¢æˆ·ç«¯ID æ’åº</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>mqAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> allocateResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ ¹æ®é‡å¹³è¡¡ç­–ç•¥åç§°è·å–ç­–ç•¥</span>
                <span class="token class-name">AllocateMessageQueueStrategy</span> allocateMessageQueueStrategy <span class="token operator">=</span> name2LoadStrategy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>strategyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> allocateMessageQueueStrategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;QueryLoad: unsupported strategy [{}],  {}&quot;</span><span class="token punctuation">,</span> strategyName<span class="token punctuation">,</span> <span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token function">parseChannelRemoteAddr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>setMessageRequestModeRequestBody <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> setMessageRequestModeRequestBody<span class="token punctuation">.</span><span class="token function">getMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">MessageRequestMode</span><span class="token punctuation">.</span><span class="token constant">POP</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// POP æ¨¡å¼é‡å¹³è¡¡</span>
                    allocateResult <span class="token operator">=</span> <span class="token function">allocate4Pop</span><span class="token punctuation">(</span>allocateMessageQueueStrategy<span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> mqAll<span class="token punctuation">,</span>
                                                  cidAll<span class="token punctuation">,</span> setMessageRequestModeRequestBody<span class="token punctuation">.</span><span class="token function">getPopShareQueueNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æ™®é€šé‡å¹³è¡¡</span>
                    allocateResult <span class="token operator">=</span> allocateMessageQueueStrategy<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> mqAll<span class="token punctuation">,</span> cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;QueryLoad: no assignment for group[{}] topic[{}], allocate message queue exception. strategy name: {}, ex: {}&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> strategyName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            assignedQueueSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>allocateResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                assignedQueueSet<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>allocateResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> assignedQueueSet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-1-2-queryassignmentprocessor-allocate4pop" tabindex="-1"><a class="header-anchor" href="#_4-1-2-queryassignmentprocessor-allocate4pop" aria-hidden="true">#</a> 4.1.2 <code>QueryAssignmentProcessor#allocate4Pop</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * POP æ¨¡å¼é‡å¹³è¡¡
 *
 * <span class="token keyword">@param</span> <span class="token parameter">allocateMessageQueueStrategy</span> é‡å¹³è¡¡ç­–ç•¥
 * <span class="token keyword">@param</span> <span class="token parameter">consumerGroup</span> æ¶ˆè´¹ç»„
 * <span class="token keyword">@param</span> <span class="token parameter">clientId</span> æ¶ˆè´¹ç»„å®¢æˆ·ç«¯ ID
 * <span class="token keyword">@param</span> <span class="token parameter">mqAll</span> å…¨éƒ¨æ¶ˆæ¯é˜Ÿåˆ—
 * <span class="token keyword">@param</span> <span class="token parameter">cidAll</span> å…¨éƒ¨å®¢æˆ·ç«¯ID
 * <span class="token keyword">@param</span> <span class="token parameter">popShareQueueNum</span> Pop æ¨¡å¼ä¸‹å¯å…è®¸è¢«å…±äº«çš„é˜Ÿåˆ—æ•°ï¼Œ0 è¡¨ç¤ºæ— é™
 * <span class="token keyword">@return</span> è¯¥æ¶ˆè´¹è€…è´Ÿè½½çš„é˜Ÿåˆ—åˆ—è¡¨
 */</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> <span class="token function">allocate4Pop</span><span class="token punctuation">(</span><span class="token class-name">AllocateMessageQueueStrategy</span> allocateMessageQueueStrategy<span class="token punctuation">,</span>
                                       <span class="token keyword">final</span> <span class="token class-name">String</span> consumerGroup<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> clientId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqAll<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cidAll<span class="token punctuation">,</span>
                                       <span class="token keyword">int</span> popShareQueueNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> allocateResult<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>popShareQueueNum <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> popShareQueueNum <span class="token operator">&gt;=</span> cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¯ä¸ªæ¶ˆè´¹è€…èƒ½æ¶ˆè´¹æ‰€æœ‰é˜Ÿåˆ—ï¼Œè¿”å›å…¨éƒ¨é˜Ÿåˆ—ã€‚é˜Ÿåˆ— ID ä¸º -1 è¡¨ç¤º Pop æ¶ˆè´¹æ—¶æ¶ˆè´¹å…¨éƒ¨é˜Ÿåˆ—</span>
        <span class="token comment">//each client pop all messagequeue</span>
        allocateResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>mqAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageQueue</span> mq <span class="token operator">:</span> mqAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//must create new MessageQueue in case of change cache in AssignmentManager</span>
            <span class="token class-name">MessageQueue</span> newMq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            allocateResult<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newMq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> mqAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ¶ˆè´¹è€…æ•°é‡å°äºç­‰äºé˜Ÿåˆ—æ•°é‡ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…åˆ†é… N ä¸ªé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—ä¹Ÿä¼šè¢«åˆ†é…ç»™å¤šä¸ªæ¶ˆè´¹è€…</span>
            <span class="token comment">//consumer working in pop mode could share the MessageQueues assigned to the N (N = popWorkGroupSize) consumer following it in the cid list</span>
            allocateResult <span class="token operator">=</span> allocateMessageQueueStrategy<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> mqAll<span class="token punctuation">,</span> cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> cidAll<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è´Ÿè½½ popShareQueueNum æ¬¡ï¼Œå°†æ¯æ¬¡è´Ÿè½½çš„ç»“æœåŠ å…¥æœ€ç»ˆç»“æœ</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> popShareQueueNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    index<span class="token operator">++</span><span class="token punctuation">;</span>
                    index <span class="token operator">=</span> index <span class="token operator">%</span> cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> tmp <span class="token operator">=</span> allocateMessageQueueStrategy<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> cidAll<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> mqAll<span class="token punctuation">,</span> cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    allocateResult<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ¶ˆè´¹è€…æ•°é‡å¤§äºé˜Ÿåˆ—æ•°é‡ï¼Œä¿è¯æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æœ‰é˜Ÿåˆ—æ¶ˆè´¹</span>
            <span class="token comment">//make sure each cid is assigned</span>
            allocateResult <span class="token operator">=</span> <span class="token function">allocate</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> mqAll<span class="token punctuation">,</span> cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> allocateResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-broker-ç«¯-pop-æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_4-2-broker-ç«¯-pop-æ¶ˆæ¯" aria-hidden="true">#</a> 4.2 Broker ç«¯ Pop æ¶ˆæ¯</h3><h4 id="_4-2-1-popmessageprocessor-processrequest" tabindex="-1"><a class="header-anchor" href="#_4-2-1-popmessageprocessor-processrequest" aria-hidden="true">#</a> 4.2.1 <code>PopMessageProcessor#processRequest</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å¤„ç† POP æ¶ˆæ¯è¯·æ±‚
 *
 * <span class="token keyword">@param</span> <span class="token parameter">channel</span>
 * <span class="token keyword">@param</span> <span class="token parameter">request</span>
 * <span class="token keyword">@return</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">RemotingCommandException</span></span>
 */</span>
<span class="token keyword">private</span> <span class="token class-name">RemotingCommand</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... è§£æè¯·æ±‚ä½“å’Œä¸€ç³»åˆ—æ ¡éªŒ</span>

    <span class="token comment">// ç”Ÿæˆéšæœºæ•°</span>
    <span class="token keyword">int</span> randomQ <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> reviveQid<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">isOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        reviveQid <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token constant">POP_ORDER_REVIVE_QUEUE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// è½®è¯¢é€‰ä¸€ä¸ª Revive é˜Ÿåˆ—</span>
        reviveQid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>ckMessageNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReviveQueueNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> commercialSizePerMsg <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommercialSizePerMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GetMessageResult</span> getMessageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetMessageResult</span><span class="token punctuation">(</span>commercialSizePerMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// é˜Ÿåˆ—ä¸­å‰©ä½™çš„æ¶ˆæ¯æ•°é‡</span>
    <span class="token keyword">long</span> restNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 1/5 çš„æ¦‚ç‡æ‹‰å–é‡è¯•æ¶ˆæ¯</span>
    <span class="token keyword">boolean</span> needRetry <span class="token operator">=</span> randomQ <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> popTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ‹‰å–é‡è¯•æ¶ˆæ¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>needRetry <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requestHeader<span class="token punctuation">.</span><span class="token function">isOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TopicConfig</span> retryTopicConfig <span class="token operator">=</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTopicConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectTopicConfig</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildPopRetryTopic</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTopicConfig <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> retryTopicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> queueId <span class="token operator">=</span> <span class="token punctuation">(</span>randomQ <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> retryTopicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                restNum <span class="token operator">=</span> <span class="token function">popMsgFromQueue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> getMessageResult<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> restNum<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span>
                                          channel<span class="token punctuation">,</span> popTime<span class="token punctuation">,</span> messageFilter<span class="token punctuation">,</span>
                                          startOffsetInfo<span class="token punctuation">,</span> msgOffsetInfo<span class="token punctuation">,</span> orderCountInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœæ‹‰å–è¯·æ±‚æ²¡æœ‰æŒ‡å®šé˜Ÿåˆ—ï¼ˆ-1ï¼‰ï¼Œåˆ™æ‹‰å–æ‰€æœ‰é˜Ÿåˆ—</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// read all queue</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> topicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> queueId <span class="token operator">=</span> <span class="token punctuation">(</span>randomQ <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> topicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            restNum <span class="token operator">=</span> <span class="token function">popMsgFromQueue</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> getMessageResult<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> restNum<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> popTime<span class="token punctuation">,</span> messageFilter<span class="token punctuation">,</span>
                                      startOffsetInfo<span class="token punctuation">,</span> msgOffsetInfo<span class="token punctuation">,</span> orderCountInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‹‰å–è¯·æ±‚æŒ‡å®šäº†é˜Ÿåˆ—ï¼Œæ‹‰å–å¯¹åº”çš„é˜Ÿåˆ—</span>
        <span class="token keyword">int</span> queueId <span class="token operator">=</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        restNum <span class="token operator">=</span> <span class="token function">popMsgFromQueue</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> getMessageResult<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> restNum<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> channel<span class="token punctuation">,</span>
                                  popTime<span class="token punctuation">,</span> messageFilter<span class="token punctuation">,</span>
                                  startOffsetInfo<span class="token punctuation">,</span> msgOffsetInfo<span class="token punctuation">,</span> orderCountInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœå‰é¢æ‹‰å–æ™®é€šæ¶ˆæ¯ä¹‹åï¼Œæ²¡æœ‰æ»¡ï¼Œåˆ™å†æ‹‰å–ä¸€æ¬¡é‡è¯•æ¶ˆæ¯</span>
    <span class="token comment">// if not full , fetch retry again</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needRetry <span class="token operator">&amp;&amp;</span> getMessageResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> requestHeader<span class="token punctuation">.</span><span class="token function">getMaxMsgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requestHeader<span class="token punctuation">.</span><span class="token function">isOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TopicConfig</span> retryTopicConfig <span class="token operator">=</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTopicConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectTopicConfig</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildPopRetryTopic</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTopicConfig <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> retryTopicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> queueId <span class="token operator">=</span> <span class="token punctuation">(</span>randomQ <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> retryTopicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                restNum <span class="token operator">=</span> <span class="token function">popMsgFromQueue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> getMessageResult<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> restNum<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span>
                                          channel<span class="token punctuation">,</span> popTime<span class="token punctuation">,</span> messageFilter<span class="token punctuation">,</span>
                                          startOffsetInfo<span class="token punctuation">,</span> msgOffsetInfo<span class="token punctuation">,</span> orderCountInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ‹‰å–æ¶ˆæ¯æˆåŠŸ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>getMessageResult<span class="token punctuation">.</span><span class="token function">getMessageBufferList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        getMessageResult<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">FOUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>restNum <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// all queue pop can not notify specified queue pop, and vice versa</span>
            <span class="token function">notifyMessageArriving</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ²¡æœ‰æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œé•¿è½®è¯¢</span>
        <span class="token keyword">int</span> pollingResult <span class="token operator">=</span> <span class="token function">polling</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> request<span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">POLLING_SUC</span> <span class="token operator">==</span> pollingResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">POLLING_FULL</span> <span class="token operator">==</span> pollingResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">POLLING_FULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">POLLING_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        getMessageResult<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MESSAGE_IN_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setInvisibleTime</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getInvisibleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setPopTime</span><span class="token punctuation">(</span>popTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setReviveQid</span><span class="token punctuation">(</span>reviveQid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setRestNum</span><span class="token punctuation">(</span>restNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setStartOffsetInfo</span><span class="token punctuation">(</span>startOffsetInfo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseHeader<span class="token punctuation">.</span><span class="token function">setMsgOffsetInfo</span><span class="token punctuation">(</span>msgOffsetInfo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">isOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> orderCountInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        responseHeader<span class="token punctuation">.</span><span class="token function">setOrderCountInfo</span><span class="token punctuation">(</span>orderCountInfo<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>getMessageResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¼ è¾“æ¶ˆæ¯</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-2-popmessageprocessor-popmsgfromqueue" tabindex="-1"><a class="header-anchor" href="#_4-2-2-popmessageprocessor-popmsgfromqueue" aria-hidden="true">#</a> 4.2.2 <code>PopMessageProcessor#popMsgFromQueue</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ POP æ¶ˆæ¯
 *
 * <span class="token keyword">@param</span> <span class="token parameter">isRetry</span> æ˜¯å¦æ˜¯é‡è¯• Topic
 * <span class="token keyword">@param</span> <span class="token parameter">getMessageResult</span>
 * <span class="token keyword">@param</span> <span class="token parameter">requestHeader</span>
 * <span class="token keyword">@param</span> <span class="token parameter">queueId</span> æ¶ˆæ¯é˜Ÿåˆ— ID
 * <span class="token keyword">@param</span> <span class="token parameter">restNum</span> é˜Ÿåˆ—å‰©ä½™æ¶ˆæ¯æ•°é‡
 * <span class="token keyword">@param</span> <span class="token parameter">reviveQid</span> å”¤é†’é˜Ÿåˆ— ID
 * <span class="token keyword">@param</span> <span class="token parameter">channel</span> Netty Channelï¼Œç”¨äºè·å–å®¢æˆ·ç«¯ hostï¼Œæ¥æäº¤æ¶ˆè´¹è¿›åº¦
 * <span class="token keyword">@param</span> <span class="token parameter">popTime</span> Pop æ—¶é—´
 * <span class="token keyword">@param</span> <span class="token parameter">messageFilter</span>
 * <span class="token keyword">@param</span> <span class="token parameter">startOffsetInfo</span> è·å– Pop çš„èµ·å§‹åç§»é‡
 * <span class="token keyword">@param</span> <span class="token parameter">msgOffsetInfo</span> è·å–æ‰€æœ‰ Pop çš„æ¶ˆæ¯çš„é€»è¾‘åç§»é‡
 * <span class="token keyword">@param</span> <span class="token parameter">orderCountInfo</span>
 * <span class="token keyword">@return</span> é˜Ÿåˆ—å‰©ä½™æ¶ˆæ¯
 */</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">popMsgFromQueue</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isRetry<span class="token punctuation">,</span> <span class="token class-name">GetMessageResult</span> getMessageResult<span class="token punctuation">,</span>
                             <span class="token class-name">PopMessageRequestHeader</span> requestHeader<span class="token punctuation">,</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token keyword">long</span> restNum<span class="token punctuation">,</span> <span class="token keyword">int</span> reviveQid<span class="token punctuation">,</span>
                             <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token keyword">long</span> popTime<span class="token punctuation">,</span>
                             <span class="token class-name">ExpressionMessageFilter</span> messageFilter<span class="token punctuation">,</span> <span class="token class-name">StringBuilder</span> startOffsetInfo<span class="token punctuation">,</span>
                             <span class="token class-name">StringBuilder</span> msgOffsetInfo<span class="token punctuation">,</span> <span class="token class-name">StringBuilder</span> orderCountInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> topic <span class="token operator">=</span> isRetry <span class="token operator">?</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildPopRetryTopic</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                           requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// {TOPIC}@{GROUP}@{QUEUE_ID}</span>
    <span class="token class-name">String</span> lockKey <span class="token operator">=</span>
        topic <span class="token operator">+</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SPLIT</span> <span class="token operator">+</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SPLIT</span> <span class="token operator">+</span> queueId<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isOrder <span class="token operator">=</span> requestHeader<span class="token punctuation">.</span><span class="token function">isOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token function">getPopOffset</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Queue ä¸ŠåŠ é”ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ‹‰å–åŒä¸€ä¸ª Queue çš„æ¶ˆæ¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queueLockManager<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¿”å›è¯¥é˜Ÿåˆ—ä¸­å¾… Pop çš„æ¶ˆæ¯æ•°é‡</span>
        restNum <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span> <span class="token operator">-</span> offset <span class="token operator">+</span> restNum<span class="token punctuation">;</span>
        <span class="token keyword">return</span> restNum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è®¡ç®—è¦ POP çš„æ¶ˆæ¯åç§»é‡</span>
    offset <span class="token operator">=</span> <span class="token function">getPopOffset</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GetMessageResult</span> getMessageTmpResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// é¡ºåºæ¶ˆè´¹ï¼Œé˜»å¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isOrder <span class="token operator">&amp;&amp;</span> brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOrderInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkBlock</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>
                                                                                 requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getInvisibleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span> <span class="token operator">-</span> offset <span class="token operator">+</span> restNum<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å·²ç»æ‹‰å–åˆ°è¶³å¤Ÿçš„æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> requestHeader<span class="token punctuation">.</span><span class="token function">getMaxMsgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            restNum <span class="token operator">=</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span> <span class="token operator">-</span> offset <span class="token operator">+</span> restNum<span class="token punctuation">;</span>
            <span class="token keyword">return</span> restNum<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ä»ç£ç›˜æ¶ˆæ¯å­˜å‚¨ä¸­æ ¹æ®é€»è¾‘åç§»é‡æŸ¥è¯¢æ¶ˆæ¯</span>
        getMessageTmpResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                                                 <span class="token punctuation">,</span> topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span>
                                                                                 requestHeader<span class="token punctuation">.</span><span class="token function">getMaxMsgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> getMessageResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageTmpResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span> <span class="token operator">-</span> offset <span class="token operator">+</span> restNum<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// maybe store offset is not correct.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_TOO_SMALL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_OVERFLOW_BADLY</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_FOUND_NULL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// commit offset, because the offset is not correct</span>
            <span class="token comment">// If offset in store is greater than cq offset, it will cause duplicate messages,</span>
            <span class="token comment">// because offset in PopBuffer is not committed.</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Pop initial offset, because store is no correct, {}, {}-&gt;{}&quot;</span><span class="token punctuation">,</span>
                            lockKey<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            offset <span class="token operator">=</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitOffset</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span>
                                                                          queueId<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            getMessageTmpResult <span class="token operator">=</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span>
                                                                   queueId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span>
                                                                   requestHeader<span class="token punctuation">.</span><span class="token function">getMaxMsgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> getMessageResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è®¡ç®—é˜Ÿåˆ—è¿˜å‰©ä¸‹çš„æ¶ˆæ¯æ•°é‡</span>
        restNum <span class="token operator">=</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> restNum<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ›´æ–°ç»Ÿè®¡æ•°æ®</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incBrokerGetNums</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incGroupGetNums</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span>
                                                                          getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incGroupGetSize</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span>
                                                                          getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getBufferTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>isOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// é¡ºåºæ¶ˆè´¹ï¼Œæ›´æ–°åç§»é‡</span>
                <span class="token keyword">int</span> count <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOrderInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>
                                                                                  requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                  queueId<span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitOffset</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                              requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">buildOrderCountInfo</span><span class="token punctuation">(</span>orderCountInfo<span class="token punctuation">,</span> isRetry<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ·»åŠ  CheckPoint åˆ°å†…å­˜ï¼Œç”¨äºç­‰å¾… ACK</span>
                <span class="token function">appendCheckPoint</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">,</span> popTime<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">buildStartOffsetInfo</span><span class="token punctuation">(</span>startOffsetInfo<span class="token punctuation">,</span> isRetry<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">buildMsgOffsetInfo</span><span class="token punctuation">(</span>msgOffsetInfo<span class="token punctuation">,</span> isRetry<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span>
                                             getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_MESSAGE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_FOUND_NULL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_WAS_REMOVING</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_LOGIC_QUEUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                   <span class="token operator">&amp;&amp;</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ²¡æœ‰æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œæ·»åŠ å‡çš„æ¶ˆæ¯ CheckPoint åˆ°é˜Ÿåˆ—</span>
            popBufferMergeService<span class="token punctuation">.</span><span class="token function">addCkMock</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span>
                                            requestHeader<span class="token punctuation">.</span><span class="token function">getInvisibleTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popTime<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//                this.brokerController.getConsumerOffsetManager().commitOffset(channel.remoteAddress().toString(), requestHeader.getConsumerGroup(), topic,</span>
            <span class="token comment">//                        queueId, getMessageTmpResult.getNextBeginOffset());</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Exception in popMsgFromQueue&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// Pop å®Œåè§£é”</span>
        queueLockManager<span class="token punctuation">.</span><span class="token function">unLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å°†æ‹‰å–åˆ°çš„æ¶ˆæ¯æ”¾å…¥ç»“æœå®¹å™¨ä¸­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageTmpResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectMappedBufferResult</span> mapedBuffer <span class="token operator">:</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            getMessageResult<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>mapedBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> restNum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-3-popmessageprocessor-appendcheckpoint" tabindex="-1"><a class="header-anchor" href="#_4-2-3-popmessageprocessor-appendcheckpoint" aria-hidden="true">#</a> 4.2.3 <code>PopMessageProcessor#appendCheckPoint</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * åœ¨ POP æ‹‰å–æ¶ˆæ¯åè°ƒç”¨ï¼Œæ·»åŠ  CheckPointï¼Œç­‰å¾… ACK
 *
 * <span class="token keyword">@param</span> <span class="token parameter">requestHeader</span>
 * <span class="token keyword">@param</span> <span class="token parameter">topic</span> POP çš„ Topic
 * <span class="token keyword">@param</span> <span class="token parameter">reviveQid</span> Revive é˜Ÿåˆ— ID
 * <span class="token keyword">@param</span> <span class="token parameter">queueId</span> POP çš„é˜Ÿåˆ— ID
 * <span class="token keyword">@param</span> <span class="token parameter">offset</span> POP æ¶ˆæ¯çš„èµ·å§‹åç§»é‡
 * <span class="token keyword">@param</span> <span class="token parameter">getMessageTmpResult</span> POP ä¸€æ‰¹æ¶ˆæ¯çš„ç»“æœ
 * <span class="token keyword">@param</span> <span class="token parameter">popTime</span> POP æ—¶é—´
 * <span class="token keyword">@param</span> <span class="token parameter">brokerName</span>
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">appendCheckPoint</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">PopMessageRequestHeader</span> requestHeader<span class="token punctuation">,</span>
                              <span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> reviveQid<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span>
                              <span class="token keyword">final</span> <span class="token class-name">GetMessageResult</span> getMessageTmpResult<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> popTime<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> brokerName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// add check point msg to revive log</span>
    <span class="token keyword">final</span> <span class="token class-name">PopCheckPoint</span> ck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PopCheckPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... æ„é€  PopCheckPointï¼Œèµ‹å€¼è¿‡ç¨‹çœç•¥</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> msgQueueOffset <span class="token operator">:</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getMessageQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ·»åŠ æ‰€æœ‰æ‹‰å–çš„æ¶ˆæ¯çš„åç§»é‡ä¸èµ·å§‹åç§»é‡çš„å·®å€¼</span>
        ck<span class="token punctuation">.</span><span class="token function">addDiff</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msgQueueOffset <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å°† Offset æ”¾å…¥å†…å­˜</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> addBufferSuc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>popBufferMergeService<span class="token punctuation">.</span><span class="token function">addCk</span><span class="token punctuation">(</span>
        ck<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>addBufferSuc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ”¾å…¥å†…å­˜åŒ¹é…å¤±è´¥ï¼ˆå†…å­˜åŒ¹é…æœªå¼€å¯ï¼‰ï¼Œå°† Offset æ”¾å…¥å†…å­˜å’Œç£ç›˜</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>popBufferMergeService<span class="token punctuation">.</span><span class="token function">addCkJustOffset</span><span class="token punctuation">(</span>
        ck<span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> getMessageTmpResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-broker-ç«¯-ack-æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_4-3-broker-ç«¯-ack-æ¶ˆæ¯" aria-hidden="true">#</a> 4.3 Broker ç«¯ Ack æ¶ˆæ¯</h3><h4 id="_4-3-1-ackmessageprocessor-processrequest" tabindex="-1"><a class="header-anchor" href="#_4-3-1-ackmessageprocessor-processrequest" aria-hidden="true">#</a> 4.3.1 <code>AckMessageProcessor#processRequest</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å¤„ç† Ack æ¶ˆæ¯è¯·æ±‚ï¼Œæ¯æ¬¡ Ack ä¸€æ¡æ¶ˆæ¯
 *
 * <span class="token keyword">@param</span> <span class="token parameter">channel</span>
 * <span class="token keyword">@param</span> <span class="token parameter">request</span>
 * <span class="token keyword">@param</span> <span class="token parameter">brokerAllowSuspend</span>
 * <span class="token keyword">@return</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">RemotingCommandException</span></span>
 */</span>
<span class="token keyword">private</span> <span class="token class-name">RemotingCommand</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">,</span>
                                       <span class="token keyword">boolean</span> brokerAllowSuspend<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token comment">// è§£æè¯·æ±‚å¤´</span>
    <span class="token keyword">final</span> <span class="token class-name">AckMessageRequestHeader</span> requestHeader <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AckMessageRequestHeader</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">AckMessageRequestHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MessageExtBrokerInner</span> msgInner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageExtBrokerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AckMsg</span> ackMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AckMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RemotingCommand</span> response <span class="token operator">=</span> <span class="token class-name">RemotingCommand</span><span class="token punctuation">.</span><span class="token function">createResponseCommand</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setOpaque</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getOpaque</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... æ ¡éªŒ</span>
    
    <span class="token comment">// æ‹†åˆ†æ¶ˆæ¯å¥æŸ„å­—ç¬¦ä¸²</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> extraInfo <span class="token operator">=</span> <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getExtraInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ç”¨è¯·æ±‚å¤´ä¸­çš„ä¿¡æ¯æ„é€  AckMsg</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setAckOffset</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setStartOffset</span><span class="token punctuation">(</span><span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getCkQueueOffset</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setPopTime</span><span class="token punctuation">(</span><span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ackMsg<span class="token punctuation">.</span><span class="token function">setBrokerName</span><span class="token punctuation">(</span><span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> rqId <span class="token operator">=</span> <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getReviveQid</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incBrokerAckNums</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incGroupAckNums</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rqId <span class="token operator">==</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token constant">POP_ORDER_REVIVE_QUEUE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... é¡ºåºæ¶ˆæ¯ ACK</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ™®é€šæ¶ˆæ¯ ACK</span>
    <span class="token comment">// å…ˆå°è¯•æ”¾å…¥å†…å­˜åŒ¹é…ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚å¤±è´¥å¯èƒ½æ˜¯å†…å­˜åŒ¹é…æœªå¼€å¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getPopMessageProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopBufferMergeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAk</span><span class="token punctuation">(</span>rqId<span class="token punctuation">,</span> ackMsg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ„é€  Ack æ¶ˆæ¯</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>reviveTopic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">DataConverter</span><span class="token punctuation">.</span>charset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//msgInner.setQueueId(Integer.valueOf(extraInfo[3]));</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span>rqId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">ACK_TAG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBornTimestamp</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBornHost</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getStoreHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setStoreHost</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getStoreHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å®šæ—¶æ¶ˆæ¯ï¼Œå®šæ—¶åˆ°å”¤é†’é‡è¯•æ—¶é—´æŠ•é€’</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setDeliverTimeMs</span><span class="token punctuation">(</span><span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">ExtraInfoUtil</span><span class="token punctuation">.</span><span class="token function">getInvisibleTime</span><span class="token punctuation">(</span>extraInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">,</span> <span class="token class-name">PopMessageProcessor</span><span class="token punctuation">.</span><span class="token function">genAckUniqueId</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setPropertiesString</span><span class="token punctuation">(</span><span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">messageProperties2String</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¿å­˜ Ack æ¶ˆæ¯åˆ°ç£ç›˜</span>
    <span class="token class-name">PutMessageResult</span> putMessageResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getEscapeBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putMessageToSpecificQueue</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">PUT_OK</span>
        <span class="token operator">&amp;&amp;</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">FLUSH_DISK_TIMEOUT</span>
        <span class="token operator">&amp;&amp;</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">FLUSH_SLAVE_TIMEOUT</span>
        <span class="token operator">&amp;&amp;</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">SLAVE_NOT_AVAILABLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;put ack msg error:&quot;</span> <span class="token operator">+</span> putMessageResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-broker-ç«¯-checkpoint-ä¸-ackmsg-åŒ¹é…" tabindex="-1"><a class="header-anchor" href="#_4-4-broker-ç«¯-checkpoint-ä¸-ackmsg-åŒ¹é…" aria-hidden="true">#</a> 4.4 Broker ç«¯ <code>CheckPoint</code> ä¸ <code>AckMsg</code> åŒ¹é…</h3><h4 id="_4-4-1-popbuffermergeservice-addck" tabindex="-1"><a class="header-anchor" href="#_4-4-1-popbuffermergeservice-addck" aria-hidden="true">#</a> 4.4.1 <code>PopBufferMergeService#addCk</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * POP æ¶ˆæ¯åï¼Œæ–°å¢ CheckPointï¼Œæ”¾å…¥å†…å­˜ Buffer
 *
 * <span class="token keyword">@param</span> <span class="token parameter">point</span>
 * <span class="token keyword">@param</span> <span class="token parameter">reviveQueueId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">reviveQueueOffset</span>
 * <span class="token keyword">@param</span> <span class="token parameter">nextBeginOffset</span>
 * <span class="token keyword">@return</span> æ˜¯å¦æ·»åŠ æˆåŠŸ
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">addCk</span><span class="token punctuation">(</span><span class="token class-name">PopCheckPoint</span> point<span class="token punctuation">,</span> <span class="token keyword">int</span> reviveQueueId<span class="token punctuation">,</span> <span class="token keyword">long</span> reviveQueueOffset<span class="token punctuation">,</span> <span class="token keyword">long</span> nextBeginOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// key: point.getT() + point.getC() + point.getQ() + point.getSo() + point.getPt()</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopBufferMerge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å†…å­˜åŒ¹é…æœåŠ¡æ˜¯å¦å¼€å¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serving<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·ç¦»ä¸‹æ¬¡å¯é‡è¯• Pop æ¶ˆè´¹çš„æ—¶åˆ» &lt; 4.5s</span>
    <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now <span class="token operator">&lt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ck, timeout, {}, {}&quot;</span><span class="token punctuation">,</span> point<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkMaxBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ck, max size, {}, {}&quot;</span><span class="token punctuation">,</span> point<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">PopCheckPointWrapper</span> pointWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PopCheckPointWrapper</span><span class="token punctuation">(</span>reviveQueueId<span class="token punctuation">,</span> reviveQueueOffset<span class="token punctuation">,</span> point<span class="token punctuation">,</span> nextBeginOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkQueueOk</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å°† CheckPoint æ”¾å…¥ Offset é˜Ÿåˆ—</span>
    <span class="token function">putOffsetQueue</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å°† CheckPoint æ”¾å…¥å†…å­˜ Buffer</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getMergeKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pointWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ck, {}&quot;</span><span class="token punctuation">,</span> pointWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-2-popbuffermergeservice-addak" tabindex="-1"><a class="header-anchor" href="#_4-4-2-popbuffermergeservice-addak" aria-hidden="true">#</a> 4.4.2 <code>PopBufferMergeService#addAk</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * æ¶ˆæ¯ ACKï¼Œä¸å†…å­˜ä¸­çš„ CheckPoint åŒ¹é…
 *
 * <span class="token keyword">@param</span> <span class="token parameter">reviveQid</span>
 * <span class="token keyword">@param</span> <span class="token parameter">ackMsg</span>
 * <span class="token keyword">@return</span> æ˜¯å¦åŒ¹é…æˆåŠŸ
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">addAk</span><span class="token punctuation">(</span><span class="token keyword">int</span> reviveQid<span class="token punctuation">,</span> <span class="token class-name">AckMsg</span> ackMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœæœªå¼€å¯å†…å­˜åŒ¹é…ï¼Œç›´æ¥è¿”å›</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopBufferMerge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serving<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ ¹æ® ACK çš„æ¶ˆæ¯æ‰¾åˆ°å†…å­˜ Buffer ä¸­çš„ CheckPoint</span>
        <span class="token class-name">PopCheckPointWrapper</span> pointWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getStartOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ‰¾ä¸åˆ° CheckPoint</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ack fail, rqId={}, no ck, {}&quot;</span><span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> ackMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å†…å­˜ä¸­ä»…ä¿å­˜ Offsetï¼Œå®é™…å·²ç»ä¿å­˜åˆ°ç£ç›˜ï¼Œå†…å­˜ä¸­ä¸å¤„ç† ACK æ¶ˆæ¯çš„åŒ¹é…ï¼Œç›´æ¥è¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">isJustOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">PopCheckPoint</span> point <span class="token operator">=</span> pointWrapper<span class="token punctuation">.</span><span class="token function">getCk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now <span class="token operator">&lt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ack fail, rqId={}, almost timeout for revive, {}, {}, {}&quot;</span><span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> pointWrapper<span class="token punctuation">,</span> ackMsg<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> point<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ack fail, rqId={}, stay too long, {}, {}, {}&quot;</span><span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> pointWrapper<span class="token punctuation">,</span> ackMsg<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æ ‡è®°è¯¥ CheckPoint å·²ç»è¢« ACK</span>
        <span class="token keyword">int</span> indexOfAck <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">indexOfAck</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">.</span><span class="token function">getAckOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>indexOfAck <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è®¾ç½® CheckPoint ä¸­è¢« Ack æ¶ˆæ¯çš„ bit ç è¡¨ä¸º 1</span>
            <span class="token function">markBitCAS</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indexOfAck<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]Invalid index of ack, reviveQid={}, {}, {}&quot;</span><span class="token punctuation">,</span> reviveQid<span class="token punctuation">,</span> ackMsg<span class="token punctuation">,</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]add ack error, rqId=&quot;</span> <span class="token operator">+</span> reviveQid <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-3-popbuffermergeservice-scan" tabindex="-1"><a class="header-anchor" href="#_4-4-3-popbuffermergeservice-scan" aria-hidden="true">#</a> 4.4.3 <code>PopBufferMergeService#scan</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * æ‰«æå†…å­˜ä¸­çš„ CheckPoint
 * æŠŠå·²ç»åŒ¹é…æˆ–å­˜ç›˜çš„ CheckPoint ç§»å‡º buffer
 * æŠŠå·²ç»å…¨éƒ¨ Ack çš„ CheckPoint å­˜ç›˜
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> countCk <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PopCheckPointWrapper</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// éå†æ‰€æœ‰å†…å­˜ä¸­çš„ CheckPoint</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PopCheckPointWrapper</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PopCheckPointWrapper</span> pointWrapper <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å¦‚æœ CheckPoint å·²ç»åœ¨ç£ç›˜ä¸­ï¼Œæˆ–è€…å…¨éƒ¨æ¶ˆæ¯éƒ½åŒ¹é…æˆåŠŸï¼Œä»å†…å­˜ä¸­ buffer ä¸­ç§»é™¤</span>
        <span class="token comment">// just process offset(already stored at pull thread), or buffer ck(not stored and ack finish)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">isJustOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pointWrapper<span class="token punctuation">.</span><span class="token function">isCkStored</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isCkDone</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token function">isCkDoneForFinish</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pointWrapper<span class="token punctuation">.</span><span class="token function">isCkStored</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            counter<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">PopCheckPoint</span> point <span class="token operator">=</span> pointWrapper<span class="token punctuation">.</span><span class="token function">getCk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ˜¯å¦è¦ä»å†…å­˜ä¸­ç§»é™¤ CheckPoint</span>
        <span class="token keyword">boolean</span> removeCk <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>serving<span class="token punctuation">;</span>
        <span class="token comment">// è·ç¦» ReviveTime æ—¶é—´å°äºé˜ˆå€¼ï¼ˆé»˜è®¤3sï¼‰</span>
        <span class="token comment">// ck will be timeout</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now <span class="token operator">&lt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            removeCk <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// åœ¨å†…å­˜ä¸­æ—¶é—´å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤10sï¼‰</span>
        <span class="token comment">// the time stayed is too long</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> point<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            removeCk <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> point<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPopCkStayBufferTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]ck finish fail, stay too long, {}&quot;</span><span class="token punctuation">,</span> pointWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// double check</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCkDone</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">isJustOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// just offset should be in store.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getReviveQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">putCkToStore</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                countCk<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>removeCk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å°† CheckPoint åŒ…è£…æˆæ¶ˆæ¯æ”¾å…¥ç£ç›˜ï¼Œä»å†…å­˜ä¸­ç§»é™¤</span>
            <span class="token comment">// put buffer ak to store</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getReviveQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">putCkToStore</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                countCk<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pointWrapper<span class="token punctuation">.</span><span class="token function">isCkStored</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// åœ¨å†…å­˜ä¸­ç§»é™¤ CheckPoint å‰ï¼ŒæŠŠå®ƒå½“ä¸­å·²ç» Ack çš„æ¶ˆæ¯ä¹Ÿä½œä¸º Ack æ¶ˆæ¯å­˜å…¥ç£ç›˜</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">byte</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> point<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// éå† CheckPoint ä¸­æ¶ˆæ¯ bit ç è¡¨æ¯ä¸€ä½ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç» Ack å¹¶ä¸”æ²¡æœ‰å­˜å…¥ç£ç›˜</span>
                <span class="token comment">// reput buffer ak to store</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DataConverter</span><span class="token punctuation">.</span><span class="token function">getBit</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">DataConverter</span><span class="token punctuation">.</span><span class="token function">getBit</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getToStoreBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">putAckToStore</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        count<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token function">markBitCAS</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">.</span><span class="token function">getToStoreBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCkDoneForFinish</span><span class="token punctuation">(</span>pointWrapper<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pointWrapper<span class="token punctuation">.</span><span class="token function">isCkStored</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[PopBuffer]ck finish, {}&quot;</span><span class="token punctuation">,</span> pointWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                counter<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ‰«æå·²ç»å®Œæˆçš„ CheckPointï¼Œä¸ºå®ƒä»¬æäº¤æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦</span>
    <span class="token keyword">int</span> offsetBufferSize <span class="token operator">=</span> <span class="token function">scanCommitOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    scanTimes<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>scanTimes <span class="token operator">&gt;=</span> countOfMinute1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        counter<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scanTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="_4-4-4-popreviveservice-consumerevivemessage" tabindex="-1"><a class="header-anchor" href="#_4-4-4-popreviveservice-consumerevivemessage" aria-hidden="true">#</a> 4.4.4 <code>PopReviveService#consumeReviveMessage</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * æ¶ˆè´¹ Revive Topic ä¸­çš„æ¶ˆæ¯ï¼ŒåŒ¹é… ACK æ¶ˆæ¯å’Œ CheckPoint
 * CK æ¶ˆæ¯æ”¾åˆ° Map ä¸­ï¼ŒACK æ¶ˆæ¯æ ¹æ® Map key åŒ¹é… CK æ¶ˆæ¯ï¼Œæ›´æ–° CK æ¶ˆæ¯çš„ç è¡¨ä»¥å®Œæˆ ACK
 * åªå¯¹ CK è¿›è¡Œæ ‡è®°
 * æ¶ˆè´¹æ—¶é—´å·® 2s å†…çš„ CKã€ACK æ¶ˆæ¯ï¼Œæˆ– 4s æ²¡æœ‰æ¶ˆè´¹åˆ°æ–°æ¶ˆæ¯
 *
 * <span class="token keyword">@param</span> <span class="token parameter">consumeReviveObj</span> CK ä¸ ACK åŒ¹é…å¯¹è±¡ï¼Œç”¨äº Revive éœ€è¦é‡è¯• Pop æ¶ˆè´¹çš„æ¶ˆæ¯
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">consumeReviveMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumeReviveObj</span> consumeReviveObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// CheckPoint åŒ¹é… mapï¼Œkey = point.getTopic() + point.getCId() + point.getQueueId() + point.getStartOffset() + point.getPopTime()</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PopCheckPoint</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> consumeReviveObj<span class="token punctuation">.</span>map<span class="token punctuation">;</span>
    <span class="token keyword">long</span> startScanTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// æŸ¥è¯¢ ReviveTopic queue ä¹‹å‰çš„æ¶ˆè´¹è¿›åº¦</span>
    <span class="token keyword">long</span> oldOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">queryOffset</span><span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">REVIVE_GROUP</span><span class="token punctuation">,</span> reviveTopic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumeReviveObj<span class="token punctuation">.</span>oldOffset <span class="token operator">=</span> oldOffset<span class="token punctuation">;</span>
    <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={}, old offset is {} &quot;</span><span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> oldOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> offset <span class="token operator">=</span> oldOffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// æ²¡æœ‰æŸ¥è¯¢åˆ°æ¶ˆæ¯çš„æ¬¡æ•°</span>
    <span class="token keyword">int</span> noMsgCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> firstRt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// offset self amend</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldRunPopRevive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;slave skip scan , revive topic={}, reviveQueueId={}&quot;</span><span class="token punctuation">,</span> reviveTopic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æŸ¥è¯¢ä¸€æ‰¹ Revive Topic ä¸­çš„æ¶ˆæ¯ï¼ˆ32æ¡ï¼‰</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> messageExts <span class="token operator">=</span> <span class="token function">getReviveMessage</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExts <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> messageExts<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> old <span class="token operator">=</span> endTime<span class="token punctuation">;</span>
            <span class="token keyword">long</span> timerDelay <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimerMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReadBehind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> commitLogDelay <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimerMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnqueueBehind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// move endTime</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>endTime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> endTime <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SECOND</span> <span class="token operator">&amp;&amp;</span> timerDelay <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> commitLogDelay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={}, offset is {}, can not get new msg, old endTime {}, new endTime {}&quot;</span><span class="token punctuation">,</span>
                            queueId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> old<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æœ€åä¸€ä¸ª CK çš„å”¤é†’æ—¶é—´ä¸ç¬¬ä¸€ä¸ª CK çš„å”¤é†’æ—¶é—´å·®å¤§äº 2sï¼Œä¸­æ–­æ¶ˆè´¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> firstRt <span class="token operator">&gt;</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span>ackTimeInterval <span class="token operator">+</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SECOND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            noMsgCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">// Fixme: why sleep is useful here?</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è¿ç»­ 4s æ²¡æœ‰æ¶ˆè´¹åˆ°æ–°çš„æ¶ˆæ¯ï¼Œä¸­æ–­æ¶ˆè´¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>noMsgCount <span class="token operator">*</span> <span class="token number">100L</span> <span class="token operator">&gt;</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SECOND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            noMsgCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startScanTime <span class="token operator">&gt;</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReviveScanTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={}, scan timeout  &quot;</span><span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// éå†æŸ¥è¯¢åˆ°çš„æ¶ˆæ¯</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageExt</span> messageExt <span class="token operator">:</span> messageExts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">CK_TAG</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœæ˜¯ CheckPoint</span>
                <span class="token class-name">String</span> raw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DataConverter</span><span class="token punctuation">.</span>charset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},find ck, offset:{}, raw : {}&quot;</span><span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">PopCheckPoint</span> point <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> <span class="token class-name">PopCheckPoint</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> point<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// æ”¾å…¥ HashMapï¼Œç­‰å¾… ACK æ¶ˆæ¯åŒ¹é…</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> point<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> point<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> point<span class="token punctuation">.</span><span class="token function">getStartOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> point<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è®¾ç½® reviveOffset ä¸º revive é˜Ÿåˆ—ä¸­æ¶ˆæ¯çš„é€»è¾‘ offset</span>
                point<span class="token punctuation">.</span><span class="token function">setReviveOffset</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    firstRt <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">ACK_TAG</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœæ˜¯ ACK æ¶ˆæ¯</span>
                <span class="token class-name">String</span> raw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DataConverter</span><span class="token punctuation">.</span>charset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},find ack, offset:{}, raw : {}&quot;</span><span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">AckMsg</span> ackMsg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> <span class="token class-name">AckMsg</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">PopCheckPoint</span> point <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getStartOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackMsg<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>point <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// å¦‚æœ HashMap ä¸­æœ‰ CheckPointï¼Œè®¡ç®— ACK çš„ bit ç è¡¨</span>
                <span class="token keyword">int</span> indexOfAck <span class="token operator">=</span> point<span class="token punctuation">.</span><span class="token function">indexOfAck</span><span class="token punctuation">(</span>ackMsg<span class="token punctuation">.</span><span class="token function">getAckOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>indexOfAck <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Ack æ¶ˆæ¯ bit ç è¡¨ä¸º 1 çš„ä½ Ack æˆåŠŸ</span>
                    point<span class="token punctuation">.</span><span class="token function">setBitMap</span><span class="token punctuation">(</span><span class="token class-name">DataConverter</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getBitMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indexOfAck<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;invalid ack index, {}, {}&quot;</span><span class="token punctuation">,</span> ackMsg<span class="token punctuation">,</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">long</span> deliverTime <span class="token operator">=</span> messageExt<span class="token punctuation">.</span><span class="token function">getDeliverTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>deliverTime <span class="token operator">&gt;</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                endTime <span class="token operator">=</span> deliverTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        offset <span class="token operator">=</span> offset <span class="token operator">+</span> messageExts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    consumeReviveObj<span class="token punctuation">.</span>endTime <span class="token operator">=</span> endTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-5-popreviveservice-mergeandrevive" tabindex="-1"><a class="header-anchor" href="#_4-4-5-popreviveservice-mergeandrevive" aria-hidden="true">#</a> 4.4.5 <code>PopReviveService#mergeAndRevive</code></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * åŒ¹é…æ¶ˆè´¹åˆ°çš„ä¸€æ‰¹ CK å’Œ ACK æ¶ˆæ¯ï¼Œå¯¹äºæ²¡æœ‰æˆåŠŸ ACK çš„æ¶ˆæ¯ï¼Œé‡å‘åˆ°é‡è¯• Topic
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">mergeAndRevive</span><span class="token punctuation">(</span><span class="token class-name">ConsumeReviveObj</span> consumeReviveObj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–æ’åºåçš„ CheckPoint åˆ—è¡¨</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PopCheckPoint</span><span class="token punctuation">&gt;</span></span> sortList <span class="token operator">=</span> consumeReviveObj<span class="token punctuation">.</span><span class="token function">genSortList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
    <span class="token keyword">long</span> newOffset <span class="token operator">=</span> consumeReviveObj<span class="token punctuation">.</span>oldOffset<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PopCheckPoint</span> popCheckPoint <span class="token operator">:</span> sortList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// å¦‚æœæ²¡æœ‰åˆ° Revive æ—¶é—´ï¼Œè·³è¿‡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>consumeReviveObj<span class="token punctuation">.</span>endTime <span class="token operator">-</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span>ackTimeInterval <span class="token operator">+</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">SECOND</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ä» CK ä¸­è§£æåŸ Topic å¹¶æ£€æŸ¥è¯¥ Topic æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è·³è¿‡</span>
        <span class="token comment">// check normal topic, skip ck , if normal topic is not exist</span>
        <span class="token class-name">String</span> normalTopic <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">parseNormalTopic</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getTopicConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectTopicConfig</span><span class="token punctuation">(</span>normalTopic<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},can not get normal topic {} , then continue &quot;</span><span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newOffset <span class="token operator">=</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getReviveOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> brokerController<span class="token punctuation">.</span><span class="token function">getSubscriptionGroupManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findSubscriptionGroupConfig</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},can not get cid {} , then continue &quot;</span><span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            newOffset <span class="token operator">=</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getReviveOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// é‡å‘ CK ä¸­æ²¡æœ‰ Ack çš„æ‰€æœ‰æ¶ˆæ¯</span>
        <span class="token function">reviveMsgFromCk</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

        newOffset <span class="token operator">=</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getReviveOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// åŒ¹é…å’Œé‡è¯•å®Œæˆåï¼Œæ›´æ–° ReviveTopic æ¶ˆè´¹è¿›åº¦</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newOffset <span class="token operator">&gt;</span> consumeReviveObj<span class="token punctuation">.</span>oldOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldRunPopRevive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;slave skip commit, revive topic={}, reviveQueueId={}&quot;</span><span class="token punctuation">,</span> reviveTopic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitOffset</span><span class="token punctuation">(</span><span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">LOCAL_HOST</span><span class="token punctuation">,</span> <span class="token class-name">PopAckConstants</span><span class="token punctuation">.</span><span class="token constant">REVIVE_GROUP</span><span class="token punctuation">,</span> reviveTopic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> newOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    consumeReviveObj<span class="token punctuation">.</span>newOffset <span class="token operator">=</span> newOffset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-6-popreviveservice-é‡è¯•æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_4-4-6-popreviveservice-é‡è¯•æ¶ˆæ¯" aria-hidden="true">#</a> 4.4.6 <code>PopReviveService</code>: é‡è¯•æ¶ˆæ¯</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * é‡å‘ CK ä¸­æ²¡æœ‰ Ack çš„æ‰€æœ‰æ¶ˆæ¯
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reviveMsgFromCk</span><span class="token punctuation">(</span><span class="token class-name">PopCheckPoint</span> popCheckPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// éå† CK ä¸­çš„æ‰€æœ‰æ¶ˆæ¯</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DataConverter</span><span class="token punctuation">.</span><span class="token function">getBit</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getBitMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// retry msg</span>
        <span class="token keyword">long</span> msgOffset <span class="token operator">=</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">ackOffsetByIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æŸ¥è¯¢ CK æ¶ˆæ¯å¯¹åº”çš„çœŸæ­£æ¶ˆæ¯</span>
        <span class="token class-name">MessageExt</span> messageExt <span class="token operator">=</span> <span class="token function">getBizMessage</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgOffset<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},can not get biz msg topic is {}, offset is {} , then continue &quot;</span><span class="token punctuation">,</span>
                            queueId<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//skip ck from last epoch</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> messageExt<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},skip ck from last epoch {}&quot;</span><span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å”¤é†’æ²¡æœ‰è¢« ACK çš„æ¶ˆæ¯ï¼Œå‘åˆ°é‡è¯•é˜Ÿåˆ—</span>
        <span class="token function">reviveRetry</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">,</span> messageExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * æ ¹æ® CheckPoint å”¤é†’æ²¡æœ‰è¢« ACK çš„æ¶ˆæ¯ï¼Œå‘åˆ°é‡è¯•é˜Ÿåˆ—
 *
 * <span class="token keyword">@param</span> <span class="token parameter">popCheckPoint</span> CK
 * <span class="token keyword">@param</span> <span class="token parameter">messageExt</span> è¦è¢«é‡è¯•çš„æ¶ˆæ¯
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reviveRetry</span><span class="token punctuation">(</span><span class="token class-name">PopCheckPoint</span> popCheckPoint<span class="token punctuation">,</span> <span class="token class-name">MessageExt</span> messageExt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldRunPopRevive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;slave skip retry , revive topic={}, reviveQueueId={}&quot;</span><span class="token punctuation">,</span> reviveTopic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ„é€ æ–°çš„æ¶ˆæ¯</span>
    <span class="token class-name">MessageExtBrokerInner</span> msgInner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageExtBrokerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å”¤é†’çš„æ¶ˆæ¯å‘åˆ°é‡è¯• Topic</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msgInner<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildPopRetryTopic</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        msgInner<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msgInner<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBornTimestamp</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setBornHost</span><span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getStoreHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setStoreHost</span><span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getStoreHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é‡è¯•æ¬¡æ•° += 1</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setReconsumeTimes</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_FIRST_POP_TIME</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_FIRST_POP_TIME</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getPopTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setPropertiesString</span><span class="token punctuation">(</span><span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">messageProperties2String</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ·»åŠ  Pop é‡è¯• Topic</span>
    <span class="token function">addRetryTopicIfNoExit</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¿å­˜é‡è¯•æ¶ˆæ¯åˆ°å­˜å‚¨</span>
    <span class="token class-name">PutMessageResult</span> putMessageResult <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getEscapeBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putMessageToSpecificQueue</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePopLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">POP_LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId={},retry msg , ck={}, msg queueId {}, offset {}, reviveDelay={}, result is {} &quot;</span><span class="token punctuation">,</span>
                        queueId<span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getReviveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">,</span> putMessageResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>putMessageResult<span class="token punctuation">.</span><span class="token function">getAppendMessageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getAppendMessageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">AppendMessageStatus</span><span class="token punctuation">.</span><span class="token constant">PUT_OK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;reviveQueueId=&quot;</span> <span class="token operator">+</span> queueId <span class="token operator">+</span> <span class="token string">&quot;,revive error ,msg is :&quot;</span> <span class="token operator">+</span> msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ... æ›´æ–°ç»Ÿè®¡æ•°æ®</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getPopMessageProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        brokerController<span class="token punctuation">.</span><span class="token function">getPopMessageProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifyMessageArriving</span><span class="token punctuation">(</span>
            <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">parseNormalTopic</span><span class="token punctuation">(</span>popCheckPoint<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            popCheckPoint<span class="token punctuation">.</span><span class="token function">getCId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">-</span><span class="token number">1</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å‚è€ƒèµ„æ–™" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™" aria-hidden="true">#</a> å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://github.com/apache/rocketmq/wiki/%5BRIP-19%5D-Server-side-rebalance,--lightweight-consumer-client-support" target="_blank" rel="noopener noreferrer">[RIP 19] Server side rebalance, lightweight consumer client support<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://developer.aliyun.com/article/801815" target="_blank" rel="noopener noreferrer">RocketMQ 5.0 POP æ¶ˆè´¹æ¨¡å¼æ¢ç§˜<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><hr><p>æ¬¢è¿å…³æ³¨å…¬ä¼—å·ã€æ¶ˆæ¯ä¸­é—´ä»¶ã€‘ï¼ˆmiddleware-mqï¼‰ï¼Œæ›´æ–°æ¶ˆæ¯ä¸­é—´ä»¶çš„æºç è§£æå’Œæœ€æ–°åŠ¨æ€ï¼</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202205170102971.jpg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/HScarb/knowledge/edit/main/docs/src/rocketmq/20221212-rocketmq-consumer-7-pop-consume.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: jjhfen00@163.com">ScarbWin</span>,<!--]--><!--[--><span class="contributor" title="email: jjhfen00@163.com">Scarb</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">é»˜è®¤é¡µè„š</div><div class="vp-copyright">Copyright Â© 2025 Scarb</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-630f6f47.js" defer></script>
  </body>
</html>
