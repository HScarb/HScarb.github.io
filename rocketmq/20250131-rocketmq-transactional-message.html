<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.66" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html"><meta property="og:site_name" content="é‡‘ç”²è™«çš„åšå®¢"><meta property="og:title" content="RocketMQ äº‹åŠ¡æ¶ˆæ¯åŸç†è¯¦è§£ & æºç è§£æ"><meta property="og:description" content="åŸæ–‡åœ°å€ï¼šhttp://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html (http://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html) 1. èƒŒæ™¯ åœ¨å½“ä¸‹çš„äº’è”ç½‘æ—¶..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-02-19T13:50:50.000Z"><meta property="article:author" content="Scarb"><meta property="article:published_time" content="2025-01-31T00:00:00.000Z"><meta property="article:modified_time" content="2025-02-19T13:50:50.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"RocketMQ äº‹åŠ¡æ¶ˆæ¯åŸç†è¯¦è§£ & æºç è§£æ","image":[""],"datePublished":"2025-01-31T00:00:00.000Z","dateModified":"2025-02-19T13:50:50.000Z","author":[{"@type":"Person","name":"Scarb"}]}</script><title>RocketMQ äº‹åŠ¡æ¶ˆæ¯åŸç†è¯¦è§£ & æºç è§£æ | é‡‘ç”²è™«çš„åšå®¢</title><meta name="description" content="åŸæ–‡åœ°å€ï¼šhttp://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html (http://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html) 1. èƒŒæ™¯ åœ¨å½“ä¸‹çš„äº’è”ç½‘æ—¶...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-e6f2d601.css" as="style"><link rel="stylesheet" href="/assets/style-e6f2d601.css">
    <link rel="modulepreload" href="/assets/app-58204090.js"><link rel="modulepreload" href="/assets/20250131-rocketmq-transactional-message.html-859aaa1b.js"><link rel="modulepreload" href="/assets/20250131-rocketmq-transactional-message.html-e19a7a5a.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/index.html-102bf403.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-6f333d07.js" as="script"><link rel="prefetch" href="/assets/20230530-lxf-java-note.html-9300be95.js" as="script"><link rel="prefetch" href="/assets/20230815-mockito-note.html-c2258399.js" as="script"><link rel="prefetch" href="/assets/20240827-reactor-java.html-fe9c28ac.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-cac7204c.js" as="script"><link rel="prefetch" href="/assets/index.html-f508c123.js" as="script"><link rel="prefetch" href="/assets/20191229-vim-note.html-b4a3cd68.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-d3e5eb48.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-7a801a5e.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-51122c83.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-0922cff0.js" as="script"><link rel="prefetch" href="/assets/20230813-lxf-js-note.html-82465167.js" as="script"><link rel="prefetch" href="/assets/20230820-powerjob.html-b9352ef3.js" as="script"><link rel="prefetch" href="/assets/20231015-consistent-hash.html-07b06be4.js" as="script"><link rel="prefetch" href="/assets/20241216-wow-restoration-druid-mythic-guide.html-78b5db66.js" as="script"><link rel="prefetch" href="/assets/99991231-ryf-ts-note.html-730cf657.js" as="script"><link rel="prefetch" href="/assets/index.html-f1d1b9ba.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-5756ebfa.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-59cfb351.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-7fe5f428.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-9de184dd.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-bb235715.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-e29ec945.js" as="script"><link rel="prefetch" href="/assets/20231016-rabbitmq-consistent-hash-exchange.html-6e2e8f6d.js" as="script"><link rel="prefetch" href="/assets/index.html-8e2b67a8.js" as="script"><link rel="prefetch" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-90c27f1b.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-2023d209.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-5de0a873.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-ae13da53.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-1ec85a19.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-e7fef9e4.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-b65d2e82.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-591b00dc.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-00247a89.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-7e15b5f8.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-b701d200.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-f9dc2d19.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-873655ea.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-7b285f6b.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-5f11b114.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-da9eb2ad.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-63ba6675.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-f3b1dd76.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-33d17a44.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-4da4a69a.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-7510810a.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-071340e5.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-f07feea0.js" as="script"><link rel="prefetch" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-650cf515.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-ff9830f7.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-26409d59.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-53d9ae69.js" as="script"><link rel="prefetch" href="/assets/20230808-rocketmq-timer.html-ee37a256.js" as="script"><link rel="prefetch" href="/assets/20240429-rocketmq-tieredstore.html-7d2652e2.js" as="script"><link rel="prefetch" href="/assets/20250204-rocketmq-dledger-leader-election.html-d0be5431.js" as="script"><link rel="prefetch" href="/assets/20250315-rocketmq-dledger-log-replication.html-8402d8c4.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-ddc41950.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-f220a3ec.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-79144a64.js" as="script"><link rel="prefetch" href="/assets/index.html-ccdf7995.js" as="script"><link rel="prefetch" href="/assets/404.html-8b9ee051.js" as="script"><link rel="prefetch" href="/assets/index.html-93211df9.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-5a8e9f7a.js" as="script"><link rel="prefetch" href="/assets/20230530-lxf-java-note.html-08c42556.js" as="script"><link rel="prefetch" href="/assets/20230815-mockito-note.html-c6e2b7aa.js" as="script"><link rel="prefetch" href="/assets/20240827-reactor-java.html-9f749db9.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-90c6834a.js" as="script"><link rel="prefetch" href="/assets/index.html-a1409058.js" as="script"><link rel="prefetch" href="/assets/20191229-vim-note.html-3cb72a58.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-a86d15ba.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-d080065a.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-4df91c45.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-b77fcd7c.js" as="script"><link rel="prefetch" href="/assets/20230813-lxf-js-note.html-eaf1a6b7.js" as="script"><link rel="prefetch" href="/assets/20230820-powerjob.html-251eed60.js" as="script"><link rel="prefetch" href="/assets/20231015-consistent-hash.html-c24475cd.js" as="script"><link rel="prefetch" href="/assets/20241216-wow-restoration-druid-mythic-guide.html-e7240a19.js" as="script"><link rel="prefetch" href="/assets/99991231-ryf-ts-note.html-2975463f.js" as="script"><link rel="prefetch" href="/assets/index.html-9ebc6945.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-858a0383.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-0630f7ab.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-c3d0ae51.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-a8a88e9f.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-b3961710.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-268544ec.js" as="script"><link rel="prefetch" href="/assets/20231016-rabbitmq-consistent-hash-exchange.html-227cab5a.js" as="script"><link rel="prefetch" href="/assets/index.html-9d4ec194.js" as="script"><link rel="prefetch" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-1b31018d.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-1e9b43e7.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-7ccda5a5.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-34d7890b.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-97bb621c.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-dcf49d86.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-13c02475.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-6462c745.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-6abd08ae.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-448c6e28.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-1cc3f55f.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-8dc2f504.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-4ef80ecd.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-9b818d2a.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-bf48ff9a.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-d99eddd6.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-28c333da.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-1096ba8f.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-95224230.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-fd8a5661.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-582b9ec4.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-d18be43e.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-14909c18.js" as="script"><link rel="prefetch" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-579f48a4.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-290f3979.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-14c44cf0.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-1e908e7d.js" as="script"><link rel="prefetch" href="/assets/20230808-rocketmq-timer.html-c6bb57f4.js" as="script"><link rel="prefetch" href="/assets/20240429-rocketmq-tieredstore.html-b33650d7.js" as="script"><link rel="prefetch" href="/assets/20250204-rocketmq-dledger-leader-election.html-344683e2.js" as="script"><link rel="prefetch" href="/assets/20250315-rocketmq-dledger-log-replication.html-373a7ec6.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-69396426.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-3445843d.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-6f48b630.js" as="script"><link rel="prefetch" href="/assets/index.html-9d89b6d6.js" as="script"><link rel="prefetch" href="/assets/404.html-081c3b90.js" as="script"><link rel="prefetch" href="/assets/giscus-0b7adcf8.js" as="script"><link rel="prefetch" href="/assets/auto-712ff3ee.js" as="script"><link rel="prefetch" href="/assets/index-2bf332f6.js" as="script"><link rel="prefetch" href="/assets/flowchart-c441f34d.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-d3d33a2d.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-abe06b83.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-122a014a.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-5794cde2.js" as="script"><link rel="prefetch" href="/assets/SearchResult-481ca63f.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><img class="vp-nav-logo" src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/scarb/scarb.jpg" alt="é‡‘ç”²è™«çš„åšå®¢"><!----><span class="vp-site-name hide-in-pad">é‡‘ç”²è™«çš„åšå®¢</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/"><!---->Home<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link active" href="/rocketmq/"><!---->RocketMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/rabbitmq/"><!---->RabbitMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/java/"><!---->Java<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/other/"><!---->Other<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Follow Me"><span class="title"><!---->Follow Me</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="https://github.com/HScarb" rel="noopener noreferrer" target="_blank" aria-label="Github" class="nav-link"><!---->Github<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://juejin.cn/user/219558057345111/posts" rel="noopener noreferrer" target="_blank" aria-label="æ˜é‡‘" class="nav-link"><!---->æ˜é‡‘<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/HScarb/knowledge" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->RocketMQ äº‹åŠ¡æ¶ˆæ¯åŸç†è¯¦è§£ &amp; æºç è§£æ</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Scarb</span></span><span property="author" content="Scarb"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2025-01-31T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 28 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT28M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_1-èƒŒæ™¯">1. èƒŒæ™¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_2-ä½¿ç”¨ç¤ºä¾‹">2. ä½¿ç”¨ç¤ºä¾‹</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-1-åˆ›å»ºäº‹åŠ¡-topic">2.1 åˆ›å»ºäº‹åŠ¡ Topic</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-2-å®ç°äº‹åŠ¡æ¶ˆæ¯æœ¬åœ°æ‰§è¡Œå’Œå›æŸ¥é€»è¾‘">2.2 å®ç°äº‹åŠ¡æ¶ˆæ¯æœ¬åœ°æ‰§è¡Œå’Œå›æŸ¥é€»è¾‘</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-3-äº‹åŠ¡æ¶ˆæ¯ç”Ÿäº§è€…">2.3 äº‹åŠ¡æ¶ˆæ¯ç”Ÿäº§è€…</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-4-æ¶ˆè´¹è€…">2.4 æ¶ˆè´¹è€…</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-5-è¿è¡Œç»“æœ">2.5 è¿è¡Œç»“æœ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_3-æ¦‚è¦è®¾è®¡">3. æ¦‚è¦è®¾è®¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_4-åŸç†è¯¦è§£">4. åŸç†è¯¦è§£</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-1-äº‹åŠ¡æ¶ˆæ¯å‘é€">4.1 äº‹åŠ¡æ¶ˆæ¯å‘é€</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-2-äº‹åŠ¡çŠ¶æ€å›æŸ¥">4.2 äº‹åŠ¡çŠ¶æ€å›æŸ¥</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_5-æºç è§£æ">5. æºç è§£æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_5-1-äº‹åŠ¡æ¶ˆæ¯å‘é€">5.1 äº‹åŠ¡æ¶ˆæ¯å‘é€</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_5-2-äº‹åŠ¡çŠ¶æ€å›æŸ¥">5.2 äº‹åŠ¡çŠ¶æ€å›æŸ¥</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>åŸæ–‡åœ°å€ï¼š<a href="http://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html" target="_blank" rel="noopener noreferrer">http://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h1 id="rocketmq-äº‹åŠ¡æ¶ˆæ¯åŸç†è¯¦è§£-æºç è§£æ" tabindex="-1"><a class="header-anchor" href="#rocketmq-äº‹åŠ¡æ¶ˆæ¯åŸç†è¯¦è§£-æºç è§£æ" aria-hidden="true">#</a> RocketMQ äº‹åŠ¡æ¶ˆæ¯åŸç†è¯¦è§£ &amp; æºç è§£æ</h1><h2 id="_1-èƒŒæ™¯" tabindex="-1"><a class="header-anchor" href="#_1-èƒŒæ™¯" aria-hidden="true">#</a> 1. èƒŒæ™¯</h2><p>åœ¨å½“ä¸‹çš„äº’è”ç½‘æ—¶ä»£ï¼Œå¾®æœåŠ¡æ¶æ„å…´èµ·ï¼Œä¸šåŠ¡é‡ä¹Ÿè¾¾åˆ°äº†æƒŠäººçš„é‡çº§ã€‚æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºå¾®æœåŠ¡æ¶æ„è§£è€¦ã€æµé‡å‰Šå³°ã€å¼‚æ­¥å¤„ç†ç­‰çš„é‡è¦ç»„ä»¶ï¼Œæˆä¸ºäº†å¾®æœåŠ¡æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚</p><p>äº‹åŠ¡æŒ‡çš„æ˜¯ä¸€ç³»åˆ—æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œäº‹åŠ¡åœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ä¹Ÿæœ‰å¤§è§„æ¨¡çš„åº”ç”¨ã€‚å½“æ¶‰åŠåˆ°äº‹åŠ¡ç›¸å…³çš„ç³»ç»Ÿæ¨¡å—æ—¶ï¼Œæ™®é€šæ¶ˆæ¯æ— æ³•æ»¡è¶³â€œæœ¬åœ°æ“ä½œå’Œæ¶ˆæ¯å‘é€â€è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥çš„éœ€æ±‚ï¼Œå› æ­¤æœ‰äº†äº‹åŠ¡æ¶ˆæ¯çš„éœ€æ±‚ã€‚</p><p>RocketMQ åœ¨ 4.3.0 ç‰ˆæœ¬å¼€å§‹æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡æ¶ˆæ¯ã€‚RocketMQ çš„äº‹åŠ¡æ¶ˆæ¯åœ¨æ™®é€šæ¶ˆæ¯åŸºç¡€ä¸Šï¼Œæ”¯æŒäºŒé˜¶æ®µçš„æäº¤èƒ½åŠ›ã€‚å°†äºŒé˜¶æ®µæäº¤å’Œæœ¬åœ°äº‹åŠ¡ç»‘å®šï¼Œå®ç°å…¨å±€æäº¤ç»“æœçš„ä¸€è‡´æ€§ã€‚</p><p>æœ¬æ–‡å°†åŸºäº RocketMQ 5.3.x æºç ï¼Œåˆ†æ RocketMQ äº‹åŠ¡æ¶ˆæ¯çš„å®ç°åŸç†ã€‚</p><h2 id="_2-ä½¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_2-ä½¿ç”¨ç¤ºä¾‹" aria-hidden="true">#</a> 2. ä½¿ç”¨ç¤ºä¾‹</h2><p>æœ¬ç¤ºä¾‹ä½¿ç”¨ RocketMQ 4.x çš„ Java å®¢æˆ·ç«¯å®ç°ã€‚</p><h3 id="_2-1-åˆ›å»ºäº‹åŠ¡-topic" tabindex="-1"><a class="header-anchor" href="#_2-1-åˆ›å»ºäº‹åŠ¡-topic" aria-hidden="true">#</a> 2.1 åˆ›å»ºäº‹åŠ¡ Topic</h3><p>äº‹å…ˆåˆ›å»ºå¥½ä¸€ä¸ª Topic ç”¨ä½œäº‹åŠ¡æ¶ˆæ¯æ¥æ”¶ã€‚RocketMQ 5.x ç‰ˆæœ¬ä¹‹åï¼Œéœ€è¦åœ¨åˆ›å»º Topic æ—¶æŒ‡å®šæ¶ˆæ¯ç±»å‹ï¼Œè¿™é‡Œåˆ›å»ºä¸€ä¸ª <code>TRANSACTION</code> ç±»å‹çš„ Topicã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./bin/mqadmin updatetopic <span class="token parameter variable">-n</span> localhost:9876 <span class="token parameter variable">-t</span> TopicTest1234 <span class="token parameter variable">-c</span> DefaultCluster <span class="token parameter variable">-a</span> +message.type<span class="token operator">=</span>TRANSACTION
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-2-å®ç°äº‹åŠ¡æ¶ˆæ¯æœ¬åœ°æ‰§è¡Œå’Œå›æŸ¥é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#_2-2-å®ç°äº‹åŠ¡æ¶ˆæ¯æœ¬åœ°æ‰§è¡Œå’Œå›æŸ¥é€»è¾‘" aria-hidden="true">#</a> 2.2 å®ç°äº‹åŠ¡æ¶ˆæ¯æœ¬åœ°æ‰§è¡Œå’Œå›æŸ¥é€»è¾‘</h3><p>ç„¶åéœ€è¦å®ç° <code>TransactionListener</code> æ¥å£ï¼Œè¯¥æ¥å£æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>executeLocalTransaction</code>ï¼šæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­å¡«å†™æœ¬åœ°äº‹åŠ¡é€»è¾‘ï¼Œè¿”å› <code>LocalTransactionState</code> æšä¸¾å€¼ï¼Œè¡¨ç¤ºæœ¬åœ°äº‹åŠ¡çš„çŠ¶æ€ã€‚</li><li><code>checkLocalTransaction</code>ï¼šæ£€æŸ¥æœ¬åœ°äº‹åŠ¡ï¼Œè¿”å› <code>LocalTransactionState</code> æšä¸¾å€¼ï¼Œè¡¨ç¤ºæœ¬åœ°äº‹åŠ¡çš„çŠ¶æ€ã€‚</li></ul><p>å¦‚æœæ‰§è¡Œæœ¬åœ°äº‹åŠ¡çš„æ“ä½œç›´æ¥è¿”å› <code>LocalTransactionState.COMMIT_MESSAGE</code> æˆ– <code>LocalTransactionState.ROLLBACK_MESSAGE</code>ï¼Œåˆ™ä¸ä¼šè°ƒç”¨ <code>checkLocalTransaction</code> æ–¹æ³•ã€‚å¦‚æœè¿”å› <code>LocalTransactionState.UNKNOW</code>ï¼Œè¡¨ç¤ºæœ¬åœ°äº‹åŠ¡æš‚æ—¶æ²¡æœ‰æ‰§è¡Œå®Œï¼Œç»“æœæœªçŸ¥ï¼Œåˆ™ä¼šåœ¨åç»­è°ƒç”¨ <code>checkLocalTransaction</code> æ–¹æ³•æ¥æ£€æŸ¥æœ¬åœ°äº‹åŠ¡æ‰§è¡Œçš„çŠ¶æ€ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionListenerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TransactionListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> transactionIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> localTrans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç”¨ä½œç¤ºä¾‹ï¼Œæ¨¡æ‹Ÿ 3 ç§æœ¬åœ°äº‹åŠ¡çš„æ‰§è¡Œç»“æœ</span>
        <span class="token keyword">int</span> value <span class="token operator">=</span> transactionIndex<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> status <span class="token operator">=</span> value <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">;</span>
        localTrans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ•…æ„è¿”å› UNKNOWï¼Œæ¨¡æ‹Ÿæœ¬åœ°äº‹åŠ¡æœªæ‰§è¡Œå®Œï¼Œéœ€è¦æ‰§è¡Œäº‹åŠ¡çŠ¶æ€æ£€æŸ¥</span>
        <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ ¹æ®æœ¬åœ°äº‹åŠ¡éšæœºæ¨¡æ‹Ÿçš„ 3 ç§æ‰§è¡Œç»“æœï¼Œè¿”å›å¯¹åº”çš„æœ¬åœ°äº‹åŠ¡çŠ¶æ€</span>
        <span class="token class-name">Integer</span> status <span class="token operator">=</span> localTrans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">ROLLBACK_MESSAGE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-äº‹åŠ¡æ¶ˆæ¯ç”Ÿäº§è€…" tabindex="-1"><a class="header-anchor" href="#_2-3-äº‹åŠ¡æ¶ˆæ¯ç”Ÿäº§è€…" aria-hidden="true">#</a> 2.3 äº‹åŠ¡æ¶ˆæ¯ç”Ÿäº§è€…</h3><p>ç„¶ååˆ›å»ºä¸€ä¸ª <code>TransactionMQProducer</code> å®ä¾‹ï¼Œå¹¶è®¾ç½® <code>TransactionListener</code>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransactionListener</span> transactionListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionListenerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TransactionMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token constant">PRODUCER_GROUP</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESRVADDR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€å›æŸ¥çº¿ç¨‹æ± </span>
    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;client-transaction-msg-check-thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> thread<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    producer<span class="token punctuation">.</span><span class="token function">setExecutorService</span><span class="token punctuation">(</span>executorService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®ä¹‹å‰å®šä¹‰çš„æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå’Œå›æŸ¥ç›‘å¬å™¨å®ä¾‹</span>
    producer<span class="token punctuation">.</span><span class="token function">setTransactionListener</span><span class="token punctuation">(</span>transactionListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">&quot;TagA&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TagB&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TagC&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TagD&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TagE&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">MESSAGE_COUNT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;KEY&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token string">&quot;Hello RocketMQ &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s%n&quot;</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> <span class="token operator">|</span> <span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-æ¶ˆè´¹è€…" tabindex="-1"><a class="header-anchor" href="#_2-4-æ¶ˆè´¹è€…" aria-hidden="true">#</a> 2.4 æ¶ˆè´¹è€…</h3><p>æœ€åå¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹è€…æ¥æ¶ˆè´¹äº‹åŠ¡æ¶ˆæ¯ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>

    <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token constant">CONSUMER_GROUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Uncomment the following line while debugging, namesrvAddr should be set to your local address</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token constant">NAMESRV_ADDR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span><span class="token constant">CONSUME_FROM_FIRST_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span> <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s Receive New Messages: %s %n&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer Started.%n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5-è¿è¡Œç»“æœ" tabindex="-1"><a class="header-anchor" href="#_2-5-è¿è¡Œç»“æœ" aria-hidden="true">#</a> 2.5 è¿è¡Œç»“æœ</h3><p>ç”Ÿäº§è€…çš„è¿è¡Œæ—¥å¿—å¦‚ä¸‹ï¼š</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18010D0000</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801BE0001</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801CD0002</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801DA0003</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801E70004</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801F50005</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1802020006</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18020F0007</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18021D0008</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18022B0009</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¶ˆè´¹è€…è¿è¡Œæ—¥å¿—å¦‚ä¸‹ï¼š</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>Consumer Started<span class="token punctuation">.</span>
<span class="token property">ConsumeMessageThread_CID_JODIE_1_1 Receive New Messages:</span> <span class="token punctuation">[</span>MessageExt <span class="token punctuation">[</span>brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1737222654439</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">5290</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1737222675592</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">7F00000100002A9F000000104A169B49</span><span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">69962472265</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">601994070</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">69962469259</span><span class="token punctuation">,</span> toString<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">=</span>Message<span class="token operator">{</span>topic<span class="token operator">=</span><span class="token string">&#39;TopicTest1234&#39;</span><span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token operator">{</span>CONSUME_START_TIME<span class="token operator">=</span><span class="token number">1737222710178</span><span class="token punctuation">,</span> MSG_REGION<span class="token operator">=</span>DefaultRegion<span class="token punctuation">,</span> UNIQ_KEY<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801E70004</span><span class="token punctuation">,</span> CLUSTER<span class="token operator">=</span>DefaultCluster<span class="token punctuation">,</span> PGROUP<span class="token operator">=</span>please_rename_unique_group_name<span class="token punctuation">,</span> MIN_OFFSET<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> __transactionId__<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801E70004</span><span class="token punctuation">,</span> TAGS<span class="token operator">=</span>TagE<span class="token punctuation">,</span> TRAN_MSG<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> KEYS<span class="token operator">=</span>KEY4<span class="token punctuation">,</span> WAIT<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRACE_ON<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRANSACTION_CHECK_TIMES<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_TOPIC<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> MAX_OFFSET<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_QID<span class="token operator">=</span><span class="token number">0</span><span class="token operator">}</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token string">&#39;C0A80109803418B4AAC25D1801E70004&#39;</span><span class="token operator">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
<span class="token property">ConsumeMessageThread_CID_JODIE_1_2 Receive New Messages:</span> <span class="token punctuation">[</span>MessageExt <span class="token punctuation">[</span>brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1737222654398</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">5290</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1737222675591</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">7F00000100002A9F000000104A1699A5</span><span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">69962471845</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">1401636825</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">69962467966</span><span class="token punctuation">,</span> toString<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">=</span>Message<span class="token operator">{</span>topic<span class="token operator">=</span><span class="token string">&#39;TopicTest1234&#39;</span><span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token operator">{</span>CONSUME_START_TIME<span class="token operator">=</span><span class="token number">1737222710178</span><span class="token punctuation">,</span> MSG_REGION<span class="token operator">=</span>DefaultRegion<span class="token punctuation">,</span> UNIQ_KEY<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801BE0001</span><span class="token punctuation">,</span> CLUSTER<span class="token operator">=</span>DefaultCluster<span class="token punctuation">,</span> PGROUP<span class="token operator">=</span>please_rename_unique_group_name<span class="token punctuation">,</span> MIN_OFFSET<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> __transactionId__<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801BE0001</span><span class="token punctuation">,</span> TAGS<span class="token operator">=</span>TagB<span class="token punctuation">,</span> TRAN_MSG<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> KEYS<span class="token operator">=</span>KEY1<span class="token punctuation">,</span> WAIT<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRACE_ON<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRANSACTION_CHECK_TIMES<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_TOPIC<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> MAX_OFFSET<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_QID<span class="token operator">=</span><span class="token number">1</span><span class="token operator">}</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token string">&#39;C0A80109803418B4AAC25D1801BE0001&#39;</span><span class="token operator">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
<span class="token property">ConsumeMessageThread_CID_JODIE_1_3 Receive New Messages:</span> <span class="token punctuation">[</span>MessageExt <span class="token punctuation">[</span>brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1737222654479</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">5290</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1737222675592</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">7F00000100002A9F000000104A169CED</span><span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">69962472685</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">988340972</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">69962470552</span><span class="token punctuation">,</span> toString<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">=</span>Message<span class="token operator">{</span>topic<span class="token operator">=</span><span class="token string">&#39;TopicTest1234&#39;</span><span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token operator">{</span>CONSUME_START_TIME<span class="token operator">=</span><span class="token number">1737222710178</span><span class="token punctuation">,</span> MSG_REGION<span class="token operator">=</span>DefaultRegion<span class="token punctuation">,</span> UNIQ_KEY<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18020F0007</span><span class="token punctuation">,</span> CLUSTER<span class="token operator">=</span>DefaultCluster<span class="token punctuation">,</span> PGROUP<span class="token operator">=</span>please_rename_unique_group_name<span class="token punctuation">,</span> MIN_OFFSET<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> __transactionId__<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18020F0007</span><span class="token punctuation">,</span> TAGS<span class="token operator">=</span>TagC<span class="token punctuation">,</span> TRAN_MSG<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> KEYS<span class="token operator">=</span>KEY7<span class="token punctuation">,</span> WAIT<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRACE_ON<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRANSACTION_CHECK_TIMES<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_TOPIC<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> MAX_OFFSET<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_QID<span class="token operator">=</span><span class="token number">3</span><span class="token operator">}</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token string">&#39;C0A80109803418B4AAC25D18020F0007&#39;</span><span class="token operator">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åªæ”¶åˆ° 3 æ¡æ¶ˆæ¯ï¼Œå› ä¸ºå‘é€æ—¶æ¨¡æ‹Ÿäº† 3 ç§æœ¬åœ°äº‹åŠ¡çš„æ‰§è¡Œç»“æœï¼Œåªæœ‰ 3 æ¡æ¶ˆæ¯æ˜¯ <code>COMMIT_MESSAGE</code> çŠ¶æ€ï¼Œ4 æ¡æ¶ˆæ¯æ˜¯ <code>UNKNOW</code> çŠ¶æ€ï¼Œ3 æ¡æ¶ˆæ¯æ˜¯ <code>ROLLBACK_MESSAGE</code> çŠ¶æ€ã€‚<br><code>UNKNOWN</code> çŠ¶æ€çš„æ¶ˆæ¯ä¼šç»§ç»­è¿›è¡Œå›æŸ¥ï¼Œ<code>ROLLBACK_MESSAGE</code> çŠ¶æ€çš„æ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒã€‚</p><h2 id="_3-æ¦‚è¦è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#_3-æ¦‚è¦è®¾è®¡" aria-hidden="true">#</a> 3. æ¦‚è¦è®¾è®¡</h2><p>RocketMQ çš„äº‹åŠ¡å®ç°æ–¹å¼ä¸ºäºŒé˜¶æ®µæäº¤ï¼š</p><ol><li>å…ˆå°†åŸå§‹æ¶ˆæ¯ä»¥äº‹åŠ¡åŠæ¶ˆæ¯çš„å½¢å¼å‘é€åˆ°æœåŠ¡ç«¯ï¼Œå¯¹æ¶ˆè´¹è€…ä¸å¯è§ã€‚</li><li>ç„¶åç”Ÿäº§è€…æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œæ ¹æ®æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœæ¥å¤åŸæˆ–ä¸¢å¼ƒäº‹åŠ¡åŠæ¶ˆæ¯ã€‚</li><li>å¦‚æœæœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœæœªçŸ¥ï¼Œåˆ™æœåŠ¡ç«¯å¯¹ç”Ÿäº§è€…è¿›è¡Œå®šæœŸå›æŸ¥æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚</li><li>æ ¹æ®å›æŸ¥çš„æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœï¼ŒæœåŠ¡ç«¯å°†äº‹åŠ¡åŠæ¶ˆæ¯å¤åŸæˆ–ä¸¢å¼ƒã€‚</li></ol><p>æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1739972940231.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li>ç”Ÿäº§è€…ï¼ˆSenderï¼‰å‘é€æ¶ˆæ¯åˆ° RocketMQ æœåŠ¡ç«¯ï¼ˆServerï¼‰ï¼Œé™¤äº†åŸæœ¬çš„ä¿¡æ¯å¤–ï¼Œå‘æ¶ˆæ¯å±æ€§ä¸­æ·»åŠ äº†äº‹åŠ¡æ¶ˆæ¯æ ‡è¯†ï¼Œè¡¨ç¤ºä¸€ä¸ªäº‹åŠ¡åŠæ¶ˆæ¯ï¼ˆHalf messageï¼‰ã€‚</li><li>æˆ‘ä»¬å¹¶ä¸å¸Œæœ›äº‹åŠ¡åŠæ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ¶ˆè´¹åˆ°ï¼Œæ‰€ä»¥å®ƒè¢«ä¿å­˜åœ¨æœåŠ¡ç«¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥ä¿å­˜åŠæ¶ˆæ¯çš„ç‰¹æ®Š Topic ä¸­ï¼Œæ¶ˆæ¯æŒä¹…åŒ–æˆåŠŸä¹‹åï¼Œå‘ç”Ÿäº§è€…è¿”å› Ack ç¡®è®¤æ¶ˆæ¯å·²ç»å‘é€æˆåŠŸã€‚</li><li>ç”Ÿäº§è€…å¼€å§‹æ‰§è¡Œæœ¬åœ°äº‹åŠ¡é€»è¾‘ã€‚</li><li>ç”Ÿäº§è€…å°†æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœä¸ŠæŠ¥ç»™æœåŠ¡ç«¯ã€‚å¦‚æœæœ¬åœ°äº‹åŠ¡æ— æ³•é©¬ä¸Šæ‰§è¡Œå®Œï¼Œåº”ä¸ŠæŠ¥ Unknownï¼›æ‰§è¡ŒæˆåŠŸåˆ™ä¸ŠæŠ¥ Commitï¼Œæ‰§è¡Œå¤±è´¥ä¸ŠæŠ¥ Rollbackã€‚æœåŠ¡ç«¯æ”¶åˆ°ç¡®è®¤ç»“æœåå¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š <ul><li>Unknownï¼šæš‚ä¸å¤„ç†ï¼ŒæœåŠ¡ç«¯åœ¨ä¸€å®šæ—¶é—´åï¼Œå¯¹ç”Ÿäº§è€…å®ä¾‹å‘èµ·å®šæ—¶å›æŸ¥ã€‚</li><li>Commit/Rollbackï¼šç”Ÿæˆä¸€ä¸ªäº‹åŠ¡æ“ä½œæ¶ˆæ¯ï¼ˆOP æ¶ˆæ¯ï¼‰ï¼Œè®°å½•è¯¥äº‹åŠ¡åŠæ¶ˆæ¯çš„æœ€ç»ˆå¤„ç†ç»“æœï¼Œç„¶åå°† OP æ¶ˆæ¯ä¿å­˜åˆ° OP Topic ä¸­ã€‚åœ¨åé¢æœåŠ¡ç«¯å®šæœŸå›æŸ¥å‰ï¼Œä» OP Topic ä¸­æŸ¥è¯¢ OP æ¶ˆæ¯ï¼Œå¦‚æœèƒ½æ‰¾åˆ° OP æ¶ˆæ¯ï¼Œè¡¨ç¤ºè¯¥äº‹åŠ¡åŠæ¶ˆæ¯éœ€è¦æäº¤æˆ–å›æ»šï¼Œåˆ™æ‰§è¡Œæäº¤æˆ–å›æ»šæ“ä½œã€‚</li></ul></li><li>æœåŠ¡ç«¯è¿›è¡Œå®šæ—¶å›æŸ¥ï¼Œå¯¹åŠæ¶ˆæ¯ Topic ä¸­çš„åŠæ¶ˆæ¯è¿›è¡Œå›æŸ¥ã€‚å…ˆæ ¹æ® OP Topic ä¸­æ˜¯å¦æœ‰è¯¥åŠæ¶ˆæ¯å¯¹åº”çš„ OP æ¶ˆæ¯æ¥åˆ¤æ–­åŠæ¶ˆæ¯çš„æ‰§è¡Œç»“æœã€‚ <ul><li>æ²¡æœ‰ OP æ¶ˆæ¯ï¼šè¿›è¡Œå›æŸ¥ã€‚</li><li>æœ‰ Commit çš„ OP æ¶ˆæ¯ï¼šå°†åŠæ¶ˆæ¯å¤åŸï¼Œå‘é€åˆ°çœŸå®çš„ Topicï¼Œå¯ä»¥æŠ•é€’ç»™æ¶ˆè´¹è€…ã€‚</li><li>æœ‰ Rollback çš„ OP æ¶ˆæ¯ï¼šä¸¢å¼ƒåŠæ¶ˆæ¯ã€‚</li></ul></li><li>ç”Ÿäº§è€…æ”¶åˆ°æ¶ˆæ¯å›æŸ¥è¯·æ±‚åï¼Œæ£€æŸ¥å¯¹åº”æ¶ˆæ¯çš„æœ¬åœ°äº‹åŠ¡æ‰§è¡Œçš„æœ€ç»ˆç»“æœã€‚</li><li>ç”Ÿäº§è€…å°†æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ä¸ŠæŠ¥ç»™æœåŠ¡ç«¯ï¼Œè¿›è¡ŒäºŒæ¬¡ç¡®è®¤ï¼ŒæœåŠ¡ç«¯ä»æŒ‰ç…§æ­¥éª¤ 4 å¯¹åŠäº‹åŠ¡æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚</li></ol><h2 id="_4-åŸç†è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#_4-åŸç†è¯¦è§£" aria-hidden="true">#</a> 4. åŸç†è¯¦è§£</h2><h3 id="_4-1-äº‹åŠ¡æ¶ˆæ¯å‘é€" tabindex="-1"><a class="header-anchor" href="#_4-1-äº‹åŠ¡æ¶ˆæ¯å‘é€" aria-hidden="true">#</a> 4.1 äº‹åŠ¡æ¶ˆæ¯å‘é€</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738347473287.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_4-1-1-ç”Ÿäº§è€…å‘é€äº‹åŠ¡æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_4-1-1-ç”Ÿäº§è€…å‘é€äº‹åŠ¡æ¶ˆæ¯" aria-hidden="true">#</a> 4.1.1 ç”Ÿäº§è€…å‘é€äº‹åŠ¡æ¶ˆæ¯</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738518692741.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>RocketMQ ä¸ºäº‹åŠ¡æ¶ˆæ¯å®šä¹‰äº†ä¸“é—¨çš„ç”Ÿäº§è€…ç±»å‹ <code>TransactionMQProducer</code> å’Œæœ¬åœ°äº‹åŠ¡æ‰§è¡Œæ¥å£ <code>TransactionListener</code>ã€‚</p><p>è°ƒç”¨äº‹åŠ¡ç”Ÿäº§è€…çš„ <code>sendMessageInTransaction</code> æ–¹æ³•å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨ <code>DefaultMQProducerImpl</code> çš„ <code>sendMessageInTransaction</code> æ–¹æ³•ï¼Œäº‹åŠ¡æ¶ˆæ¯å‘é€çš„ä¸»è¦é€»è¾‘éƒ½åœ¨è¯¥æ–¹æ³•ä¸­ã€‚</p><p><code>sendMessageInTransaction</code> æ–¹æ³•æ¥æ”¶ä¸€ä¸ªæ™®é€šæ¶ˆæ¯ï¼Œå°†å®ƒåŒ…è£…æˆäº‹åŠ¡åŠæ¶ˆæ¯å‘é€ç»™ Brokerï¼Œç„¶åæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œä¸ŠæŠ¥æ‰§è¡Œç»“æœç»™ Brokerã€‚è¯¦ç»†é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>è®¾ç½®åŸå§‹æ¶ˆæ¯çš„ <code>TRAN_MSG</code> å±æ€§è®¾ç½®ä¸º <code>true</code>ï¼Œè¡¨ç¤ºè¯¥æ¶ˆæ¯æ˜¯ä¸€ä¸ªäº‹åŠ¡åŠæ¶ˆæ¯ã€‚</li><li>å‘é€åŠæ¶ˆæ¯åˆ° Brokerã€‚</li><li>å¦‚æœåŠæ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œè·å–æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœï¼›å¦‚æœå‘é€å¤±è´¥ï¼Œåˆ™ä¸æ‰§è¡Œã€‚</li><li>è°ƒç”¨ <code>endTransaction</code> æ–¹æ³•ï¼Œé€šçŸ¥ Broker æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœã€‚è¿™é‡Œæ˜¯å¼‚æ­¥å•å‘è¯·æ±‚ï¼Œä¸éœ€è¦ç­‰å¾…å“åº”ã€‚</li></ol><h4 id="_4-1-2-broker-æ¥æ”¶äº‹åŠ¡åŠæ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_4-1-2-broker-æ¥æ”¶äº‹åŠ¡åŠæ¶ˆæ¯" aria-hidden="true">#</a> 4.1.2 Broker æ¥æ”¶äº‹åŠ¡åŠæ¶ˆæ¯</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738518693004.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Broker çš„æ¶ˆæ¯ç”Ÿäº§è¯·æ±‚å¤„ç†å™¨ <code>SendMessageProcessor</code> çš„ <code>processRequest</code> æ–¹æ³•å¤„ç†ç”Ÿäº§è€…å‘æ¥çš„æ™®é€šæ¶ˆæ¯å’Œäº‹åŠ¡æ¶ˆæ¯ã€‚</p><p>è¯¥æ–¹æ³•ä¼šæ£€æŸ¥æ¶ˆæ¯çš„ <code>TRAN_MSG</code> å±æ€§ï¼Œå¦‚æœä¸º <code>true</code>ï¼Œåˆ™è¡¨ç¤ºè¯¥æ¶ˆæ¯æ˜¯ä¸€ä¸ªäº‹åŠ¡åŠæ¶ˆæ¯ã€‚ä¸ºäº†è®©æ¶ˆè´¹è€…æš‚æ—¶æ— æ³•æ¶ˆè´¹åˆ°è¯¥æ¶ˆæ¯ï¼ŒRocketMQ çš„è®¾è®¡æ˜¯å°†å®ƒä¿å­˜åˆ° <code>RMQ_SYS_TRANS_HALF_TOPIC</code> Topic ä¸­ã€‚åç»­æ”¶åˆ°ç”Ÿäº§è€…çš„æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœåï¼Œä¼šæ ¹æ®æ‰§è¡Œç»“æœå°†äº‹åŠ¡åŠæ¶ˆæ¯æŸ¥å‡ºæ¥ï¼Œå¤åŸæˆ–ä¸¢å¼ƒã€‚</p><h4 id="_4-1-3-broker-æ¥æ”¶äº‹åŠ¡æ‰§è¡Œç»“æœè¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#_4-1-3-broker-æ¥æ”¶äº‹åŠ¡æ‰§è¡Œç»“æœè¯·æ±‚" aria-hidden="true">#</a> 4.1.3 Broker æ¥æ”¶äº‹åŠ¡æ‰§è¡Œç»“æœè¯·æ±‚</h4><p>Broker çš„äº‹åŠ¡æ‰§è¡Œç»“æœå¤„ç†é€»è¾‘ä¼šåœ¨ä»¥ä¸‹ä¸¤ä¸ªæƒ…å†µä¸‹è§¦å‘ï¼š</p><ul><li>ç”Ÿäº§è€…ç¬¬ä¸€æ¬¡å‘é€äº‹åŠ¡åŠæ¶ˆæ¯ï¼Œæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œä¼šè°ƒç”¨ <code>endTransaction</code> æ–¹æ³•ï¼Œé€šçŸ¥ Broker æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœã€‚</li><li>ç”Ÿäº§è€…æ”¶åˆ° Broker çš„äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€å›æŸ¥è¯·æ±‚ï¼Œä¼šæŸ¥è¯¢æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœï¼Œç„¶åä¸ŠæŠ¥ç»™ Brokerã€‚</li></ul><p>Broker çš„ <code>EndTransactionProcessor</code> çš„ <code>processRequest</code> æ–¹æ³•å¤„ç†äº‹åŠ¡æ‰§è¡Œç»“æœè¯·æ±‚ï¼Œå®ƒæ ¹æ®ç”Ÿäº§è€…ä¸ŠæŠ¥çš„æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœï¼Œå°†äº‹åŠ¡åŠæ¶ˆæ¯å¤åŸæˆ–ä¸¢å¼ƒã€‚è¯¦ç»†é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ä¸º <code>COMMIT_MESSAGE</code>ï¼š <ol><li>æ ¹æ®è¯·æ±‚å¤´ä¸­çš„äº‹åŠ¡åŠæ¶ˆæ¯ç‰©ç†åç§»é‡ï¼Œä»å­˜å‚¨ä¸­æŸ¥è¯¢å‡ºäº‹åŠ¡åŠæ¶ˆæ¯ã€‚</li><li>å¤åŸäº‹åŠ¡åŠæ¶ˆæ¯çš„åŸå§‹ Topic å’Œé˜Ÿåˆ—ã€‚</li><li>å°†å¤åŸåçš„æ¶ˆæ¯ä¿å­˜åˆ°å­˜å‚¨ï¼Œæ­¤æ—¶æ¶ˆæ¯å¯ä»¥è¢«æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚</li><li>åˆ é™¤äº‹åŠ¡åŠæ¶ˆæ¯ï¼šå°†äº‹åŠ¡åŠæ¶ˆæ¯å­˜å‚¨åœ¨äº‹åŠ¡æ¶ˆæ¯ OP Topicï¼šRMQ_SYS_TRANS_OP_HALF_TOPIC ä¸­ï¼Œè¡¨ç¤ºè¯¥æ¶ˆæ¯å·²ç»è¢«å¤„ç†, æ— éœ€å†æ¬¡å›æŸ¥ã€‚</li></ol></li><li>å¦‚æœæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ä¸º <code>ROLLBACK_MESSAGE</code><ol><li>ä»å­˜å‚¨ä¸­æŸ¥è¯¢å‡ºäº‹åŠ¡åŠæ¶ˆæ¯</li><li>åˆ é™¤äº‹åŠ¡åŠæ¶ˆæ¯</li></ol></li><li>å¦‚æœæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ä¸º <code>UNKNOWN</code> åˆ™ä¸ä½œå¤„ç†</li></ul><h3 id="_4-2-äº‹åŠ¡çŠ¶æ€å›æŸ¥" tabindex="-1"><a class="header-anchor" href="#_4-2-äº‹åŠ¡çŠ¶æ€å›æŸ¥" aria-hidden="true">#</a> 4.2 äº‹åŠ¡çŠ¶æ€å›æŸ¥</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738347473545.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_4-2-1-broker-å›æŸ¥äº‹åŠ¡çŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#_4-2-1-broker-å›æŸ¥äº‹åŠ¡çŠ¶æ€" aria-hidden="true">#</a> 4.2.1 Broker å›æŸ¥äº‹åŠ¡çŠ¶æ€</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738518693032.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Broker çš„æœåŠ¡çº¿ç¨‹ <code>TransactionalMessageCheckService</code> æ¯ 30s è§¦å‘ä¸€æ¬¡ <code>TransactionalMessageServiceImpl#check</code> æ–¹æ³•è¿›è¡Œäº‹åŠ¡æ¶ˆæ¯çš„å›æŸ¥ã€‚è¯¥æ–¹æ³•ä¼šä»åŠæ¶ˆæ¯ Topic ä¸­å–å‡ºåŠæ¶ˆæ¯ï¼Œä¸ OP Topic ä¸­çš„æ¶ˆæ¯è¿›è¡ŒåŒ¹é…ï¼ˆåŒ¹é…ä¸Šåˆ™è®¤ä¸ºå¤„ç†å®Œï¼‰ã€‚å¯¹äºæ²¡æœ‰å¤„ç†å®Œçš„åŠæ¶ˆæ¯ï¼Œå‘é€å›æŸ¥è¯·æ±‚ç»™ç”Ÿäº§è€…ç»„ä¸­çš„ä¸€ä¸ªç”Ÿäº§è€…ï¼Œè§¦å‘ç”Ÿäº§è€…ä¸ŠæŠ¥æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚å®ƒçš„è¯¦ç»†é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>è·å–äº‹åŠ¡åŠæ¶ˆæ¯ Topic çš„æ‰€æœ‰é˜Ÿåˆ—ï¼Œç„¶åéå†è¿™äº›é˜Ÿåˆ—ï¼ˆé»˜è®¤åªæœ‰ 1 ä¸ªé˜Ÿåˆ—ï¼‰ <ol><li>è·å–åŠæ¶ˆæ¯é˜Ÿåˆ—å¯¹åº”çš„ OP Topic çš„é˜Ÿåˆ—ï¼ŒOP Topic æ˜¯ç”¨æ¥ä¿å­˜äº‹åŠ¡åŠæ¶ˆæ¯çš„æ“ä½œç»“æœçš„ Topicï¼Œä¸º <code>RMQ_SYS_TRANS_OP_HALF_TOPIC</code>ã€‚åœ¨ä¸Šé¢çš„ Broker å¤„ç†æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœè¯·æ±‚æ—¶ï¼Œäº‹åŠ¡çš„æ‰§è¡Œç»“æœä¼šä¿å­˜åˆ°è¯¥ Topic ä¸­ã€‚</li><li>è°ƒç”¨ <code>fillOpRemoveMap</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢ä¸€æ‰¹ OP æ¶ˆæ¯ï¼Œç„¶åéå†å®ƒä»¬ï¼ŒæŠŠå®ƒä»¬å¯¹åº”çš„éœ€è¦ç§»é™¤çš„åŠæ¶ˆæ¯çš„é€»è¾‘åç§»é‡æ”¾åˆ° <code>removeMap</code> ä¸­ï¼Œç”¨ä½œåç»­åŒ¹é…ã€‚</li><li>ä¸æ–­å¾ªç¯æ¶ˆè´¹äº‹åŠ¡åŠæ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œç›´åˆ°æ²¡æœ‰æ–°çš„åŠæ¶ˆæ¯æˆ–å¤„ç†æŒç»­æ—¶é—´è¶…è¿‡ 60sï¼š</li></ol><ul><li>åˆ¤æ–­å½“å‰è¦æ¶ˆè´¹çš„åŠæ¶ˆæ¯çš„åç§»é‡æ˜¯å¦åœ¨ <code>removeMap</code> ä¸­ï¼Œå¦‚æœåœ¨åˆ™è¡¨ç¤ºè¯¥åŠæ¶ˆæ¯å·²ç»æäº¤æˆ–å›æ»šï¼Œè·³è¿‡ï¼Œç»§ç»­æ¶ˆè´¹ä¸‹ä¸€æ¡ã€‚</li><li>å¯¹äºæ²¡æœ‰åœ¨ <code>removeMap</code> ä¸­çš„åŠæ¶ˆæ¯ <ol><li>è°ƒç”¨ <code>getHalfMsg</code> æ–¹æ³•ä»å­˜å‚¨ä¸­æŸ¥è¯¢å‡ºè¯¥åŠæ¶ˆæ¯</li><li>åˆ¤æ–­äº‹åŠ¡æ¶ˆæ¯æ˜¯å¦éœ€è¦ä¸¢å¼ƒï¼Œå³è¶…è¿‡æœ€å¤§å›æŸ¥æ¬¡æ•°ï¼ˆ15æ¬¡ï¼‰ï¼›æˆ–è€…æ˜¯å¦éœ€è¦è·³è¿‡ï¼Œå³è¶…è¿‡æ–‡ä»¶ä¿å­˜æ—¶é—´ã€‚å¦‚æœæ˜¯åˆ™ä¸¢å¼ƒåç»§ç»­æŸ¥è¯¢ä¸‹ä¸€æ¡ã€‚</li><li>æ›´æ–°åŠæ¶ˆæ¯çš„å›æŸ¥æ¬¡æ•°ï¼ˆ+1ï¼‰ï¼Œåœ¨æ¶ˆæ¯å±æ€§ä¸­ã€‚</li><li>è®¡ç®—äº‹åŠ¡åŠæ¶ˆæ¯æ˜¯å¦å¤„åœ¨å…ç–«å›æŸ¥æœŸï¼šå³äº‹åŠ¡æ¶ˆæ¯å‘é€ä¸€æ®µæ—¶é—´ä¹‹å†…ä¸è¿›è¡Œå›æŸ¥ï¼Œé»˜è®¤ 6sã€‚å¦‚æœåœ¨å…ç–«å™¨åˆ™è·³å‡ºå›æŸ¥å¾ªç¯ã€‚</li><li>å¦‚æœéœ€è¦å›æŸ¥ï¼Œå°†åŠæ¶ˆæ¯é‡æ–°ä¿å­˜ï¼ˆå› ä¸ºå‰é¢æ›´æ–°äº†å›æŸ¥æ¬¡æ•°ï¼Œè¿™é‡Œä¼šæ–°å†™å…¥ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†åé¢èƒ½å¤Ÿé‡æ–°æ¶ˆè´¹åˆ°è¿™æ¡åŠæ¶ˆæ¯å†æ¬¡è¿›è¡Œå›æŸ¥çš„åˆ¤æ–­ï¼Œå¦‚æœå›æŸ¥æ¬¡æ•°å¤šä¼šå¯¼è‡´å†™æ”¾å¤§ã€‚)ã€‚</li><li>æ ¹æ®ç”Ÿäº§ç»„ï¼Œè½®è¯¢ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¼‚æ­¥å‘é€å•å‘æ¶ˆæ¯å›æŸ¥è¯·æ±‚ã€‚</li><li>å›æŸ¥æ—¶ä¼šå¤åŸåŠæ¶ˆæ¯çš„åŸå§‹ Topic å’Œé˜Ÿåˆ—ï¼Œç„¶åå°†å…¶ä½œä¸ºå›æŸ¥è¯·æ±‚ä½“å‘é€ç»™ç”Ÿäº§è€…ã€‚</li></ol></li></ul></li></ul><blockquote><p>è¿™é‡Œ OP æ¶ˆæ¯çš„æ“ä½œè¾ƒä¸ºç¹çï¼Œå®ƒç”¨æ¥æ ‡è®°ä¸€æ¡åŠæ¶ˆæ¯çš„äº‹åŠ¡æ‰§è¡Œç»“æœã€‚ä¸€ä¸ªä¼˜åŒ–æ–¹æ¡ˆæ˜¯ç›´æ¥å°†åŠæ¶ˆæ¯çš„äº‹åŠ¡æ‰§è¡Œç»“æœè¦†å†™åˆ°åŠæ¶ˆæ¯æœ¬èº«ï¼Œè¿™æ ·åé¢åˆ¤æ–­åŠæ¶ˆæ¯æ˜¯å¦éœ€è¦å›æŸ¥æ—¶å¯ä»¥ç›´æ¥æ ¹æ®åŠæ¶ˆæ¯æœ¬èº«æ¥åˆ¤æ–­ã€‚è¿™ä¸ªæ–¹æ¡ˆçš„å¥½å¤„æ˜¯å¯ä»¥ä¸éœ€è¦ OP æ¶ˆæ¯ç¹ççš„æ“ä½œï¼Œåå¤„æ˜¯è¿™æ ·ä¼šç ´å CommitLog WAL çš„è¯­ä¹‰ï¼Œé€ æˆéšæœºè¯»å†™ã€‚å¦‚æœéœ€è¦è¦†ç›–çš„åŠæ¶ˆæ¯ä¸åœ¨é¡µç¼“å­˜ï¼Œä¼šè§¦å‘ç£ç›˜ I/Oï¼Œé€Ÿåº¦å°±æ¯”è¾ƒæ…¢äº†ã€‚</p></blockquote><h4 id="_4-2-2-ç”Ÿäº§è€…å¤„ç†äº‹åŠ¡çŠ¶æ€å›æŸ¥è¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#_4-2-2-ç”Ÿäº§è€…å¤„ç†äº‹åŠ¡çŠ¶æ€å›æŸ¥è¯·æ±‚" aria-hidden="true">#</a> 4.2.2 ç”Ÿäº§è€…å¤„ç†äº‹åŠ¡çŠ¶æ€å›æŸ¥è¯·æ±‚</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738518693394.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ç”Ÿäº§è€…å¤„ç† Broker å›æŸ¥è¯·æ±‚çš„ä¸»è¦æ–¹æ³•æ˜¯ <code>DefaultMQProducerImpl#checkLocalTransaction</code>ï¼Œå®ƒæ ¹æ® Broker å‘å›çš„åŠæ¶ˆæ¯è·å–æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœï¼Œç„¶åå°†æ‰§è¡Œç»“æœå‘å› Brokerã€‚</p><h2 id="_5-æºç è§£æ" tabindex="-1"><a class="header-anchor" href="#_5-æºç è§£æ" aria-hidden="true">#</a> 5. æºç è§£æ</h2><h3 id="_5-1-äº‹åŠ¡æ¶ˆæ¯å‘é€" tabindex="-1"><a class="header-anchor" href="#_5-1-äº‹åŠ¡æ¶ˆæ¯å‘é€" aria-hidden="true">#</a> 5.1 äº‹åŠ¡æ¶ˆæ¯å‘é€</h3><h4 id="_5-1-1-ç”Ÿäº§è€…å‘é€äº‹åŠ¡æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_5-1-1-ç”Ÿäº§è€…å‘é€äº‹åŠ¡æ¶ˆæ¯" aria-hidden="true">#</a> 5.1.1 ç”Ÿäº§è€…å‘é€äº‹åŠ¡æ¶ˆæ¯</h4><h5 id="transactionmqproducer-sendmessageintransaction" tabindex="-1"><a class="header-anchor" href="#transactionmqproducer-sendmessageintransaction" aria-hidden="true">#</a> TransactionMQProducer#sendMessageInTransaction</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// TransactionMQProducer.java</span>
<span class="token doc-comment comment">/**
 * å‘é€äº‹åŠ¡æ¶ˆæ¯
 * 
 * <span class="token keyword">@param</span> <span class="token parameter">msg</span> Transactional message to send.
 *            éœ€è¦å‘é€çš„äº‹åŠ¡æ¶ˆæ¯
 * <span class="token keyword">@param</span> <span class="token parameter">arg</span> Argument used along with local transaction executor.
 *            æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå™¨çš„å‚æ•°
 * <span class="token keyword">@return</span> äº‹åŠ¡æ¶ˆæ¯å‘é€ç»“æœ
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">TransactionSendResult</span> <span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transactionListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">&quot;TransactionListener is null&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    msg<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token class-name">NamespaceUtil</span><span class="token punctuation">.</span><span class="token function">wrapNamespace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducerImpl<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="defaultmqproducerimpl-sendmessageintransaction" tabindex="-1"><a class="header-anchor" href="#defaultmqproducerimpl-sendmessageintransaction" aria-hidden="true">#</a> DefaultMQProducerImpl#sendMessageInTransaction</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// DefaultMQProducerImpl.java</span>
<span class="token doc-comment comment">/**
 * å‘é€äº‹åŠ¡æ¶ˆæ¯
 * 
 * <span class="token keyword">@param</span> <span class="token parameter">msg</span> äº‹åŠ¡æ¶ˆæ¯
 * <span class="token keyword">@param</span> <span class="token parameter">localTransactionListener</span> æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå’ŒçŠ¶æ€æ£€æŸ¥å™¨
 * <span class="token keyword">@param</span> <span class="token parameter">arg</span> æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå‚æ•°
 */</span>
<span class="token keyword">public</span> <span class="token class-name">TransactionSendResult</span> <span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">TransactionListener</span> localTransactionListener<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransactionListener</span> transactionListener <span class="token operator">=</span> <span class="token function">getCheckListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> localTransactionListener <span class="token operator">&amp;&amp;</span> <span class="token keyword">null</span> <span class="token operator">==</span> transactionListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">&quot;tranExecutor is null&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ignore DelayTimeLevel parameter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">clearProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_DELAY_TIME_LEVEL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Validators</span><span class="token punctuation">.</span><span class="token function">checkMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®æ¶ˆæ¯å±æ€§ TRAN_MSGï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºäº‹åŠ¡æ¶ˆæ¯</span>
    <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_TRANSACTION_PREPARED</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_PRODUCER_GROUP</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‘é€åŠäº‹åŠ¡æ¶ˆæ¯</span>
        sendResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">&quot;send message Exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">LocalTransactionState</span> localTransactionState <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
    <span class="token class-name">Throwable</span> localException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">SEND_OK</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    msg<span class="token punctuation">.</span><span class="token function">putUserProperty</span><span class="token punctuation">(</span><span class="token string">&quot;__transactionId__&quot;</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">String</span> transactionId <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> transactionId <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    msg<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> localTransactionListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ä½¿ç”¨ DefaultMQProducerImpl è¿›è¡Œäº‹åŠ¡æ¶ˆæ¯å‘é€ï¼Œæ‰§è¡Œæœ¬åœ°äº‹åŠ¡</span>
                    localTransactionState <span class="token operator">=</span> localTransactionListener<span class="token punctuation">.</span><span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ä½¿ç”¨æ–°çš„ TransactionMQProducer è¿›è¡Œäº‹åŠ¡æ¶ˆæ¯å‘é€ï¼Œæ‰§è¡Œæœ¬åœ°äº‹åŠ¡</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Used new transaction API&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    localTransactionState <span class="token operator">=</span> transactionListener<span class="token punctuation">.</span><span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> localTransactionState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    localTransactionState <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>localTransactionState <span class="token operator">!=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;executeLocalTransactionBranch return: {} messageTopic: {} transactionId: {} tag: {} key: {}&quot;</span><span class="token punctuation">,</span>
                        localTransactionState<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;executeLocalTransactionBranch exception, messageTopic: {} transactionId: {} tag: {} key: {}&quot;</span><span class="token punctuation">,</span>
                    msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                localException <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">FLUSH_DISK_TIMEOUT</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token constant">FLUSH_SLAVE_TIMEOUT</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token constant">SLAVE_NOT_AVAILABLE</span><span class="token operator">:</span>
            localTransactionState <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">ROLLBACK_MESSAGE</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç»“æŸäº‹åŠ¡ï¼Œå¦‚æœåŠæ¶ˆæ¯å‘é€å¤±è´¥æˆ–æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå¤±è´¥å‘Šè¯‰æœåŠ¡ç«¯åˆ é™¤åŠæ¶ˆæ¯ï¼ŒåŠæ¶ˆæ¯å‘é€æˆåŠŸä¸”æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸåˆ™å‘Šè¯‰æœåŠ¡ç«¯è®©åŠæ¶ˆæ¯å¤åŸ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">endTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> sendResult<span class="token punctuation">,</span> localTransactionState<span class="token punctuation">,</span> localException<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;local transaction execute &quot;</span> <span class="token operator">+</span> localTransactionState <span class="token operator">+</span> <span class="token string">&quot;, but end broker transaction failed&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">TransactionSendResult</span> transactionSendResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionSendResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setSendStatus</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setMessageQueue</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setMsgId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setQueueOffset</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setLocalTransactionState</span><span class="token punctuation">(</span>localTransactionState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> transactionSendResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="transactionmqproducer-endtransaction" tabindex="-1"><a class="header-anchor" href="#transactionmqproducer-endtransaction" aria-hidden="true">#</a> TransactionMQProducer#endTransaction</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// TransactionMQProducer.java</span>
<span class="token doc-comment comment">/**
 * å‘ Broker å‘é€ç»“æŸäº‹åŠ¡è¯·æ±‚ï¼Œæ ¹æ®æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ï¼Œé€šçŸ¥ Broker åŠæ¶ˆæ¯å¦‚ä½•å¤„ç†
 * 
 * <span class="token keyword">@param</span> <span class="token parameter">msg</span> äº‹åŠ¡æ¶ˆæ¯
 * <span class="token keyword">@param</span> <span class="token parameter">sendResult</span> äº‹åŠ¡åŠæ¶ˆæ¯çš„å‘é€ç»“æœ
 * <span class="token keyword">@param</span> <span class="token parameter">localTransactionState</span> æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">endTransaction</span><span class="token punctuation">(</span>
    <span class="token keyword">final</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">SendResult</span> sendResult<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">LocalTransactionState</span> localTransactionState<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">Throwable</span> localException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">MessageId</span> id<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getOffsetMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        id <span class="token operator">=</span> <span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">decodeMessageId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getOffsetMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        id <span class="token operator">=</span> <span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">decodeMessageId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> transactionId <span class="token operator">=</span> sendResult<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> destBrokerName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getBrokerNameFromMessageQueue</span><span class="token punctuation">(</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">queueWithNamespace</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> brokerAddr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">findBrokerAddressInPublish</span><span class="token punctuation">(</span>destBrokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EndTransactionRequestHeader</span> requestHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EndTransactionRequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setCommitLogOffset</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setBrokerName</span><span class="token punctuation">(</span>destBrokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ ¹æ®æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€è®¾ç½®äº‹åŠ¡ç»“æŸè¯·æ±‚ç±»å‹</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>localTransactionState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">COMMIT_MESSAGE</span><span class="token operator">:</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_COMMIT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">ROLLBACK_MESSAGE</span><span class="token operator">:</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_ROLLBACK_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">UNKNOW</span><span class="token operator">:</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_NOT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ‰§è¡Œäº‹åŠ¡ç»“æŸé’©å­ï¼Œè¿™é‡Œä¸»è¦ä¼šè®°å½•æ¶ˆæ¯è½¨è¿¹</span>
    <span class="token function">doExecuteEndTransactionHook</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> brokerAddr<span class="token punctuation">,</span> localTransactionState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setTranStateTableOffset</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setMsgId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> remark <span class="token operator">=</span> localException <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">&quot;executeLocalTransactionBranch exception: &quot;</span> <span class="token operator">+</span> localException<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘ Broker å‘é€äº‹åŠ¡æ¶ˆæ¯ç»“æŸè¯·æ±‚ï¼Œæ ¹æ®æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€é€šçŸ¥ Broker åŠæ¶ˆæ¯å¦‚ä½•å¤„ç†</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getMQClientAPIImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endTransactionOneway</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> remark<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getSendMsgTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-2-broker-æ¥æ”¶äº‹åŠ¡æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#_5-1-2-broker-æ¥æ”¶äº‹åŠ¡æ¶ˆæ¯" aria-hidden="true">#</a> 5.1.2 Broker æ¥æ”¶äº‹åŠ¡æ¶ˆæ¯</h4><h5 id="sendmessageprocessor-processrequest-æ¥æ”¶äº‹åŠ¡åŠæ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#sendmessageprocessor-processrequest-æ¥æ”¶äº‹åŠ¡åŠæ¶ˆæ¯" aria-hidden="true">#</a> SendMessageProcessor#processRequest æ¥æ”¶äº‹åŠ¡åŠæ¶ˆæ¯</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// SendMessageProcessor.java</span>
<span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">SendMessageContext</span> sendMessageContext<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">SendMessageRequestHeader</span> requestHeader<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">TopicQueueMappingContext</span> mappingContext<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">SendMessageCallback</span> sendMessageCallback<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// ...</span>

    <span class="token comment">// å°è¯•è·å–äº‹åŠ¡æ¶ˆæ¯æ ‡è¯†</span>
    <span class="token class-name">String</span> traFlag <span class="token operator">=</span> oriProps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_TRANSACTION_PREPARED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> sendTransactionPrepareMessage<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>traFlag<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> msgInner<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//For client under version 4.6.1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isRejectTransactionMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">NO_PERMISSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>
                <span class="token string">&quot;the broker[&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerIP1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;] sending transaction message is forbidden&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ˜¯äº‹åŠ¡æ¶ˆæ¯</span>
        sendTransactionPrepareMessage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        sendTransactionPrepareMessage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å¼‚æ­¥å­˜å‚¨æ¶ˆæ¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAsyncSendEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PutMessageResult</span><span class="token punctuation">&gt;</span></span> asyncPutMessageFuture<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sendTransactionPrepareMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœæ˜¯äº‹åŠ¡æ¶ˆæ¯ï¼Œæ„é€ äº‹åŠ¡åŠæ¶ˆæ¯å¹¶å­˜å‚¨</span>
            asyncPutMessageFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asyncPrepareMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ™®é€šæ¶ˆæ¯å­˜å‚¨</span>
            asyncPutMessageFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asyncPutMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> finalQueueIdInt <span class="token operator">=</span> queueIdInt<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">MessageExtBrokerInner</span> finalMsgInner <span class="token operator">=</span> msgInner<span class="token punctuation">;</span>
        asyncPutMessageFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span>putMessageResult <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">RemotingCommand</span> responseFuture <span class="token operator">=</span>
                <span class="token function">handlePutMessageResult</span><span class="token punctuation">(</span>putMessageResult<span class="token punctuation">,</span> response<span class="token punctuation">,</span> request<span class="token punctuation">,</span> finalMsgInner<span class="token punctuation">,</span> responseHeader<span class="token punctuation">,</span> sendMessageContext<span class="token punctuation">,</span>
                    ctx<span class="token punctuation">,</span> finalQueueIdInt<span class="token punctuation">,</span> beginTimeMillis<span class="token punctuation">,</span> mappingContext<span class="token punctuation">,</span> <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span><span class="token function">getMessageType</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>responseFuture <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">doResponse</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">,</span> responseFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// record the transaction metrics, responseFuture == null means put successfully</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sendTransactionPrepareMessage <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>responseFuture <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> responseFuture<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            sendMessageCallback<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span>sendMessageContext<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getPutMessageFutureExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Returns null to release the send message thread</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// åŒæ­¥å­˜å‚¨æ¶ˆæ¯</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">PutMessageResult</span> putMessageResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sendTransactionPrepareMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœæ˜¯äº‹åŠ¡æ¶ˆæ¯ï¼Œæ„é€ äº‹åŠ¡åŠæ¶ˆæ¯å¹¶å­˜å‚¨</span>
            putMessageResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prepareMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ™®é€šæ¶ˆæ¯å­˜å‚¨</span>
            putMessageResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">handlePutMessageResult</span><span class="token punctuation">(</span>putMessageResult<span class="token punctuation">,</span> response<span class="token punctuation">,</span> request<span class="token punctuation">,</span> msgInner<span class="token punctuation">,</span> responseHeader<span class="token punctuation">,</span> sendMessageContext<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> queueIdInt<span class="token punctuation">,</span> beginTimeMillis<span class="token punctuation">,</span> mappingContext<span class="token punctuation">,</span> <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span><span class="token function">getMessageType</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// record the transaction metrics</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">PUT_OK</span> <span class="token operator">&amp;&amp;</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getAppendMessageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sendMessageCallback<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span>sendMessageContext<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="transactionmessagebridge-parsehalfmessageinner-äº‹åŠ¡æ¶ˆæ¯è½¬æ¢æˆäº‹åŠ¡åŠæ¶ˆæ¯ä¿å­˜" tabindex="-1"><a class="header-anchor" href="#transactionmessagebridge-parsehalfmessageinner-äº‹åŠ¡æ¶ˆæ¯è½¬æ¢æˆäº‹åŠ¡åŠæ¶ˆæ¯ä¿å­˜" aria-hidden="true">#</a> TransactionMessageBridge#parseHalfMessageInner äº‹åŠ¡æ¶ˆæ¯è½¬æ¢æˆäº‹åŠ¡åŠæ¶ˆæ¯ä¿å­˜</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// TransactionMessageBridge.java</span>
<span class="token keyword">public</span> <span class="token class-name">PutMessageResult</span> <span class="token function">putHalfMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageExtBrokerInner</span> messageInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span><span class="token function">parseHalfMessageInner</span><span class="token punctuation">(</span>messageInner<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PutMessageResult</span><span class="token punctuation">&gt;</span></span> <span class="token function">asyncPutHalfMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageExtBrokerInner</span> messageInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">asyncPutMessage</span><span class="token punctuation">(</span><span class="token function">parseHalfMessageInner</span><span class="token punctuation">(</span>messageInner<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * å‡†å¤‡äº‹åŠ¡åŠæ¶ˆæ¯ï¼Œå°†åŸæ¶ˆæ¯çš„ Topic å’Œ QueueId ä¿å­˜åˆ°æ¶ˆæ¯å±æ€§ä¸­ï¼Œç„¶åå°†æ¶ˆæ¯çš„ Topic è®¾ç½®ä¸º RMQ_SYS_TRANS_HALF_TOPIC çš„ 0 é˜Ÿåˆ—
 */</span>
<span class="token keyword">private</span> <span class="token class-name">MessageExtBrokerInner</span> <span class="token function">parseHalfMessageInner</span><span class="token punctuation">(</span><span class="token class-name">MessageExtBrokerInner</span> msgInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> uniqId <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uniqId <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>uniqId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> <span class="token class-name">TransactionalMessageUtil</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_ID</span><span class="token punctuation">,</span> uniqId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å°†åŸå§‹æ¶ˆæ¯çš„ Topic å’Œ QueueId ä¿å­˜åˆ°äº‹åŠ¡åŠæ¶ˆæ¯çš„å±æ€§ä¸­</span>
    <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_QUEUE_ID</span><span class="token punctuation">,</span>
        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setSysFlag</span><span class="token punctuation">(</span>
        <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token function">resetTransactionValue</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_NOT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®äº‹åŠ¡åŠæ¶ˆæ¯çš„ Topic ä¸º RMQ_SYS_TRANS_HALF_TOPIC</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token class-name">TransactionalMessageUtil</span><span class="token punctuation">.</span><span class="token function">buildHalfTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setPropertiesString</span><span class="token punctuation">(</span><span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">messageProperties2String</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> msgInner<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="endtransactionprocessor-processrequest-å¤„ç†-endtransaction-è¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#endtransactionprocessor-processrequest-å¤„ç†-endtransaction-è¯·æ±‚" aria-hidden="true">#</a> EndTransactionProcessor#processRequest å¤„ç† EndTransaction è¯·æ±‚</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// EndTransactionProcessor.java</span>
<span class="token doc-comment comment">/**
 * ä¸¤ä¸ªåœºæ™¯ä¼šå‘è§¦å‘ END_TRANSACTION è¯·æ±‚
 * 1. ç”Ÿäº§è€…ç¬¬ä¸€æ¬¡å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼Œæ‰§è¡Œå®Œæœ¬åœ°äº‹åŠ¡å
 * 2. ç”Ÿäº§è€…æ”¶åˆ°æœåŠ¡ç«¯äº‹åŠ¡å›æŸ¥è¯·æ±‚ï¼ŒæŸ¥è¯¢å®Œæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span>
    <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">RemotingCommand</span> response <span class="token operator">=</span> <span class="token class-name">RemotingCommand</span><span class="token punctuation">.</span><span class="token function">createResponseCommand</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">EndTransactionRequestHeader</span> requestHeader <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token class-name">EndTransactionRequestHeader</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">EndTransactionRequestHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BrokerRole</span><span class="token punctuation">.</span><span class="token constant">SLAVE</span> <span class="token operator">==</span> brokerController<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SLAVE_NOT_AVAILABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Message store is slave mode, so end transaction is forbidden. &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ...</span>

    <span class="token class-name">OperationResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OperationResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// äº‹åŠ¡æäº¤</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_COMMIT_TYPE</span> <span class="token operator">==</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitOrRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»å­˜å‚¨ä¸­æŸ¥è¯¢å‡ºäº‹åŠ¡åŠæ¶ˆæ¯</span>
        result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æˆåŠŸæŸ¥è¯¢å‡ºäº‹åŠ¡åŠæ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rejectCommitOrRollback</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">ILLEGAL_OPERATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Message commit fail [producer end]. currentTimeMillis - bornTime &gt; checkImmunityTime, msgId={},commitLogOffset={}, wait check&quot;</span><span class="token punctuation">,</span>
                        requestHeader<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// éªŒè¯äº‹åŠ¡åŠæ¶ˆæ¯çš„å¿…è¦å­—æ®µ</span>
            <span class="token class-name">RemotingCommand</span> res <span class="token operator">=</span> <span class="token function">checkPrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// éªŒè¯æˆåŠŸ</span>
                <span class="token comment">// æ¢å¤äº‹åŠ¡åŠæ¶ˆæ¯çš„çœŸå® Topicã€é˜Ÿåˆ—ï¼Œå¹¶è®¾ç½®äº‹åŠ¡ IDï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§</span>
                <span class="token class-name">MessageExtBrokerInner</span> msgInner <span class="token operator">=</span> <span class="token function">endMessageTransaction</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msgInner<span class="token punctuation">.</span><span class="token function">setSysFlag</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token function">resetTransactionValue</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitOrRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msgInner<span class="token punctuation">.</span><span class="token function">setQueueOffset</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTranStateTableOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msgInner<span class="token punctuation">.</span><span class="token function">setPreparedTransactionOffset</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msgInner<span class="token punctuation">.</span><span class="token function">setStoreTimestamp</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">clearProperty</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_TRANSACTION_PREPARED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å‘é€æœ€ç»ˆçš„äº‹åŠ¡æ¶ˆæ¯ï¼Œå­˜å‚¨åˆ° CommitLog ä¸­ï¼Œå¯ä»¥è¢«æ¶ˆè´¹è€…æ¶ˆè´¹</span>
                <span class="token class-name">RemotingCommand</span> sendResult <span class="token operator">=</span> <span class="token function">sendFinalMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// åˆ é™¤äº‹åŠ¡åŠæ¶ˆæ¯ï¼šå°†äº‹åŠ¡åŠæ¶ˆæ¯å­˜å‚¨åœ¨äº‹åŠ¡æ¶ˆæ¯æ“ä½œ Topicï¼šRMQ_SYS_TRANS_OP_HALF_TOPIC ä¸­ï¼Œè¡¨ç¤ºè¯¥æ¶ˆæ¯å·²ç»è¢«å¤„ç†</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deletePrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// successful committed, then total num of half-messages minus 1</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span>commitMessagesTotal<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span><span class="token function">newAttributesBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">LABEL_TOPIC</span><span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// record the commit latency.</span>
                    <span class="token class-name">Long</span> commitLatency <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
                    <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span>transactionFinishLatency<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>commitLatency<span class="token punctuation">,</span> <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span><span class="token function">newAttributesBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">LABEL_TOPIC</span><span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> sendResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// äº‹åŠ¡å›æ»š</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_ROLLBACK_TYPE</span> <span class="token operator">==</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitOrRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»å­˜å‚¨ä¸­æŸ¥è¯¢å‡ºäº‹åŠ¡åŠæ¶ˆæ¯</span>
        result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollbackMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æˆåŠŸæŸ¥è¯¢å‡ºäº‹åŠ¡åŠæ¶ˆæ¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rejectCommitOrRollback</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">ILLEGAL_OPERATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Message rollback fail [producer end]. currentTimeMillis - bornTime &gt; checkImmunityTime, msgId={},commitLogOffset={}, wait check&quot;</span><span class="token punctuation">,</span>
                        requestHeader<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">RemotingCommand</span> res <span class="token operator">=</span> <span class="token function">checkPrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// åˆ é™¤äº‹åŠ¡åŠæ¶ˆæ¯ï¼šå°†äº‹åŠ¡åŠæ¶ˆæ¯å­˜å‚¨åœ¨äº‹åŠ¡æ¶ˆæ¯æ“ä½œ Topicï¼šRMQ_SYS_TRANS_OP_HALF_TOPIC ä¸­ï¼Œè¡¨ç¤ºè¯¥æ¶ˆæ¯å·²ç»è¢«å¤„ç†</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deletePrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// roll back, then total num of half-messages minus 1</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span>rollBackMessagesTotal<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span><span class="token function">newAttributesBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">LABEL_TOPIC</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€æœªçŸ¥åˆ™ä¸åšå¤„ç†</span>
    response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseRemark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-äº‹åŠ¡çŠ¶æ€å›æŸ¥" tabindex="-1"><a class="header-anchor" href="#_5-2-äº‹åŠ¡çŠ¶æ€å›æŸ¥" aria-hidden="true">#</a> 5.2 äº‹åŠ¡çŠ¶æ€å›æŸ¥</h3><h4 id="_5-2-1-broker-å›æŸ¥äº‹åŠ¡çŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#_5-2-1-broker-å›æŸ¥äº‹åŠ¡çŠ¶æ€" aria-hidden="true">#</a> 5.2.1 Broker å›æŸ¥äº‹åŠ¡çŠ¶æ€</h4><h5 id="transactionalmessagecheckservice-onwaitend" tabindex="-1"><a class="header-anchor" href="#transactionalmessagecheckservice-onwaitend" aria-hidden="true">#</a> TransactionalMessageCheckService#onWaitEnd</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// TransactionalMessageCheckService.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Start transaction check service thread!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é»˜è®¤æ¯ 30s æ£€æŸ¥ä¸€æ¬¡</span>
        <span class="token keyword">long</span> checkInterval <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionCheckInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span>checkInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;End transaction check service thread!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onWaitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº‹åŠ¡æ¶ˆæ¯å›æŸ¥å…ç–«æœŸï¼Œè¿‡äº†å…ç–«æœŸï¼Œå³æ¶ˆæ¯çš„å­˜å‚¨æ—¶é—´ + è¯¥å€¼ &gt; ç³»ç»Ÿå½“å‰æ—¶é—´ï¼Œæ‰å¯¹è¯¥æ¶ˆæ¯æ‰§è¡Œäº‹åŠ¡çŠ¶æ€å›æŸ¥ã€‚é»˜è®¤ä¸º 6s</span>
    <span class="token keyword">long</span> timeout <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// äº‹åŠ¡çš„æœ€å¤§æ£€æµ‹æ¬¡æ•°ï¼Œå¦‚æœè¶…è¿‡æ£€æµ‹æ¬¡æ•°ï¼Œæ¶ˆæ¯ä¼šé»˜è®¤ä¸ºä¸¢å¼ƒï¼Œå³ rollback æ¶ˆæ¯ã€‚é»˜è®¤ 15 æ¬¡</span>
    <span class="token keyword">int</span> checkMax <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionCheckMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Begin to check prepare message, begin time:{}&quot;</span><span class="token punctuation">,</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€è¯·æ±‚åˆ°ç”Ÿäº§è€…å®¢æˆ·ç«¯ï¼Œå›æŸ¥äº‹åŠ¡æ¶ˆæ¯æ‰§è¡ŒçŠ¶æ€</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> checkMax<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageCheckListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;End to check prepare message, consumed time:{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="transactionalmessageserviceimpl-check" tabindex="-1"><a class="header-anchor" href="#transactionalmessageserviceimpl-check" aria-hidden="true">#</a> TransactionalMessageServiceImpl#check</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// TransactionalMessageServiceImpl.java</span>
<span class="token doc-comment comment">/**
 * å‘é€è¯·æ±‚åˆ°ç”Ÿäº§è€…å®¢æˆ·ç«¯ï¼Œå›æŸ¥äº‹åŠ¡æ¶ˆæ¯æ‰§è¡ŒçŠ¶æ€
 *
 * <span class="token keyword">@param</span> <span class="token parameter">transactionTimeout</span> The minimum time of the transactional message to be checked firstly, one message only
 * exceed this time interval that can be checked.
 *        äº‹åŠ¡æ¶ˆæ¯é¦–æ¬¡å›æŸ¥çš„æœ€å°æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´é—´éš”çš„äº‹åŠ¡æ¶ˆæ¯æ‰ä¼šè¢«å›æŸ¥
 * <span class="token keyword">@param</span> <span class="token parameter">transactionCheckMax</span> The maximum number of times the message was checked, if exceed this value, this
 * message will be discarded.
 *        æ¶ˆæ¯è¢«å›æŸ¥çš„æœ€å¤§æ¬¡æ•°ï¼Œè¶…è¿‡è¿™ä¸ªæ¬¡æ•°åˆ™ä¸¢å¼ƒ
 * <span class="token keyword">@param</span> <span class="token parameter">listener</span> When the message is considered to be checked or discarded, the relative method of this class will
 * be invoked.
 *        å½“æ¶ˆæ¯è¢«å›æŸ¥æˆ–è€…ä¸¢å¼ƒæ—¶ï¼Œä¼šè°ƒç”¨è¯¥ç›‘å¬å™¨çš„æ–¹æ³•
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">long</span> transactionTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> transactionCheckMax<span class="token punctuation">,</span>
    <span class="token class-name">AbstractTransactionalMessageCheckListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token class-name">TopicValidator</span><span class="token punctuation">.</span><span class="token constant">RMQ_SYS_TRANS_HALF_TOPIC</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–äº‹åŠ¡åŠæ¶ˆæ¯ Topic çš„æ‰€æœ‰é˜Ÿåˆ—ï¼Œé»˜è®¤åªæœ‰ 1 ä¸ªé˜Ÿåˆ—</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> msgQueues <span class="token operator">=</span> transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">fetchMessageQueues</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgQueues <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> msgQueues<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;The queue of topic is empty :&quot;</span> <span class="token operator">+</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageQueue</span> messageQueue <span class="token operator">:</span> msgQueues<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è·å–å¯¹åº”çš„æ“ä½œé˜Ÿåˆ—ï¼Œä¸»é¢˜ä¸ºï¼šRMQ_SYS_TRANS_OP_HALF_TOPICã€‚è¯¥ä¸»é¢˜ä¿å­˜äº‹åŠ¡æ¶ˆæ¯æäº¤æˆ–è€…å›æ»šçš„è¯·æ±‚</span>
            <span class="token class-name">MessageQueue</span> opQueue <span class="token operator">=</span> <span class="token function">getOpQueue</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å†…éƒ¨æ¶ˆè´¹ç»„ CID_SYS_RMQ_TRANS å¯¹äº‹åŠ¡åŠæ¶ˆæ¯çš„æ¶ˆè´¹è¿›åº¦</span>
            <span class="token keyword">long</span> halfOffset <span class="token operator">=</span> transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">fetchConsumeOffset</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å†…éƒ¨æ¶ˆè´¹ç»„ CID_SYS_RMQ_TRANS å¯¹æ“ä½œé˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦</span>
            <span class="token keyword">long</span> opOffset <span class="token operator">=</span> transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">fetchConsumeOffset</span><span class="token punctuation">(</span>opQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Before check, the queue={} msgOffset={} opOffset={}&quot;</span><span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span> halfOffset<span class="token punctuation">,</span> opOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>halfOffset <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> opOffset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;MessageQueue: {} illegal offset read: {}, op offset: {},skip this queue&quot;</span><span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span>
                    halfOffset<span class="token punctuation">,</span> opOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// å·²ç»å¤„ç†å®Œçš„æ“ä½œæ¶ˆæ¯çš„åç§»é‡åˆ—è¡¨</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> doneOpOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å·²ç»æ”¶åˆ°æ“ä½œæ¶ˆæ¯çš„äº‹åŠ¡åŠæ¶ˆæ¯åç§»é‡ï¼Œéœ€è¦è¢«ç§»é™¤ã€‚keyï¼šåŠæ¶ˆæ¯åç§»é‡ï¼Œvalueï¼šæ“ä½œæ¶ˆæ¯åç§»é‡</span>
            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> removeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åœ¨æ“ä½œæ¶ˆæ¯ä¸­çš„æ‰€æœ‰åŠæ¶ˆæ¯çš„åç§»é‡</span>
            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">HashSet</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> opMsgMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">HashSet</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ‹‰å–ä¸€æ‰¹ï¼ˆ32 æ¡ï¼‰æ“ä½œé˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œå¡«å…… removeMap å’Œ opMsgMapã€‚å¯¹äºè¿™æ‰¹æ“ä½œæ¶ˆæ¯å·²ç»æäº¤çš„äº‹åŠ¡åŠæ¶ˆæ¯ï¼Œä¸ç”¨å›æŸ¥éœ€è¦ç§»é™¤</span>
            <span class="token class-name">PullResult</span> pullResult <span class="token operator">=</span> <span class="token function">fillOpRemoveMap</span><span class="token punctuation">(</span>removeMap<span class="token punctuation">,</span> opQueue<span class="token punctuation">,</span> opOffset<span class="token punctuation">,</span> halfOffset<span class="token punctuation">,</span> opMsgMap<span class="token punctuation">,</span> doneOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> pullResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;The queue={} check msgOffset={} with opOffset={} failed, pullResult is null&quot;</span><span class="token punctuation">,</span>
                    messageQueue<span class="token punctuation">,</span> halfOffset<span class="token punctuation">,</span> opOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// single thread</span>
            <span class="token comment">// è·å–ç©ºæ¶ˆæ¯çš„æ¬¡æ•°</span>
            <span class="token keyword">int</span> getMessageNullCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">// äº‹åŠ¡åŠæ¶ˆæ¯é˜Ÿåˆ—çš„æœ€æ–°æ¶ˆè´¹è¿›åº¦</span>
            <span class="token keyword">long</span> newOffset <span class="token operator">=</span> halfOffset<span class="token punctuation">;</span>
            <span class="token comment">// å½“å‰å¤„ç†å›æŸ¥çš„äº‹åŠ¡åŠæ¶ˆæ¯æ¶ˆè´¹åç§»é‡ï¼Œä»å½“å‰æ¶ˆè´¹è¿›åº¦å¼€å§‹éå†</span>
            <span class="token keyword">long</span> i <span class="token operator">=</span> halfOffset<span class="token punctuation">;</span>
            <span class="token keyword">long</span> nextOpOffset <span class="token operator">=</span> pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// é‡æ–°æ”¾å…¥äº‹åŠ¡åŠæ¶ˆæ¯é˜Ÿåˆ—çš„äº‹åŠ¡åŠæ¶ˆæ¯æ•°é‡</span>
            <span class="token keyword">int</span> putInQueueCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> escapeFailCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token comment">// æ¶ˆæ¯å›æŸ¥æ­»å¾ªç¯ï¼Œå›æŸ¥è¯¥é˜Ÿåˆ—ä¸­éœ€è¦å›æŸ¥çš„äº‹åŠ¡åŠæ¶ˆæ¯çš„æ‰§è¡ŒçŠ¶æ€</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¯¹è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯çš„å›æŸ¥æœ€å¤šæŒç»­ 60s</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">&gt;</span> <span class="token constant">MAX_PROCESS_TIME_LIMIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Queue={} process time reach max={}&quot;</span><span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span> <span class="token constant">MAX_PROCESS_TIME_LIMIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// å¦‚æœ removeMap ä¸­åŒ…å«è¯¥äº‹åŠ¡åŠæ¶ˆæ¯çš„åç§»é‡ï¼Œè¯´æ˜è¯¥äº‹åŠ¡åŠæ¶ˆæ¯å·²ç»è¢«æäº¤æˆ–è€…å›æ»šï¼Œéœ€è¦ç§»é™¤ï¼Œä¸éœ€è¦å›æŸ¥</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>removeMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Half offset {} has been committed/rolled back&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Long</span> removedOpOffset <span class="token operator">=</span> removeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    opMsgMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>removedOpOffset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>opMsgMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>removedOpOffset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        opMsgMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>removedOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        doneOpOffset<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>removedOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token comment">// è¯¥äº‹åŠ¡åŠæ¶ˆæ¯æ²¡æœ‰è¢«æäº¤æˆ–è€…å›æ»šï¼Œéœ€è¦å›æŸ¥ã€‚æŸ¥è¯¢å‡ºè¯¥äº‹åŠ¡åŠæ¶ˆæ¯çš„æ¶ˆæ¯ä½“</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">GetResult</span> getResult <span class="token operator">=</span> <span class="token function">getHalfMsg</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// äº‹åŠ¡åŠæ¶ˆæ¯</span>
                    <span class="token class-name">MessageExt</span> msgExt <span class="token operator">=</span> getResult<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgExt <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// å¦‚æœäº‹åŠ¡åŠæ¶ˆæ¯ Topic ä¸­è·å–ä¸åˆ°æ¶ˆæ¯ï¼Œä¸”è¶…è¿‡æœ€å¤§è·å–ä¸åˆ°æ¶ˆæ¯çš„æ¬¡æ•°ï¼ˆé»˜è®¤ 1 æ¬¡ï¼‰ï¼Œåˆ™ç»“æŸæœ¬æ¬¡å›æŸ¥</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageNullCount<span class="token operator">++</span> <span class="token operator">&gt;</span> <span class="token constant">MAX_RETRY_COUNT_WHEN_HALF_NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PullStatus</span><span class="token punctuation">.</span><span class="token constant">NO_NEW_MSG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;No new msg, the miss offset={} in={}, continue check={}, pull result={}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>
                                messageQueue<span class="token punctuation">,</span> getMessageNullCount<span class="token punctuation">,</span> getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment">// ä¼ å…¥çš„åç§»é‡éæ³•ï¼Œä¿®æ­£åç§»é‡åç»§ç»­æŸ¥è¯¢äº‹åŠ¡åŠæ¶ˆæ¯</span>
                            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Illegal offset, the miss offset={} in={}, continue check={}, pull result={}&quot;</span><span class="token punctuation">,</span>
                                i<span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span> getMessageNullCount<span class="token punctuation">,</span> getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            i <span class="token operator">=</span> getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            newOffset <span class="token operator">=</span> i<span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// äº‹åŠ¡æ¶ˆæ¯é€ƒé€¸</span>
                    <span class="token comment">// ...</span>

                    <span class="token comment">// åˆ¤æ–­äº‹åŠ¡æ¶ˆæ¯æ˜¯å¦éœ€è¦ä¸¢å¼ƒï¼Œå³è¶…è¿‡æœ€å¤§å›æŸ¥æ¬¡æ•°ï¼ˆ15æ¬¡ï¼‰ï¼›æˆ–è€…æ˜¯å¦éœ€è¦è·³è¿‡ï¼Œå³è¶…è¿‡æ–‡ä»¶ä¿å­˜æ—¶é—´ã€‚</span>
                    <span class="token comment">// å¦‚æœä¸ä¸¢å¼ƒæˆ–è·³è¿‡ï¼Œè¿™é‡Œä¼šå¢åŠ äº‹åŠ¡åŠæ¶ˆæ¯å±æ€§ä¸­çš„é‡è¯•æ¬¡æ•°</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needDiscard</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">,</span> transactionCheckMax<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">needSkip</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// ä¸¢å¼ƒæˆ–è·³è¿‡ï¼šå°†äº‹åŠ¡åŠæ¶ˆæ¯å‘é€åˆ°ç‰¹æ®Šçš„å†…éƒ¨ Topicï¼šTRANS_CHECK_MAX</span>
                        listener<span class="token punctuation">.</span><span class="token function">resolveDiscardMsg</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        newOffset <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        i<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// å¦‚æœäº‹åŠ¡åŠæ¶ˆæ¯çš„å­˜å‚¨æ—¶é—´å¤§äºç­‰äºæœ¬æ¬¡å›æŸ¥å¼€å§‹æ—¶é—´ï¼Œè¯´æ˜è¿™æ¡æ˜¯æ–°çš„äº‹åŠ¡åŠæ¶ˆæ¯å­˜å‚¨è¿›æ¥ï¼Œç»“æŸæœ¬æ¬¡å›æŸ¥ï¼Œç¨åå†å›æŸ¥</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Fresh stored. the miss offset={}, check it later, store={}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// è®¡ç®—äº‹åŠ¡åŠæ¶ˆæ¯æ˜¯å¦å¤„åœ¨å…ç–«å›æŸ¥æœŸï¼šå³äº‹åŠ¡æ¶ˆæ¯å‘é€ä¸€æ®µæ—¶é—´ä¹‹å†…ä¸è¿›è¡Œå›æŸ¥</span>
                    <span class="token comment">// äº‹åŠ¡åŠæ¶ˆæ¯å·²ç»å­˜åœ¨çš„æ—¶é•¿</span>
                    <span class="token keyword">long</span> valueOfCurrentMinusBorn <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> msgExt<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// å…ç–«å›æŸ¥æœŸæ—¶é•¿ï¼Œé»˜è®¤ç­‰äºäº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼Œ6s</span>
                    <span class="token keyword">long</span> checkImmunityTime <span class="token operator">=</span> transactionTimeout<span class="token punctuation">;</span>
                    <span class="token comment">// æ¶ˆæ¯å±æ€§ä¸­å®šä¹‰çš„å…ç–«å›æŸ¥æ—¶é•¿</span>
                    <span class="token class-name">String</span> checkImmunityTimeStr <span class="token operator">=</span> msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_CHECK_IMMUNITY_TIME_IN_SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> checkImmunityTimeStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// å¦‚æœæ¶ˆæ¯å±æ€§ä¸­ä¹Ÿå®šä¹‰äº†å…ç–«å›æŸ¥æ—¶é•¿ï¼Œä¼˜å…ˆä½¿ç”¨æ¶ˆæ¯å±æ€§ä¸­çš„å€¼ï¼Œå•ä½ä¸ºç§’</span>
                        checkImmunityTime <span class="token operator">=</span> <span class="token function">getImmunityTime</span><span class="token punctuation">(</span>checkImmunityTimeStr<span class="token punctuation">,</span> transactionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// äº‹åŠ¡åŠæ¶ˆæ¯å­˜åœ¨æ—¶é•¿å°äºå…ç–«å›æŸ¥æ—¶é•¿ï¼Œä¸éœ€è¦å›æŸ¥</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>valueOfCurrentMinusBorn <span class="token operator">&lt;</span> checkImmunityTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// æ£€æŸ¥è¯¥äº‹åŠ¡åŠæ¶ˆæ¯çš„åç§»é‡ï¼Œå¦‚æœåœ¨ removeMap é‡Œï¼Œå³è¯¥æ¶ˆæ¯å·²ç»è¢«æäº¤æˆ–å›æ»šï¼Œä¸éœ€è¦å¤„ç†äº†ã€‚</span>
                            <span class="token comment">// è·³è¿‡ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªäº‹åŠ¡åŠæ¶ˆæ¯çš„å›æŸ¥åˆ¤æ–­</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkPrepareQueueOffset</span><span class="token punctuation">(</span>removeMap<span class="token punctuation">,</span> doneOpOffset<span class="token punctuation">,</span> msgExt<span class="token punctuation">,</span> checkImmunityTimeStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                newOffset <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                                i<span class="token operator">++</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> valueOfCurrentMinusBorn <span class="token operator">&amp;&amp;</span> valueOfCurrentMinusBorn <span class="token operator">&lt;</span> checkImmunityTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;New arrived, the miss offset={}, check it later checkImmunity={}, born={}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>
                                checkImmunityTime<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">/*
                     * åˆ¤æ–­æ˜¯å¦éœ€è¦å›æŸ¥ï¼Œæ»¡è¶³ä»¥ä¸‹ 3 ä¸ªæ¡ä»¶ä¹‹ä¸€åˆ™è¿›è¡Œå›æŸ¥
                     * 1. æ²¡æœ‰æ“ä½œæ¶ˆæ¯ï¼Œä¸”å½“å‰åŠæ¶ˆæ¯åœ¨å›æŸ¥å…ç–«æœŸå¤–
                     * 2. å­˜åœ¨æ“ä½œæ¶ˆæ¯ï¼Œä¸”æœ¬æ‰¹æ¬¡æ“ä½œæ¶ˆæ¯ä¸­æœ€åä¸€ä¸ªåœ¨å…ç–«æœŸå¤–
                     * 3. Broker ä¸å®¢æˆ·ç«¯æœ‰æ—¶é—´å·®
                     */</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> opMsg <span class="token operator">=</span> pullResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> isNeedCheck <span class="token operator">=</span> opMsg <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> valueOfCurrentMinusBorn <span class="token operator">&gt;</span> checkImmunityTime
                        <span class="token operator">||</span> opMsg <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> opMsg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>opMsg<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">&gt;</span> transactionTimeout
                        <span class="token operator">||</span> valueOfCurrentMinusBorn <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>isNeedCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// å°†äº‹åŠ¡åŠæ¶ˆæ¯é‡æ–°æ”¾å…¥åˆ°äº‹åŠ¡åŠæ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå› ä¸ºå‰é¢æ›´æ–°äº†äº‹åŠ¡åŠæ¶ˆæ¯çš„å±æ€§ï¼ˆå›æŸ¥æ¬¡æ•°ï¼‰ï¼Œéœ€è¦æ›´æ–°æ¶ˆè´¹åç§»é‡å¹¶ä¸”é‡æ–°å­˜å‚¨ã€‚</span>
                        <span class="token comment">// å¹¶ä¸”å›æŸ¥æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹ï¼Œä¸ç¡®å®šå›æŸ¥æ˜¯å¦èƒ½å¤Ÿè¯·æ±‚åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œåšæœ€åçš„æ‰“ç®—ï¼Œæ²¡æœ‰è¯·æ±‚æˆåŠŸåˆ™ä¸‹æ¬¡ç»§ç»­å›æŸ¥ã€‚</span>
                        <span class="token comment">// å¦‚æœå›æŸ¥æˆåŠŸåˆ™å†™å…¥æ“ä½œæ¶ˆæ¯ Mapï¼Œä¸‹æ¬¡ä¸ä¼šå›æŸ¥ã€‚</span>
                        <span class="token comment">// è¿™é‡Œæœ‰ä¸ªé—®é¢˜æ˜¯ï¼šæœ€åçš„æƒ…å†µä¸‹ï¼ˆäº‹åŠ¡æ¶ˆæ¯ä¸€ç›´æ‰§è¡Œä¸­ï¼Œä¸åœå›æŸ¥ï¼‰ï¼Œä¼šæœ€å¤šé‡å¤å­˜å‚¨ 15 æ¬¡äº‹åŠ¡åŠæ¶ˆæ¯ï¼Œé€ æˆå†™æ”¾å¤§ã€‚</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">putBackHalfMsgQueue</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        putInQueueCount<span class="token operator">++</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Check transaction. real_topic={},uniqKey={},offset={},commitLogOffset={}&quot;</span><span class="token punctuation">,</span>
                                msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                msgExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgExt<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// é€šè¿‡ listener å‘æ¶ˆè´¹è€…å®¢æˆ·ç«¯å‘é€å•å‘çš„æ¶ˆæ¯å›æŸ¥è¯·æ±‚</span>
                        listener<span class="token punctuation">.</span><span class="token function">resolveHalfMsg</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// ä¸éœ€è¦è¿›è¡Œå›æŸ¥ï¼Œæ›´æ–°ä¸‹ä¸€ä¸ªè¦æ£€æŸ¥çš„äº‹åŠ¡æ“ä½œæ¶ˆæ¯çš„åç§»é‡</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        nextOpOffset <span class="token operator">=</span> pullResult <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> nextOpOffset<span class="token punctuation">;</span>
                        pullResult <span class="token operator">=</span> <span class="token function">fillOpRemoveMap</span><span class="token punctuation">(</span>removeMap<span class="token punctuation">,</span> opQueue<span class="token punctuation">,</span> nextOpOffset<span class="token punctuation">,</span>
                                halfOffset<span class="token punctuation">,</span> opMsgMap<span class="token punctuation">,</span> doneOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>pullResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> pullResult<span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PullStatus</span><span class="token punctuation">.</span><span class="token constant">NO_NEW_MSG</span>
                                <span class="token operator">||</span> pullResult<span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PullStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_ILLEGAL</span>
                                <span class="token operator">||</span> pullResult<span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PullStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_MSG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token constant">SLEEP_WHILE_NO_OP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token punctuation">}</span>

                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;The miss message offset:{}, pullOffsetOfOp:{}, miniOffset:{} get more opMsg.&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> nextOpOffset<span class="token punctuation">,</span> halfOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                newOffset <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ›´æ–°äº‹åŠ¡åŠæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—çš„å›æŸ¥è¿›åº¦</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newOffset <span class="token operator">!=</span> halfOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">updateConsumeOffset</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">,</span> newOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ›´æ–°æ“ä½œé˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦</span>
            <span class="token keyword">long</span> newOpOffset <span class="token operator">=</span> <span class="token function">calculateOpOffset</span><span class="token punctuation">(</span>doneOpOffset<span class="token punctuation">,</span> opOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newOpOffset <span class="token operator">!=</span> opOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">updateConsumeOffset</span><span class="token punctuation">(</span>opQueue<span class="token punctuation">,</span> newOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">GetResult</span> getResult <span class="token operator">=</span> <span class="token function">getHalfMsg</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">,</span> newOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pullResult <span class="token operator">=</span> <span class="token function">pullOpMsg</span><span class="token punctuation">(</span>opQueue<span class="token punctuation">,</span> newOpOffset<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> maxMsgOffset <span class="token operator">=</span> getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> newOffset <span class="token operator">:</span> getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> maxOpOffset <span class="token operator">=</span> pullResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> newOpOffset <span class="token operator">:</span> pullResult<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> msgTime <span class="token operator">=</span> getResult<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> getResult<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;After check, {} opOffset={} opOffsetDiff={} msgOffset={} msgOffsetDiff={} msgTime={} msgTimeDelayInMs={} putInQueueCount={}&quot;</span><span class="token punctuation">,</span>
                    messageQueue<span class="token punctuation">,</span> newOpOffset<span class="token punctuation">,</span> maxOpOffset <span class="token operator">-</span> newOpOffset<span class="token punctuation">,</span> newOffset<span class="token punctuation">,</span> maxMsgOffset <span class="token operator">-</span> newOffset<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>msgTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> msgTime<span class="token punctuation">,</span> putInQueueCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Check error&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * è®¡ç®—å…ç–«å›æŸ¥æ—¶é•¿ï¼Œå¦‚æœæ¶ˆæ¯å±æ€§ä¸­å®šä¹‰äº†å…ç–«å›æŸ¥æ—¶é•¿ï¼Œåˆ™ä½¿ç”¨æ¶ˆæ¯å±æ€§ä¸­å®šä¹‰çš„å…ç–«å›æŸ¥æ—¶é•¿ï¼Œå¦åˆ™ä½¿ç”¨äº‹åŠ¡è¶…æ—¶æ—¶é—´
 * <span class="token keyword">@param</span> <span class="token parameter">checkImmunityTimeStr</span> æ¶ˆæ¯å±æ€§ä¸­å®šä¹‰çš„å…ç–«å›æŸ¥æ—¶é•¿
 * <span class="token keyword">@param</span> <span class="token parameter">transactionTimeout</span> äº‹åŠ¡è¶…æ—¶æ—¶é—´
 * <span class="token keyword">@return</span> å…ç–«å›æŸ¥æ—¶é•¿
 */</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">getImmunityTime</span><span class="token punctuation">(</span><span class="token class-name">String</span> checkImmunityTimeStr<span class="token punctuation">,</span> <span class="token keyword">long</span> transactionTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> checkImmunityTime<span class="token punctuation">;</span>

    checkImmunityTime <span class="token operator">=</span> <span class="token function">getLong</span><span class="token punctuation">(</span>checkImmunityTimeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> checkImmunityTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        checkImmunityTime <span class="token operator">=</span> transactionTimeout<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        checkImmunityTime <span class="token operator">*=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> checkImmunityTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="abstracttransactionalmessagechecklistener-resolvehalfmsg" tabindex="-1"><a class="header-anchor" href="#abstracttransactionalmessagechecklistener-resolvehalfmsg" aria-hidden="true">#</a> AbstractTransactionalMessageCheckListener#resolveHalfMsg</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AbstractTransactionalMessageCheckListener.java</span>
<span class="token doc-comment comment">/**
 * å¤„ç†äº‹åŠ¡åŠæ¶ˆæ¯ï¼ˆå›æŸ¥å…¶æ‰§è¡ŒçŠ¶æ€ï¼‰
 * <span class="token keyword">@param</span> <span class="token parameter">msgExt</span> äº‹åŠ¡åŠæ¶ˆæ¯
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resolveHalfMsg</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MessageExt</span> msgExt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executorService <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">sendCheckMessage</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Send check message error!&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;TransactionalMessageCheckListener not init&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * å‘é€å›æŸ¥è¯·æ±‚åˆ°ç”Ÿäº§è€…å®¢æˆ·ç«¯
 *
 * <span class="token keyword">@param</span> <span class="token parameter">msgExt</span> äº‹åŠ¡åŠæ¶ˆæ¯
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendCheckMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msgExt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">CheckTransactionStateRequestHeader</span> checkTransactionStateRequestHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckTransactionStateRequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setCommitLogOffset</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setOffsetMsgId</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setMsgId</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setTranStateTableOffset</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setBrokerName</span><span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä»æ¶ˆæ¯å±æ€§ä¸­å¤åŸçœŸå®çš„ topic å’Œ queueId</span>
    msgExt<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgExt<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_QUEUE_ID</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgExt<span class="token punctuation">.</span><span class="token function">setStoreSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> groupId <span class="token operator">=</span> msgExt<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_PRODUCER_GROUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è½®è¯¢é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ç”Ÿäº§è€…å®¢æˆ·ç«¯é€šé“</span>
    <span class="token class-name">Channel</span> channel <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getProducerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAvailableChannel</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‘é€å›æŸ¥è¯·æ±‚åˆ°ç”Ÿäº§è€…å®¢æˆ·ç«¯ï¼Œå›æŸ¥äº‹åŠ¡æ¶ˆæ¯æ‰§è¡ŒçŠ¶æ€ã€‚å•å‘è¯·æ±‚ï¼Œä¸éœ€è¦ç­‰å¾…å“åº”</span>
        brokerController<span class="token punctuation">.</span><span class="token function">getBroker2Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkProducerTransactionState</span><span class="token punctuation">(</span>groupId<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> checkTransactionStateRequestHeader<span class="token punctuation">,</span> msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Check transaction failed, channel is null. groupId={}&quot;</span><span class="token punctuation">,</span> groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-2-producer-å¤„ç†å›æŸ¥è¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#_5-2-2-producer-å¤„ç†å›æŸ¥è¯·æ±‚" aria-hidden="true">#</a> 5.2.2 Producer å¤„ç†å›æŸ¥è¯·æ±‚</h4><h5 id="clientremotingprocessor-checktransactionstate" tabindex="-1"><a class="header-anchor" href="#clientremotingprocessor-checktransactionstate" aria-hidden="true">#</a> ClientRemotingProcessor#checkTransactionState</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ClientRemotingProcessor.java</span>
<span class="token doc-comment comment">/**
 * å¤„ç† Broker å‘æ¥çš„äº‹åŠ¡å›æŸ¥è¯·æ±‚ï¼Œå‘é€æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€åˆ° Broker
 */</span>
<span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">checkTransactionState</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
    <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">CheckTransactionStateRequestHeader</span> requestHeader <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token class-name">CheckTransactionStateRequestHeader</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">CheckTransactionStateRequestHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">MessageExt</span> messageExt <span class="token operator">=</span> <span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory<span class="token punctuation">.</span><span class="token function">getClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            messageExt<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token class-name">NamespaceUtil</span>
                <span class="token punctuation">.</span><span class="token function">withoutNamespace</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory<span class="token punctuation">.</span><span class="token function">getClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> transactionId <span class="token operator">=</span> messageExt<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> transactionId <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            messageExt<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> group <span class="token operator">=</span> messageExt<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_PRODUCER_GROUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>group <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">MQProducerInner</span> producer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory<span class="token punctuation">.</span><span class="token function">selectProducer</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>producer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> addr <span class="token operator">=</span> <span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token function">parseChannelRemoteAddr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ£€æŸ¥æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ï¼Œå‘é€åˆ° Broker</span>
                producer<span class="token punctuation">.</span><span class="token function">checkTransactionState</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> messageExt<span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;checkTransactionState, pick producer by group[{}] failed&quot;</span><span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;checkTransactionState, pick producer group failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;checkTransactionState, decode message failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="defaultmqproducerimpl-checktransactionstate" tabindex="-1"><a class="header-anchor" href="#defaultmqproducerimpl-checktransactionstate" aria-hidden="true">#</a> DefaultMQProducerImpl#checkTransactionState</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// DefaultMQProducerImpl.java</span>
<span class="token doc-comment comment">/**
 * å¤„ç† Broker å‘æ¥çš„äº‹åŠ¡æ¶ˆæ¯æ‰§è¡ŒçŠ¶æ€å›æŸ¥è¯·æ±‚ï¼Œæ£€æŸ¥æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ï¼Œå‘é€åˆ° Broker
 *
 * <span class="token keyword">@param</span> <span class="token parameter">addr</span> Broker åœ°å€
 * <span class="token keyword">@param</span> <span class="token parameter">msg</span> Broker å‘å›çš„äº‹åŠ¡åŠæ¶ˆæ¯
 * <span class="token keyword">@param</span> <span class="token parameter">header</span> Broker å›æŸ¥çš„è¯·æ±‚å¤´
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkTransactionState</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> addr<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">MessageExt</span> msg<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">CheckTransactionStateRequestHeader</span> header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Runnable</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> brokerAddr <span class="token operator">=</span> addr<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MessageExt</span> message <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CheckTransactionStateRequestHeader</span> checkRequestHeader <span class="token operator">=</span> header<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> group <span class="token operator">=</span> <span class="token class-name">DefaultMQProducerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TransactionCheckListener</span> transactionCheckListener <span class="token operator">=</span> <span class="token class-name">DefaultMQProducerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionListener</span> transactionListener <span class="token operator">=</span> <span class="token function">getCheckListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionCheckListener <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> transactionListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">LocalTransactionState</span> localTransactionState <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
                <span class="token class-name">Throwable</span> exception <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è·å–æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionCheckListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// ä½¿ç”¨äº†è€çš„ç”Ÿäº§è€…</span>
                        localTransactionState <span class="token operator">=</span> transactionCheckListener<span class="token punctuation">.</span><span class="token function">checkLocalTransactionState</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// ä½¿ç”¨äº†æ–°çš„äº‹åŠ¡æ¶ˆæ¯ç”Ÿäº§è€… API</span>
                        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;TransactionCheckListener is null, used new check API, producerGroup={}&quot;</span><span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        localTransactionState <span class="token operator">=</span> transactionListener<span class="token punctuation">.</span><span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Broker call checkTransactionState, but checkLocalTransactionState exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    exception <span class="token operator">=</span> e<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// å°†æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€å‘é€åˆ° Broker</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processTransactionState</span><span class="token punctuation">(</span>
                    checkRequestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    localTransactionState<span class="token punctuation">,</span>
                    group<span class="token punctuation">,</span>
                    exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;CheckTransactionState, pick transactionCheckListener by group[{}] failed&quot;</span><span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * æ ¹æ®æœ¬åœ°äº‹åŠ¡æ‰§è¡Œè£…å¡«ï¼Œæäº¤æˆ–å›æ»šäº‹åŠ¡æ¶ˆæ¯
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processTransactionState</span><span class="token punctuation">(</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">LocalTransactionState</span> localTransactionState<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> producerGroup<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">Throwable</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">EndTransactionRequestHeader</span> thisHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EndTransactionRequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setCommitLogOffset</span><span class="token punctuation">(</span>checkRequestHeader<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span>producerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setTranStateTableOffset</span><span class="token punctuation">(</span>checkRequestHeader<span class="token punctuation">.</span><span class="token function">getTranStateTableOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ˜¯ Broker ç«¯å›æŸ¥åå‘å‡ºçš„è¯·æ±‚</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setFromTransactionCheck</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setBrokerName</span><span class="token punctuation">(</span>checkRequestHeader<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> uniqueKey <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>uniqueKey <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                uniqueKey <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setMsgId</span><span class="token punctuation">(</span>uniqueKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>checkRequestHeader<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ ¹æ®æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ï¼Œè®¾ç½®è¯·æ±‚å¤´ä¸­çš„ commitOrRollback å€¼</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>localTransactionState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">COMMIT_MESSAGE</span><span class="token operator">:</span>
                    thisHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_COMMIT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">ROLLBACK_MESSAGE</span><span class="token operator">:</span>
                    thisHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_ROLLBACK_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;when broker check, client rollback this transaction, {}&quot;</span><span class="token punctuation">,</span> thisHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">UNKNOW</span><span class="token operator">:</span>
                    thisHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_NOT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;when broker check, client does not know this transaction state, {}&quot;</span><span class="token punctuation">,</span> thisHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> remark <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                remark <span class="token operator">=</span> <span class="token string">&quot;checkLocalTransactionState Exception: &quot;</span> <span class="token operator">+</span> <span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">exceptionSimpleDesc</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ‰§è¡Œäº‹åŠ¡æ¶ˆæ¯çŠ¶æ€å›æŸ¥åé’©å­ï¼Œä¸»è¦æ˜¯ä¸ŠæŠ¥æ¶ˆæ¯è½¨è¿¹</span>
            <span class="token function">doExecuteEndTransactionHook</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> uniqueKey<span class="token punctuation">,</span> brokerAddr<span class="token punctuation">,</span> localTransactionState<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// å‘ Broker å‘é€äº‹åŠ¡æ‰§è¡Œç»“æœï¼ŒBroker æ ¹æ®ç»“æœå¤„ç†äº‹åŠ¡åŠæ¶ˆæ¯</span>
                <span class="token class-name">DefaultMQProducerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getMQClientAPIImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endTransactionOneway</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> thisHeader<span class="token punctuation">,</span> remark<span class="token punctuation">,</span>
                    <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;endTransactionOneway exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>checkExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å‚è€ƒèµ„æ–™" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™" aria-hidden="true">#</a> å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://github.com/apache/rocketmq/blob/master/docs/cn/design.md#5-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF" target="_blank" rel="noopener noreferrer">RocketMQ è®¾è®¡æ–‡æ¡£â€”â€”äº‹åŠ¡æ¶ˆæ¯<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://rocketmq.apache.org/zh/docs/featureBehavior/04transactionmessage" target="_blank" rel="noopener noreferrer">å®˜æ–¹æ–‡æ¡£â€”â€”äº‹åŠ¡æ¶ˆæ¯<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://blog.csdn.net/prestigeding/article/details/81259646" target="_blank" rel="noopener noreferrer">RocketMQ æºç åˆ†æäº‹åŠ¡æ¶ˆæ¯ç³»åˆ—â€”â€”ä¸å¨<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><hr><p>æ¬¢è¿å…³æ³¨å…¬ä¼—å·ã€æ¶ˆæ¯ä¸­é—´ä»¶ã€‘ï¼ˆmiddleware-mqï¼‰ï¼Œæ›´æ–°æ¶ˆæ¯ä¸­é—´ä»¶çš„æºç è§£æå’Œæœ€æ–°åŠ¨æ€ï¼</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202205170102971.jpg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/HScarb/knowledge/edit/main/docs/src/rocketmq/20250131-rocketmq-transactional-message.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: jjhfen00@163.com">ScarbWin</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">é»˜è®¤é¡µè„š</div><div class="vp-copyright">Copyright Â© 2025 Scarb</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-58204090.js" defer></script>
  </body>
</html>
