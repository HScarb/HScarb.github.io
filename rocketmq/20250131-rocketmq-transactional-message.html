<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.66" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html"><meta property="og:site_name" content="金甲虫的博客"><meta property="og:title" content="RocketMQ 事务消息原理详解 & 源码解析"><meta property="og:description" content="原文地址：http://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html (http://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html) 1. 背景 在当下的互联网时..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-02-19T13:50:50.000Z"><meta property="article:author" content="Scarb"><meta property="article:published_time" content="2025-01-31T00:00:00.000Z"><meta property="article:modified_time" content="2025-02-19T13:50:50.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"RocketMQ 事务消息原理详解 & 源码解析","image":[""],"datePublished":"2025-01-31T00:00:00.000Z","dateModified":"2025-02-19T13:50:50.000Z","author":[{"@type":"Person","name":"Scarb"}]}</script><title>RocketMQ 事务消息原理详解 & 源码解析 | 金甲虫的博客</title><meta name="description" content="原文地址：http://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html (http://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html) 1. 背景 在当下的互联网时...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-e6f2d601.css" as="style"><link rel="stylesheet" href="/assets/style-e6f2d601.css">
    <link rel="modulepreload" href="/assets/app-58204090.js"><link rel="modulepreload" href="/assets/20250131-rocketmq-transactional-message.html-859aaa1b.js"><link rel="modulepreload" href="/assets/20250131-rocketmq-transactional-message.html-e19a7a5a.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/index.html-102bf403.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-6f333d07.js" as="script"><link rel="prefetch" href="/assets/20230530-lxf-java-note.html-9300be95.js" as="script"><link rel="prefetch" href="/assets/20230815-mockito-note.html-c2258399.js" as="script"><link rel="prefetch" href="/assets/20240827-reactor-java.html-fe9c28ac.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-cac7204c.js" as="script"><link rel="prefetch" href="/assets/index.html-f508c123.js" as="script"><link rel="prefetch" href="/assets/20191229-vim-note.html-b4a3cd68.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-d3e5eb48.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-7a801a5e.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-51122c83.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-0922cff0.js" as="script"><link rel="prefetch" href="/assets/20230813-lxf-js-note.html-82465167.js" as="script"><link rel="prefetch" href="/assets/20230820-powerjob.html-b9352ef3.js" as="script"><link rel="prefetch" href="/assets/20231015-consistent-hash.html-07b06be4.js" as="script"><link rel="prefetch" href="/assets/20241216-wow-restoration-druid-mythic-guide.html-78b5db66.js" as="script"><link rel="prefetch" href="/assets/99991231-ryf-ts-note.html-730cf657.js" as="script"><link rel="prefetch" href="/assets/index.html-f1d1b9ba.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-5756ebfa.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-59cfb351.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-7fe5f428.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-9de184dd.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-bb235715.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-e29ec945.js" as="script"><link rel="prefetch" href="/assets/20231016-rabbitmq-consistent-hash-exchange.html-6e2e8f6d.js" as="script"><link rel="prefetch" href="/assets/index.html-8e2b67a8.js" as="script"><link rel="prefetch" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-90c27f1b.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-2023d209.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-5de0a873.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-ae13da53.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-1ec85a19.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-e7fef9e4.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-b65d2e82.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-591b00dc.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-00247a89.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-7e15b5f8.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-b701d200.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-f9dc2d19.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-873655ea.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-7b285f6b.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-5f11b114.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-da9eb2ad.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-63ba6675.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-f3b1dd76.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-33d17a44.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-4da4a69a.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-7510810a.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-071340e5.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-f07feea0.js" as="script"><link rel="prefetch" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-650cf515.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-ff9830f7.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-26409d59.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-53d9ae69.js" as="script"><link rel="prefetch" href="/assets/20230808-rocketmq-timer.html-ee37a256.js" as="script"><link rel="prefetch" href="/assets/20240429-rocketmq-tieredstore.html-7d2652e2.js" as="script"><link rel="prefetch" href="/assets/20250204-rocketmq-dledger-leader-election.html-d0be5431.js" as="script"><link rel="prefetch" href="/assets/20250315-rocketmq-dledger-log-replication.html-8402d8c4.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-ddc41950.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-f220a3ec.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-79144a64.js" as="script"><link rel="prefetch" href="/assets/index.html-ccdf7995.js" as="script"><link rel="prefetch" href="/assets/404.html-8b9ee051.js" as="script"><link rel="prefetch" href="/assets/index.html-93211df9.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-5a8e9f7a.js" as="script"><link rel="prefetch" href="/assets/20230530-lxf-java-note.html-08c42556.js" as="script"><link rel="prefetch" href="/assets/20230815-mockito-note.html-c6e2b7aa.js" as="script"><link rel="prefetch" href="/assets/20240827-reactor-java.html-9f749db9.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-90c6834a.js" as="script"><link rel="prefetch" href="/assets/index.html-a1409058.js" as="script"><link rel="prefetch" href="/assets/20191229-vim-note.html-3cb72a58.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-a86d15ba.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-d080065a.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-4df91c45.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-b77fcd7c.js" as="script"><link rel="prefetch" href="/assets/20230813-lxf-js-note.html-eaf1a6b7.js" as="script"><link rel="prefetch" href="/assets/20230820-powerjob.html-251eed60.js" as="script"><link rel="prefetch" href="/assets/20231015-consistent-hash.html-c24475cd.js" as="script"><link rel="prefetch" href="/assets/20241216-wow-restoration-druid-mythic-guide.html-e7240a19.js" as="script"><link rel="prefetch" href="/assets/99991231-ryf-ts-note.html-2975463f.js" as="script"><link rel="prefetch" href="/assets/index.html-9ebc6945.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-858a0383.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-0630f7ab.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-c3d0ae51.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-a8a88e9f.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-b3961710.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-268544ec.js" as="script"><link rel="prefetch" href="/assets/20231016-rabbitmq-consistent-hash-exchange.html-227cab5a.js" as="script"><link rel="prefetch" href="/assets/index.html-9d4ec194.js" as="script"><link rel="prefetch" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-1b31018d.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-1e9b43e7.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-7ccda5a5.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-34d7890b.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-97bb621c.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-dcf49d86.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-13c02475.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-6462c745.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-6abd08ae.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-448c6e28.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-1cc3f55f.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-8dc2f504.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-4ef80ecd.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-9b818d2a.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-bf48ff9a.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-d99eddd6.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-28c333da.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-1096ba8f.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-95224230.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-fd8a5661.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-582b9ec4.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-d18be43e.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-14909c18.js" as="script"><link rel="prefetch" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-579f48a4.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-290f3979.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-14c44cf0.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-1e908e7d.js" as="script"><link rel="prefetch" href="/assets/20230808-rocketmq-timer.html-c6bb57f4.js" as="script"><link rel="prefetch" href="/assets/20240429-rocketmq-tieredstore.html-b33650d7.js" as="script"><link rel="prefetch" href="/assets/20250204-rocketmq-dledger-leader-election.html-344683e2.js" as="script"><link rel="prefetch" href="/assets/20250315-rocketmq-dledger-log-replication.html-373a7ec6.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-69396426.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-3445843d.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-6f48b630.js" as="script"><link rel="prefetch" href="/assets/index.html-9d89b6d6.js" as="script"><link rel="prefetch" href="/assets/404.html-081c3b90.js" as="script"><link rel="prefetch" href="/assets/giscus-0b7adcf8.js" as="script"><link rel="prefetch" href="/assets/auto-712ff3ee.js" as="script"><link rel="prefetch" href="/assets/index-2bf332f6.js" as="script"><link rel="prefetch" href="/assets/flowchart-c441f34d.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-d3d33a2d.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-abe06b83.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-122a014a.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-5794cde2.js" as="script"><link rel="prefetch" href="/assets/SearchResult-481ca63f.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><img class="vp-nav-logo" src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/scarb/scarb.jpg" alt="金甲虫的博客"><!----><span class="vp-site-name hide-in-pad">金甲虫的博客</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/"><!---->Home<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link active" href="/rocketmq/"><!---->RocketMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/rabbitmq/"><!---->RabbitMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/java/"><!---->Java<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/other/"><!---->Other<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Follow Me"><span class="title"><!---->Follow Me</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="https://github.com/HScarb" rel="noopener noreferrer" target="_blank" aria-label="Github" class="nav-link"><!---->Github<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://juejin.cn/user/219558057345111/posts" rel="noopener noreferrer" target="_blank" aria-label="掘金" class="nav-link"><!---->掘金<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/HScarb/knowledge" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->RocketMQ 事务消息原理详解 &amp; 源码解析</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Scarb</span></span><span property="author" content="Scarb"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2025-01-31T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 28 分钟</span><meta property="timeRequired" content="PT28M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_1-背景">1. 背景</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_2-使用示例">2. 使用示例</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-1-创建事务-topic">2.1 创建事务 Topic</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-2-实现事务消息本地执行和回查逻辑">2.2 实现事务消息本地执行和回查逻辑</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-3-事务消息生产者">2.3 事务消息生产者</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-4-消费者">2.4 消费者</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-5-运行结果">2.5 运行结果</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_3-概要设计">3. 概要设计</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_4-原理详解">4. 原理详解</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-1-事务消息发送">4.1 事务消息发送</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-2-事务状态回查">4.2 事务状态回查</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_5-源码解析">5. 源码解析</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_5-1-事务消息发送">5.1 事务消息发送</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_5-2-事务状态回查">5.2 事务状态回查</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#参考资料">参考资料</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>原文地址：<a href="http://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html" target="_blank" rel="noopener noreferrer">http://hscarb.github.io/rocketmq/20250131-rocketmq-transactional-message.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h1 id="rocketmq-事务消息原理详解-源码解析" tabindex="-1"><a class="header-anchor" href="#rocketmq-事务消息原理详解-源码解析" aria-hidden="true">#</a> RocketMQ 事务消息原理详解 &amp; 源码解析</h1><h2 id="_1-背景" tabindex="-1"><a class="header-anchor" href="#_1-背景" aria-hidden="true">#</a> 1. 背景</h2><p>在当下的互联网时代，微服务架构兴起，业务量也达到了惊人的量级。消息队列作为微服务架构解耦、流量削峰、异步处理等的重要组件，成为了微服务架构中不可或缺的一部分。</p><p>事务指的是一系列操作，要么全部成功，要么全部失败，事务在业务系统中也有大规模的应用。当涉及到事务相关的系统模块时，普通消息无法满足“本地操作和消息发送”要么全部成功，要么全部失败的需求，因此有了事务消息的需求。</p><p>RocketMQ 在 4.3.0 版本开始支持分布式事务消息。RocketMQ 的事务消息在普通消息基础上，支持二阶段的提交能力。将二阶段提交和本地事务绑定，实现全局提交结果的一致性。</p><p>本文将基于 RocketMQ 5.3.x 源码，分析 RocketMQ 事务消息的实现原理。</p><h2 id="_2-使用示例" tabindex="-1"><a class="header-anchor" href="#_2-使用示例" aria-hidden="true">#</a> 2. 使用示例</h2><p>本示例使用 RocketMQ 4.x 的 Java 客户端实现。</p><h3 id="_2-1-创建事务-topic" tabindex="-1"><a class="header-anchor" href="#_2-1-创建事务-topic" aria-hidden="true">#</a> 2.1 创建事务 Topic</h3><p>事先创建好一个 Topic 用作事务消息接收。RocketMQ 5.x 版本之后，需要在创建 Topic 时指定消息类型，这里创建一个 <code>TRANSACTION</code> 类型的 Topic。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./bin/mqadmin updatetopic <span class="token parameter variable">-n</span> localhost:9876 <span class="token parameter variable">-t</span> TopicTest1234 <span class="token parameter variable">-c</span> DefaultCluster <span class="token parameter variable">-a</span> +message.type<span class="token operator">=</span>TRANSACTION
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-2-实现事务消息本地执行和回查逻辑" tabindex="-1"><a class="header-anchor" href="#_2-2-实现事务消息本地执行和回查逻辑" aria-hidden="true">#</a> 2.2 实现事务消息本地执行和回查逻辑</h3><p>然后需要实现 <code>TransactionListener</code> 接口，该接口有两个方法：</p><ul><li><code>executeLocalTransaction</code>：执行本地事务，这个方法中填写本地事务逻辑，返回 <code>LocalTransactionState</code> 枚举值，表示本地事务的状态。</li><li><code>checkLocalTransaction</code>：检查本地事务，返回 <code>LocalTransactionState</code> 枚举值，表示本地事务的状态。</li></ul><p>如果执行本地事务的操作直接返回 <code>LocalTransactionState.COMMIT_MESSAGE</code> 或 <code>LocalTransactionState.ROLLBACK_MESSAGE</code>，则不会调用 <code>checkLocalTransaction</code> 方法。如果返回 <code>LocalTransactionState.UNKNOW</code>，表示本地事务暂时没有执行完，结果未知，则会在后续调用 <code>checkLocalTransaction</code> 方法来检查本地事务执行的状态。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionListenerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TransactionListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> transactionIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> localTrans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用作示例，模拟 3 种本地事务的执行结果</span>
        <span class="token keyword">int</span> value <span class="token operator">=</span> transactionIndex<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> status <span class="token operator">=</span> value <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">;</span>
        localTrans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 故意返回 UNKNOW，模拟本地事务未执行完，需要执行事务状态检查</span>
        <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据本地事务随机模拟的 3 种执行结果，返回对应的本地事务状态</span>
        <span class="token class-name">Integer</span> status <span class="token operator">=</span> localTrans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">ROLLBACK_MESSAGE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-事务消息生产者" tabindex="-1"><a class="header-anchor" href="#_2-3-事务消息生产者" aria-hidden="true">#</a> 2.3 事务消息生产者</h3><p>然后创建一个 <code>TransactionMQProducer</code> 实例，并设置 <code>TransactionListener</code>。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransactionListener</span> transactionListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionListenerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TransactionMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token constant">PRODUCER_GROUP</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_NAMESRVADDR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 本地事务执行状态回查线程池</span>
    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;client-transaction-msg-check-thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> thread<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    producer<span class="token punctuation">.</span><span class="token function">setExecutorService</span><span class="token punctuation">(</span>executorService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置之前定义的本地事务执行和回查监听器实例</span>
    producer<span class="token punctuation">.</span><span class="token function">setTransactionListener</span><span class="token punctuation">(</span>transactionListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">&quot;TagA&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TagB&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TagC&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TagD&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;TagE&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">MESSAGE_COUNT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;KEY&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token string">&quot;Hello RocketMQ &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s%n&quot;</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> <span class="token operator">|</span> <span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-消费者" tabindex="-1"><a class="header-anchor" href="#_2-4-消费者" aria-hidden="true">#</a> 2.4 消费者</h3><p>最后启动一个消费者来消费事务消息。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>

    <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token constant">CONSUMER_GROUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Uncomment the following line while debugging, namesrvAddr should be set to your local address</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token constant">NAMESRV_ADDR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span><span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span><span class="token constant">CONSUME_FROM_FIRST_OFFSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span> <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s Receive New Messages: %s %n&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer Started.%n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5-运行结果" tabindex="-1"><a class="header-anchor" href="#_2-5-运行结果" aria-hidden="true">#</a> 2.5 运行结果</h3><p>生产者的运行日志如下：</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18010D0000</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801BE0001</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801CD0002</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801DA0003</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801E70004</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801F50005</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1802020006</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18020F0007</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18021D0008</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
SendResult <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span>SEND_OK<span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18022B0009</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span>MessageQueue <span class="token punctuation">[</span>topic<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> recallHandle<span class="token operator">=</span><span class="token boolean">null</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>消费者运行日志如下：</p><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>Consumer Started<span class="token punctuation">.</span>
<span class="token property">ConsumeMessageThread_CID_JODIE_1_1 Receive New Messages:</span> <span class="token punctuation">[</span>MessageExt <span class="token punctuation">[</span>brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1737222654439</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">5290</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1737222675592</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">7F00000100002A9F000000104A169B49</span><span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">69962472265</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">601994070</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">69962469259</span><span class="token punctuation">,</span> toString<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">=</span>Message<span class="token operator">{</span>topic<span class="token operator">=</span><span class="token string">&#39;TopicTest1234&#39;</span><span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token operator">{</span>CONSUME_START_TIME<span class="token operator">=</span><span class="token number">1737222710178</span><span class="token punctuation">,</span> MSG_REGION<span class="token operator">=</span>DefaultRegion<span class="token punctuation">,</span> UNIQ_KEY<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801E70004</span><span class="token punctuation">,</span> CLUSTER<span class="token operator">=</span>DefaultCluster<span class="token punctuation">,</span> PGROUP<span class="token operator">=</span>please_rename_unique_group_name<span class="token punctuation">,</span> MIN_OFFSET<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> __transactionId__<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801E70004</span><span class="token punctuation">,</span> TAGS<span class="token operator">=</span>TagE<span class="token punctuation">,</span> TRAN_MSG<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> KEYS<span class="token operator">=</span>KEY4<span class="token punctuation">,</span> WAIT<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRACE_ON<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRANSACTION_CHECK_TIMES<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_TOPIC<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> MAX_OFFSET<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_QID<span class="token operator">=</span><span class="token number">0</span><span class="token operator">}</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token string">&#39;C0A80109803418B4AAC25D1801E70004&#39;</span><span class="token operator">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
<span class="token property">ConsumeMessageThread_CID_JODIE_1_2 Receive New Messages:</span> <span class="token punctuation">[</span>MessageExt <span class="token punctuation">[</span>brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1737222654398</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">5290</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1737222675591</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">7F00000100002A9F000000104A1699A5</span><span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">69962471845</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">1401636825</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">69962467966</span><span class="token punctuation">,</span> toString<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">=</span>Message<span class="token operator">{</span>topic<span class="token operator">=</span><span class="token string">&#39;TopicTest1234&#39;</span><span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token operator">{</span>CONSUME_START_TIME<span class="token operator">=</span><span class="token number">1737222710178</span><span class="token punctuation">,</span> MSG_REGION<span class="token operator">=</span>DefaultRegion<span class="token punctuation">,</span> UNIQ_KEY<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801BE0001</span><span class="token punctuation">,</span> CLUSTER<span class="token operator">=</span>DefaultCluster<span class="token punctuation">,</span> PGROUP<span class="token operator">=</span>please_rename_unique_group_name<span class="token punctuation">,</span> MIN_OFFSET<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> __transactionId__<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D1801BE0001</span><span class="token punctuation">,</span> TAGS<span class="token operator">=</span>TagB<span class="token punctuation">,</span> TRAN_MSG<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> KEYS<span class="token operator">=</span>KEY1<span class="token punctuation">,</span> WAIT<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRACE_ON<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRANSACTION_CHECK_TIMES<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_TOPIC<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> MAX_OFFSET<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_QID<span class="token operator">=</span><span class="token number">1</span><span class="token operator">}</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token string">&#39;C0A80109803418B4AAC25D1801BE0001&#39;</span><span class="token operator">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
<span class="token property">ConsumeMessageThread_CID_JODIE_1_3 Receive New Messages:</span> <span class="token punctuation">[</span>MessageExt <span class="token punctuation">[</span>brokerName<span class="token operator">=</span>broker<span class="token operator">-</span>a<span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">420</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1737222654479</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">5290</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1737222675592</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token ip-address constant">127.0.0.1</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token hash constant">7F00000100002A9F000000104A169CED</span><span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">69962472685</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">988340972</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">69962470552</span><span class="token punctuation">,</span> toString<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">=</span>Message<span class="token operator">{</span>topic<span class="token operator">=</span><span class="token string">&#39;TopicTest1234&#39;</span><span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token operator">{</span>CONSUME_START_TIME<span class="token operator">=</span><span class="token number">1737222710178</span><span class="token punctuation">,</span> MSG_REGION<span class="token operator">=</span>DefaultRegion<span class="token punctuation">,</span> UNIQ_KEY<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18020F0007</span><span class="token punctuation">,</span> CLUSTER<span class="token operator">=</span>DefaultCluster<span class="token punctuation">,</span> PGROUP<span class="token operator">=</span>please_rename_unique_group_name<span class="token punctuation">,</span> MIN_OFFSET<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> __transactionId__<span class="token operator">=</span><span class="token hash constant">C0A80109803418B4AAC25D18020F0007</span><span class="token punctuation">,</span> TAGS<span class="token operator">=</span>TagC<span class="token punctuation">,</span> TRAN_MSG<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> KEYS<span class="token operator">=</span>KEY7<span class="token punctuation">,</span> WAIT<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRACE_ON<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> TRANSACTION_CHECK_TIMES<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_TOPIC<span class="token operator">=</span>TopicTest1234<span class="token punctuation">,</span> MAX_OFFSET<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> REAL_QID<span class="token operator">=</span><span class="token number">3</span><span class="token operator">}</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token string">&#39;C0A80109803418B4AAC25D18020F0007&#39;</span><span class="token operator">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>只收到 3 条消息，因为发送时模拟了 3 种本地事务的执行结果，只有 3 条消息是 <code>COMMIT_MESSAGE</code> 状态，4 条消息是 <code>UNKNOW</code> 状态，3 条消息是 <code>ROLLBACK_MESSAGE</code> 状态。<br><code>UNKNOWN</code> 状态的消息会继续进行回查，<code>ROLLBACK_MESSAGE</code> 状态的消息会被丢弃。</p><h2 id="_3-概要设计" tabindex="-1"><a class="header-anchor" href="#_3-概要设计" aria-hidden="true">#</a> 3. 概要设计</h2><p>RocketMQ 的事务实现方式为二阶段提交：</p><ol><li>先将原始消息以事务半消息的形式发送到服务端，对消费者不可见。</li><li>然后生产者执行本地事务，根据本地事务执行结果来复原或丢弃事务半消息。</li><li>如果本地事务执行结果未知，则服务端对生产者进行定期回查本地事务执行状态。</li><li>根据回查的本地事务执行结果，服务端将事务半消息复原或丢弃。</li></ol><p>整个流程如下图所示：</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1739972940231.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li>生产者（Sender）发送消息到 RocketMQ 服务端（Server），除了原本的信息外，向消息属性中添加了事务消息标识，表示一个事务半消息（Half message）。</li><li>我们并不希望事务半消息被消费者消费到，所以它被保存在服务端一个专门用来保存半消息的特殊 Topic 中，消息持久化成功之后，向生产者返回 Ack 确认消息已经发送成功。</li><li>生产者开始执行本地事务逻辑。</li><li>生产者将本地事务执行结果上报给服务端。如果本地事务无法马上执行完，应上报 Unknown；执行成功则上报 Commit，执行失败上报 Rollback。服务端收到确认结果后处理逻辑如下： <ul><li>Unknown：暂不处理，服务端在一定时间后，对生产者实例发起定时回查。</li><li>Commit/Rollback：生成一个事务操作消息（OP 消息），记录该事务半消息的最终处理结果，然后将 OP 消息保存到 OP Topic 中。在后面服务端定期回查前，从 OP Topic 中查询 OP 消息，如果能找到 OP 消息，表示该事务半消息需要提交或回滚，则执行提交或回滚操作。</li></ul></li><li>服务端进行定时回查，对半消息 Topic 中的半消息进行回查。先根据 OP Topic 中是否有该半消息对应的 OP 消息来判断半消息的执行结果。 <ul><li>没有 OP 消息：进行回查。</li><li>有 Commit 的 OP 消息：将半消息复原，发送到真实的 Topic，可以投递给消费者。</li><li>有 Rollback 的 OP 消息：丢弃半消息。</li></ul></li><li>生产者收到消息回查请求后，检查对应消息的本地事务执行的最终结果。</li><li>生产者将本地事务执行状态上报给服务端，进行二次确认，服务端仍按照步骤 4 对半事务消息进行处理。</li></ol><h2 id="_4-原理详解" tabindex="-1"><a class="header-anchor" href="#_4-原理详解" aria-hidden="true">#</a> 4. 原理详解</h2><h3 id="_4-1-事务消息发送" tabindex="-1"><a class="header-anchor" href="#_4-1-事务消息发送" aria-hidden="true">#</a> 4.1 事务消息发送</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738347473287.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_4-1-1-生产者发送事务消息" tabindex="-1"><a class="header-anchor" href="#_4-1-1-生产者发送事务消息" aria-hidden="true">#</a> 4.1.1 生产者发送事务消息</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738518692741.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>RocketMQ 为事务消息定义了专门的生产者类型 <code>TransactionMQProducer</code> 和本地事务执行接口 <code>TransactionListener</code>。</p><p>调用事务生产者的 <code>sendMessageInTransaction</code> 方法发送事务消息，该方法会调用 <code>DefaultMQProducerImpl</code> 的 <code>sendMessageInTransaction</code> 方法，事务消息发送的主要逻辑都在该方法中。</p><p><code>sendMessageInTransaction</code> 方法接收一个普通消息，将它包装成事务半消息发送给 Broker，然后执行本地事务，上报执行结果给 Broker。详细逻辑如下：</p><ol><li>设置原始消息的 <code>TRAN_MSG</code> 属性设置为 <code>true</code>，表示该消息是一个事务半消息。</li><li>发送半消息到 Broker。</li><li>如果半消息发送成功，执行本地事务，获取本地事务执行结果；如果发送失败，则不执行。</li><li>调用 <code>endTransaction</code> 方法，通知 Broker 本地事务执行结果。这里是异步单向请求，不需要等待响应。</li></ol><h4 id="_4-1-2-broker-接收事务半消息" tabindex="-1"><a class="header-anchor" href="#_4-1-2-broker-接收事务半消息" aria-hidden="true">#</a> 4.1.2 Broker 接收事务半消息</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738518693004.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Broker 的消息生产请求处理器 <code>SendMessageProcessor</code> 的 <code>processRequest</code> 方法处理生产者发来的普通消息和事务消息。</p><p>该方法会检查消息的 <code>TRAN_MSG</code> 属性，如果为 <code>true</code>，则表示该消息是一个事务半消息。为了让消费者暂时无法消费到该消息，RocketMQ 的设计是将它保存到 <code>RMQ_SYS_TRANS_HALF_TOPIC</code> Topic 中。后续收到生产者的本地事务执行结果后，会根据执行结果将事务半消息查出来，复原或丢弃。</p><h4 id="_4-1-3-broker-接收事务执行结果请求" tabindex="-1"><a class="header-anchor" href="#_4-1-3-broker-接收事务执行结果请求" aria-hidden="true">#</a> 4.1.3 Broker 接收事务执行结果请求</h4><p>Broker 的事务执行结果处理逻辑会在以下两个情况下触发：</p><ul><li>生产者第一次发送事务半消息，执行本地事务，会调用 <code>endTransaction</code> 方法，通知 Broker 本地事务执行结果。</li><li>生产者收到 Broker 的事务执行状态回查请求，会查询本地事务执行结果，然后上报给 Broker。</li></ul><p>Broker 的 <code>EndTransactionProcessor</code> 的 <code>processRequest</code> 方法处理事务执行结果请求，它根据生产者上报的本地事务执行结果，将事务半消息复原或丢弃。详细逻辑如下：</p><ul><li>如果本地事务执行状态为 <code>COMMIT_MESSAGE</code>： <ol><li>根据请求头中的事务半消息物理偏移量，从存储中查询出事务半消息。</li><li>复原事务半消息的原始 Topic 和队列。</li><li>将复原后的消息保存到存储，此时消息可以被消费者消费。</li><li>删除事务半消息：将事务半消息存储在事务消息 OP Topic：RMQ_SYS_TRANS_OP_HALF_TOPIC 中，表示该消息已经被处理, 无需再次回查。</li></ol></li><li>如果本地事务执行状态为 <code>ROLLBACK_MESSAGE</code><ol><li>从存储中查询出事务半消息</li><li>删除事务半消息</li></ol></li><li>如果本地事务执行状态为 <code>UNKNOWN</code> 则不作处理</li></ul><h3 id="_4-2-事务状态回查" tabindex="-1"><a class="header-anchor" href="#_4-2-事务状态回查" aria-hidden="true">#</a> 4.2 事务状态回查</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738347473545.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_4-2-1-broker-回查事务状态" tabindex="-1"><a class="header-anchor" href="#_4-2-1-broker-回查事务状态" aria-hidden="true">#</a> 4.2.1 Broker 回查事务状态</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738518693032.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Broker 的服务线程 <code>TransactionalMessageCheckService</code> 每 30s 触发一次 <code>TransactionalMessageServiceImpl#check</code> 方法进行事务消息的回查。该方法会从半消息 Topic 中取出半消息，与 OP Topic 中的消息进行匹配（匹配上则认为处理完）。对于没有处理完的半消息，发送回查请求给生产者组中的一个生产者，触发生产者上报本地事务执行状态。它的详细逻辑如下：</p><ul><li>获取事务半消息 Topic 的所有队列，然后遍历这些队列（默认只有 1 个队列） <ol><li>获取半消息队列对应的 OP Topic 的队列，OP Topic 是用来保存事务半消息的操作结果的 Topic，为 <code>RMQ_SYS_TRANS_OP_HALF_TOPIC</code>。在上面的 Broker 处理本地事务执行结果请求时，事务的执行结果会保存到该 Topic 中。</li><li>调用 <code>fillOpRemoveMap</code> 方法，查询一批 OP 消息，然后遍历它们，把它们对应的需要移除的半消息的逻辑偏移量放到 <code>removeMap</code> 中，用作后续匹配。</li><li>不断循环消费事务半消息进行处理，直到没有新的半消息或处理持续时间超过 60s：</li></ol><ul><li>判断当前要消费的半消息的偏移量是否在 <code>removeMap</code> 中，如果在则表示该半消息已经提交或回滚，跳过，继续消费下一条。</li><li>对于没有在 <code>removeMap</code> 中的半消息 <ol><li>调用 <code>getHalfMsg</code> 方法从存储中查询出该半消息</li><li>判断事务消息是否需要丢弃，即超过最大回查次数（15次）；或者是否需要跳过，即超过文件保存时间。如果是则丢弃后继续查询下一条。</li><li>更新半消息的回查次数（+1），在消息属性中。</li><li>计算事务半消息是否处在免疫回查期：即事务消息发送一段时间之内不进行回查，默认 6s。如果在免疫器则跳出回查循环。</li><li>如果需要回查，将半消息重新保存（因为前面更新了回查次数，这里会新写入一条消息，这也是为了后面能够重新消费到这条半消息再次进行回查的判断，如果回查次数多会导致写放大。)。</li><li>根据生产组，轮询一个生产者，异步发送单向消息回查请求。</li><li>回查时会复原半消息的原始 Topic 和队列，然后将其作为回查请求体发送给生产者。</li></ol></li></ul></li></ul><blockquote><p>这里 OP 消息的操作较为繁琐，它用来标记一条半消息的事务执行结果。一个优化方案是直接将半消息的事务执行结果覆写到半消息本身，这样后面判断半消息是否需要回查时可以直接根据半消息本身来判断。这个方案的好处是可以不需要 OP 消息繁琐的操作，坏处是这样会破坏 CommitLog WAL 的语义，造成随机读写。如果需要覆盖的半消息不在页缓存，会触发磁盘 I/O，速度就比较慢了。</p></blockquote><h4 id="_4-2-2-生产者处理事务状态回查请求" tabindex="-1"><a class="header-anchor" href="#_4-2-2-生产者处理事务状态回查请求" aria-hidden="true">#</a> 4.2.2 生产者处理事务状态回查请求</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2025/02/1738518693394.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>生产者处理 Broker 回查请求的主要方法是 <code>DefaultMQProducerImpl#checkLocalTransaction</code>，它根据 Broker 发回的半消息获取本地事务执行结果，然后将执行结果发回 Broker。</p><h2 id="_5-源码解析" tabindex="-1"><a class="header-anchor" href="#_5-源码解析" aria-hidden="true">#</a> 5. 源码解析</h2><h3 id="_5-1-事务消息发送" tabindex="-1"><a class="header-anchor" href="#_5-1-事务消息发送" aria-hidden="true">#</a> 5.1 事务消息发送</h3><h4 id="_5-1-1-生产者发送事务消息" tabindex="-1"><a class="header-anchor" href="#_5-1-1-生产者发送事务消息" aria-hidden="true">#</a> 5.1.1 生产者发送事务消息</h4><h5 id="transactionmqproducer-sendmessageintransaction" tabindex="-1"><a class="header-anchor" href="#transactionmqproducer-sendmessageintransaction" aria-hidden="true">#</a> TransactionMQProducer#sendMessageInTransaction</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// TransactionMQProducer.java</span>
<span class="token doc-comment comment">/**
 * 发送事务消息
 * 
 * <span class="token keyword">@param</span> <span class="token parameter">msg</span> Transactional message to send.
 *            需要发送的事务消息
 * <span class="token keyword">@param</span> <span class="token parameter">arg</span> Argument used along with local transaction executor.
 *            本地事务执行器的参数
 * <span class="token keyword">@return</span> 事务消息发送结果
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">TransactionSendResult</span> <span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transactionListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">&quot;TransactionListener is null&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    msg<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token class-name">NamespaceUtil</span><span class="token punctuation">.</span><span class="token function">wrapNamespace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducerImpl<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="defaultmqproducerimpl-sendmessageintransaction" tabindex="-1"><a class="header-anchor" href="#defaultmqproducerimpl-sendmessageintransaction" aria-hidden="true">#</a> DefaultMQProducerImpl#sendMessageInTransaction</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// DefaultMQProducerImpl.java</span>
<span class="token doc-comment comment">/**
 * 发送事务消息
 * 
 * <span class="token keyword">@param</span> <span class="token parameter">msg</span> 事务消息
 * <span class="token keyword">@param</span> <span class="token parameter">localTransactionListener</span> 本地事务执行和状态检查器
 * <span class="token keyword">@param</span> <span class="token parameter">arg</span> 本地事务执行参数
 */</span>
<span class="token keyword">public</span> <span class="token class-name">TransactionSendResult</span> <span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">TransactionListener</span> localTransactionListener<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransactionListener</span> transactionListener <span class="token operator">=</span> <span class="token function">getCheckListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> localTransactionListener <span class="token operator">&amp;&amp;</span> <span class="token keyword">null</span> <span class="token operator">==</span> transactionListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">&quot;tranExecutor is null&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ignore DelayTimeLevel parameter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">clearProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_DELAY_TIME_LEVEL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Validators</span><span class="token punctuation">.</span><span class="token function">checkMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置消息属性 TRAN_MSG，标记消息为事务消息</span>
    <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_TRANSACTION_PREPARED</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_PRODUCER_GROUP</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 发送半事务消息</span>
        sendResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">&quot;send message Exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">LocalTransactionState</span> localTransactionState <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
    <span class="token class-name">Throwable</span> localException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">SEND_OK</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    msg<span class="token punctuation">.</span><span class="token function">putUserProperty</span><span class="token punctuation">(</span><span class="token string">&quot;__transactionId__&quot;</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">String</span> transactionId <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> transactionId <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    msg<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> localTransactionListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 使用 DefaultMQProducerImpl 进行事务消息发送，执行本地事务</span>
                    localTransactionState <span class="token operator">=</span> localTransactionListener<span class="token punctuation">.</span><span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 使用新的 TransactionMQProducer 进行事务消息发送，执行本地事务</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Used new transaction API&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    localTransactionState <span class="token operator">=</span> transactionListener<span class="token punctuation">.</span><span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> localTransactionState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    localTransactionState <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>localTransactionState <span class="token operator">!=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">COMMIT_MESSAGE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;executeLocalTransactionBranch return: {} messageTopic: {} transactionId: {} tag: {} key: {}&quot;</span><span class="token punctuation">,</span>
                        localTransactionState<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;executeLocalTransactionBranch exception, messageTopic: {} transactionId: {} tag: {} key: {}&quot;</span><span class="token punctuation">,</span>
                    msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                localException <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">FLUSH_DISK_TIMEOUT</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token constant">FLUSH_SLAVE_TIMEOUT</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token constant">SLAVE_NOT_AVAILABLE</span><span class="token operator">:</span>
            localTransactionState <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">ROLLBACK_MESSAGE</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 结束事务，如果半消息发送失败或本地事务执行失败告诉服务端删除半消息，半消息发送成功且本地事务执行成功则告诉服务端让半消息复原</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">endTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> sendResult<span class="token punctuation">,</span> localTransactionState<span class="token punctuation">,</span> localException<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;local transaction execute &quot;</span> <span class="token operator">+</span> localTransactionState <span class="token operator">+</span> <span class="token string">&quot;, but end broker transaction failed&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">TransactionSendResult</span> transactionSendResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionSendResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setSendStatus</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setMessageQueue</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setMsgId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setQueueOffset</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionSendResult<span class="token punctuation">.</span><span class="token function">setLocalTransactionState</span><span class="token punctuation">(</span>localTransactionState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> transactionSendResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="transactionmqproducer-endtransaction" tabindex="-1"><a class="header-anchor" href="#transactionmqproducer-endtransaction" aria-hidden="true">#</a> TransactionMQProducer#endTransaction</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// TransactionMQProducer.java</span>
<span class="token doc-comment comment">/**
 * 向 Broker 发送结束事务请求，根据本地事务执行状态，通知 Broker 半消息如何处理
 * 
 * <span class="token keyword">@param</span> <span class="token parameter">msg</span> 事务消息
 * <span class="token keyword">@param</span> <span class="token parameter">sendResult</span> 事务半消息的发送结果
 * <span class="token keyword">@param</span> <span class="token parameter">localTransactionState</span> 本地事务执行状态
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">endTransaction</span><span class="token punctuation">(</span>
    <span class="token keyword">final</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">SendResult</span> sendResult<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">LocalTransactionState</span> localTransactionState<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">Throwable</span> localException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">MessageId</span> id<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getOffsetMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        id <span class="token operator">=</span> <span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">decodeMessageId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getOffsetMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        id <span class="token operator">=</span> <span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">decodeMessageId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> transactionId <span class="token operator">=</span> sendResult<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> destBrokerName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getBrokerNameFromMessageQueue</span><span class="token punctuation">(</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">queueWithNamespace</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> brokerAddr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">findBrokerAddressInPublish</span><span class="token punctuation">(</span>destBrokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EndTransactionRequestHeader</span> requestHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EndTransactionRequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setCommitLogOffset</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setBrokerName</span><span class="token punctuation">(</span>destBrokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据本地事务执行状态设置事务结束请求类型</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>localTransactionState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">COMMIT_MESSAGE</span><span class="token operator">:</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_COMMIT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">ROLLBACK_MESSAGE</span><span class="token operator">:</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_ROLLBACK_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">UNKNOW</span><span class="token operator">:</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_NOT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 执行事务结束钩子，这里主要会记录消息轨迹</span>
    <span class="token function">doExecuteEndTransactionHook</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> brokerAddr<span class="token punctuation">,</span> localTransactionState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setTranStateTableOffset</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestHeader<span class="token punctuation">.</span><span class="token function">setMsgId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> remark <span class="token operator">=</span> localException <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">&quot;executeLocalTransactionBranch exception: &quot;</span> <span class="token operator">+</span> localException<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 向 Broker 发送事务消息结束请求，根据本地事务执行状态通知 Broker 半消息如何处理</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getMQClientAPIImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endTransactionOneway</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> remark<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getSendMsgTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-2-broker-接收事务消息" tabindex="-1"><a class="header-anchor" href="#_5-1-2-broker-接收事务消息" aria-hidden="true">#</a> 5.1.2 Broker 接收事务消息</h4><h5 id="sendmessageprocessor-processrequest-接收事务半消息" tabindex="-1"><a class="header-anchor" href="#sendmessageprocessor-processrequest-接收事务半消息" aria-hidden="true">#</a> SendMessageProcessor#processRequest 接收事务半消息</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// SendMessageProcessor.java</span>
<span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">SendMessageContext</span> sendMessageContext<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">SendMessageRequestHeader</span> requestHeader<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">TopicQueueMappingContext</span> mappingContext<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">SendMessageCallback</span> sendMessageCallback<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// ...</span>

    <span class="token comment">// 尝试获取事务消息标识</span>
    <span class="token class-name">String</span> traFlag <span class="token operator">=</span> oriProps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_TRANSACTION_PREPARED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> sendTransactionPrepareMessage<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>traFlag<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> msgInner<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//For client under version 4.6.1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isRejectTransactionMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">NO_PERMISSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>
                <span class="token string">&quot;the broker[&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerIP1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">&quot;] sending transaction message is forbidden&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 是事务消息</span>
        sendTransactionPrepareMessage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        sendTransactionPrepareMessage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 异步存储消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAsyncSendEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PutMessageResult</span><span class="token punctuation">&gt;</span></span> asyncPutMessageFuture<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sendTransactionPrepareMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果是事务消息，构造事务半消息并存储</span>
            asyncPutMessageFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asyncPrepareMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 普通消息存储</span>
            asyncPutMessageFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asyncPutMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> finalQueueIdInt <span class="token operator">=</span> queueIdInt<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">MessageExtBrokerInner</span> finalMsgInner <span class="token operator">=</span> msgInner<span class="token punctuation">;</span>
        asyncPutMessageFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span>putMessageResult <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">RemotingCommand</span> responseFuture <span class="token operator">=</span>
                <span class="token function">handlePutMessageResult</span><span class="token punctuation">(</span>putMessageResult<span class="token punctuation">,</span> response<span class="token punctuation">,</span> request<span class="token punctuation">,</span> finalMsgInner<span class="token punctuation">,</span> responseHeader<span class="token punctuation">,</span> sendMessageContext<span class="token punctuation">,</span>
                    ctx<span class="token punctuation">,</span> finalQueueIdInt<span class="token punctuation">,</span> beginTimeMillis<span class="token punctuation">,</span> mappingContext<span class="token punctuation">,</span> <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span><span class="token function">getMessageType</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>responseFuture <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">doResponse</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">,</span> responseFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// record the transaction metrics, responseFuture == null means put successfully</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sendTransactionPrepareMessage <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>responseFuture <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> responseFuture<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            sendMessageCallback<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span>sendMessageContext<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getPutMessageFutureExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Returns null to release the send message thread</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 同步存储消息</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">PutMessageResult</span> putMessageResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sendTransactionPrepareMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果是事务消息，构造事务半消息并存储</span>
            putMessageResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prepareMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 普通消息存储</span>
            putMessageResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">handlePutMessageResult</span><span class="token punctuation">(</span>putMessageResult<span class="token punctuation">,</span> response<span class="token punctuation">,</span> request<span class="token punctuation">,</span> msgInner<span class="token punctuation">,</span> responseHeader<span class="token punctuation">,</span> sendMessageContext<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> queueIdInt<span class="token punctuation">,</span> beginTimeMillis<span class="token punctuation">,</span> mappingContext<span class="token punctuation">,</span> <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span><span class="token function">getMessageType</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// record the transaction metrics</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PutMessageStatus</span><span class="token punctuation">.</span><span class="token constant">PUT_OK</span> <span class="token operator">&amp;&amp;</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getAppendMessageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sendMessageCallback<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span>sendMessageContext<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="transactionmessagebridge-parsehalfmessageinner-事务消息转换成事务半消息保存" tabindex="-1"><a class="header-anchor" href="#transactionmessagebridge-parsehalfmessageinner-事务消息转换成事务半消息保存" aria-hidden="true">#</a> TransactionMessageBridge#parseHalfMessageInner 事务消息转换成事务半消息保存</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// TransactionMessageBridge.java</span>
<span class="token keyword">public</span> <span class="token class-name">PutMessageResult</span> <span class="token function">putHalfMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageExtBrokerInner</span> messageInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span><span class="token function">parseHalfMessageInner</span><span class="token punctuation">(</span>messageInner<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PutMessageResult</span><span class="token punctuation">&gt;</span></span> <span class="token function">asyncPutHalfMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageExtBrokerInner</span> messageInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">asyncPutMessage</span><span class="token punctuation">(</span><span class="token function">parseHalfMessageInner</span><span class="token punctuation">(</span>messageInner<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 准备事务半消息，将原消息的 Topic 和 QueueId 保存到消息属性中，然后将消息的 Topic 设置为 RMQ_SYS_TRANS_HALF_TOPIC 的 0 队列
 */</span>
<span class="token keyword">private</span> <span class="token class-name">MessageExtBrokerInner</span> <span class="token function">parseHalfMessageInner</span><span class="token punctuation">(</span><span class="token class-name">MessageExtBrokerInner</span> msgInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> uniqId <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uniqId <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>uniqId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> <span class="token class-name">TransactionalMessageUtil</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_ID</span><span class="token punctuation">,</span> uniqId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将原始消息的 Topic 和 QueueId 保存到事务半消息的属性中</span>
    <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_QUEUE_ID</span><span class="token punctuation">,</span>
        <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setSysFlag</span><span class="token punctuation">(</span>
        <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token function">resetTransactionValue</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_NOT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置事务半消息的 Topic 为 RMQ_SYS_TRANS_HALF_TOPIC</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token class-name">TransactionalMessageUtil</span><span class="token punctuation">.</span><span class="token function">buildHalfTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgInner<span class="token punctuation">.</span><span class="token function">setPropertiesString</span><span class="token punctuation">(</span><span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">messageProperties2String</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> msgInner<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="endtransactionprocessor-processrequest-处理-endtransaction-请求" tabindex="-1"><a class="header-anchor" href="#endtransactionprocessor-processrequest-处理-endtransaction-请求" aria-hidden="true">#</a> EndTransactionProcessor#processRequest 处理 EndTransaction 请求</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// EndTransactionProcessor.java</span>
<span class="token doc-comment comment">/**
 * 两个场景会发触发 END_TRANSACTION 请求
 * 1. 生产者第一次发送事务消息，执行完本地事务后
 * 2. 生产者收到服务端事务回查请求，查询完本地事务执行状态
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span>
    <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">RemotingCommand</span> response <span class="token operator">=</span> <span class="token class-name">RemotingCommand</span><span class="token punctuation">.</span><span class="token function">createResponseCommand</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">EndTransactionRequestHeader</span> requestHeader <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token class-name">EndTransactionRequestHeader</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">EndTransactionRequestHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BrokerRole</span><span class="token punctuation">.</span><span class="token constant">SLAVE</span> <span class="token operator">==</span> brokerController<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SLAVE_NOT_AVAILABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Message store is slave mode, so end transaction is forbidden. &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ...</span>

    <span class="token class-name">OperationResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OperationResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 事务提交</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_COMMIT_TYPE</span> <span class="token operator">==</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitOrRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从存储中查询出事务半消息</span>
        result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 成功查询出事务半消息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rejectCommitOrRollback</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">ILLEGAL_OPERATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Message commit fail [producer end]. currentTimeMillis - bornTime &gt; checkImmunityTime, msgId={},commitLogOffset={}, wait check&quot;</span><span class="token punctuation">,</span>
                        requestHeader<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 验证事务半消息的必要字段</span>
            <span class="token class-name">RemotingCommand</span> res <span class="token operator">=</span> <span class="token function">checkPrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 验证成功</span>
                <span class="token comment">// 恢复事务半消息的真实 Topic、队列，并设置事务 ID，并设置相关属性</span>
                <span class="token class-name">MessageExtBrokerInner</span> msgInner <span class="token operator">=</span> <span class="token function">endMessageTransaction</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msgInner<span class="token punctuation">.</span><span class="token function">setSysFlag</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token function">resetTransactionValue</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitOrRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msgInner<span class="token punctuation">.</span><span class="token function">setQueueOffset</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTranStateTableOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msgInner<span class="token punctuation">.</span><span class="token function">setPreparedTransactionOffset</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msgInner<span class="token punctuation">.</span><span class="token function">setStoreTimestamp</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">clearProperty</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_TRANSACTION_PREPARED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 发送最终的事务消息，存储到 CommitLog 中，可以被消费者消费</span>
                <span class="token class-name">RemotingCommand</span> sendResult <span class="token operator">=</span> <span class="token function">sendFinalMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 删除事务半消息：将事务半消息存储在事务消息操作 Topic：RMQ_SYS_TRANS_OP_HALF_TOPIC 中，表示该消息已经被处理</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deletePrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// successful committed, then total num of half-messages minus 1</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span>commitMessagesTotal<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span><span class="token function">newAttributesBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">LABEL_TOPIC</span><span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// record the commit latency.</span>
                    <span class="token class-name">Long</span> commitLatency <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
                    <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span>transactionFinishLatency<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>commitLatency<span class="token punctuation">,</span> <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span><span class="token function">newAttributesBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">LABEL_TOPIC</span><span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> sendResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// 事务回滚</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_ROLLBACK_TYPE</span> <span class="token operator">==</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitOrRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从存储中查询出事务半消息</span>
        result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollbackMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 成功查询出事务半消息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rejectCommitOrRollback</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">ILLEGAL_OPERATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Message rollback fail [producer end]. currentTimeMillis - bornTime &gt; checkImmunityTime, msgId={},commitLogOffset={}, wait check&quot;</span><span class="token punctuation">,</span>
                        requestHeader<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">RemotingCommand</span> res <span class="token operator">=</span> <span class="token function">checkPrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 删除事务半消息：将事务半消息存储在事务消息操作 Topic：RMQ_SYS_TRANS_OP_HALF_TOPIC 中，表示该消息已经被处理</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deletePrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// roll back, then total num of half-messages minus 1</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span>rollBackMessagesTotal<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">BrokerMetricsManager</span><span class="token punctuation">.</span><span class="token function">newAttributesBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">LABEL_TOPIC</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 事务执行状态未知则不做处理</span>
    response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseRemark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-事务状态回查" tabindex="-1"><a class="header-anchor" href="#_5-2-事务状态回查" aria-hidden="true">#</a> 5.2 事务状态回查</h3><h4 id="_5-2-1-broker-回查事务状态" tabindex="-1"><a class="header-anchor" href="#_5-2-1-broker-回查事务状态" aria-hidden="true">#</a> 5.2.1 Broker 回查事务状态</h4><h5 id="transactionalmessagecheckservice-onwaitend" tabindex="-1"><a class="header-anchor" href="#transactionalmessagecheckservice-onwaitend" aria-hidden="true">#</a> TransactionalMessageCheckService#onWaitEnd</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// TransactionalMessageCheckService.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Start transaction check service thread!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 默认每 30s 检查一次</span>
        <span class="token keyword">long</span> checkInterval <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionCheckInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span>checkInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;End transaction check service thread!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onWaitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 事务消息回查免疫期，过了免疫期，即消息的存储时间 + 该值 &gt; 系统当前时间，才对该消息执行事务状态回查。默认为 6s</span>
    <span class="token keyword">long</span> timeout <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 事务的最大检测次数，如果超过检测次数，消息会默认为丢弃，即 rollback 消息。默认 15 次</span>
    <span class="token keyword">int</span> checkMax <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionCheckMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Begin to check prepare message, begin time:{}&quot;</span><span class="token punctuation">,</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送请求到生产者客户端，回查事务消息执行状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> checkMax<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageCheckListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;End to check prepare message, consumed time:{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="transactionalmessageserviceimpl-check" tabindex="-1"><a class="header-anchor" href="#transactionalmessageserviceimpl-check" aria-hidden="true">#</a> TransactionalMessageServiceImpl#check</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// TransactionalMessageServiceImpl.java</span>
<span class="token doc-comment comment">/**
 * 发送请求到生产者客户端，回查事务消息执行状态
 *
 * <span class="token keyword">@param</span> <span class="token parameter">transactionTimeout</span> The minimum time of the transactional message to be checked firstly, one message only
 * exceed this time interval that can be checked.
 *        事务消息首次回查的最小时间，超过这个时间间隔的事务消息才会被回查
 * <span class="token keyword">@param</span> <span class="token parameter">transactionCheckMax</span> The maximum number of times the message was checked, if exceed this value, this
 * message will be discarded.
 *        消息被回查的最大次数，超过这个次数则丢弃
 * <span class="token keyword">@param</span> <span class="token parameter">listener</span> When the message is considered to be checked or discarded, the relative method of this class will
 * be invoked.
 *        当消息被回查或者丢弃时，会调用该监听器的方法
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">long</span> transactionTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> transactionCheckMax<span class="token punctuation">,</span>
    <span class="token class-name">AbstractTransactionalMessageCheckListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token class-name">TopicValidator</span><span class="token punctuation">.</span><span class="token constant">RMQ_SYS_TRANS_HALF_TOPIC</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取事务半消息 Topic 的所有队列，默认只有 1 个队列</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> msgQueues <span class="token operator">=</span> transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">fetchMessageQueues</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgQueues <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> msgQueues<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;The queue of topic is empty :&quot;</span> <span class="token operator">+</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageQueue</span> messageQueue <span class="token operator">:</span> msgQueues<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取对应的操作队列，主题为：RMQ_SYS_TRANS_OP_HALF_TOPIC。该主题保存事务消息提交或者回滚的请求</span>
            <span class="token class-name">MessageQueue</span> opQueue <span class="token operator">=</span> <span class="token function">getOpQueue</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 内部消费组 CID_SYS_RMQ_TRANS 对事务半消息的消费进度</span>
            <span class="token keyword">long</span> halfOffset <span class="token operator">=</span> transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">fetchConsumeOffset</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 内部消费组 CID_SYS_RMQ_TRANS 对操作队列的消费进度</span>
            <span class="token keyword">long</span> opOffset <span class="token operator">=</span> transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">fetchConsumeOffset</span><span class="token punctuation">(</span>opQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Before check, the queue={} msgOffset={} opOffset={}&quot;</span><span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span> halfOffset<span class="token punctuation">,</span> opOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>halfOffset <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> opOffset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;MessageQueue: {} illegal offset read: {}, op offset: {},skip this queue&quot;</span><span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span>
                    halfOffset<span class="token punctuation">,</span> opOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 已经处理完的操作消息的偏移量列表</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> doneOpOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 已经收到操作消息的事务半消息偏移量，需要被移除。key：半消息偏移量，value：操作消息偏移量</span>
            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> removeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 在操作消息中的所有半消息的偏移量</span>
            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">HashSet</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> opMsgMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">HashSet</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 拉取一批（32 条）操作队列的消息，填充 removeMap 和 opMsgMap。对于这批操作消息已经提交的事务半消息，不用回查需要移除</span>
            <span class="token class-name">PullResult</span> pullResult <span class="token operator">=</span> <span class="token function">fillOpRemoveMap</span><span class="token punctuation">(</span>removeMap<span class="token punctuation">,</span> opQueue<span class="token punctuation">,</span> opOffset<span class="token punctuation">,</span> halfOffset<span class="token punctuation">,</span> opMsgMap<span class="token punctuation">,</span> doneOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> pullResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;The queue={} check msgOffset={} with opOffset={} failed, pullResult is null&quot;</span><span class="token punctuation">,</span>
                    messageQueue<span class="token punctuation">,</span> halfOffset<span class="token punctuation">,</span> opOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// single thread</span>
            <span class="token comment">// 获取空消息的次数</span>
            <span class="token keyword">int</span> getMessageNullCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">// 事务半消息队列的最新消费进度</span>
            <span class="token keyword">long</span> newOffset <span class="token operator">=</span> halfOffset<span class="token punctuation">;</span>
            <span class="token comment">// 当前处理回查的事务半消息消费偏移量，从当前消费进度开始遍历</span>
            <span class="token keyword">long</span> i <span class="token operator">=</span> halfOffset<span class="token punctuation">;</span>
            <span class="token keyword">long</span> nextOpOffset <span class="token operator">=</span> pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 重新放入事务半消息队列的事务半消息数量</span>
            <span class="token keyword">int</span> putInQueueCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> escapeFailCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token comment">// 消息回查死循环，回查该队列中需要回查的事务半消息的执行状态</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 对该队列的消息的回查最多持续 60s</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">&gt;</span> <span class="token constant">MAX_PROCESS_TIME_LIMIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Queue={} process time reach max={}&quot;</span><span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span> <span class="token constant">MAX_PROCESS_TIME_LIMIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 如果 removeMap 中包含该事务半消息的偏移量，说明该事务半消息已经被提交或者回滚，需要移除，不需要回查</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>removeMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Half offset {} has been committed/rolled back&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Long</span> removedOpOffset <span class="token operator">=</span> removeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    opMsgMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>removedOpOffset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>opMsgMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>removedOpOffset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        opMsgMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>removedOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        doneOpOffset<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>removedOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token comment">// 该事务半消息没有被提交或者回滚，需要回查。查询出该事务半消息的消息体</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">GetResult</span> getResult <span class="token operator">=</span> <span class="token function">getHalfMsg</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 事务半消息</span>
                    <span class="token class-name">MessageExt</span> msgExt <span class="token operator">=</span> getResult<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgExt <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 如果事务半消息 Topic 中获取不到消息，且超过最大获取不到消息的次数（默认 1 次），则结束本次回查</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageNullCount<span class="token operator">++</span> <span class="token operator">&gt;</span> <span class="token constant">MAX_RETRY_COUNT_WHEN_HALF_NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PullStatus</span><span class="token punctuation">.</span><span class="token constant">NO_NEW_MSG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;No new msg, the miss offset={} in={}, continue check={}, pull result={}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>
                                messageQueue<span class="token punctuation">,</span> getMessageNullCount<span class="token punctuation">,</span> getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment">// 传入的偏移量非法，修正偏移量后继续查询事务半消息</span>
                            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Illegal offset, the miss offset={} in={}, continue check={}, pull result={}&quot;</span><span class="token punctuation">,</span>
                                i<span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span> getMessageNullCount<span class="token punctuation">,</span> getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            i <span class="token operator">=</span> getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            newOffset <span class="token operator">=</span> i<span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// 事务消息逃逸</span>
                    <span class="token comment">// ...</span>

                    <span class="token comment">// 判断事务消息是否需要丢弃，即超过最大回查次数（15次）；或者是否需要跳过，即超过文件保存时间。</span>
                    <span class="token comment">// 如果不丢弃或跳过，这里会增加事务半消息属性中的重试次数</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needDiscard</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">,</span> transactionCheckMax<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">needSkip</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 丢弃或跳过：将事务半消息发送到特殊的内部 Topic：TRANS_CHECK_MAX</span>
                        listener<span class="token punctuation">.</span><span class="token function">resolveDiscardMsg</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        newOffset <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        i<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 如果事务半消息的存储时间大于等于本次回查开始时间，说明这条是新的事务半消息存储进来，结束本次回查，稍后再回查</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Fresh stored. the miss offset={}, check it later, store={}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// 计算事务半消息是否处在免疫回查期：即事务消息发送一段时间之内不进行回查</span>
                    <span class="token comment">// 事务半消息已经存在的时长</span>
                    <span class="token keyword">long</span> valueOfCurrentMinusBorn <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> msgExt<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 免疫回查期时长，默认等于事务超时时间，6s</span>
                    <span class="token keyword">long</span> checkImmunityTime <span class="token operator">=</span> transactionTimeout<span class="token punctuation">;</span>
                    <span class="token comment">// 消息属性中定义的免疫回查时长</span>
                    <span class="token class-name">String</span> checkImmunityTimeStr <span class="token operator">=</span> msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_CHECK_IMMUNITY_TIME_IN_SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> checkImmunityTimeStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 如果消息属性中也定义了免疫回查时长，优先使用消息属性中的值，单位为秒</span>
                        checkImmunityTime <span class="token operator">=</span> <span class="token function">getImmunityTime</span><span class="token punctuation">(</span>checkImmunityTimeStr<span class="token punctuation">,</span> transactionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 事务半消息存在时长小于免疫回查时长，不需要回查</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>valueOfCurrentMinusBorn <span class="token operator">&lt;</span> checkImmunityTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// 检查该事务半消息的偏移量，如果在 removeMap 里，即该消息已经被提交或回滚，不需要处理了。</span>
                            <span class="token comment">// 跳过，继续下一个事务半消息的回查判断</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkPrepareQueueOffset</span><span class="token punctuation">(</span>removeMap<span class="token punctuation">,</span> doneOpOffset<span class="token punctuation">,</span> msgExt<span class="token punctuation">,</span> checkImmunityTimeStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                newOffset <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                                i<span class="token operator">++</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> valueOfCurrentMinusBorn <span class="token operator">&amp;&amp;</span> valueOfCurrentMinusBorn <span class="token operator">&lt;</span> checkImmunityTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;New arrived, the miss offset={}, check it later checkImmunity={}, born={}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>
                                checkImmunityTime<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">/*
                     * 判断是否需要回查，满足以下 3 个条件之一则进行回查
                     * 1. 没有操作消息，且当前半消息在回查免疫期外
                     * 2. 存在操作消息，且本批次操作消息中最后一个在免疫期外
                     * 3. Broker 与客户端有时间差
                     */</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> opMsg <span class="token operator">=</span> pullResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> isNeedCheck <span class="token operator">=</span> opMsg <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> valueOfCurrentMinusBorn <span class="token operator">&gt;</span> checkImmunityTime
                        <span class="token operator">||</span> opMsg <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> opMsg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>opMsg<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">&gt;</span> transactionTimeout
                        <span class="token operator">||</span> valueOfCurrentMinusBorn <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>isNeedCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 将事务半消息重新放入到事务半消息队列中，因为前面更新了事务半消息的属性（回查次数），需要更新消费偏移量并且重新存储。</span>
                        <span class="token comment">// 并且回查是一个异步过程，不确定回查是否能够请求到，所以这里做最坏的打算，没有请求成功则下次继续回查。</span>
                        <span class="token comment">// 如果回查成功则写入操作消息 Map，下次不会回查。</span>
                        <span class="token comment">// 这里有个问题是：最坏的情况下（事务消息一直执行中，不停回查），会最多重复存储 15 次事务半消息，造成写放大。</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">putBackHalfMsgQueue</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        putInQueueCount<span class="token operator">++</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Check transaction. real_topic={},uniqKey={},offset={},commitLogOffset={}&quot;</span><span class="token punctuation">,</span>
                                msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                msgExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgExt<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 通过 listener 向消费者客户端发送单向的消息回查请求</span>
                        listener<span class="token punctuation">.</span><span class="token function">resolveHalfMsg</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 不需要进行回查，更新下一个要检查的事务操作消息的偏移量</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        nextOpOffset <span class="token operator">=</span> pullResult <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> nextOpOffset<span class="token punctuation">;</span>
                        pullResult <span class="token operator">=</span> <span class="token function">fillOpRemoveMap</span><span class="token punctuation">(</span>removeMap<span class="token punctuation">,</span> opQueue<span class="token punctuation">,</span> nextOpOffset<span class="token punctuation">,</span>
                                halfOffset<span class="token punctuation">,</span> opMsgMap<span class="token punctuation">,</span> doneOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>pullResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> pullResult<span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PullStatus</span><span class="token punctuation">.</span><span class="token constant">NO_NEW_MSG</span>
                                <span class="token operator">||</span> pullResult<span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PullStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_ILLEGAL</span>
                                <span class="token operator">||</span> pullResult<span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PullStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_MSG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token constant">SLEEP_WHILE_NO_OP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token punctuation">}</span>

                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;The miss message offset:{}, pullOffsetOfOp:{}, miniOffset:{} get more opMsg.&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> nextOpOffset<span class="token punctuation">,</span> halfOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                newOffset <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 更新事务半消息消费队列的回查进度</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newOffset <span class="token operator">!=</span> halfOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">updateConsumeOffset</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">,</span> newOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 更新操作队列的消费进度</span>
            <span class="token keyword">long</span> newOpOffset <span class="token operator">=</span> <span class="token function">calculateOpOffset</span><span class="token punctuation">(</span>doneOpOffset<span class="token punctuation">,</span> opOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newOpOffset <span class="token operator">!=</span> opOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">updateConsumeOffset</span><span class="token punctuation">(</span>opQueue<span class="token punctuation">,</span> newOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">GetResult</span> getResult <span class="token operator">=</span> <span class="token function">getHalfMsg</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">,</span> newOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pullResult <span class="token operator">=</span> <span class="token function">pullOpMsg</span><span class="token punctuation">(</span>opQueue<span class="token punctuation">,</span> newOpOffset<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> maxMsgOffset <span class="token operator">=</span> getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> newOffset <span class="token operator">:</span> getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> maxOpOffset <span class="token operator">=</span> pullResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> newOpOffset <span class="token operator">:</span> pullResult<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> msgTime <span class="token operator">=</span> getResult<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> getResult<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;After check, {} opOffset={} opOffsetDiff={} msgOffset={} msgOffsetDiff={} msgTime={} msgTimeDelayInMs={} putInQueueCount={}&quot;</span><span class="token punctuation">,</span>
                    messageQueue<span class="token punctuation">,</span> newOpOffset<span class="token punctuation">,</span> maxOpOffset <span class="token operator">-</span> newOpOffset<span class="token punctuation">,</span> newOffset<span class="token punctuation">,</span> maxMsgOffset <span class="token operator">-</span> newOffset<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>msgTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> msgTime<span class="token punctuation">,</span> putInQueueCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Check error&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 计算免疫回查时长，如果消息属性中定义了免疫回查时长，则使用消息属性中定义的免疫回查时长，否则使用事务超时时间
 * <span class="token keyword">@param</span> <span class="token parameter">checkImmunityTimeStr</span> 消息属性中定义的免疫回查时长
 * <span class="token keyword">@param</span> <span class="token parameter">transactionTimeout</span> 事务超时时间
 * <span class="token keyword">@return</span> 免疫回查时长
 */</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">getImmunityTime</span><span class="token punctuation">(</span><span class="token class-name">String</span> checkImmunityTimeStr<span class="token punctuation">,</span> <span class="token keyword">long</span> transactionTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> checkImmunityTime<span class="token punctuation">;</span>

    checkImmunityTime <span class="token operator">=</span> <span class="token function">getLong</span><span class="token punctuation">(</span>checkImmunityTimeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> checkImmunityTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        checkImmunityTime <span class="token operator">=</span> transactionTimeout<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        checkImmunityTime <span class="token operator">*=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> checkImmunityTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="abstracttransactionalmessagechecklistener-resolvehalfmsg" tabindex="-1"><a class="header-anchor" href="#abstracttransactionalmessagechecklistener-resolvehalfmsg" aria-hidden="true">#</a> AbstractTransactionalMessageCheckListener#resolveHalfMsg</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AbstractTransactionalMessageCheckListener.java</span>
<span class="token doc-comment comment">/**
 * 处理事务半消息（回查其执行状态）
 * <span class="token keyword">@param</span> <span class="token parameter">msgExt</span> 事务半消息
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resolveHalfMsg</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MessageExt</span> msgExt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executorService <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">sendCheckMessage</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Send check message error!&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;TransactionalMessageCheckListener not init&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 发送回查请求到生产者客户端
 *
 * <span class="token keyword">@param</span> <span class="token parameter">msgExt</span> 事务半消息
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendCheckMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> msgExt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">CheckTransactionStateRequestHeader</span> checkTransactionStateRequestHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckTransactionStateRequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setCommitLogOffset</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setOffsetMsgId</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setMsgId</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setTranStateTableOffset</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkTransactionStateRequestHeader<span class="token punctuation">.</span><span class="token function">setBrokerName</span><span class="token punctuation">(</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从消息属性中复原真实的 topic 和 queueId</span>
    msgExt<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgExt<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_QUEUE_ID</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msgExt<span class="token punctuation">.</span><span class="token function">setStoreSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> groupId <span class="token operator">=</span> msgExt<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_PRODUCER_GROUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 轮询选择一个可用的生产者客户端通道</span>
    <span class="token class-name">Channel</span> channel <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getProducerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAvailableChannel</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 发送回查请求到生产者客户端，回查事务消息执行状态。单向请求，不需要等待响应</span>
        brokerController<span class="token punctuation">.</span><span class="token function">getBroker2Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkProducerTransactionState</span><span class="token punctuation">(</span>groupId<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> checkTransactionStateRequestHeader<span class="token punctuation">,</span> msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Check transaction failed, channel is null. groupId={}&quot;</span><span class="token punctuation">,</span> groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-2-producer-处理回查请求" tabindex="-1"><a class="header-anchor" href="#_5-2-2-producer-处理回查请求" aria-hidden="true">#</a> 5.2.2 Producer 处理回查请求</h4><h5 id="clientremotingprocessor-checktransactionstate" tabindex="-1"><a class="header-anchor" href="#clientremotingprocessor-checktransactionstate" aria-hidden="true">#</a> ClientRemotingProcessor#checkTransactionState</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ClientRemotingProcessor.java</span>
<span class="token doc-comment comment">/**
 * 处理 Broker 发来的事务回查请求，发送本地事务执行状态到 Broker
 */</span>
<span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">checkTransactionState</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
    <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">CheckTransactionStateRequestHeader</span> requestHeader <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token class-name">CheckTransactionStateRequestHeader</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">CheckTransactionStateRequestHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">MessageExt</span> messageExt <span class="token operator">=</span> <span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory<span class="token punctuation">.</span><span class="token function">getClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            messageExt<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token class-name">NamespaceUtil</span>
                <span class="token punctuation">.</span><span class="token function">withoutNamespace</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory<span class="token punctuation">.</span><span class="token function">getClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> transactionId <span class="token operator">=</span> messageExt<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> transactionId <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            messageExt<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> group <span class="token operator">=</span> messageExt<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_PRODUCER_GROUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>group <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">MQProducerInner</span> producer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory<span class="token punctuation">.</span><span class="token function">selectProducer</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>producer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> addr <span class="token operator">=</span> <span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token function">parseChannelRemoteAddr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 检查本地事务执行状态，发送到 Broker</span>
                producer<span class="token punctuation">.</span><span class="token function">checkTransactionState</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> messageExt<span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;checkTransactionState, pick producer by group[{}] failed&quot;</span><span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;checkTransactionState, pick producer group failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;checkTransactionState, decode message failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="defaultmqproducerimpl-checktransactionstate" tabindex="-1"><a class="header-anchor" href="#defaultmqproducerimpl-checktransactionstate" aria-hidden="true">#</a> DefaultMQProducerImpl#checkTransactionState</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// DefaultMQProducerImpl.java</span>
<span class="token doc-comment comment">/**
 * 处理 Broker 发来的事务消息执行状态回查请求，检查本地事务执行状态，发送到 Broker
 *
 * <span class="token keyword">@param</span> <span class="token parameter">addr</span> Broker 地址
 * <span class="token keyword">@param</span> <span class="token parameter">msg</span> Broker 发回的事务半消息
 * <span class="token keyword">@param</span> <span class="token parameter">header</span> Broker 回查的请求头
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkTransactionState</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> addr<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">MessageExt</span> msg<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">CheckTransactionStateRequestHeader</span> header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Runnable</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> brokerAddr <span class="token operator">=</span> addr<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MessageExt</span> message <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CheckTransactionStateRequestHeader</span> checkRequestHeader <span class="token operator">=</span> header<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> group <span class="token operator">=</span> <span class="token class-name">DefaultMQProducerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TransactionCheckListener</span> transactionCheckListener <span class="token operator">=</span> <span class="token class-name">DefaultMQProducerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionListener</span> transactionListener <span class="token operator">=</span> <span class="token function">getCheckListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionCheckListener <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> transactionListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">LocalTransactionState</span> localTransactionState <span class="token operator">=</span> <span class="token class-name">LocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOW</span><span class="token punctuation">;</span>
                <span class="token class-name">Throwable</span> exception <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 获取本地事务执行状态</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionCheckListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 使用了老的生产者</span>
                        localTransactionState <span class="token operator">=</span> transactionCheckListener<span class="token punctuation">.</span><span class="token function">checkLocalTransactionState</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 使用了新的事务消息生产者 API</span>
                        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;TransactionCheckListener is null, used new check API, producerGroup={}&quot;</span><span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        localTransactionState <span class="token operator">=</span> transactionListener<span class="token punctuation">.</span><span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Broker call checkTransactionState, but checkLocalTransactionState exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    exception <span class="token operator">=</span> e<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 将本地事务执行状态发送到 Broker</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processTransactionState</span><span class="token punctuation">(</span>
                    checkRequestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    localTransactionState<span class="token punctuation">,</span>
                    group<span class="token punctuation">,</span>
                    exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;CheckTransactionState, pick transactionCheckListener by group[{}] failed&quot;</span><span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * 根据本地事务执行装填，提交或回滚事务消息
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processTransactionState</span><span class="token punctuation">(</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">LocalTransactionState</span> localTransactionState<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> producerGroup<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">Throwable</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">EndTransactionRequestHeader</span> thisHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EndTransactionRequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setCommitLogOffset</span><span class="token punctuation">(</span>checkRequestHeader<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span>producerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setTranStateTableOffset</span><span class="token punctuation">(</span>checkRequestHeader<span class="token punctuation">.</span><span class="token function">getTranStateTableOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 是 Broker 端回查后发出的请求</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setFromTransactionCheck</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setBrokerName</span><span class="token punctuation">(</span>checkRequestHeader<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> uniqueKey <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>uniqueKey <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                uniqueKey <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setMsgId</span><span class="token punctuation">(</span>uniqueKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thisHeader<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>checkRequestHeader<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 根据本地事务执行状态，设置请求头中的 commitOrRollback 值</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>localTransactionState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">COMMIT_MESSAGE</span><span class="token operator">:</span>
                    thisHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_COMMIT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">ROLLBACK_MESSAGE</span><span class="token operator">:</span>
                    thisHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_ROLLBACK_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;when broker check, client rollback this transaction, {}&quot;</span><span class="token punctuation">,</span> thisHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">UNKNOW</span><span class="token operator">:</span>
                    thisHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span><span class="token class-name">MessageSysFlag</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_NOT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;when broker check, client does not know this transaction state, {}&quot;</span><span class="token punctuation">,</span> thisHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> remark <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                remark <span class="token operator">=</span> <span class="token string">&quot;checkLocalTransactionState Exception: &quot;</span> <span class="token operator">+</span> <span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">exceptionSimpleDesc</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 执行事务消息状态回查后钩子，主要是上报消息轨迹</span>
            <span class="token function">doExecuteEndTransactionHook</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> uniqueKey<span class="token punctuation">,</span> brokerAddr<span class="token punctuation">,</span> localTransactionState<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 向 Broker 发送事务执行结果，Broker 根据结果处理事务半消息</span>
                <span class="token class-name">DefaultMQProducerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getMQClientAPIImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endTransactionOneway</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> thisHeader<span class="token punctuation">,</span> remark<span class="token punctuation">,</span>
                    <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;endTransactionOneway exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>checkExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2><ul><li><a href="https://github.com/apache/rocketmq/blob/master/docs/cn/design.md#5-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF" target="_blank" rel="noopener noreferrer">RocketMQ 设计文档——事务消息<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://rocketmq.apache.org/zh/docs/featureBehavior/04transactionmessage" target="_blank" rel="noopener noreferrer">官方文档——事务消息<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://blog.csdn.net/prestigeding/article/details/81259646" target="_blank" rel="noopener noreferrer">RocketMQ 源码分析事务消息系列——丁威<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><hr><p>欢迎关注公众号【消息中间件】（middleware-mq），更新消息中间件的源码解析和最新动态！</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202205170102971.jpg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/HScarb/knowledge/edit/main/docs/src/rocketmq/20250131-rocketmq-transactional-message.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: jjhfen00@163.com">ScarbWin</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">默认页脚</div><div class="vp-copyright">Copyright © 2025 Scarb</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-58204090.js" defer></script>
  </body>
</html>
