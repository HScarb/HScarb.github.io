<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.66" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://hscarb.github.io/rocketmq/20240429-rocketmq-tieredstore.html"><meta property="og:site_name" content="金甲虫的博客"><meta property="og:title" content="Rocketmq 5 分级存储 Tieredstore（RIP-57、RIP-65） 原理详解 & 源码解析"><meta property="og:description" content="原文地址：http://hscarb.github.io/rocketmq/20240429-rocketmq-tieredstore.html (http://hscarb.github.io/rocketmq/20240429-rocketmq-tieredstore.html) 1. 背景 1.1 需求 RocketMQ 5.x 的演进目标之一是..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-04-28T17:07:38.000Z"><meta property="article:author" content="Scarb"><meta property="article:published_time" content="2024-04-29T00:00:00.000Z"><meta property="article:modified_time" content="2024-04-28T17:07:38.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Rocketmq 5 分级存储 Tieredstore（RIP-57、RIP-65） 原理详解 & 源码解析","image":[""],"datePublished":"2024-04-29T00:00:00.000Z","dateModified":"2024-04-28T17:07:38.000Z","author":[{"@type":"Person","name":"Scarb"}]}</script><title>Rocketmq 5 分级存储 Tieredstore（RIP-57、RIP-65） 原理详解 & 源码解析 | 金甲虫的博客</title><meta name="description" content="原文地址：http://hscarb.github.io/rocketmq/20240429-rocketmq-tieredstore.html (http://hscarb.github.io/rocketmq/20240429-rocketmq-tieredstore.html) 1. 背景 1.1 需求 RocketMQ 5.x 的演进目标之一是...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-e6f2d601.css" as="style"><link rel="stylesheet" href="/assets/style-e6f2d601.css">
    <link rel="modulepreload" href="/assets/app-10497a29.js"><link rel="modulepreload" href="/assets/20240429-rocketmq-tieredstore.html-7d2652e2.js"><link rel="modulepreload" href="/assets/20240429-rocketmq-tieredstore.html-bfbe37af.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/index.html-102bf403.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-6f333d07.js" as="script"><link rel="prefetch" href="/assets/20230530-lxf-java-note.html-9300be95.js" as="script"><link rel="prefetch" href="/assets/20230815-mockito-note.html-c2258399.js" as="script"><link rel="prefetch" href="/assets/20240827-reactor-java.html-fe9c28ac.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-cac7204c.js" as="script"><link rel="prefetch" href="/assets/index.html-f508c123.js" as="script"><link rel="prefetch" href="/assets/20191229-vim-note.html-b4a3cd68.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-d3e5eb48.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-7a801a5e.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-51122c83.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-0922cff0.js" as="script"><link rel="prefetch" href="/assets/20230813-lxf-js-note.html-82465167.js" as="script"><link rel="prefetch" href="/assets/20230820-powerjob.html-b9352ef3.js" as="script"><link rel="prefetch" href="/assets/20231015-consistent-hash.html-07b06be4.js" as="script"><link rel="prefetch" href="/assets/20241216-wow-restoration-druid-mythic-guide.html-d5f7518b.js" as="script"><link rel="prefetch" href="/assets/99991231-ryf-ts-note.html-730cf657.js" as="script"><link rel="prefetch" href="/assets/index.html-f1d1b9ba.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-5756ebfa.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-59cfb351.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-7fe5f428.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-9de184dd.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-bb235715.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-e29ec945.js" as="script"><link rel="prefetch" href="/assets/20231016-rabbitmq-consistent-hash-exchange.html-6e2e8f6d.js" as="script"><link rel="prefetch" href="/assets/index.html-8e2b67a8.js" as="script"><link rel="prefetch" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-90c27f1b.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-2023d209.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-5de0a873.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-ae13da53.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-1ec85a19.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-e7fef9e4.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-b65d2e82.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-591b00dc.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-00247a89.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-7e15b5f8.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-b701d200.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-f9dc2d19.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-873655ea.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-7b285f6b.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-5f11b114.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-da9eb2ad.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-63ba6675.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-f3b1dd76.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-33d17a44.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-4da4a69a.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-7510810a.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-071340e5.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-f07feea0.js" as="script"><link rel="prefetch" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-650cf515.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-ff9830f7.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-26409d59.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-53d9ae69.js" as="script"><link rel="prefetch" href="/assets/20230808-rocketmq-timer.html-ee37a256.js" as="script"><link rel="prefetch" href="/assets/20250131-rocketmq-transactional-message.html-859aaa1b.js" as="script"><link rel="prefetch" href="/assets/20250204-rocketmq-dledger-leader-election.html-d0be5431.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-ddc41950.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-f220a3ec.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-79144a64.js" as="script"><link rel="prefetch" href="/assets/index.html-ad7f47b1.js" as="script"><link rel="prefetch" href="/assets/404.html-8b9ee051.js" as="script"><link rel="prefetch" href="/assets/index.html-a98a8640.js" as="script"><link rel="prefetch" href="/assets/20220427-jmh.html-a1cffa83.js" as="script"><link rel="prefetch" href="/assets/20230530-lxf-java-note.html-16a45ebc.js" as="script"><link rel="prefetch" href="/assets/20230815-mockito-note.html-2844a4b5.js" as="script"><link rel="prefetch" href="/assets/20240827-reactor-java.html-e7df226f.js" as="script"><link rel="prefetch" href="/assets/99991231-java-best-io.html-8b4d68fb.js" as="script"><link rel="prefetch" href="/assets/index.html-d0d845b7.js" as="script"><link rel="prefetch" href="/assets/20191229-vim-note.html-11b8c635.js" as="script"><link rel="prefetch" href="/assets/20220614-erlang-note.html-a548380e.js" as="script"><link rel="prefetch" href="/assets/20230306-arthas-note.html-032d3a17.js" as="script"><link rel="prefetch" href="/assets/20230306-openchaos.html-54f4f5f8.js" as="script"><link rel="prefetch" href="/assets/20230316-vim-linebreaker.html-eb507b7c.js" as="script"><link rel="prefetch" href="/assets/20230813-lxf-js-note.html-7243baa8.js" as="script"><link rel="prefetch" href="/assets/20230820-powerjob.html-b3cd2a30.js" as="script"><link rel="prefetch" href="/assets/20231015-consistent-hash.html-9675eefe.js" as="script"><link rel="prefetch" href="/assets/20241216-wow-restoration-druid-mythic-guide.html-d1b6a648.js" as="script"><link rel="prefetch" href="/assets/99991231-ryf-ts-note.html-13a3d8ff.js" as="script"><link rel="prefetch" href="/assets/index.html-ef3af0de.js" as="script"><link rel="prefetch" href="/assets/20220131-rabbitmq-flow-control.html-9f7c3e8d.js" as="script"><link rel="prefetch" href="/assets/20220313-rabbitmq-federation-plugin.html-ee86d1ee.js" as="script"><link rel="prefetch" href="/assets/20220408-rabbitmq-3.7-install.html-a6da5151.js" as="script"><link rel="prefetch" href="/assets/20220409-rabbitmq-mirror-queue.html-0e1fb865.js" as="script"><link rel="prefetch" href="/assets/20220610-rabbitmq-store.html-1eadb9fb.js" as="script"><link rel="prefetch" href="/assets/20220714-rabbitmq-quorum-queues-feature-focus.html-ea45ed4d.js" as="script"><link rel="prefetch" href="/assets/20231016-rabbitmq-consistent-hash-exchange.html-af93db6e.js" as="script"><link rel="prefetch" href="/assets/index.html-2276d3a3.js" as="script"><link rel="prefetch" href="/assets/20220131-rocketmq-4.9.1-performance-improvement.html-0e28b938.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-consumequeue.html-a58cc1fe.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-indexfile.html-66003e02.js" as="script"><link rel="prefetch" href="/assets/20220301-rocketmq-longpolling-pullrequestholdservice.html-2e1bf533.js" as="script"><link rel="prefetch" href="/assets/20220313-rocketmq-scheduled-message.html-e10d7b29.js" as="script"><link rel="prefetch" href="/assets/20220320-rocketmq-scheduled-message-4.9.3-improve.html-3c606299.js" as="script"><link rel="prefetch" href="/assets/20220328-rocketmq-expired-file-delete.html-fbc777a1.js" as="script"><link rel="prefetch" href="/assets/20220410-rocketmq-high-performance-io.html-4eb1a3ef.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-4.9.3-performance-improvement.html-61a83d6a.js" as="script"><link rel="prefetch" href="/assets/20220412-rocketmq-flexable-scheduled-message.html-7a7e4e93.js" as="script"><link rel="prefetch" href="/assets/20220502-rocketmq-nameserver.html-5fb36819.js" as="script"><link rel="prefetch" href="/assets/20220515-rocketmq-acl.html-d42754e7.js" as="script"><link rel="prefetch" href="/assets/20220521-rocketmq-trace.html-0f64bb41.js" as="script"><link rel="prefetch" href="/assets/20220606-rocketmq-send-message.html-f73addeb.js" as="script"><link rel="prefetch" href="/assets/20220618-rocketmq-memory-store.html-1ea13dc0.js" as="script"><link rel="prefetch" href="/assets/20220724-rocketmq-docker-compose.html-2528c4f1.js" as="script"><link rel="prefetch" href="/assets/20220820-rocketmq-consumer-1-summary.html-b1fd0d26.js" as="script"><link rel="prefetch" href="/assets/20220827-rocketmq-consumer-2-struct-and-init.html-361b2d3f.js" as="script"><link rel="prefetch" href="/assets/20220830-rocketmq-consumer-3-rebalance.html-6d3b3400.js" as="script"><link rel="prefetch" href="/assets/20220904-rocketmq-consumer-4-pull-message.html-77b0a0d0.js" as="script"><link rel="prefetch" href="/assets/20220912-rocketmq-consumer-5-message-consume.html-320c3a28.js" as="script"><link rel="prefetch" href="/assets/20220929-rocketmq-consumer-6-consume-orderly.html-d4e39e42.js" as="script"><link rel="prefetch" href="/assets/20221104-rocketmq-best-practice.html-9da097be.js" as="script"><link rel="prefetch" href="/assets/20221212-rocketmq-consumer-7-pop-consume.html-290e9acb.js" as="script"><link rel="prefetch" href="/assets/20230304-rocketmq-light-message-queue.html-94bf2dc6.js" as="script"><link rel="prefetch" href="/assets/20230324-rocketmq-netty-write-buffer-watermark.html-e26390be.js" as="script"><link rel="prefetch" href="/assets/20230716-rocketmq-filter.html-9be11d93.js" as="script"><link rel="prefetch" href="/assets/20230808-rocketmq-timer.html-0e334765.js" as="script"><link rel="prefetch" href="/assets/20250131-rocketmq-transactional-message.html-26a42015.js" as="script"><link rel="prefetch" href="/assets/20250204-rocketmq-dledger-leader-election.html-b3c38388.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-dynamic-config.html-7b1ebe6f.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-kafka-zero-copy.html-d63413e7.js" as="script"><link rel="prefetch" href="/assets/99991231-rocketmq-mappedfile.html-2e485f8c.js" as="script"><link rel="prefetch" href="/assets/index.html-cc31027d.js" as="script"><link rel="prefetch" href="/assets/404.html-5ea88242.js" as="script"><link rel="prefetch" href="/assets/giscus-0b7adcf8.js" as="script"><link rel="prefetch" href="/assets/auto-712ff3ee.js" as="script"><link rel="prefetch" href="/assets/index-2bf332f6.js" as="script"><link rel="prefetch" href="/assets/flowchart-c441f34d.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-227cc54b.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-abe06b83.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-99e11767.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-5794cde2.js" as="script"><link rel="prefetch" href="/assets/SearchResult-83b0d178.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><img class="vp-nav-logo" src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/scarb/scarb.jpg" alt="金甲虫的博客"><!----><span class="vp-site-name hide-in-pad">金甲虫的博客</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/"><!---->Home<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link active" href="/rocketmq/"><!---->RocketMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/rabbitmq/"><!---->RabbitMQ<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/java/"><!---->Java<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/other/"><!---->Other<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Follow Me"><span class="title"><!---->Follow Me</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="https://github.com/HScarb" rel="noopener noreferrer" target="_blank" aria-label="Github" class="nav-link"><!---->Github<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://juejin.cn/user/219558057345111/posts" rel="noopener noreferrer" target="_blank" aria-label="掘金" class="nav-link"><!---->掘金<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/HScarb/knowledge" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Rocketmq 5 分级存储 Tieredstore（RIP-57、RIP-65） 原理详解 &amp; 源码解析</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Scarb</span></span><span property="author" content="Scarb"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-04-29T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 50 分钟</span><meta property="timeRequired" content="PT50M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_1-背景">1. 背景</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_1-1-需求">1.1 需求</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_1-2-解决的问题">1.2 解决的问题</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_1-3-演进过程">1.3 演进过程</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_2-使用">2. 使用</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-1-broker-配置">2.1 Broker 配置</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_2-2-数据组织结构">2.2 数据组织结构</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_3-概要设计">3. 概要设计</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-1-技术架构选型">3.1 技术架构选型</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-2-存储模型与抽象">3.2 存储模型与抽象</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-3-分层设计">3.3 分层设计</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-4-写消息">3.4 写消息</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-5-读消息">3.5 读消息</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-6-索引设计">3.6 索引设计</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_3-7-重启恢复和元数据">3.7 重启恢复和元数据</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_4-详细设计">4. 详细设计</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-1-接入方式">4.1 接入方式</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-2-存储模型">4.2 存储模型</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-3-写消息">4.3 写消息</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-4-读消息">4.4 读消息</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-5-索引文件">4.5 索引文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_4-6-重启恢复和元数据">4.6 重启恢复和元数据</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#_5-源码解析">5. 源码解析</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_5-1-分级存储接入">5.1 分级存储接入</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_5-2-写消息">5.2 写消息</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_5-3-读消息">5.3 读消息</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#_5-4-索引文件">5.4 索引文件</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#参考资料">参考资料</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>原文地址：<a href="http://hscarb.github.io/rocketmq/20240429-rocketmq-tieredstore.html" target="_blank" rel="noopener noreferrer">http://hscarb.github.io/rocketmq/20240429-rocketmq-tieredstore.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h1 id="rocketmq-5-分级存储-tieredstore-rip-57、rip-65-原理详解-源码解析" tabindex="-1"><a class="header-anchor" href="#rocketmq-5-分级存储-tieredstore-rip-57、rip-65-原理详解-源码解析" aria-hidden="true">#</a> Rocketmq 5 分级存储 Tieredstore（RIP-57、RIP-65） 原理详解 &amp; 源码解析</h1><h2 id="_1-背景" tabindex="-1"><a class="header-anchor" href="#_1-背景" aria-hidden="true">#</a> 1. 背景</h2><h3 id="_1-1-需求" tabindex="-1"><a class="header-anchor" href="#_1-1-需求" aria-hidden="true">#</a> 1.1 需求</h3><p>RocketMQ 5.x 的演进目标之一是云原生化，在云原生和 Serverless 的浪潮下，需要解决 RocketMQ 存储层存在两个瓶颈。</p><ol><li>数据量膨胀过快，单体硬件无法支撑</li><li>存储的低成本和速度无法兼得</li></ol><p>众多云厂商也希望提供 Serverless 化的 RocketMQ 来降低成本，为用户提供更加极致弹性的云服务。</p><h3 id="_1-2-解决的问题" tabindex="-1"><a class="header-anchor" href="#_1-2-解决的问题" aria-hidden="true">#</a> 1.2 解决的问题</h3><p>除了以上两个瓶颈之外，分级存储还希望解决的问题是</p><ol><li>消息仅支持保留固定的时间</li><li>Topic 的数据与 Broker 绑定，无法迁移。比如在 Broker 缩容的场景下，被削减的 Broker 上的历史数据无法保留。</li></ol><h3 id="_1-3-演进过程" tabindex="-1"><a class="header-anchor" href="#_1-3-演进过程" aria-hidden="true">#</a> 1.3 演进过程</h3><p>RocketMQ 5.1 中提出了分级存储的方案（<a href="https://github.com/apache/rocketmq/wiki/RIP-57-Tiered-storage-for-RocketMQ" target="_blank" rel="noopener noreferrer">RIP-57<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>），但当时的版本还未达到生产可用。</p><p><a href="https://github.com/apache/rocketmq/wiki/RIP-65-Tiered-Storage-Optimization" target="_blank" rel="noopener noreferrer">RIP-65<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 对之前的分级存储实现进行了重构，修改了模型抽象、线程模式、元数据管理和索引文件的实现，提升了分级存储的代码可读性。</p><p><a href="https://github.com/apache/rocketmq/issues/7878" target="_blank" rel="noopener noreferrer">ISSUE #7878<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 又对分级存储的代码进行了大量重构，修复已知问题，提升性能，减少资源利用率。</p><p>经过几次重构，当前的分级存储基本已经属于可用的状态。不过官方只提供了内存和本地文件两种分级存储文件段的实现，其他存储介质分级存储的实现需要用户自行扩展来实现。</p><h2 id="_2-使用" tabindex="-1"><a class="header-anchor" href="#_2-使用" aria-hidden="true">#</a> 2. 使用</h2><h3 id="_2-1-broker-配置" tabindex="-1"><a class="header-anchor" href="#_2-1-broker-配置" aria-hidden="true">#</a> 2.1 Broker 配置</h3><p>要测试分级存储，需要在 <code>broker.conf</code> 中添加如下配置：</p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code><span class="token comment"># tiered</span>
<span class="token key attr-name">messageStorePlugIn</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.rocketmq.tieredstore.TieredMessageStore</span>
<span class="token key attr-name">tieredBackendServiceProvider</span><span class="token punctuation">=</span><span class="token value attr-value">org.apache.rocketmq.tieredstore.provider.PosixFileSegment</span>
<span class="token key attr-name">tieredStoreFilePath</span><span class="token punctuation">=</span><span class="token value attr-value">e:\\data\\rocketmq\\node\\tieredstore</span>
<span class="token key attr-name">tieredStorageLevel</span><span class="token punctuation">=</span><span class="token value attr-value">FORCE</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分级存储各个配置的含义表如下：</p><table><thead><tr><th>配置</th><th>默认值</th><th>单位</th><th>作用</th></tr></thead><tbody><tr><td>messageStorePlugIn</td><td></td><td></td><td>扩展 MessageStore 实现，如果要用分级存储，设置成<code>org.apache.rocketmq.tieredstore.TieredMessageStore </code></td></tr><tr><td>tieredMetadataServiceProvider</td><td>org.apache.rocketmq.tieredstore.metadata.DefaultMetadataStore</td><td></td><td>分级存储元数据存储实现</td></tr><tr><td>tieredBackendServiceProvider</td><td>org.apache.rocketmq.tieredstore.provider.MemoryFileSegment</td><td></td><td>分级存储数据存储实现</td></tr><tr><td>tieredStoreFilepath</td><td></td><td></td><td>分级存储数据文件保存位置（POSIX provider）</td></tr><tr><td>tieredStorageLevel</td><td>NOT_IN_DISK</td><td></td><td>分级存储读取策略，默认 NOT_IN_DISK，即只有在本地存储中不存在时才会读取分级存储。其他选项为：DISABLE，禁用分级存储；NOT_IN_MEM，消息不在内存（Page Cache）时读分级存储；FORCE，强制读取分级存储</td></tr><tr><td>tieredStoreFileReservedTime</td><td>72</td><td>hour</td><td>分级存储消息保存时间</td></tr><tr><td>commitLogRollingInterval</td><td>24</td><td>hour</td><td>分级存储 CommitLog 强制滚动时间</td></tr><tr><td>readAheadCacheEnable</td><td>true</td><td></td><td>从分级存储读取时是否启用预读缓存</td></tr><tr><td>readAheadMessageCountThreshold</td><td>4096</td><td></td><td>从分级存储时每次读取消息数量阈值</td></tr><tr><td>readAheadMessageSizeThreshold</td><td>16 * 1024 * 1024</td><td>byte</td><td>从分级存储中每次读取消息的长度阈值</td></tr><tr><td>readAheadCacheExpireDuration</td><td>15000</td><td>ms</td><td>预读缓存过期时间，没有读写操作 15s 后过期</td></tr><tr><td>readAheadCacheSizeThresholdRate</td><td>0.3</td><td>比例</td><td>最大预读缓存大小，为 JVM 最大内存的一定比例</td></tr><tr><td>tieredStoreMaxPendingLimit</td><td>10000</td><td></td><td>分级存储写文件最大同时写文件数量</td></tr></tbody></table><p>目前 RocketMQ 源码中内置了两种分级存储 FileSegment 的实现</p><ul><li>MemoryFileSegment：使用内存作为二级存储</li><li>PosixFileSegment：使用磁盘文件作为二级存储</li></ul><p>他们都是实验性的，这里选择了 <code>PosixFileSegment</code>。</p><p>要实现其他存储介质的分级存储，只需要扩展 <code>FileSegment</code> 实现一个新的 <code>FileSegment</code> 类即可。</p><h3 id="_2-2-数据组织结构" tabindex="-1"><a class="header-anchor" href="#_2-2-数据组织结构" aria-hidden="true">#</a> 2.2 数据组织结构</h3><p>对启用了分级存储的 Broker 进行压测，一段时间后分级存储目录中的文件：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>/e/data/rocketmq/node/tieredstore
`-- [   0]  212d6b50_DefaultCluster
                    `-- [   0]  broker-a
        |           `-- [   0]  rmq_sys_INDEX
        |           `-- [   0]  0
        |           `-- [   0]  INDEX
        |           `-- [572M]  cfcd208400000000000000000000
        `-- [   0]  topic-tiered
            |-- [   0]  0
            |   |-- [   0]  COMMIT_LOG
            |   |   |-- [1024M]  1f329fef00000000001073741775
            |   |   |-- [1024M]  cfcd208400000000000000000000
            |   |   `-- [707M]  dcb86ff200000000002147483550
            |   `-- [   0]  CONSUME_QUEUE
            |       |-- [ 60M]  40d473e300000000000104857600
            |       `-- [100M]  cfcd208400000000000000000000
            |-- [   0]  1
            |   |-- [   0]  COMMIT_LOG
            |   |   |-- [1024M]  1f329fef00000000001073741775
            |   |   |-- [1024M]  cfcd208400000000000000000000
            |   |   `-- [707M]  dcb86ff200000000002147483550
            |   `-- [   0]  CONSUME_QUEUE
            |       |-- [ 60M]  40d473e300000000000104857600
            |       `-- [100M]  cfcd208400000000000000000000
            |-- [   0]  2
            |   |-- [   0]  COMMIT_LOG
            |   |   |-- [1024M]  1f329fef00000000001073741775
            |   |   |-- [1024M]  cfcd208400000000000000000000
            |   |   `-- [707M]  dcb86ff200000000002147483550
            |   `-- [   0]  CONSUME_QUEUE
            |       |-- [ 60M]  40d473e300000000000104857600
            |       `-- [100M]  cfcd208400000000000000000000
            `-- [   0]  3
                |-- [   0]  COMMIT_LOG
                |   |-- [1024M]  1f329fef00000000001073741775
                |   |-- [1024M]  cfcd208400000000000000000000
                |   `-- [707M]  dcb86ff200000000002147483550
                `-- [   0]  CONSUME_QUEUE
                    |-- [ 60M]  40d473e300000000000104857600
                    `-- [100M]  cfcd208400000000000000000000
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中索引文件单独存放，每个 Topic 的队列都单独有 CommitLog 和 ConsumeQueue</p><ul><li><p>CommitLog 为消息数据，与本地存储不同，每个 Topic 的队列都拆分单独一组的 CommitLog 文件，每个 1G</p></li><li><p>ConsumeQueue 为消费索引</p></li><li><p>INDEX 为索引文件，单独目录存放</p></li></ul><h2 id="_3-概要设计" tabindex="-1"><a class="header-anchor" href="#_3-概要设计" aria-hidden="true">#</a> 3. 概要设计</h2><h3 id="_3-1-技术架构选型" tabindex="-1"><a class="header-anchor" href="#_3-1-技术架构选型" aria-hidden="true">#</a> 3.1 技术架构选型</h3><p>分级存储的方案中一个重要的选择是直写还是转写。</p><ul><li><strong>直写</strong>：用高可用的存储或分布式文件系统直接替换本地块存储。优点是池化存储。</li><li><strong>转写</strong>：热数据使用本地块存储先顺序写，压缩之后转储到更廉价的存储系统中。优点是降低冷数据的长期存储成本。</li></ul><p>最理想的终态可以是两者的结合，RocketMQ 自己来做数据转冷。因为消息系统自身对如何更好的压缩数据和加速读取的细节更了解，在转冷的过程中能够做一些消息系统内部的格式变化来加速冷数据的读取，减少 IO 次数、配置不同的 TTL 等。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202404141823483.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>目前的分级存储方案考虑到商业和开源技术架构的一致性，选择先实现<strong>转写</strong>模式。具体包括以下一些考虑：</p><ul><li>成本：将大部分冷数据卸载到更便宜的存储系统中后，热数据的存储成本可以显著减小，更直接的降低存储成本。</li><li>可移植性：直写分布式文件系统通常需要依赖特定 SDK，配合 RDMA 等技术来降低延迟，对应用不完全透明，运维、人力、技术复杂度都有一定上升。保留成熟的本地存储，只需要实现与其他存储后端的适配层就可以轻松切换多种存储后端。</li><li>延迟与性能：通常分布式文件系统跨可用区部署，消息写多数派成功才能被消费，存在跨可用区的延迟。直接写本地磁盘的延迟会小于跨可用区的延迟，其延迟在热数据读写的情况下也不是瓶颈。</li><li>可用性： 转写模式下，整个系统弱依赖二级存储，更适合开源与非公有云场景。</li></ul><h3 id="_3-2-存储模型与抽象" tabindex="-1"><a class="header-anchor" href="#_3-2-存储模型与抽象" aria-hidden="true">#</a> 3.2 存储模型与抽象</h3><p>分级存储的模型与本地存储的模型一一对应，结构上也类似。最大的区别在于分级存储模型的组织形式，其 CommitLog 不再将所有队列的消息数据都存在一起，而是按照队列的维度拆分存储。</p><p>下表展示了本地存储与分级存储模型的对应关系。</p><table><thead><tr><th>本地存储</th><th>分级存储</th><th>说明</th></tr></thead><tbody><tr><td>MappedFile</td><td>FileSegment</td><td>对应单个文件，MappedFile 是 mmap 实现的内存映射文件，FileSegment 是分级存储中文件的句柄</td></tr><tr><td>MappedFileQueue</td><td>FlatAppendFile</td><td>多个 MappedFile/FileSegment 组成的链表，只有最后一个文件是可写的，前面的都是不可变的</td></tr><tr><td>CommitLog</td><td>FlatCommitLogFile</td><td>MappedFileQueue/FlatAppendFile 的封装，CommitLog 是由所有队列的消息数据构成的文件，FlatCommitLogFile 存储单个队列中的消息数据</td></tr><tr><td>ConsumeQueue</td><td>FlatConsumeQueueFile</td><td>MappedFileQueue/FilatAppendFile 的封装，消费索引文件，保存着每个消息在 CommitLog 中的物理偏移量，用于消费每个队列的时候查询消息。本地存储的 ConsumeQueue 详解见 <a href="/rocketmq/20220301-rocketmq-consumequeue.html" class="">这篇文章</a></td></tr><tr><td></td><td>FlatMessageFile</td><td>分级存储引入的概念，表示单个队列的消息文件，组合 FlatCommitLogFile 和 FlatConsumeQueueFile，并提供一系列操作接口</td></tr><tr><td>IndexFile</td><td>IndexStoreFile</td><td>索引文件，也由一组文件构成，用于根据 Key 查询消息。本地存储的 IndexFile 类似一个 HashMap，hash 冲突时，value 是头插法构造成的一个链表。分级存储的 IndexStoreFile 最后一个文件格式与本地存储的 IndexFile 类似，但是列表前面的文件在写入完毕后会经过压缩。本地存储的 IndexFile 讲解见 <a href="/rocketmq/20220301-rocketmq-indexfile.html" class="">这篇文章</a></td></tr></tbody></table><h3 id="_3-3-分层设计" tabindex="-1"><a class="header-anchor" href="#_3-3-分层设计" aria-hidden="true">#</a> 3.3 分层设计</h3><p>分级存储的实现分为 3 层，从上至下分别是<strong>接入层</strong>、<strong>容器层</strong>、<strong>驱动层</strong>。</p><ul><li><strong>驱动层</strong>最为底层，负责实现逻辑文件到具体的分级存储系统的映射。实现 <code>FileSegment</code> 接口，目前提供了内存和本地磁盘的实现。</li><li><strong>容器层</strong>为上面提到的存储模型除了 <code>FileSegment</code> 以外的其他分级存储抽象。</li><li><strong>接入层</strong>作为操作分级存储数据的入口，包含整个分级存储的 <code>MessageStore</code>，以及从分级存储读数据的 Fetcher 和写数据的 Dispatcher。</li></ul><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2024/04/1714324026203.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_3-4-写消息" tabindex="-1"><a class="header-anchor" href="#_3-4-写消息" aria-hidden="true">#</a> 3.4 写消息</h3><p>写消息经过一次重构，由原来的实时上传改为<strong>攒批</strong>，纯<strong>异步</strong>上传。在相同流量下性能提升了 3 倍以上。</p><p>写消息逻辑由<strong>分级存储消息分发器</strong>处理，它被注册到默认存储的分发器链中，在其他分发器都分发完毕后被调用，在这里被调用只是为了创建队列的文件容器和持久化队列的元数据。</p><p><strong>分级存储消息分发器</strong>是一个服务线程，每 20s 进行一次扫描，依次扫描所有的队列，决定是否要上传消息。</p><p>触发上传的条件有两个：距离上次提交达到一定时间（默认 30s），或者等待上传的消息超过一定数量（默认 4096）。</p><p>上传的过程是：</p><ol><li>先将等待上传的这部分消息放入刷盘缓冲区</li><li>为这些消息创建消费队列，也是将消费队列数据放入刷盘缓冲区</li><li>判断缓冲区中的消息是否达到阈值（等到到一定时间或者缓冲区中消息到一定数量），如果达到阈值，则用一个专门的消息上传线程池异步上传已被放入缓冲区的消息。</li><li>上传的过程中，先批量上传消息数据，上传成功后再批量上传消费索引数据（最后如果开启索引构建的话，再构建索引）</li></ol><h3 id="_3-5-读消息" tabindex="-1"><a class="header-anchor" href="#_3-5-读消息" aria-hidden="true">#</a> 3.5 读消息</h3><h4 id="_3-5-1-读取策略" tabindex="-1"><a class="header-anchor" href="#_3-5-1-读取策略" aria-hidden="true">#</a> 3.5.1 读取策略</h4><p>在分级存储的情况下，随着时间的推移，消息的存储位置也会经历 内存（Page Cache）-&gt; 本地存储 -&gt; 二级存储 这样的转变。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202404150040404.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>RocketMQ 分级存储把读取策略抽象了出来，供用户自行配置，默认是 <code>NOT_IN_DISK</code>。</p><ul><li>DISABLE：禁用分级存储，所有 fetch 请求都将由本地消息存储处理。</li><li>NOT_IN_DISK：只有 offset 不在本地存储中的 fetch 请求才会由分级存储处理。</li><li>NOT_IN_MEM：只有 offset 不在内存中的 fetch 请求才会由分级存储处理。</li><li>FORCE：所有 fetch 请求都将由分级存储处理。</li></ul><h4 id="_3-5-2-读取流程" tabindex="-1"><a class="header-anchor" href="#_3-5-2-读取流程" aria-hidden="true">#</a> 3.5.2 读取流程</h4><p>为了加速从二级存储读取的速度和减少整体上对二级存储的请求次数，引入了预读缓存的设计。</p><ul><li><p>首先根据读取策略，查询已提交二级存储的 offset 和消息是否在内存中这些信息来判断是否要走二级存储读取。</p></li><li><p>优先从预读缓存读取消息。（如果开启预读缓存功能）</p></li><li><p>如果从缓存中读到消息，直接返回。如果没有读到消息，立即从二级存储中拉取消息，拉取到后放入缓存，然后返回。</p><ul><li>从二级存储读取消息的过程：先读取消费队列数据，然后用消费队列数据查询消息数据，确定要读取消息数据的长度，最后从分级存储中读取消息数据并返回。</li></ul></li></ul><h3 id="_3-6-索引设计" tabindex="-1"><a class="header-anchor" href="#_3-6-索引设计" aria-hidden="true">#</a> 3.6 索引设计</h3><h4 id="_3-6-1-索引重排" tabindex="-1"><a class="header-anchor" href="#_3-6-1-索引重排" aria-hidden="true">#</a> 3.6.1 索引重排</h4><p><a href="/rocketmq/20220301-rocketmq-indexfile.html" class="">索引文件</a> 是为了根据 Key 查询消息而创建的。它的组织结构近似一个 HashMap，Key 为消息的 Key 进行 hash 之后的值，Value 包含了消息物理偏移量等信息。</p><p>当发生哈希冲突时（消息 Key 经过 hash 之后可能相同），采用链表的形式处理冲突，将新插入的 Value 插入 hash 槽的开头（头插法）。这样，每个 hash 槽就对应了一条按照插入时间倒序排列的链表。</p><p>但是这样的结构组成文件之后，读取一个 hash 槽对应的链表时，由于每个 Value 插入时间不是连续的，它们会分布在文件的不同位置，这样查询时就存在多次随机读。</p><p>冷存储的 IOPS 代价是十分昂贵的，所以在分级存储中面向查询进行优化，如下图所示。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202404150137847.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>新的索引文件将每个 hash 槽所对应的 Value 重新排列，在文件中连续存储和读取，不再使用非连续的链表形式。这样可以让查询时的多次随机 IO 变成一次 IO。</p><h4 id="_3-6-2-索引构建流程" tabindex="-1"><a class="header-anchor" href="#_3-6-2-索引构建流程" aria-hidden="true">#</a> 3.6.2 索引构建流程</h4><p>分级存储的索引文件分为三个状态：</p><ol><li><strong>UNSEALED</strong>：初始状态，<strong>类似</strong>主存索引文件格式（顺序写），存储在本地磁盘上，正在被写入。一般只有最后一个索引文件处于该状态。路径为 <code>{storePath}/tiered_index_file/{时间戳}</code></li><li><strong>SEALED</strong>：已经或正在被压缩成新格式的索引文件，还未上传到外部存储。路径为 <code>{storePath}/tiered_index_file/compacting/{时间戳}</code></li><li><strong>UPLOAD</strong>：已经上传到二级存储。</li></ol><p>索引文件在消息上传到二级存储后开始构建，每次写入只会写入文件列表最后一个处于 <code>UNSEALED</code> 状态的文件。当一个索引文件写满后，把它改为 <code>SEALED</code> 状态，并新建一个 <code>UNSEALED</code> 的索引文件。</p><p>索引文件服务启动一个线程，每 10s 扫描一次，找到创建时间<strong>最早</strong>的处于 <code>SEALED</code> 状态的索引文件，<strong>压缩</strong>并上传到二级存储。</p><p><strong>压缩</strong>的过程会在 <code>compacting</code> 目录创建一个新格式的索引文件，然后遍历老索引文件，将内容重新排列后写入新的索引文件，最后将新索引文件内容上传到二级存储。上传完成之后会删掉处于本地的新老索引文件。</p><h3 id="_3-7-重启恢复和元数据" tabindex="-1"><a class="header-anchor" href="#_3-7-重启恢复和元数据" aria-hidden="true">#</a> 3.7 重启恢复和元数据</h3><p>在 Broker 重启后，需要重新加载分级存储文件句柄到内存。之前加载过的二级存储文件信息通过元数据的形式保存在本地文件中，专门用于 Broker 重启之后的恢复。</p><p>元数据文件默认保存的位置是 <code>${ROCKETMQ_HOME}/store/config/tieredStoreMetadata.json</code>。</p><p>元数据文件分为两类：一类是保存 Topic、Queue 数据的；另一类是保存所有分级存储文件句柄（FileSegment）的。每当有新的 Topic 或 Queue 的消息被分发到分级存储，对应的 Topic 和 Queue 的元数据会被创建和持久化；每当新的分级存储文件句柄（FileSegment）被创建，对应的文件句柄元数据也会被创建和持久化。</p><p>在重启后，分级存储系统会读取持久化在本地的 Topic、Queue 元数据，在内存中重建 Queue，然后再读取文件句柄的元数据，在内存中恢复所有分级存储的文件句柄。</p><h2 id="_4-详细设计" tabindex="-1"><a class="header-anchor" href="#_4-详细设计" aria-hidden="true">#</a> 4. 详细设计</h2><p>分级存储的代码位于一个单独的模块 <code>tieredstore</code>，由 <code>TieredMessageStore</code> 这个类承载。</p><h3 id="_4-1-接入方式" tabindex="-1"><a class="header-anchor" href="#_4-1-接入方式" aria-hidden="true">#</a> 4.1 接入方式</h3><p>RocketMQ 支持以插件的方式引入自定义的存储实现，分级存储就是通过实现 <code>AbstractPluginMessageStore</code> 来作为插件进行接入的。<code>AbstractPluginMessageStore</code> 实现了 <code>MessageStore</code> 接口，可以作为 Broker 的存储实现。</p><h4 id="_4-1-1-分级存储初始化" tabindex="-1"><a class="header-anchor" href="#_4-1-1-分级存储初始化" aria-hidden="true">#</a> 4.1.1 分级存储初始化</h4><p>在 BrokerController 初始化时，调用 <code>initializeMessageStore()</code> 方法，会先进行默认存储的初始化。</p><p>默认存储有两种类型</p><ol><li><code>DefaultMessageStore</code>，为使用磁盘文件存储的默认存储实现</li><li><code>RocksDBMessageStore</code>，使用 RocksDB 进行存储实现，为了支持百万队列而引入</li></ol><p>然后如果配置了插件存储，则将实例化插件存储，作为 Broker 中真正使用的存储实现。最后，将默认存储作为一个引用传入插件存储，这样，在插件存储中仍然可以调用默认存储。</p><h4 id="_4-1-2-分级存储调用" tabindex="-1"><a class="header-anchor" href="#_4-1-2-分级存储调用" aria-hidden="true">#</a> 4.1.2 分级存储调用</h4><h5 id="写消息" tabindex="-1"><a class="header-anchor" href="#写消息" aria-hidden="true">#</a> 写消息</h5><p>在存储消息时，<code>TieredMessageStore</code> 并没有重写消息存储的方法，而是直接调用了默认存储的消息保存，先将消息存至默认的本地存储中。</p><p>分级存储在这里的接入方法是：在默认存储的消息分发器中添加分级存储的消息分发器实例。这样，消息在存储到 <code>CommitLog</code> 之后会先分发到 <code>ConsumeQueue</code> 和 <code>IndexFile</code>，然后分发到分级存储。</p><h5 id="读消息" tabindex="-1"><a class="header-anchor" href="#读消息" aria-hidden="true">#</a> 读消息</h5><p>查询时，<code>TieredMessageStore</code> 重写了 <code>getMessageAsync</code> 方法，根据配置的分级存储消息读取策略进行判断，如果是读本地存储，则使用本地存储的引用调用其 <code>getMessageAsync</code> 方法，如果是读分级存储则调用分级存储 <code>fetcher</code> 获取消息。</p><h3 id="_4-2-存储模型" tabindex="-1"><a class="header-anchor" href="#_4-2-存储模型" aria-hidden="true">#</a> 4.2 存储模型</h3><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2024/04/1714324026671.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>如上图所示，<code>TieredMessageStore</code> 中包含了分级存储所有的存储模型，下面来分别介绍</p><ul><li><p>FlatFileStore：分级存储中消息文件存储的实现，内部有一个 Map 作为分级存储文件容器，Key 是队列，Value 是该队列的分级存储文件，以 <code>FlatMessageFile</code> 的形式存储</p><ul><li><p>FlatMessageFile：表示单个队列的存储实现，它封装了 <code>FlatCommitLogFile</code> 和 <code>FlatConsumeQueueFile</code> 对象，并且提供了读/写消息等操作接口。</p><ul><li><p>FlatCommitLogFile：分级存储 <code>CommitLog</code> 文件，类似本地存储的 <code>CommitLog</code>，由一组 <code>FileSegment</code> 队列构成。区别是分级存储的 <code>CommitLog</code> 是以队列维度保存的。</p><p>这是为了方便连续地读取单个队列中的消息。如果仍然以本地存储的方式将所有队列的 <code>CommitLog</code> 统一存储，同一队列的消息数据可能会横跨更多的文件，为分级存储带来更多的 IOPS 压力，这对分级存储来说是非常昂贵的。</p></li><li><p>FlatConsumeQueueFile：分级存储队列消费索引，类似本地存储的 <code>ConsumeQueue</code>，由一组 <code>FileSegment</code> 队列构成。保存着消息位置（指向 <code>FlatCommitLogFile</code> 的偏移量）</p><ul><li>FlatAppendFile：<code>FlatCommitLogFile</code> 和 <code>FlatConsumeQueueFile</code> 都扩展了这个类，它类似本地存储的 <code>MappedFileQueue</code>，是零个或多个定长 <code>FileSegment</code> 组成的链表。其中最多只有最后一个 <code>FileSegment</code> 是可写的，前面的文件都是只读的。 <ul><li>FileSegment：类似本地存储的 <code>MappedFile</code>，分级存储中的文件最小单元。</li></ul></li></ul></li></ul></li></ul></li><li><p>DefaultMetadataStore：分级存储元数据存储实现，用于存储 Topic、Queue、FileSegment 等元数据信息</p><ul><li>topicMetadataTable：Map，存储分级存储中 Topic 的元数据和额外属性</li><li>queueMetadataTable：Map，存储分级存储中 Queue 元数据和额外属性</li><li>commitLogFileSegmentTable：分级存储 <code>CommitLog</code> 的 <code>FileSegment</code> 文件元数据</li><li>consumeQueueFileSegment：分级存储 <code>ConsumeQueue</code> 的 <code>FileSegment</code> 文件元数据</li><li>indexFileSegmentTable：分级存储 <code>IndexFile</code> 的 <code>FileSegment</code> 文件元数据</li></ul></li><li><p>MessageStoreFetcher：分级存储消息读取器，负责处理分级存储读取请求。</p><ul><li>fetcherCache：读取器预读缓存，为了加速从二级存储读取的速度和减少整体上对二级存储请求数而设置。在读取前查询和读取缓存；从二级存储读到数据后放入缓存。</li></ul></li><li><p>MessageStoreDispatcher：分级存储消息分发器，是一个服务线程，定时将本地已经攒批的数据上传到分级存储。</p></li><li><p>IndexStoreService：分级存储索引服务，内部包含了由 <code>IndexStoreFile</code> 构成的索引文件表，以及当前正在写入的索引文件的引用。同时提供了索引文件操作的接口。</p><ul><li>IndexStoreFile：分级存储索引文件，类似本地存储的 <code>IndexFile</code>，底层是分级存储 <code>FileSegment</code>。</li></ul></li></ul><h3 id="_4-3-写消息" tabindex="-1"><a class="header-anchor" href="#_4-3-写消息" aria-hidden="true">#</a> 4.3 写消息</h3><p>初始化分级存储时会将分级存储 dispatcher 注册到 CommitLog 的 dispatcher 链当中。</p><p>在消息写入 CommitLog 后，reput 线程会扫描 CommitLog 中的消息，然后依次运行 dispatcher 链中的 dispatcher，生成 ConsumeQueue 和 IndexFile。在这之后，会执行分级存储 dispatcher 方法。分级存储的 dispatcher 仅仅根据扫描到的消息创建分级存储对应的队列目录和空的分级存储 FileSegment 文件，上传数据的流程为定时发起。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2024/04/1714324026694.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>MessageStoreDispatcherImpl</code> 是分级存储消息分发器的实现，用于将本地存储的消息提交到分级存储中。它是一个服务线程，每 20s 运行一次，判断缓冲区中等待上传的消息是否达到阈值，如果达到则将本地存储中的这批消息提交到分级存储。</p><p>每 20s，它遍历当前分级存储中所有的 <code>FlatMessageFile</code>（也就是遍历每个 Queue），对他们执行 <code>dispatchWithSemaphore</code> 方法。</p><p>这个方法获取信号量，然后将执行异步上传操作，当前默认允许的同时上传的 Queue 数量为 2500。</p><p><code>doScheduleDispatch</code> 方法执行消息数据的获取、缓冲和上传。</p><p>每次上传的数据量是有一个阈值的，满足了阈值条件其中之一才进行上传，否则等待下一次扫描。</p><ul><li>超时：上次提交到当前时间是否超过分级存储存储的提交时间阈值（30s）</li><li>缓冲区满：当前队列等待提交的消息数量超过阈值（4096）</li></ul><p>该方法的第一步是找到本次上传数据的偏移量起始和结束位置。在这之前需要明确一些概念。</p><p>RocketMQ 在多副本的情况下，消息被写入 CommitLog 之后更新 max offset（图中黄色部分），但这些消息还需要同步到其他副本。多副本中多数派的最小位点（低水位）为 commit offset，而在这之间的消息是正在等待副本同步的。允许上传到分级存储的消息（也就是上传数据的结束位置最多）是 commit offset 之前。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202404260139047.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>起始位置的计算方式如下：</p><ul><li>如果这个队列的分级存储 FileSegment 为空（刚初始化），那么起始位置即该 FileSegment 文件对应的队列起始偏移量。</li><li>如果这个 FileSegment 已经初始化过，那么为分级存储 ConsumeQueue 当前的 maxOffset。因为分级存储的 CommitLog 和 ConsumeQueue 上传是一系列操作，必须保证消息上传到这两个文件成功才视作上传成功。所以应该以 ConsumeQueue 的 max offset 为准。</li></ul><p>明确了起始位置之后，要计算当次上传的结束位置。单次上传最大消息数据量也有一个阈值，默认为 4M，如果队列中等待上传的消息量超过 4M，则截断上传，否则全部上传。</p><p>上传到分级存储的操作也分为两步，<code>append</code> 和 <code>commit</code>。</p><ul><li>append：将数据放入上传缓冲区，等待批量上传。这个过程在这里是同步的。分级存储文件的 max offset 包含了放入缓冲区中等待上传的消息数据。</li><li>commit：真正将数据上传到二级存储，为异步操作。分级存储文件中的 commit offset 为已经上传到分级存储的消息数据。</li></ul><p><code>doScheduleDispatch</code> 整个分发逻辑为：</p><ol><li>从起始位置到结束位置遍历队列逻辑偏移量</li><li>根据偏移量获取本地存储中的 ConsumeQueue 单元</li><li>根据 ConsumeQueue 单元查找本地存储 CommitLog，获取消息数据</li><li>将消息数据 append 到分级存储 CommitLog 中的缓存</li><li>提交一个分级存储的 DispatchRequest，append 到分级存储 ConsumeQueue 的缓存</li><li>异步执行 commit，先将 CommitLog 缓存中的数据上传到分级存储，然后将 ConsumeQueue 缓存中的数据上传到二级存储。上传完成之后更新 commit offset，然后释放 CommitLog 缓冲区和 ConsumeQueue 分发请求缓冲区。</li><li>如果开启 IndexFile，则调用 <code>constructIndexFile</code> 构造分级存储 IndexFile，具体逻辑后面会讲</li></ol><p>对于上传失败的情况，在 <code>doScheduleDispatch</code> 开始时进行判断，分级存储 ConsumeQueue 的 commit offset 是否大于等于 max offset，如果不是则重试上次上传，也就是把上次还在缓冲区的数据重新上传一次。</p><h3 id="_4-4-读消息" tabindex="-1"><a class="header-anchor" href="#_4-4-读消息" aria-hidden="true">#</a> 4.4 读消息</h3><p>读消息的逻辑引入预读缓存，以加快读取速度、减少对分级存储的访问。读消息的逻辑也经过一次重构，原先的预读缓存使用了拥塞控制算法，每次预读消息量类似拥塞窗口采用加法增、乘法减的流量控制机制，但存在 OOM 的问题。重构后采用更简单明了的预读策略：当缓存中的数据大小大于缓存配置大小的 80% 时就直接走分级存储，解决了 OOM 的问题。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2024/04/1714324026716.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_4-4-1-tieredmessagestore-读消息" tabindex="-1"><a class="header-anchor" href="#_4-4-1-tieredmessagestore-读消息" aria-hidden="true">#</a> 4.4.1 TieredMessageStore 读消息</h4><p>如果使用分级存储，<code>TieredMessageStore</code> 则会作为 Broker 使用的 <code>MessageStore</code>，读消息时会调用 <code>getMessageAsync</code> 方法。它的逻辑是</p><ol><li>根据用户配置的分级存储读取策略，检查是否需要从分级存储中读取消息。分级存储读取策略如下，默认为 <code>NOT_IN_DISK</code>： <ul><li>DISABLE：禁用分级存储，所有 fetch 请求都将由本地消息存储处理。</li><li>NOT_IN_DISK：只有 offset 不在本地存储中的 fetch 请求才会由分级存储处理。</li><li>NOT_IN_MEM：只有 offset 不在内存中的 fetch 请求才会由分级存储处理。</li><li>FORCE：所有 fetch 请求都将由分级存储处理。</li></ul></li><li>如果是从分级存储进行读取，则调用 <code>MessageStoreFetcherImpl</code> 的 <code>getMessageAsync</code> 方法，从分级存储读取消息数据。如果是从本地存储读取，则调用本地存储 <code>MessageStore</code> 的引用，读取本地存储中的消息数据。</li><li>如果从分级存储没有找到消息，会从本地存储再读取一次。如果从分级存储中找到，更新分级存储的统计信息。</li></ol><h4 id="_4-4-2-预读缓存设计" tabindex="-1"><a class="header-anchor" href="#_4-4-2-预读缓存设计" aria-hidden="true">#</a> 4.4.2 预读缓存设计</h4><p>预读缓存是使用 Caffeine 库来创建的内存缓存。最大可用的内存默认为 JVM 内存的 30%，缓存项在 15s 内没有被使用则清理，使用消息 buffer 大小计算内存使用量。</p><h4 id="_4-4-3-messagestorefetcher-读消息" tabindex="-1"><a class="header-anchor" href="#_4-4-3-messagestorefetcher-读消息" aria-hidden="true">#</a> 4.4.3 MessageStoreFetcher 读消息</h4><p><code>MessageStoreFetcherImpl#getMessageAsync</code> 方法需要判断走预读缓存读消息还是直接走分级存储，根据判断结果来调用读取消息的方法。判断依据是预读缓存占用的内存是否超过阈值（即超过预读缓存最多可用内存的 80%）。</p><p>缓存的 Key 是 <code>topic@queueId@offset</code> 字符串，Value 是 <code>SelectBufferResult</code></p><h5 id="从分级存储读取" tabindex="-1"><a class="header-anchor" href="#从分级存储读取" aria-hidden="true">#</a> 从分级存储读取</h5><p>先来看<strong>直接走分级存储</strong>读取的场景，会调用 <code>getMessageFromTieredStoreAsync</code> 方法，该方法逻辑如下</p><ol><li>根据要读取消息的偏移量和最大读取消息数量获取分级存储 ConsumeQueue</li><li>根据 ConsumeQueue 读取分级存储 CommitLog <ol><li>从 ConsumeQueue Buffer 中解析出第一条和最后一条消息的 commitLog offset，并验证是否合法</li><li>获取整体要读的消息长度，如果长度超过阈值，则缩小单次读取长度（从最后一条消息开始往前缩小，直到缩到只有一条消息）</li><li>从分级存储 CommitLog 中读取消息</li></ol></li><li>读取到消息数据后进行处理，将返回结果解析成消息对象，放入返回结果中返回</li></ol><h5 id="从预读缓存读取" tabindex="-1"><a class="header-anchor" href="#从预读缓存读取" aria-hidden="true">#</a> 从预读缓存读取</h5><p>然后来看走<strong>预读缓存</strong>的场景，如果预读缓存中没有消息，会走到上面分级存储读取的方法来读取消息然后放入预读缓存。</p><p><code>getMessageFromCacheAsync</code> 逻辑如下：</p><ol><li>先尝试从缓存中读消息，根据消息逻辑偏移量一条一条从缓存中查询消息。</li><li>如果从缓存中读取到消息，即便没有达到 maxCount 也直接返回。</li><li>如果缓存中没有读到，调用 <code>fetchMessageThenPutToCache</code> 方法： <ol><li>它先调用 <code>getMessageFromTieredStoreAsync</code> 方法从分级存储查询消息</li><li>然后将读到的消息放入缓存</li></ol></li><li>最后再查询缓存，将结果返回</li></ol><h4 id="_4-4-4-flatappendfile-读消息" tabindex="-1"><a class="header-anchor" href="#_4-4-4-flatappendfile-读消息" aria-hidden="true">#</a> 4.4.4 FlatAppendFile 读消息</h4><p>FlatAppendFile 是分级存储 FileSegment 列表的封装，<code>readAsync</code> 方法会找到要读取的 FileSegment，然后调用 FileSegment 的 <code>readAsync</code> 方法进行读取，逻辑如下：</p><ol><li>从后往前遍历 FileSegment，找到包含 offset 的 FileSegment</li><li>获取 offset 所在的 FileSegment，以及它后面一个 FileSegment（如果要读取的数据跨越了两个 FileSegment）</li><li>读取 FileSegment 的数据，合并后返回</li></ol><h3 id="_4-5-索引文件" tabindex="-1"><a class="header-anchor" href="#_4-5-索引文件" aria-hidden="true">#</a> 4.5 索引文件</h3><p>分级存储中的索引文件也是以一组 FileSegment 的形式存在。</p><p>概要设计中讲到，为了减少分级存储索引文件的 IOPS，所以在设计上对分级存储中保存的 IndexFile 文件格式进行了优化。在分级存储索引项刚开始构建时，这个索引文件处于未压缩状态，文件内容格式与本地存储的索引文件相同。在一个索引文件写满后，会重排该索引文件，写到一个新的文件中，最后上传到分级存储。</p><h4 id="_4-5-1-索引文件类设计" tabindex="-1"><a class="header-anchor" href="#_4-5-1-索引文件类设计" aria-hidden="true">#</a> 4.5.1 索引文件类设计</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202404280113296.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>IndexService</code> 接口中包含了对索引文件操作的封装：<code>putKey</code> 和 <code>queryAsync</code>，两个索引文件类实现了这个接口。</p><ul><li>IndexStoreFile：表示单个索引文件，包含了压缩前的索引文件引用、压缩后索引文件引用、上传到二级存储的索引文件引用。 <ul><li>fileStatus：索引文件状态 <ul><li><strong>UNSEALED</strong>：初始状态，<strong>类似</strong>主存索引文件格式（顺序写），存储在本地磁盘上，正在被写入。一般只有最后一个索引文件处于该状态。路径为 <code>{storePath}/tiered_index_file/{时间戳}</code></li><li><strong>SEALED</strong>：已经或正在被压缩成新格式的索引文件，还未上传到外部存储。路径为 <code>{storePath}/tiered_index_file/compacting/{时间戳}</code></li><li><strong>UPLOAD</strong>：已经上传到二级存储。</li></ul></li><li>mappedFile：UNSEALED 状态下索引文件引用，类似本地 IndexFile 的格式</li><li>compactMappedFile：SEALED 状态下的索引文件，经过重排后的格式</li><li>fileSegment：UPLOAD 状态下的索引文件，已上传二级存储</li></ul></li><li>IndexStoreService：IndexStoreFile 文件的容器，内部有排序的 IndexStoreFile 表，实现了索引文件读写接口，作为索引文件操作的入口。也是一个服务线程，用于扫描和重排已经写满的索引文件。 <ul><li>timeStoreTable：索引文件表，根据创建时间排序的跳表，Key 是创建时间</li><li>currentWriteFile：正在写入的索引文件，也是 timeStoreTable 中的最后一个索引文件</li></ul></li></ul><h4 id="_4-5-2-索引文件读写" tabindex="-1"><a class="header-anchor" href="#_4-5-2-索引文件读写" aria-hidden="true">#</a> 4.5.2 索引文件读写</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2024/04/1714324026743.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>IndexStoreService</code> 作为索引文件的容器和操作入口，保存着索引文件的跳表。该列表最多只允许有一个 <code>UNSEALED</code> 的文件，处理写入请求。</p><h5 id="写分级存储索引" tabindex="-1"><a class="header-anchor" href="#写分级存储索引" aria-hidden="true">#</a> 写分级存储索引</h5><p>索引文件的写入在前面写过的分级存储 ConsumeQueue 数据上传完成之后被调用，入口是 <code>MessageStoreDispatcherImpl#constructIndexFile</code>，它会调用 <code>IndexStoreService#putKey</code> 方法进行写入。<code>putKey</code> 中会找到当前 <code>UNSEALED</code> 状态的索引文件，调用它的 <code>putKey</code> 方法写入，最多重试 3 次。如果文件写满，则创建新的索引文件后，都写入失败则打印错误日志。</p><p>索引文件仅在根据 Key 查消息时使用，没有它的情况下也能正常消费消息，所以在多次写入失败的情况下可以放弃写入，它的写入顺序也是最靠后的。</p><p>单个索引文件的写入逻辑如下：</p><ol><li>判断是否已经写满（索引数量超过最大值，默认 2000w），如果写满则将索引文件状态置为 SEALED 等待压缩，返回文件已满</li><li>将索引项先写入本地的一个临时索引文件中</li></ol><h5 id="读分级存储索引" tabindex="-1"><a class="header-anchor" href="#读分级存储索引" aria-hidden="true">#</a> 读分级存储索引</h5><p>读索引的调用链如图所示，一般由 RocketMQ Admin client 发送 QueryMessage 请求触发，从下到上进行调用</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202404282113622.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>IndexStoreService#queryAsync</code> 作为分级存储索引文件读取的入口，逻辑如下：</p><ol><li>获取查询时间范围内的所有索引文件</li><li>逆序遍历索引文件，调用它的 <code>queryAsync</code> 方法异步查询索引项</li><li>等待所有查询任务完成，将所有索引文件的查询结果放入结果列表</li></ol><p>单个索引文件的读取逻辑如下：</p><ol><li>根据索引文件状态判断从哪里读取 <ul><li>UNSEALED/SEALED 状态：从本地未压缩的临时索引文件查询，读取方式和读取普通的本地索引文件类似</li><li>UPLOADED：从已上传分级存储的 FileSegment 中读取 <ol><li>根据 key 的 hashCode 计算 hash 槽位置</li><li>读取 hash 槽中的索引项起始位置和总长度</li><li>根据索引项起始位置和索引项总长度从 FileSegment 读取索引项</li><li>从读到的索引项开始遍历，根据索引项的时间戳范围和 hashCode 过滤索引项，直到找到足够的索引项</li></ol></li></ul></li></ol><h4 id="_4-5-3-索引文件重排" tabindex="-1"><a class="header-anchor" href="#_4-5-3-索引文件重排" aria-hidden="true">#</a> 4.5.3 索引文件重排</h4><h4 id="_4-5-3-1-重排流程" tabindex="-1"><a class="header-anchor" href="#_4-5-3-1-重排流程" aria-hidden="true">#</a> 4.5.3.1 重排流程</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2024/04/1714324026764.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>索引文件重排的入口是 <code>IndexStoreService</code>，它是一个服务线程，每 10s 进行一次扫描，找到索引文件表中下一个 <code>SEALED</code> 状态的索引文件，准备重排和上传。</p><p>重排和上传的入口函数是 <code>doCompactThenUploadFile</code>，它的逻辑如下</p><ol><li>如果这个文件还没有被重排，调用 <code>IndexStoreFile#doCompaction</code> 进行重排 <ol><li>创建一个新的本地内存映射文件，作为重排后的文件，它的目录也是单独的。在没有上传成功之前，重排前后的两个文件同时存在，老文件用来读取，新文件用来上传。 <ul><li>未重排文件：<code>{storePath}/tiered_index_file/{时间戳}</code></li><li>重排后文件：<code>{storePath}/tiered_index_file/compacting/{时间戳}</code></li></ul></li><li>遍历老文件的 hash 槽和索引项，将索引项和 hash 槽写入新文件，此时进行重排</li><li>更新新文件的头信息</li></ol></li><li>用重排后新索引文件的 ByteBuffer 在分级存储索引文件的 FlatAppendFile 中创建一个 FileSegment</li><li>上传该 FileSegment 到分级存储</li><li>上传完成之后将该 FileSegment 封装成 IndexStoreFile（UPLOADED 状态），放入 <code>IndexStoreService</code> 的跳表（覆盖原来未上传的）。</li><li>删除本地的新老格式的索引文件</li></ol><h4 id="_4-5-3-2-重排细节" tabindex="-1"><a class="header-anchor" href="#_4-5-3-2-重排细节" aria-hidden="true">#</a> 4.5.3.2 重排细节</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202404150137847.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>左边是老的索引文件格式，这里不再赘述。重排的目标是在查询时减少对分级存储的 IOPS，也就是说在查询某个 Key 对应 hash 槽的所有索引项时，最好可以连续读。</p><p>所以重排之后的结构就呼之欲出：原来 hash 槽的链表项，在文件中的位置是随机的，通过链表指针的方式连接起来。新的格式直接将同一 hash 槽的索引项在物理位置上连续排列，去掉链表指针也可以节省每个索引项占用的大小（4 Byte）。</p><p>重排后的文件相对重排之前：</p><ol><li>Header 不变、hash 槽和索引项数量不变</li><li>hash 槽大小从 4 Byte 扩大到 8 Byte，多了索引项总长度，方便一次性把这个 hash 槽的所有索引项查出来 <ol><li>0~4byte：hash 槽索引项的起始位置</li><li>5~8byte：这个 hash 槽所有索引项的总长度</li></ol></li><li>索引项经过排序，去掉了链表指针，从 32byte 变为 28byte</li></ol><h3 id="_4-6-重启恢复和元数据" tabindex="-1"><a class="header-anchor" href="#_4-6-重启恢复和元数据" aria-hidden="true">#</a> 4.6 重启恢复和元数据</h3><p>分级存储的元数据是专门为了恢复分级存储文件引用而设置的，在分级存储相关的 Topic、Queue 或者 FileSegment 文件发生新建/删除时，索引文件会更新并持久化到本地文件中，在重启恢复分级存储模块时读取。</p><h4 id="_4-6-1-元数据" tabindex="-1"><a class="header-anchor" href="#_4-6-1-元数据" aria-hidden="true">#</a> 4.6.1 元数据</h4><p><code>DefaultMetadataStore</code> 作为分级存储元数据管理类，它扩展了 <code>ConfigManager</code> 类。</p><p><code>ConfigManager</code> 是 RocketMQ 一些动态配置（比如 topic 配置、消费组偏移量等）也用到的配置文件抽象类，它已经实现了 <code>load</code> 和 <code>persist</code> 方法，用于持久化到本地文件和从本地文件读取。扩展它之后只需要实现 <code>decode</code> 方法，定义持久化哪些数据。这里持久化了 5 组元数据表，以 json 的格式存储在 <code>{storePath}/config/tieredStoreMetadata.json</code>。</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2024/04/1714324026787.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>元数据文件包括两类：</p><ol><li><code>Topic</code>、<code>Queue</code> 的数据，在 <code>FlatMessageFile</code> 创建时更新，入口是 <code>FlatMessageFile</code> 构造函数。</li><li><code>FileSegment</code> 数据，包含创建时间、起始偏移量、大小、状态等。在 FileSegment 创建时更新，入口是 <code>FlatAppendFile#rollingNewFile</code>。</li></ol><p>一个简单的元数据文件示例如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;commitLogFileSegmentTable&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;broker-a\\topic-tiered\\0&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token operator">:</span><span class="token punctuation">{</span>
				<span class="token property">&quot;baseOffset&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token property">&quot;beginTimestamp&quot;</span><span class="token operator">:</span><span class="token number">1713719372709</span><span class="token punctuation">,</span>
				<span class="token property">&quot;createTimestamp&quot;</span><span class="token operator">:</span><span class="token number">1713719498811</span><span class="token punctuation">,</span>
				<span class="token property">&quot;endTimestamp&quot;</span><span class="token operator">:</span><span class="token number">1713719488780</span><span class="token punctuation">,</span>
				<span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;broker-a\\topic-tiered\\0&quot;</span><span class="token punctuation">,</span>
				<span class="token property">&quot;sealTimestamp&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">557667000</span><span class="token punctuation">,</span>
				<span class="token property">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token number">0</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;consumeQueueFileSegmentTable&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;broker-a\\topic-tiered\\0&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token operator">:</span><span class="token punctuation">{</span>
				<span class="token property">&quot;baseOffset&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token property">&quot;beginTimestamp&quot;</span><span class="token operator">:</span><span class="token number">1713719372709</span><span class="token punctuation">,</span>
				<span class="token property">&quot;createTimestamp&quot;</span><span class="token operator">:</span><span class="token number">1713719498817</span><span class="token punctuation">,</span>
				<span class="token property">&quot;endTimestamp&quot;</span><span class="token operator">:</span><span class="token number">1713719488008</span><span class="token punctuation">,</span>
				<span class="token property">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;broker-a\\topic-tiered\\0&quot;</span><span class="token punctuation">,</span>
				<span class="token property">&quot;sealTimestamp&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token property">&quot;size&quot;</span><span class="token operator">:</span><span class="token number">32417620</span><span class="token punctuation">,</span>
				<span class="token property">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token number">1</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;indexFileSegmentTable&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;queueMetadataTable&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;topic-tiered&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token operator">:</span><span class="token punctuation">{</span>
				<span class="token property">&quot;maxOffset&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token property">&quot;minOffset&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
				<span class="token property">&quot;queue&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
					<span class="token property">&quot;brokerName&quot;</span><span class="token operator">:</span><span class="token string">&quot;broker-a&quot;</span><span class="token punctuation">,</span>
					<span class="token property">&quot;queueId&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
					<span class="token property">&quot;topic&quot;</span><span class="token operator">:</span><span class="token string">&quot;topic-tiered&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">&quot;updateTimestamp&quot;</span><span class="token operator">:</span><span class="token number">1713719498827</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;topicMetadataTable&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token property">&quot;topic-tiered&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
			<span class="token property">&quot;reserveTime&quot;</span><span class="token operator">:</span><span class="token number">-1</span><span class="token punctuation">,</span>
			<span class="token property">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
			<span class="token property">&quot;topic&quot;</span><span class="token operator">:</span><span class="token string">&quot;topic-tiered&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;topicId&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
			<span class="token property">&quot;updateTimestamp&quot;</span><span class="token operator">:</span><span class="token number">1713719372725</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;topicSerialNumber&quot;</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-6-2-重启恢复" tabindex="-1"><a class="header-anchor" href="#_4-6-2-重启恢复" aria-hidden="true">#</a> 4.6.2 重启恢复</h4><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/knowledge/2024/04/1714324026805.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>恢复的入口是 <code>TieredMessageStore#load</code> 方法，它调用分级存储 <code>FlatFileStore#load</code> 方法，先恢复分级存储，然后调用本地存储的 <code>load</code> 方法恢复本地存储。</p><p><code>FlatFileStore</code> 的 <code>load</code> 方法中先清空所有分级存储文件，然后调用 <code>recover</code> 进行分级存储文件恢复，最后启动定时任务，每分钟扫描和清理过期文件。</p><p>recover 方法逻辑如下：</p><ol><li>遍历 Topic 元数据，调用 <code>recoverAsync(toicMetadata)</code> 并发恢复 Topic，恢复之前获取信号量避免并发度过高</li><li>遍历该 Topic 中的 Queue 元数据，调用 <code>computeIfAbsent(MessageQueue)</code> 为每个队列初始化分级存储消息数据文件 FlatMessageFile。初始化分级存储消息数据文件时，会递归恢复 CommitLog、ConsumeQueue、IndexFile 的分级存储文件（也遍历元数据来恢复）</li><li><code>FlatMessageFile</code> 的构造函数中会调用 <code>createFlatFileForCommitLog</code> 和 <code>createFlatFileForConsumeQueue</code> 来恢复对应的 FileSegment</li><li>这两个方法也会调用元数据存储的 <code>iterateFileSegment</code> 遍历 FileSegment 的元数据来构造 FileSegment</li></ol><h2 id="_5-源码解析" tabindex="-1"><a class="header-anchor" href="#_5-源码解析" aria-hidden="true">#</a> 5. 源码解析</h2><h3 id="_5-1-分级存储接入" tabindex="-1"><a class="header-anchor" href="#_5-1-分级存储接入" aria-hidden="true">#</a> 5.1 分级存储接入</h3><h4 id="_5-1-1-brokercontroller-initializemessagestore-初始化分级存储实现" tabindex="-1"><a class="header-anchor" href="#_5-1-1-brokercontroller-initializemessagestore-初始化分级存储实现" aria-hidden="true">#</a> 5.1.1 BrokerController#initializeMessageStore 初始化分级存储实现</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">initializeMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">DefaultMessageStore</span> defaultMessageStore<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableRocksDBStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            defaultMessageStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RocksDBMessageStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStatsManager<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageArrivingListener<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">,</span> topicConfigManager<span class="token punctuation">.</span><span class="token function">getTopicConfigTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            defaultMessageStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStatsManager<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageArrivingListener<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">,</span> topicConfigManager<span class="token punctuation">.</span><span class="token function">getTopicConfigTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果开启主从切换（DLedger 模式），为 DLedgerLeaderElector 选主器添加角色变更监听器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DLedgerRoleChangeHandler</span> roleChangeHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLedgerRoleChangeHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DLedgerCommitLog</span><span class="token punctuation">)</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getdLedgerServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDLedgerLeaderElector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addRoleChangeHandler</span><span class="token punctuation">(</span>roleChangeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerStats</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Load store plugin</span>
        <span class="token class-name">MessageStorePluginContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageStorePluginContext</span><span class="token punctuation">(</span>
            messageStoreConfig<span class="token punctuation">,</span> brokerStatsManager<span class="token punctuation">,</span> messageArrivingListener<span class="token punctuation">,</span> brokerConfig<span class="token punctuation">,</span> configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据配置文件中的 storePlugin 属性，加载对应的消息存储插件。并且传入默认的消息存储实现的引用，以便插件中可以调用默认的消息存储实现。</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore <span class="token operator">=</span> <span class="token class-name">MessageStoreFactory</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">getDispatcherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherCalcBitMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerFilterManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isTimerWheelEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;BrokerController#initialize: unexpected error occurs&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-2-messagestorefactory-build-构造分级存储插件" tabindex="-1"><a class="header-anchor" href="#_5-1-2-messagestorefactory-build-构造分级存储插件" aria-hidden="true">#</a> 5.1.2 MessageStoreFactory#build 构造分级存储插件</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据 BrokerConfig 配置的 MessageStorePlugin 创建扩展 MessageStore 实现
 *
 * <span class="token keyword">@param</span> <span class="token parameter">messageStore</span> 默认 MessageStore，当前有 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">DefaultMessageStore</span></span><span class="token punctuation">}</span> 和 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">RocksDBMessageStore</span></span><span class="token punctuation">}</span> 两个实现
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">MessageStore</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">MessageStorePluginContext</span> context<span class="token punctuation">,</span>
    <span class="token class-name">MessageStore</span> messageStore<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> plugin <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageStorePlugIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果指定了扩展 MessageStore 实现，则创建扩展 MessageStore 实现，并将默认 MessageStore 作为参数传入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> plugin<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pluginClasses <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> pluginClasses<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> pluginClass <span class="token operator">=</span> pluginClasses<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractPluginMessageStore</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractPluginMessageStore</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>pluginClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractPluginMessageStore</span><span class="token punctuation">&gt;</span></span> construct <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">MessageStorePluginContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">MessageStore</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">AbstractPluginMessageStore</span> pluginMessageStore <span class="token operator">=</span> construct<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
                messageStore <span class="token operator">=</span> pluginMessageStore<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Initialize plugin&#39;s class: &quot;</span> <span class="token operator">+</span> pluginClass <span class="token operator">+</span> <span class="token string">&quot; not found!&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> messageStore<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-写消息" tabindex="-1"><a class="header-anchor" href="#_5-2-写消息" aria-hidden="true">#</a> 5.2 写消息</h3><h4 id="_5-2-1-messagestoredispatcherimpl-doscheduledispatch-定时上传消息到分级存储" tabindex="-1"><a class="header-anchor" href="#_5-2-1-messagestoredispatcherimpl-doscheduledispatch-定时上传消息到分级存储" aria-hidden="true">#</a> 5.2.1 MessageStoreDispatcherImpl#doScheduleDispatch 定时上传消息到分级存储</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 定时任务，每隔 20 秒为每个队列执行一次分发
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} service started&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flatFileStore<span class="token punctuation">.</span><span class="token function">deepCopyFlatFileToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">dispatchWithSemaphore</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} service shutdown&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 分发消息，将消息写入到 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">FlatMessageFile</span></span><span class="token punctuation">}</span> 文件中
 *
 * <span class="token keyword">@param</span> <span class="token parameter">force</span> true: 等待直到获取锁成功，false: 获取锁失败时直接返回
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">doScheduleDispatch</span><span class="token punctuation">(</span><span class="token class-name">FlatFileInterface</span> flatFile<span class="token punctuation">,</span> <span class="token keyword">boolean</span> force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stopped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">String</span> topic <span class="token operator">=</span> flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> queueId <span class="token operator">=</span> flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取分级存储文件锁，写消息。force 为 true 时，会待直到获取锁成功</span>
    <span class="token comment">// For test scenarios, we set the &#39;force&#39; variable to true to</span>
    <span class="token comment">// ensure that the data in the cache is directly committed successfully.</span>
    force <span class="token operator">=</span> <span class="token operator">!</span>storeConfig<span class="token punctuation">.</span><span class="token function">isTieredStoreGroupCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> force<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flatFile<span class="token punctuation">.</span><span class="token function">getFileLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flatFile<span class="token punctuation">.</span><span class="token function">getFileLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果 Topic 被过滤，则直接销毁文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>topicFilter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> topicFilter<span class="token punctuation">.</span><span class="token function">filterTopic</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            flatFileStore<span class="token punctuation">.</span><span class="token function">destroyFile</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 已经提交到缓冲区的 ConsumeQueue offset</span>
        <span class="token keyword">long</span> currentOffset <span class="token operator">=</span> flatFile<span class="token punctuation">.</span><span class="token function">getConsumeQueueMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 已经刷盘的 ConsumeQueue offset</span>
        <span class="token keyword">long</span> commitOffset <span class="token operator">=</span> flatFile<span class="token punctuation">.</span><span class="token function">getConsumeQueueCommitOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> minOffsetInQueue <span class="token operator">=</span> defaultStore<span class="token punctuation">.</span><span class="token function">getMinOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> maxOffsetInQueue <span class="token operator">=</span> defaultStore<span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果 ConsumeQueue 的 FileSegment 文件完全没有初始化，则初始化文件</span>
        <span class="token comment">// If set to max offset here, some written messages may be lost</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flatFile<span class="token punctuation">.</span><span class="token function">isFlatFileInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            currentOffset <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>minOffsetInQueue<span class="token punctuation">,</span>
                maxOffsetInQueue <span class="token operator">-</span> storeConfig<span class="token punctuation">.</span><span class="token function">getTieredStoreGroupCommitSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            flatFile<span class="token punctuation">.</span><span class="token function">initOffset</span><span class="token punctuation">(</span>currentOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果上一次刷盘失败（已刷盘 offset 小于提交到缓冲区的 offset，说明没有全部刷盘成功），立即重试上次刷盘</span>
        <span class="token comment">// If the previous commit fails, attempt to trigger a commit directly.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>commitOffset <span class="token operator">&lt;</span> currentOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果当前 offset 小于最小 offset，则销毁文件，重新创建文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentOffset <span class="token operator">&lt;</span> minOffsetInQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;MessageDispatcher#dispatch, current offset is too small, &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;topic={}, queueId={}, offset={}-{}, current={}&quot;</span><span class="token punctuation">,</span>
                topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> minOffsetInQueue<span class="token punctuation">,</span> maxOffsetInQueue<span class="token punctuation">,</span> currentOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            flatFileStore<span class="token punctuation">.</span><span class="token function">destroyFile</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            flatFileStore<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> brokerName<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentOffset <span class="token operator">&gt;</span> maxOffsetInQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;MessageDispatcher#dispatch, current offset is too large, &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;topic: {}, queueId: {}, offset={}-{}, current={}&quot;</span><span class="token punctuation">,</span>
                topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> minOffsetInQueue<span class="token punctuation">,</span> maxOffsetInQueue<span class="token punctuation">,</span> currentOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果超过滚动时间（24h），则滚动文件</span>
        <span class="token keyword">long</span> interval <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>storeConfig<span class="token punctuation">.</span><span class="token function">getCommitLogRollingInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flatFile<span class="token punctuation">.</span><span class="token function">rollingFile</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;MessageDispatcher#dispatch, rolling file, &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;topic: {}, queueId: {}, offset={}-{}, current={}&quot;</span><span class="token punctuation">,</span>
                topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> minOffsetInQueue<span class="token punctuation">,</span> maxOffsetInQueue<span class="token punctuation">,</span> currentOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentOffset <span class="token operator">==</span> maxOffsetInQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">long</span> bufferSize <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> groupCommitSize <span class="token operator">=</span> storeConfig<span class="token punctuation">.</span><span class="token function">getTieredStoreGroupCommitSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> groupCommitCount <span class="token operator">=</span> storeConfig<span class="token punctuation">.</span><span class="token function">getTieredStoreGroupCommitCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算目标 offset，为当前以提交到缓冲区的 ConsumeQueue offset 加上单次提交的消息数阈值</span>
        <span class="token keyword">long</span> targetOffset <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>currentOffset <span class="token operator">+</span> groupCommitCount<span class="token punctuation">,</span> maxOffsetInQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 判断是否需要立即提交，还是继续攒批</span>
        <span class="token comment">// 取出最后 append 到缓冲区的一条消息</span>
        <span class="token class-name">ConsumeQueueInterface</span> consumeQueue <span class="token operator">=</span> defaultStore<span class="token punctuation">.</span><span class="token function">getConsumeQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CqUnit</span> cqUnit <span class="token operator">=</span> consumeQueue<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SelectMappedBufferResult</span> message <span class="token operator">=</span>
            defaultStore<span class="token punctuation">.</span><span class="token function">selectOneMessageByOffset</span><span class="token punctuation">(</span>cqUnit<span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cqUnit<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 超时：上次提交到当前时间是否超过分级存储存储的提交时间阈值（30s）</span>
        <span class="token keyword">boolean</span> timeout <span class="token operator">=</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">getStoreTimeStamp</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            storeConfig<span class="token punctuation">.</span><span class="token function">getTieredStoreGroupCommitTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 缓冲区满：当前队列等待提交的消息数量超过阈值（4096）</span>
        <span class="token keyword">boolean</span> bufferFull <span class="token operator">=</span> maxOffsetInQueue <span class="token operator">-</span> currentOffset <span class="token operator">&gt;</span> storeConfig<span class="token punctuation">.</span><span class="token function">getTieredStoreGroupCommitCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bufferFull <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果没有到提交时间阈值、缓冲区没有满、没有强制刷盘，则不进行刷盘，继续攒批</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;MessageDispatcher#dispatch hold, topic={}, queueId={}, offset={}-{}, current={}, remain={}&quot;</span><span class="token punctuation">,</span>
                topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> minOffsetInQueue<span class="token punctuation">,</span> maxOffsetInQueue<span class="token punctuation">,</span> currentOffset<span class="token punctuation">,</span> maxOffsetInQueue <span class="token operator">-</span> currentOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果到提交时间阈值或者缓冲区满或者强制刷盘，则进行刷盘</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">getStoreTimeStamp</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;MessageDispatcher#dispatch behind too much, topic={}, queueId={}, offset={}-{}, current={}, remain={}&quot;</span><span class="token punctuation">,</span>
                    topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> minOffsetInQueue<span class="token punctuation">,</span> maxOffsetInQueue<span class="token punctuation">,</span> currentOffset<span class="token punctuation">,</span> maxOffsetInQueue <span class="token operator">-</span> currentOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;MessageDispatcher#dispatch, topic={}, queueId={}, offset={}-{}, current={}, remain={}&quot;</span><span class="token punctuation">,</span>
                    topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> minOffsetInQueue<span class="token punctuation">,</span> maxOffsetInQueue<span class="token punctuation">,</span> currentOffset<span class="token punctuation">,</span> maxOffsetInQueue <span class="token operator">-</span> currentOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        message<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 准备提交，先将消息放入缓冲区</span>
        <span class="token comment">// 对于目标偏移量之前的每个偏移量，从消费队列中获取消费队列单元，然后根据其从本地存储中查询消息</span>
        <span class="token comment">// 将消息追加到 CommitLog 缓冲区，并将分发请求追加到 ConsumeQueue 缓冲区</span>
        <span class="token keyword">long</span> offset <span class="token operator">=</span> currentOffset<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> offset <span class="token operator">&lt;</span> targetOffset<span class="token punctuation">;</span> offset<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cqUnit <span class="token operator">=</span> consumeQueue<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            bufferSize <span class="token operator">+=</span> cqUnit<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferSize <span class="token operator">&gt;=</span> groupCommitSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            message <span class="token operator">=</span> defaultStore<span class="token punctuation">.</span><span class="token function">selectOneMessageByOffset</span><span class="token punctuation">(</span>cqUnit<span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cqUnit<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 将消息追加到分级存储 CommitLog 缓冲区</span>
            <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AppendResult</span> result <span class="token operator">=</span> flatFile<span class="token punctuation">.</span><span class="token function">appendCommitLog</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">long</span> mappedCommitLogOffset <span class="token operator">=</span> flatFile<span class="token punctuation">.</span><span class="token function">getCommitLogMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> byteBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> properties <span class="token operator">=</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">DispatchRequest</span> dispatchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DispatchRequest</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> mappedCommitLogOffset<span class="token punctuation">,</span>
                cqUnit<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cqUnit<span class="token punctuation">.</span><span class="token function">getTagsCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">getStoreTimeStamp</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                cqUnit<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_KEYS</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                properties<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dispatchRequest<span class="token punctuation">.</span><span class="token function">setOffsetId</span><span class="token punctuation">(</span><span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">getOffsetId</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 提交一个 DispatchRequest 到分级存储 ConsumeQueue</span>
            result <span class="token operator">=</span> flatFile<span class="token punctuation">.</span><span class="token function">appendConsumeQueue</span><span class="token punctuation">(</span>dispatchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果等待提交的消息数量超过阈值（4096），立即进行下一次提交</span>
        <span class="token comment">// If there are many messages waiting to be uploaded, call the upload logic immediately.</span>
        <span class="token keyword">boolean</span> repeat <span class="token operator">=</span> timeout <span class="token operator">||</span> maxOffsetInQueue <span class="token operator">-</span> offset <span class="token operator">&gt;</span> storeConfig<span class="token punctuation">.</span><span class="token function">getTieredStoreGroupCommitCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果 FlatMessageFile 中待分发的 ConsumeQueue 请求不为空，则将缓冲区中的数据刷到二级存储</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flatFile<span class="token punctuation">.</span><span class="token function">getDispatchRequestList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Attributes</span> attributes <span class="token operator">=</span> <span class="token class-name">TieredStoreMetricsManager</span><span class="token punctuation">.</span><span class="token function">newAttributesBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TieredStoreMetricsConstant</span><span class="token punctuation">.</span><span class="token constant">LABEL_TOPIC</span><span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TieredStoreMetricsConstant</span><span class="token punctuation">.</span><span class="token constant">LABEL_QUEUE_ID</span><span class="token punctuation">,</span> queueId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TieredStoreMetricsConstant</span><span class="token punctuation">.</span><span class="token constant">LABEL_FILE_TYPE</span><span class="token punctuation">,</span> <span class="token class-name">FileSegmentType</span><span class="token punctuation">.</span><span class="token constant">COMMIT_LOG</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TieredStoreMetricsManager</span><span class="token punctuation">.</span>messagesDispatchTotal<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>offset <span class="token operator">-</span> currentOffset<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unused<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>repeat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 如果等待提交的消息数量超过阈值（4096），立即进行下一次提交</span>
                        storeExecutor<span class="token punctuation">.</span>commonExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">dispatchWithSemaphore</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        flatFile<span class="token punctuation">.</span><span class="token function">getFileLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 执行 CommitLog 刷盘，再执行 ConsumeQueue 的刷盘，再执行 Index 构建（如果开启 Index）
 *
 * <span class="token keyword">@param</span> <span class="token parameter">flatFile</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">commitAsync</span><span class="token punctuation">(</span><span class="token class-name">FlatFileInterface</span> flatFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> flatFile<span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span>success <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>storeConfig<span class="token punctuation">.</span><span class="token function">isMessageIndexEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                flatFile<span class="token punctuation">.</span><span class="token function">getDispatchRequestList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
                    request <span class="token operator">-&gt;</span> <span class="token function">constructIndexFile</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">.</span><span class="token function">getTopicId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            flatFile<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">MessageStoreExecutor</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>bufferCommitExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-2-filesegment-commitasync-异步上传" tabindex="-1"><a class="header-anchor" href="#_5-2-2-filesegment-commitasync-异步上传" aria-hidden="true">#</a> 5.2.2 FileSegment#commitAsync 异步上传</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 将 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">bufferList</span></span><span class="token punctuation">}</span> 中的数据写入分级存储文件中
 */</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;NonAtomicOperationOnVolatileField&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">commitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">needCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// acquire lock</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>commitLock<span class="token punctuation">.</span><span class="token function">drainPermits</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理上次提交的错误（如果 fileSegmentInputStream 不为空）</span>
    <span class="token comment">// handle last commit error</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fileSegmentInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> fileSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fileSize <span class="token operator">==</span> <span class="token constant">GET_FILE_SIZE_ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;FileSegment correct position error, fileName={}, commit={}, append={}, buffer={}&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> commitPosition<span class="token punctuation">,</span> appendPosition<span class="token punctuation">,</span> fileSegmentInputStream<span class="token punctuation">.</span><span class="token function">getContentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">releaseCommitLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">correctPosition</span><span class="token punctuation">(</span>fileSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fileSegmentInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 计算要提交数据的大小，并创建一个 FileSegmentInputStream 自定义输入流</span>
    <span class="token keyword">int</span> bufferSize<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fileSegmentInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 上次提交失败，重置输入流，重新提交</span>
        fileSegmentInputStream<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bufferSize <span class="token operator">=</span> fileSegmentInputStream<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 上次提交成功，用 bufferList 中的 ByteBuffer 创建新的输入流</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> bufferList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">borrowBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bufferSize <span class="token operator">=</span> bufferList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token operator">::</span><span class="token function">remaining</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 没有数据要提交，释放提交锁</span>
            <span class="token function">releaseCommitLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        fileSegmentInputStream <span class="token operator">=</span> <span class="token class-name">FileSegmentInputStreamFactory</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
            fileType<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCommitOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bufferList<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 调用 commit0 方法执行实际提交操作</span>
    <span class="token keyword">boolean</span> append <span class="token operator">=</span> fileType <span class="token operator">!=</span> <span class="token class-name">FileSegmentType</span><span class="token punctuation">.</span><span class="token constant">INDEX</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> flightCommitRequest <span class="token operator">=</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">commit0</span><span class="token punctuation">(</span>fileSegmentInputStream<span class="token punctuation">,</span> commitPosition<span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span> append<span class="token punctuation">)</span>
            <span class="token comment">// 处理提交操作结果</span>
            <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 提交成功，更新 commit offset，清空 fileSegmentInputStream</span>
                    commitPosition <span class="token operator">+=</span> bufferSize<span class="token punctuation">;</span>
                    fileSegmentInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 提交失败，重置 fileSegmentInputStream</span>
                    fileSegmentInputStream<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">exceptionally</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">handleCommitException</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">releaseCommitLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-读消息" tabindex="-1"><a class="header-anchor" href="#_5-3-读消息" aria-hidden="true">#</a> 5.3 读消息</h3><h4 id="_5-3-1-messagestorefetcherimpl-getmessageasync-分级存储消息读取入口" tabindex="-1"><a class="header-anchor" href="#_5-3-1-messagestorefetcherimpl-getmessageasync-分级存储消息读取入口" aria-hidden="true">#</a> 5.3.1 MessageStoreFetcherImpl#getMessageAsync 分级存储消息读取入口</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 从分级存储读消息
 *
 * <span class="token keyword">@param</span> <span class="token parameter">group</span>         Consumer group that launches this query.
 * <span class="token keyword">@param</span> <span class="token parameter">topic</span>         Topic to query.
 * <span class="token keyword">@param</span> <span class="token parameter">queueId</span>       Queue ID to query.
 * <span class="token keyword">@param</span> <span class="token parameter">queueOffset</span>        Logical offset to start from.
 * <span class="token keyword">@param</span> <span class="token parameter">maxCount</span>      Maximum count of messages to query.
 * <span class="token keyword">@param</span> <span class="token parameter">messageFilter</span> Message filter used to screen desired messages.
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GetMessageResult</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMessageAsync</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> group<span class="token punctuation">,</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token keyword">long</span> queueOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCount<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">MessageFilter</span> messageFilter<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">GetMessageResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetMessageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据队列查找分级存储文件</span>
    <span class="token class-name">FlatMessageFile</span> flatFile <span class="token operator">=</span> flatFileStore<span class="token punctuation">.</span><span class="token function">getFlatFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> brokerName<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 分级存储队列文件不存在，返回 NO_MATCHED_LOGIC_QUEUE</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flatFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_LOGIC_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 从分级存储文件获取最小和最大偏移量，其中最大偏移量取的是消费队列的已提交偏移量（正在上传中的不算在内）</span>
    <span class="token comment">// Max queue offset means next message put position</span>
    result<span class="token punctuation">.</span><span class="token function">setMinOffset</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">.</span><span class="token function">getConsumeQueueMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">setMaxOffset</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">.</span><span class="token function">getConsumeQueueCommitOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据 fetch 的 queueOffset 和返回结果的 minOffset、maxOffset 来决定返回的结果</span>
    <span class="token comment">// Fill result according file offset.</span>
    <span class="token comment">// Offset range  | Result           | Fix to</span>
    <span class="token comment">// (-oo, 0]      | no message       | current offset</span>
    <span class="token comment">// (0, min)      | too small        | min offset</span>
    <span class="token comment">// [min, max)    | correct          |</span>
    <span class="token comment">// [max, max]    | overflow one     | max offset</span>
    <span class="token comment">// (max, +oo)    | overflow badly   | max offset</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MESSAGE_IN_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>queueOffset <span class="token operator">&lt;</span> result<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_TOO_SMALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>queueOffset <span class="token operator">==</span> result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_OVERFLOW_ONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>queueOffset <span class="token operator">&gt;</span> result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_OVERFLOW_BADLY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> cacheBusy <span class="token operator">=</span> fetcherCache<span class="token punctuation">.</span><span class="token function">estimatedSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> memoryMaxSize <span class="token operator">*</span> <span class="token number">0.8</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>storeConfig<span class="token punctuation">.</span><span class="token function">isReadAheadCacheEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cacheBusy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从缓存读消息</span>
        <span class="token keyword">return</span> <span class="token function">getMessageFromCacheAsync</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">,</span> group<span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> maxCount<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>messageResultExt <span class="token operator">-&gt;</span> messageResultExt<span class="token punctuation">.</span><span class="token function">doFilterMessage</span><span class="token punctuation">(</span>messageFilter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从分级存储读消息</span>
        <span class="token keyword">return</span> <span class="token function">getMessageFromTieredStoreAsync</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> maxCount<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>messageResultExt <span class="token operator">-&gt;</span> messageResultExt<span class="token punctuation">.</span><span class="token function">doFilterMessage</span><span class="token punctuation">(</span>messageFilter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-2-messagestorefetcherimpl-getmessagefromcacheasync-从缓存中读取消息" tabindex="-1"><a class="header-anchor" href="#_5-3-2-messagestorefetcherimpl-getmessagefromcacheasync-从缓存中读取消息" aria-hidden="true">#</a> 5.3.2 MessageStoreFetcherImpl#getMessageFromCacheAsync 从缓存中读取消息</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 从分级存储预读缓存读消息
 */</span>
<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GetMessageResultExt</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMessageFromCacheAsync</span><span class="token punctuation">(</span>
    <span class="token class-name">FlatMessageFile</span> flatFile<span class="token punctuation">,</span> <span class="token class-name">String</span> group<span class="token punctuation">,</span> <span class="token keyword">long</span> queueOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">MessageQueue</span> mq <span class="token operator">=</span> flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从缓存中读一批消息</span>
    <span class="token class-name">GetMessageResultExt</span> result <span class="token operator">=</span> <span class="token function">getMessageFromCache</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> maxCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取到消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">FOUND</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;MessageFetcher cache hit, group={}, topic={}, queueId={}, offset={}, maxCount={}, resultSize={}, lag={}&quot;</span><span class="token punctuation">,</span>
            group<span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span>
            result<span class="token punctuation">.</span><span class="token function">getMessageCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> result<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果缓存中没有读到，立即从二级存储中拉消息，并放入缓存</span>
    <span class="token comment">// If cache miss, pull messages immediately</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;MessageFetcher cache miss, group={}, topic={}, queueId={}, offset={}, maxCount={}, lag={}&quot;</span><span class="token punctuation">,</span>
        group<span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> result<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">fetchMessageThenPutToCache</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> storeConfig<span class="token punctuation">.</span><span class="token function">getReadAheadMessageCountThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>maxOffset <span class="token operator">-&gt;</span> <span class="token function">getMessageFromCache</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> maxCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 从二级存储拉消息，放入缓存
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">fetchMessageThenPutToCache</span><span class="token punctuation">(</span>
    <span class="token class-name">FlatMessageFile</span> flatFile<span class="token punctuation">,</span> <span class="token keyword">long</span> queueOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> batchSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">MessageQueue</span> mq <span class="token operator">=</span> flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从二级存储读消息</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageFromTieredStoreAsync</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> batchSize<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_OVERFLOW_ONE</span> <span class="token operator">||</span>
                result<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_OVERFLOW_BADLY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">FOUND</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;MessageFetcher prefetch message then put to cache failed, result={}, &quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;topic={}, queue={}, queue offset={}, batch size={}&quot;</span><span class="token punctuation">,</span>
                    result<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> offsetList <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getMessageQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> tagCodeList <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getTagCodeList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectMappedBufferResult</span><span class="token punctuation">&gt;</span></span> msgList <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getMessageMapedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将读到的消息放入缓存</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> offsetList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">SelectMappedBufferResult</span> msg <span class="token operator">=</span> msgList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SelectBufferResult</span> bufferResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SelectBufferResult</span><span class="token punctuation">(</span>
                    msg<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getStartOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tagCodeList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putMessageToCache</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">,</span> queueOffset <span class="token operator">+</span> i<span class="token punctuation">,</span> bufferResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> offsetList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>offsetList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-3-messagestorefetcherimpl-getmessagefromtieredstoreasync-从二级存储中读取消息" tabindex="-1"><a class="header-anchor" href="#_5-3-3-messagestorefetcherimpl-getmessagefromtieredstoreasync-从二级存储中读取消息" aria-hidden="true">#</a> 5.3.3 MessageStoreFetcherImpl#getMessageFromTieredStoreAsync 从二级存储中读取消息</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 从二级存储中读取消息
 */</span>
<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GetMessageResultExt</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMessageFromTieredStoreAsync</span><span class="token punctuation">(</span>
    <span class="token class-name">FlatMessageFile</span> flatFile<span class="token punctuation">,</span> <span class="token keyword">long</span> queueOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> batchSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 从分级存储文件获取最小和最大偏移量，其中最大偏移量取的是消费队列的已提交偏移量（正在上传中的不算在内）</span>
    <span class="token class-name">GetMessageResultExt</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetMessageResultExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">setMinOffset</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">.</span><span class="token function">getConsumeQueueMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">setMaxOffset</span><span class="token punctuation">(</span>flatFile<span class="token punctuation">.</span><span class="token function">getConsumeQueueCommitOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据 fetch 的 queueOffset 和返回结果的 minOffset、maxOffset 来决定返回的结果</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queueOffset <span class="token operator">&lt;</span> result<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_TOO_SMALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>queueOffset <span class="token operator">==</span> result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_OVERFLOW_ONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>queueOffset <span class="token operator">&gt;</span> result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_OVERFLOW_BADLY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>queueOffset <span class="token operator">&lt;</span> result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        batchSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>batchSize<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
            result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> queueOffset<span class="token punctuation">,</span> storeConfig<span class="token punctuation">.</span><span class="token function">getReadAheadMessageCountThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取 ConsumeQueue</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> readConsumeQueueFuture<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        readConsumeQueueFuture <span class="token operator">=</span> flatFile<span class="token punctuation">.</span><span class="token function">getConsumeQueueAsync</span><span class="token punctuation">(</span>queueOffset<span class="token punctuation">,</span> batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TieredStoreException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">ILLEGAL_PARAM</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">ILLEGAL_OFFSET</span><span class="token operator">:</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_FOUND_NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> finalBatchSize <span class="token operator">=</span> batchSize<span class="token punctuation">;</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> readCommitLogFuture <span class="token operator">=</span> readConsumeQueueFuture<span class="token punctuation">.</span><span class="token function">thenCompose</span><span class="token punctuation">(</span>cqBuffer <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

        <span class="token comment">// 从 ConsumeQueue Buffer 中解析出第一条和最后一条消息的 commitLog offset，并验证是否合法</span>
        <span class="token keyword">long</span> firstCommitLogOffset <span class="token operator">=</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">getCommitLogOffsetFromItem</span><span class="token punctuation">(</span>cqBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cqBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>cqBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token constant">CONSUME_QUEUE_UNIT_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> lastCommitLogOffset <span class="token operator">=</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">getCommitLogOffsetFromItem</span><span class="token punctuation">(</span>cqBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastCommitLogOffset <span class="token operator">&lt;</span> firstCommitLogOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;MessageFetcher#getMessageFromTieredStoreAsync, last offset is smaller than first offset, &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;topic={} queueId={}, offset={}, firstOffset={}, lastOffset={}&quot;</span><span class="token punctuation">,</span>
                flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span>
                firstCommitLogOffset<span class="token punctuation">,</span> lastCommitLogOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取整体要读的消息长度，如果长度超过阈值，则缩小单次读取长度（从最后一条消息开始往前缩小，直到缩到只有一条消息）</span>
        <span class="token comment">// Get at least one message</span>
        <span class="token comment">// Reducing the length limit of cq to prevent OOM</span>
        <span class="token keyword">long</span> length <span class="token operator">=</span> lastCommitLogOffset <span class="token operator">-</span> firstCommitLogOffset <span class="token operator">+</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">getSizeFromItem</span><span class="token punctuation">(</span>cqBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>cqBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token constant">CONSUME_QUEUE_UNIT_SIZE</span> <span class="token operator">&amp;&amp;</span>
            length <span class="token operator">&gt;</span> storeConfig<span class="token punctuation">.</span><span class="token function">getReadAheadMessageSizeThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cqBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>cqBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cqBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>cqBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token constant">CONSUME_QUEUE_UNIT_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            length <span class="token operator">=</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">getCommitLogOffsetFromItem</span><span class="token punctuation">(</span>cqBuffer<span class="token punctuation">)</span>
                <span class="token operator">-</span> firstCommitLogOffset <span class="token operator">+</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">getSizeFromItem</span><span class="token punctuation">(</span>cqBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> messageCount <span class="token operator">=</span> cqBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token constant">CONSUME_QUEUE_UNIT_SIZE</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;MessageFetcher#getMessageFromTieredStoreAsync, &quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;topic={}, queueId={}, broker offset={}-{}, offset={}, expect={}, actually={}, lag={}&quot;</span><span class="token punctuation">,</span>
            flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            result<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> finalBatchSize<span class="token punctuation">,</span>
            messageCount<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 从分级存储 CommitLog 中读取消息</span>
        <span class="token keyword">return</span> flatFile<span class="token punctuation">.</span><span class="token function">getCommitLogAsync</span><span class="token punctuation">(</span>firstCommitLogOffset<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> readConsumeQueueFuture<span class="token punctuation">.</span><span class="token function">thenCombine</span><span class="token punctuation">(</span>readCommitLogFuture<span class="token punctuation">,</span> <span class="token punctuation">(</span>cqBuffer<span class="token punctuation">,</span> msgBuffer<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 拆分每条消息的 ByteBuffer</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectBufferResult</span><span class="token punctuation">&gt;</span></span> bufferList <span class="token operator">=</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">splitMessageBuffer</span><span class="token punctuation">(</span>cqBuffer<span class="token punctuation">,</span> msgBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> requestSize <span class="token operator">=</span> cqBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token constant">CONSUME_QUEUE_UNIT_SIZE</span><span class="token punctuation">;</span>

        <span class="token comment">// not use buffer list size to calculate next offset to prevent split error</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 消息 ByteBuffer 列表为空</span>
            result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>queueOffset <span class="token operator">+</span> requestSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 消息 ByteBuffer 列表不为空</span>
            result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">FOUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>queueOffset <span class="token operator">+</span> requestSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 将所有消息加入结果</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectBufferResult</span> bufferResult <span class="token operator">:</span> bufferList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ByteBuffer</span> slice <span class="token operator">=</span> bufferResult<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                slice<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>bufferResult<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SelectMappedBufferResult</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SelectMappedBufferResult</span><span class="token punctuation">(</span>bufferResult<span class="token punctuation">.</span><span class="token function">getStartOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    bufferResult<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bufferResult<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span><span class="token function">addMessageExt</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageFormatUtil</span><span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span>slice<span class="token punctuation">)</span><span class="token punctuation">,</span> bufferResult<span class="token punctuation">.</span><span class="token function">getTagCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionally</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">MessageQueue</span> mq <span class="token operator">=</span> flatFile<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;MessageFetcher#getMessageFromTieredStoreAsync failed, &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;topic={} queueId={}, offset={}, batchSize={}&quot;</span><span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> finalBatchSize<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_FOUND_NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-索引文件" tabindex="-1"><a class="header-anchor" href="#_5-4-索引文件" aria-hidden="true">#</a> 5.4 索引文件</h3><h4 id="_5-4-1-indexstoreservice-indexstorefile-putkey-写入索引项" tabindex="-1"><a class="header-anchor" href="#_5-4-1-indexstoreservice-indexstorefile-putkey-写入索引项" aria-hidden="true">#</a> 5.4.1 IndexStoreService/IndexStoreFile#putKey 写入索引项</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// IndexStoreService.java</span>
<span class="token doc-comment comment">/**
 * 向最新的索引文件中写入索引项
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">AppendResult</span> <span class="token function">putKey</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">int</span> topicId<span class="token punctuation">,</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keySet<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN_ERROR</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>keySet <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> keySet<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 向当前写入的索引文件中写入索引项，重试 3 次</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AppendResult</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentWriteFile<span class="token punctuation">.</span><span class="token function">putKey</span><span class="token punctuation">(</span>
            topic<span class="token punctuation">,</span> topicId<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> keySet<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> size<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">FILE_FULL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 当前索引文件已满，创建新的索引文件</span>
            <span class="token comment">// use current time to ensure the order of file</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createNewIndexFile</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写入失败</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreService put key three times return error, topic: {}, topicId: {}, &quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;queueId: {}, keySize: {}, timestamp: {}&quot;</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> topicId<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> keySet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN_ERROR</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// IndexStoreFile.java</span>
<span class="token keyword">public</span> <span class="token class-name">AppendResult</span> <span class="token function">putKey</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">int</span> topicId<span class="token punctuation">,</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keySet<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN_ERROR</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>keySet <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> keySet<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        fileReadWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 只有 UNSEALED 状态的索引文件才允许被写入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">UNSEALED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>fileStatus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">FILE_FULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 索引数量超过最大值（默认 2000w），将索引文件状态置为 SEALED 等待压缩，返回文件已满</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>indexItemCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> keySet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexItemMaxCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fileStatus<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">IndexStatusEnum</span><span class="token punctuation">.</span><span class="token constant">SEALED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">FILE_FULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 遍历每个 Key，插入索引项</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keySet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> hashCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> slotPosition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSlotPosition</span><span class="token punctuation">(</span>hashCode <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotMaxCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> slotOldValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSlotValue</span><span class="token punctuation">(</span>slotPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> timeDiff <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timestamp <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beginTimestamp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 构造 IndexItem，写入索引文件</span>
            <span class="token class-name">IndexItem</span> indexItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexItem</span><span class="token punctuation">(</span>
                topicId<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> size<span class="token punctuation">,</span> hashCode<span class="token punctuation">,</span> timeDiff<span class="token punctuation">,</span> slotOldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> itemIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexItemCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getItemPosition</span><span class="token punctuation">(</span>itemIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>indexItem<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>byteBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>slotPosition<span class="token punctuation">,</span> itemIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>slotOldValue <span class="token operator">&lt;=</span> <span class="token constant">INVALID_INDEX</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 更新 endTimestamp</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>endTimestamp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>endTimestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 更新索引文件 Header</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">flushNewMetadata</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">,</span> indexItemMaxCount <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexItemCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile put key, timestamp: {}, topic: {}, key: {}, slot: {}, item: {}, previous item: {}, content: {}&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> key<span class="token punctuation">,</span> hashCode <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotMaxCount<span class="token punctuation">,</span> itemIndex<span class="token punctuation">,</span> slotOldValue<span class="token punctuation">,</span> indexItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile put key error, topic: {}, topicId: {}, queueId: {}, keySet: {}, offset: {}, &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;size: {}, timestamp: {}&quot;</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> topicId<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> keySet<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> size<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        fileReadWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token class-name">AppendResult</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN_ERROR</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-2-indexstoreservice-indexstorefile-docompaction-索引文件压缩重排" tabindex="-1"><a class="header-anchor" href="#_5-4-2-indexstoreservice-indexstorefile-docompaction-索引文件压缩重排" aria-hidden="true">#</a> 5.4.2 IndexStoreService/IndexStoreFile#doCompaction 索引文件压缩重排</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// IndexStoreService.java</span>
<span class="token doc-comment comment">/**
 * 每 10s 进行一次扫描和压缩
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 删除过期索引文件</span>
        <span class="token keyword">long</span> expireTimestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>storeConfig<span class="token punctuation">.</span><span class="token function">getTieredStoreFileReservedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroyExpiredFile</span><span class="token punctuation">(</span>expireTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 按时间顺序找到下一个 SEALED 待压缩文件</span>
        <span class="token class-name">IndexFile</span> indexFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNextSealedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 压缩并上传</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>indexFile <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCompactThenUploadFile</span><span class="token punctuation">(</span>indexFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCompactTimestamp</span><span class="token punctuation">(</span>indexFile<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; service shutdown&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 压缩索引文件并上传到二级存储
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">doCompactThenUploadFile</span><span class="token punctuation">(</span><span class="token class-name">IndexFile</span> indexFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">IndexFile<span class="token punctuation">.</span>IndexStatusEnum</span><span class="token punctuation">.</span><span class="token constant">UPLOAD</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>indexFile<span class="token punctuation">.</span><span class="token function">getFileStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreService file status not correct, so skip, timestamp: {}, status: {}&quot;</span><span class="token punctuation">,</span>
            indexFile<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indexFile<span class="token punctuation">.</span><span class="token function">getFileStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        indexFile<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Stopwatch</span> stopwatch <span class="token operator">=</span> <span class="token class-name">Stopwatch</span><span class="token punctuation">.</span><span class="token function">createStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果缓冲区的所有内容都已刷盘到二级存储，则可以进行压缩</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flatAppendFile<span class="token punctuation">.</span><span class="token function">getCommitOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> flatAppendFile<span class="token punctuation">.</span><span class="token function">getAppendOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 压缩成新索引文件，返回新文件的 ByteBuffer</span>
        <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> indexFile<span class="token punctuation">.</span><span class="token function">doCompaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreService found compaction buffer is null, timestamp: {}&quot;</span><span class="token punctuation">,</span> indexFile<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 创建新的 FileSegment，即压缩后的索引文件</span>
        flatAppendFile<span class="token punctuation">.</span><span class="token function">rollingNewFile</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> flatAppendFile<span class="token punctuation">.</span><span class="token function">getAppendOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        flatAppendFile<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">,</span> indexFile<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        flatAppendFile<span class="token punctuation">.</span><span class="token function">getFileToWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMinTimestamp</span><span class="token punctuation">(</span>indexFile<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        flatAppendFile<span class="token punctuation">.</span><span class="token function">getFileToWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxTimestamp</span><span class="token punctuation">(</span>indexFile<span class="token punctuation">.</span><span class="token function">getEndTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 等待压缩后的索引文件刷盘到分级存储</span>
    <span class="token keyword">boolean</span> result <span class="token operator">=</span> flatAppendFile<span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileSegment</span><span class="token punctuation">&gt;</span></span> fileSegmentList <span class="token operator">=</span> flatAppendFile<span class="token punctuation">.</span><span class="token function">getFileSegmentList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">FileSegment</span> fileSegment <span class="token operator">=</span> fileSegmentList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fileSegmentList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result <span class="token operator">||</span> fileSegment <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> fileSegment<span class="token punctuation">.</span><span class="token function">getMinTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> indexFile<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreService upload compacted file error, timestamp: {}&quot;</span><span class="token punctuation">,</span> indexFile<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreService upload compacted file success, timestamp: {}&quot;</span><span class="token punctuation">,</span> indexFile<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将上传后的所以你文件封装成 IndexFile，保存到 timeStoreTable 中</span>
    readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">IndexFile</span> storeFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexStoreFile</span><span class="token punctuation">(</span>storeConfig<span class="token punctuation">,</span> fileSegment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        timeStoreTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>storeFile<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> storeFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除本地 IndexFile（未压缩的和压缩后的）</span>
        indexFile<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreService rolling file error, timestamp: {}, cost: {}ms&quot;</span><span class="token punctuation">,</span>
            indexFile<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stopwatch<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// IndexStoreFile.java</span>
<span class="token doc-comment comment">/**
 * 压缩索引文件到新文件，设置索引文件状态为 SEALED，返回新文件 ByteBuffer
 *
 * <span class="token keyword">@return</span> 压缩后索引文件 ByteBuffer，读模式
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ByteBuffer</span> <span class="token function">doCompaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Stopwatch</span> stopwatch <span class="token operator">=</span> <span class="token class-name">Stopwatch</span><span class="token punctuation">.</span><span class="token function">createStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        buffer <span class="token operator">=</span> <span class="token function">compactToNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile do compaction, timestamp: {}, file size: {}, cost: {}ms&quot;</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stopwatch<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MICROSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile do compaction, timestamp: {}, cost: {}ms&quot;</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stopwatch<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MICROSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Make sure there is no read request here</span>
        fileReadWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileStatus<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">IndexStatusEnum</span><span class="token punctuation">.</span><span class="token constant">SEALED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile change file status to sealed error, timestamp={}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        fileReadWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 将 UNSEALED 状态的索引文件压缩到新文件
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * 压缩文件于压缩前文件相比
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
 *     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>header 不变<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
 *     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>hash 槽从 4byte 扩大到 8byte，增加了<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
 *     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>索引项经过排序，去掉了指针，从 32byte 变为 28byte<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
 *
 * <span class="token keyword">@return</span> 压缩后的新文件 ByteBuffer，读模式
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">ByteBuffer</span> <span class="token function">compactToNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> payload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token class-name">IndexItem</span><span class="token punctuation">.</span><span class="token constant">INDEX_ITEM_SIZE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> payloadBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 索引项开始写入位置 = header size + hash 槽总 size（hash 槽数 500w * hash 槽 size 8）</span>
    <span class="token keyword">int</span> writePosition <span class="token operator">=</span> <span class="token constant">INDEX_HEADER_SIZE</span> <span class="token operator">+</span> <span class="token punctuation">(</span>hashSlotMaxCount <span class="token operator">*</span> <span class="token constant">HASH_SLOT_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 文件大小 = 索引项写入位置 + 索引项总 size（索引项数 2000w * 索引项 size 32）</span>
    <span class="token keyword">int</span> fileMaxLength <span class="token operator">=</span> writePosition <span class="token operator">+</span> <span class="token constant">COMPACT_INDEX_ITEM_SIZE</span> <span class="token operator">*</span> indexItemCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建新的压缩索引文件</span>
    compactMappedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMappedFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCompactedFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fileMaxLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 压缩后的索引文件 ByteBuffer</span>
    <span class="token class-name">MappedByteBuffer</span> newBuffer <span class="token operator">=</span> compactMappedFile<span class="token punctuation">.</span><span class="token function">getMappedByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历所有 hash 槽（500w）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hashSlotMaxCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> slotPosition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSlotPosition</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> slotValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSlotValue</span><span class="token punctuation">(</span>slotPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> writeBeginPosition <span class="token operator">=</span> writePosition<span class="token punctuation">;</span>

        <span class="token comment">// 遍历 hash 槽中所有的索引项</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>slotValue <span class="token operator">&gt;</span> <span class="token constant">INVALID_INDEX</span> <span class="token operator">&amp;&amp;</span> writePosition <span class="token operator">&lt;</span> fileMaxLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 读取压缩前索引项</span>
            <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>byteBuffer<span class="token punctuation">.</span><span class="token function">duplicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getItemPosition</span><span class="token punctuation">(</span>slotValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 读取老索引项的下一个索引项位置</span>
            <span class="token keyword">int</span> newSlotValue <span class="token operator">=</span> payloadBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token constant">COMPACT_INDEX_ITEM_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 截掉老索引项的下一个索引项位置，新索引项中不需要。这行是多余的，后面没有操作 buffer</span>
            buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token constant">COMPACT_INDEX_ITEM_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 索引项写入到新索引文件</span>
            newBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>writePosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">COMPACT_INDEX_ITEM_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile do compaction, write item, slot: {}, current: {}, next: {}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> slotValue<span class="token punctuation">,</span> newSlotValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 指向下一个索引项位置</span>
            slotValue <span class="token operator">=</span> newSlotValue<span class="token punctuation">;</span>
            <span class="token comment">// 写入位置后移</span>
            writePosition <span class="token operator">+=</span> <span class="token constant">COMPACT_INDEX_ITEM_SIZE</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 计算所有索引项总长度</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> writePosition <span class="token operator">-</span> writeBeginPosition<span class="token punctuation">;</span>
        <span class="token comment">// 向压缩后的文件写入 hash 槽数据</span>
        <span class="token comment">// 0~4byte: 这个 hash 槽索引项的起始位置</span>
        newBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>slotPosition<span class="token punctuation">,</span> writeBeginPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5~8byte: 这个 hash 槽所有索引项的总长度</span>
        newBuffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>slotPosition <span class="token operator">+</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">BYTES</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile do compaction, write slot, slot: {}, begin: {}, length: {}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> writeBeginPosition<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 更新 header</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">flushNewMetadata</span><span class="token punctuation">(</span>newBuffer<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 切换成读模式</span>
    newBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> newBuffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-3-indexstoreservice-indexstorefile-queryasync-根据消息-key-查询索引项" tabindex="-1"><a class="header-anchor" href="#_5-4-3-indexstoreservice-indexstorefile-queryasync-根据消息-key-查询索引项" aria-hidden="true">#</a> 5.4.3 IndexStoreService/IndexStoreFile#queryAsync 根据消息 Key 查询索引项</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// IndexStoreService.java</span>
<span class="token doc-comment comment">/**
 * 异步查询索引项
 *
 * <span class="token keyword">@param</span> <span class="token parameter">topic</span>     The topic of the key.
 * <span class="token keyword">@param</span> <span class="token parameter">key</span>       The key to be queried.
 * <span class="token keyword">@param</span> <span class="token parameter">maxCount</span>
 * <span class="token keyword">@param</span> <span class="token parameter">beginTime</span> The start time of the query range.
 * <span class="token keyword">@param</span> <span class="token parameter">endTime</span>   The end time of the query range.
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">IndexItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryAsync</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCount<span class="token punctuation">,</span> <span class="token keyword">long</span> beginTime<span class="token punctuation">,</span> <span class="token keyword">long</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">IndexItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取时间范围内的所有索引文件</span>
        <span class="token class-name">ConcurrentNavigableMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">IndexFile</span><span class="token punctuation">&gt;</span></span> pendingMap <span class="token operator">=</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>timeStoreTable<span class="token punctuation">.</span><span class="token function">subMap</span><span class="token punctuation">(</span>beginTime<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> endTime<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> futureList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>pendingMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span> <span class="token comment">/* queueId-offset */</span><span class="token punctuation">,</span> <span class="token class-name">IndexItem</span><span class="token operator">&gt;</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 逆序遍历索引文件，异步查询索引项</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">IndexFile</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> pendingMap<span class="token punctuation">.</span><span class="token function">descendingMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> completableFuture <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">queryAsync</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> key<span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span> beginTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenAccept</span><span class="token punctuation">(</span>itemList <span class="token operator">-&gt;</span> itemList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>indexItem <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;%d-%d&quot;</span><span class="token punctuation">,</span> indexItem<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indexItem<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indexItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            futureList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>completableFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 等待所有查询任务完成</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>futureList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// Try to return the query results as much as possible here</span>
                <span class="token comment">// rather than directly throwing exceptions</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    future<span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IndexItem</span><span class="token punctuation">&gt;</span></span> resultList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    future<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>resultList<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>resultList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        future<span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> future<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// IndexStoreFile.java</span>
<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">IndexItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryAsync</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCount<span class="token punctuation">,</span> <span class="token keyword">long</span> beginTime<span class="token punctuation">,</span> <span class="token keyword">long</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileStatus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">UNSEALED</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token constant">SEALED</span><span class="token operator">:</span>
            <span class="token comment">// 从本地未压缩的索引文件中查询索引项。SEALED 状态的索引文件仍然会保留未压缩前的索引文件。</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryAsyncFromUnsealedFile</span><span class="token punctuation">(</span><span class="token function">buildKey</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span> beginTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">UPLOAD</span><span class="token operator">:</span>
            <span class="token comment">// 从已压缩并上传到二级存储的索引文件中查询索引项</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryAsyncFromSegmentFile</span><span class="token punctuation">(</span><span class="token function">buildKey</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span> beginTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">SHUTDOWN</span><span class="token operator">:</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 从未压缩的索引文件中查询索引项。SEALED 状态的索引文件仍然会保留未压缩前的索引文件，可能已经创建新索引文件并正在压缩
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">IndexItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryAsyncFromUnsealedFile</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCount<span class="token punctuation">,</span> <span class="token keyword">long</span> beginTime<span class="token punctuation">,</span> <span class="token keyword">long</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IndexItem</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            fileReadWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">UNSEALED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileStatus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token constant">SEALED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileStatus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFile <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mappedFile<span class="token punctuation">.</span><span class="token function">hold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 根据 key 的 hashCode 计算 hash 槽位置，获取 hash 槽的值。它指向第一个索引项的位置</span>
            <span class="token keyword">int</span> hashCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> slotPosition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSlotPosition</span><span class="token punctuation">(</span>hashCode <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotMaxCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> slotValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSlotValue</span><span class="token punctuation">(</span>slotPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 遍历索引项链表，直到找到足够的索引项或者达到最大查询次数（默认 512）</span>
            <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token constant">MAX_QUERY_COUNT</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>left <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                slotValue <span class="token operator">&gt;</span> <span class="token constant">INVALID_INDEX</span> <span class="token operator">&amp;&amp;</span>
                slotValue <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexItemCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token class-name">IndexItem</span><span class="token punctuation">.</span><span class="token constant">INDEX_ITEM_SIZE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>byteBuffer<span class="token punctuation">.</span><span class="token function">duplicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getItemPosition</span><span class="token punctuation">(</span>slotValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">IndexItem</span> indexItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexItem</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>hashCode <span class="token operator">==</span> indexItem<span class="token punctuation">.</span><span class="token function">getHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>indexItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> maxCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                slotValue <span class="token operator">=</span> indexItem<span class="token punctuation">.</span><span class="token function">getItemIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                left<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile query from unsealed mapped file, timestamp: {}, result size: {}, &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;key: {}, hashCode: {}, maxCount: {}, timestamp={}-{}&quot;</span><span class="token punctuation">,</span>
                <span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> hashCode<span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span> beginTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile query from unsealed mapped file error, timestamp: {}, &quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;key: {}, maxCount: {}, timestamp={}-{}&quot;</span><span class="token punctuation">,</span> <span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span> beginTime<span class="token punctuation">,</span> endTime<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            fileReadWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mappedFile<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">MessageStoreExecutor</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>bufferFetchExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 从已压缩并上传到二级存储的索引文件中查询索引项
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">IndexItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryAsyncFromSegmentFile</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCount<span class="token punctuation">,</span> <span class="token keyword">long</span> beginTime<span class="token punctuation">,</span> <span class="token keyword">long</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileSegment <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token constant">UPLOAD</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileStatus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Stopwatch</span> stopwatch <span class="token operator">=</span> <span class="token class-name">Stopwatch</span><span class="token punctuation">.</span><span class="token function">createStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从二级存储中读取索引文件，根据 key 的 hashCode 计算 hash 槽位置</span>
    <span class="token keyword">int</span> hashCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> slotPosition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSlotPosition</span><span class="token punctuation">(</span>hashCode <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotMaxCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据 hash 槽位置查询 hash 槽</span>
    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">IndexItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSegment<span class="token punctuation">.</span><span class="token function">readAsync</span><span class="token punctuation">(</span>slotPosition<span class="token punctuation">,</span> <span class="token constant">HASH_SLOT_SIZE</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">thenCompose</span><span class="token punctuation">(</span>slotBuffer <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slotBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">HASH_SLOT_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile query from tiered storage return error slot buffer, &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;key: {}, maxCount: {}, timestamp={}-{}&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span> beginTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 读取 hash 槽中的索引项起始位置和总长度</span>
            <span class="token keyword">int</span> indexPosition <span class="token operator">=</span> slotBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> indexTotalSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>slotBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">COMPACT_INDEX_ITEM_SIZE</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>indexPosition <span class="token operator">&lt;=</span> <span class="token constant">INVALID_INDEX</span> <span class="token operator">||</span> indexTotalSize <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 根据索引项起始位置和索引项总长度读取索引项</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSegment<span class="token punctuation">.</span><span class="token function">readAsync</span><span class="token punctuation">(</span>indexPosition<span class="token punctuation">,</span> indexTotalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 组装读取到的索引项</span>
        <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>itemBuffer <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IndexItem</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>itemBuffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>itemBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token constant">COMPACT_INDEX_ITEM_SIZE</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile query from tiered storage return error item buffer, &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;key: {}, maxCount: {}, timestamp={}-{}&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span> beginTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 遍历索引项，根据索引项的时间戳范围和 hashCode 过滤索引项，直到找到足够的索引项</span>
            <span class="token keyword">int</span> size <span class="token operator">=</span> itemBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token constant">COMPACT_INDEX_ITEM_SIZE</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token constant">COMPACT_INDEX_ITEM_SIZE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                itemBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">IndexItem</span> indexItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexItem</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> storeTimestamp <span class="token operator">=</span> indexItem<span class="token punctuation">.</span><span class="token function">getTimeDiff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> beginTimestamp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>hashCode <span class="token operator">==</span> indexItem<span class="token punctuation">.</span><span class="token function">getHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    beginTime <span class="token operator">&lt;=</span> storeTimestamp <span class="token operator">&amp;&amp;</span> storeTimestamp <span class="token operator">&lt;=</span> endTime <span class="token operator">&amp;&amp;</span>
                    result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>indexItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> future<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> costTime <span class="token operator">=</span> stopwatch<span class="token punctuation">.</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile query from segment file, cost: {}ms, timestamp: {}, &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;key: {}, hashCode: {}, maxCount: {}, timestamp={}-{}&quot;</span><span class="token punctuation">,</span>
                costTime<span class="token punctuation">,</span> <span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> hashCode<span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span> beginTime<span class="token punctuation">,</span> endTime<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> details <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%d-%d&quot;</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;IndexStoreFile query from segment file, cost: {}ms, timestamp: {}, result size: {}, ({}), &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;key: {}, hashCode: {}, maxCount: {}, timestamp={}-{}&quot;</span><span class="token punctuation">,</span>
                costTime<span class="token punctuation">,</span> <span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> details<span class="token punctuation">,</span> key<span class="token punctuation">,</span> hashCode<span class="token punctuation">,</span> maxCount<span class="token punctuation">,</span> beginTime<span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2><ul><li><a href="https://github.com/apache/rocketmq/blob/develop/tieredstore/README.md" target="_blank" rel="noopener noreferrer">Tiered storage README.md<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/apache/rocketmq/wiki/RIP-57-Tiered-storage-for-RocketMQ" target="_blank" rel="noopener noreferrer">RIP 57 Tiered storage for RocketMQ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/apache/rocketmq/wiki/RIP-65-Tiered-Storage-Optimization" target="_blank" rel="noopener noreferrer">RIP 65 Tiered Storage Optimization<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/apache/rocketmq/issues/6633" target="_blank" rel="noopener noreferrer">Refactoring and improving Tiered Storage Implementation<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/apache/rocketmq/issues/7545" target="_blank" rel="noopener noreferrer">[RIP-65] Support efficient random index for massive messages<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/apache/rocketmq/issues/7878" target="_blank" rel="noopener noreferrer">[Enhancement] Performance Improvement and Bug Fixes for the Tiered Storage Module<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://blog.lv5.moe/p/introduce-tiered-storage-for-rocketmq" target="_blank" rel="noopener noreferrer">RocketMQ 多级存储设计与实现<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://developer.aliyun.com/article/1441642?spm=a2c6h.24874632.expert-profile.29.5f185d0693jYjN" target="_blank" rel="noopener noreferrer">谈谈 RocketMQ 5.0 分级存储背后一些有挑战的技术优化<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://juejin.cn/post/7340603873605222435" target="_blank" rel="noopener noreferrer">RocketMQ5源码（七）分层存储<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><hr><p>欢迎关注公众号【消息中间件】（middleware-mq），更新消息中间件的源码解析和最新动态！</p><figure><img src="https://scarb-images.oss-cn-hangzhou.aliyuncs.com/img/202205170102971.jpg" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/HScarb/knowledge/edit/main/docs/src/rocketmq/20240429-rocketmq-tieredstore.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: jjhfen00@163.com">ScarbWin</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">默认页脚</div><div class="vp-copyright">Copyright © 2025 Scarb</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-10497a29.js" defer></script>
  </body>
</html>
